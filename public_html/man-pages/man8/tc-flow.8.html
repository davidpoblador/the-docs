<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>tc-flow: Flow based traffic control filter</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Flow based traffic control filter">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="tc-flow (8) manual">
  <meta name="twitter:description" content="Flow based traffic control filter">
  <meta name="twitter:image" content="https://www.carta.tech/images/iproute2-tc-flow-8.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man8/tc-flow.8.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="tc-flow (8) manual" />
  <meta property="og:description" content="Flow based traffic control filter" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/iproute2-tc-flow-8.png" />

</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">tc-flow<small> (8)</small></h1>
        <p class="lead">Flow based traffic control filter</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/">
      <span itemprop="name">System administration commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/tc-flow.8.html">
      <span itemprop="name">tc-flow: Flow based traffic control filter</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/iproute2/">
      <span itemprop="name">iproute2</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/tc-flow.8.html">
      <span itemprop="name">tc-flow: Flow based traffic control filter</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    <p>Mapping mode:</p>
  </dt>
  <dd>
    <p><strong>tc</strong> <strong>filter</strong> ... <strong>flow map key </strong> <em>KEY</em> [ <em>OPS</em> ] [ <em>OPTIONS</em> ] </p>
  </dd>
  <dt>
    <p>Hashing mode:</p>
  </dt>
  <dd>
    <p><strong>tc</strong> <strong>filter</strong> ... <strong>flow hash keys </strong> <em>KEY_LIST</em> [  <strong>perturb</strong> <em>secs</em> ] [ <em>OPTIONS</em> ] </p><p><em>OPS</em> := [ <em>OPS</em> ] <em>OP</em></p><p><em>OPTIONS</em> := [  <strong>divisor</strong> <em>NUM</em> ] [  <strong>baseclass</strong> <em>ID</em> ] [  <strong>match</strong> <em>EMATCH_TREE</em> ] [  <strong>action</strong> <em>ACTION_SPEC</em> ]</p><p><em>KEY_LIST</em> := [ <em>KEY_LIST</em> ] <em>KEY</em></p><p><em>OP</em> := {  <strong>or</strong> | <strong>and</strong> | <strong>xor</strong> | <strong>rshift</strong> | <strong>addend</strong> }  <em>NUM</em></p><p><em>ID</em> := <em>X</em>:<em>Y</em></p><p><em>KEY</em> := {  <strong>src</strong> | <strong>dst</strong> | <strong>proto</strong> | <strong>proto-src</strong> | <strong>proto-dst</strong> | <strong>iif</strong> |  <strong>priority</strong> | <strong>mark</strong> | <strong>nfct</strong> | <strong>nfct-src</strong> | <strong>nfct-dst</strong> |  <strong>nfct-proto-src</strong> | <strong>nfct-proto-dst</strong> | <strong>rt-classid</strong> | <strong>sk-uid</strong> |  <strong>sk-gid</strong> | <strong>vlan-tag</strong> | <strong>rxhash</strong> }</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>The <strong>flow</strong> classifier is meant to extend the <strong>SFQ</strong> hashing capabilities without hard-coding new hash functions. It also allows deterministic mappings of keys to classes.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OPTIONS</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    <p><strong>action</strong><em> ACTION_SPEC</em></p>
  </dt>
  <dd>
    <p>Apply an action from the generic actions framework on matching packets.</p>
  </dd>
  <dt>
    <p><strong>baseclass</strong><em> ID</em></p>
  </dt>
  <dd>
    <p>An offset for the resulting class ID. <em>ID</em> may be <strong>root</strong>, <strong>none</strong> or a hexadecimal class ID in the form [<em>X</em><strong>:</strong>]<em>Y</em>. If <em>X</em> is omitted, it is assumed to be zero.</p>
  </dd>
  <dt>
    <p><strong>divisor</strong><em> NUM</em></p>
  </dt>
  <dd>
    <p>Number of buckets to use for sorting into. Keys are calculated modulo <em>NUM</em>.</p>
  </dd>
  <dt>
    <p><strong>hash keys </strong><em>KEY-LIST</em></p>
  </dt>
  <dd>
    <p>Perform a <strong>jhash2</strong> operation over the keys in <em>KEY-LIST</em>, the result (modulo the <strong>divisor</strong> if given) is taken as class ID, optionally offset by the value of <strong>baseclass</strong>. It is possible to specify an interval (in seconds) after which <strong>jhash2</strong>'s entropy source is recreated using the <strong>perturb</strong> parameter.</p>
  </dd>
  <dt>
    <p><strong>map key </strong><em>KEY</em></p>
  </dt>
  <dd>
    <p>Packet data identified by <em>KEY</em> is translated into class IDs to push the packet into. The value may be mangled by <em>OPS</em> before using it for the mapping. They are applied in the order listed here:</p>
<dl class='dl-vertical'>
  <dt>
    <p><strong>and</strong><em> NUM</em></p>
  </dt>
  <dd>
    <p>Perform bitwise <strong>AND</strong> operation with numeric value <em>NUM</em>.</p>
  </dd>
  <dt>
    <p><strong>or</strong><em> NUM</em></p>
  </dt>
  <dd>
    <p>Perform bitwise <strong>OR</strong> operation with numeric value <em>NUM</em>.</p>
  </dd>
  <dt>
    <p><strong>xor</strong><em> NUM</em></p>
  </dt>
  <dd>
    <p>Perform bitwise <strong>XOR</strong> operation with numeric value <em>NUM</em>.</p>
  </dd>
  <dt>
    <p><strong>rshift</strong><em> NUM</em></p>
  </dt>
  <dd>
    <p>Shift the value of <em>KEY</em> to the right by <em>NUM</em> bits.</p>
  </dd>
  <dt>
    <p><strong>addend</strong><em> NUM</em></p>
  </dt>
  <dd>
    <p>Add <em>NUM</em> to the value of <em>KEY</em>.</p>
  </dd>

</dl>
<p>For the <strong>or</strong>, <strong>and</strong>, <strong>xor</strong> and <strong>rshift</strong> operations, <em>NUM</em> is assumed to be an unsigned, 32bit integer value. For the <strong>addend</strong> operation, <em>NUM</em> may be much more complex: It may be prefixed by a minus ('-') sign to cause subtraction instead of addition and for keys of <strong>src</strong>, <strong>dst</strong>, <strong>nfct-src</strong> and <strong>nfct-dst</strong> it may be given in IP address notation. See below for an illustrating example.</p>
  </dd>
  <dt>
    <p><strong>match</strong><em> EMATCH_TREE</em></p>
  </dt>
  <dd>
    <p>Match packets using the extended match infrastructure. See <a href="../man8/tc-ematch.8.html"><strong>tc-ematch</strong>(8)</a> for a detailed description of the allowed syntax in <em>EMATCH_TREE</em>.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">KEYS</h2>
        <div class="sectioncontent">
<p>In mapping mode, a single key is used (after optional permutation) to build a class ID. The resulting ID is deducible in most cases. In hashing more, a number of keys may be specified which are then hashed and the output used as class ID. This ID is not deducible in beforehand, and may even change over time for a given flow if a <strong>perturb</strong> interval has been given.</p><p>The range of class IDs can be limited by the <strong>divisor</strong> option, which is used for a modulus.</p>
<dl class='dl-vertical'>
  <dt>
    <p><strong>src</strong>, <strong>dst</strong></p>
  </dt>
  <dd>
    <p>Use source or destination address as key. In case of IPv4 and TIPC, this is the actual address value. For IPv6, the 128bit address is folded into a 32bit value by XOR'ing the four 32bit words. In all other cases, the kernel-internal socket address is used (after folding into 32bits on 64bit systems).</p>
  </dd>
  <dt>
    <p><strong>proto</strong></p>
  </dt>
  <dd>
    <p>Use the layer four protocol number as key.</p>
  </dd>
  <dt>
    <p><strong>proto-src</strong></p>
  </dt>
  <dd>
    <p>Use the layer four source port as key. If not available, the kernel-internal socket address is used instead.</p>
  </dd>
  <dt>
    <p><strong>proto-dst</strong></p>
  </dt>
  <dd>
    <p>Use the layer four destination port as key. If not available, the associated kernel-internal dst_entry address is used after XOR'ing with the packet's layer three protocol number.</p>
  </dd>
  <dt>
    <p><strong>iif</strong></p>
  </dt>
  <dd>
    <p>Use the incoming interface index as key.</p>
  </dd>
  <dt>
    <p><strong>priority</strong></p>
  </dt>
  <dd>
    <p>Use the packet's priority as key. Usually this is the IP header's DSCP/ECN value.</p>
  </dd>
  <dt>
    <p><strong>mark</strong></p>
  </dt>
  <dd>
    <p>Use the netfilter <strong>fwmark</strong> as key.</p>
  </dd>
  <dt>
    <p><strong>nfct</strong></p>
  </dt>
  <dd>
    <p>Use the associated conntrack entry address as key.</p>
  </dd>
  <dt>
    <p><strong>nfct-src</strong>, <strong>nfct-dst</strong>, <strong>nfct-proto-src</strong>, <strong>nfct-proto-dst</strong></p>
  </dt>
  <dd>
    <p>These are conntrack-aware variants of <strong>src</strong>, <strong>dst</strong>, <strong>proto-src</strong> and <strong>proto-dst</strong>. In case of NAT, these are basically the packet header's values before NAT was applied.</p>
  </dd>
  <dt>
    <p><strong>rt-classid</strong></p>
  </dt>
  <dd>
    <p>Use the packet's destination routing table entry's realm as key.</p>
  </dd>
  <dt>
    <p><strong>sk-uid</strong> <strong>sk-gid</strong></p>
  </dt>
  <dd>
    <p>For locally generated packets, use the user or group ID the originating socket belongs to as key.</p>
  </dd>
  <dt>
    <p><strong>vlan-tag</strong></p>
  </dt>
  <dd>
    <p>Use the packet's vlan ID as key.</p>
  </dd>
  <dt>
    <p><strong>rxhash</strong></p>
  </dt>
  <dd>
    <p>Use the flow hash as key.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLES</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    <p>Classic SFQ hash:</p>
  </dt>
  <dd>
    
<pre>
tc filter add ... flow hash &#92;
	keys src,dst,proto,proto-src,proto-dst divisor 1024
</pre>

  </dd>
  <dt>
    <p>Classic SFQ hash, but using information from conntrack to work properly in combination with NAT:</p>
  </dt>
  <dd>
    
<pre>
tc filter add ... flow hash &#92;
	keys nfct-src,nfct-dst,proto,nfct-proto-src,nfct-proto-dst &#92;
	divisor 1024
</pre>

  </dd>
  <dt>
    <p>Map destination IPs of 192.168.0.0/24 to classids 1-257:</p>
  </dt>
  <dd>
    
<pre>
tc filter add ... flow map &#92;
	key dst addend -192.168.0.0 divisor 256
</pre>

  </dd>
  <dt>
    <p>Alternative to the above:</p>
  </dt>
  <dd>
    
<pre>
tc filter add ... flow map &#92;
	key dst and 0xff
</pre>

  </dd>
  <dt>
    <p>The same, but in reverse order:</p>
  </dt>
  <dd>
    
<pre>
tc filter add ... flow map &#92;
	key dst and 0xff xor 0xff
</pre>

  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO tc-flow&hellip;</h2>
        <div class="sectioncontent">
<p><strong>tc</strong>(8), <a href="../man8/tc-ematch.8.html"><strong>tc-ematch</strong>(8)</a>, <a href="../man8/tc-sfq.8.html"><strong>tc-sfq</strong>(8)</a></p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="tc-ematch.8.html"><span aria-hidden="true">&larr;</span> tc-ematch.8: Extended matches for use with "basic" or "flow" filters</a></li>
   <li class="next"><a href="tc-flower.8.html">tc-flower.8: Flow based traffic control filter <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
