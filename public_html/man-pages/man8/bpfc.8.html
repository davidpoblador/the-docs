<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>bpfc: A berkeley packet filter assembler and compiler</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="A berkeley packet filter assembler and compiler">
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">bpfc<small> (8)</small></h1>
        <p class="lead">A berkeley packet filter assembler and compiler</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/">
      <span itemprop="name">System administration commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/bpfc.8.html">
      <span itemprop="name">bpfc: A berkeley packet filter assembler and compiler</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/netsniff-ng/">
      <span itemprop="name">netsniff-ng</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/bpfc.8.html">
      <span itemprop="name">bpfc: A berkeley packet filter assembler and compiler</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>bpfc</strong> { [<em>options</em>] | [<em>source-file</em>] }</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>bpfc is a small Berkeley Packet Filter assembler and compiler which is able to translate BPF assembler-like mnemonics into a numerical or C-like format, that can be read by tools such as netsniff-ng, iptables (xt_bpf) and many others. BPF is the one and only upstream filtering construct that is used in combination with <a href="../man7/packet.7.html"><strong>packet</strong>(7)</a> sockets, but also seccomp-BPF for system call sandboxing.</p><p>The Linux kernel and also BSD kernels implement "virtual machine" like constructs and JIT compilers that mimic a small register-based machine in BPF architecture and execute filter code that is, for example, composed by bpfc on a data buffer that is given by network packets. The purpose of this is to shift computation in time, so that the kernel can drop or truncate incoming packets as early as possible without having to push them to user space for further analysis first. Meanwhile, BPF constructs also find application in other areas such as in the communication between user and kernel space like system call sand-boxing.</p><p>At the time of writing this man page, the only other available BPF compiler is part of the <strong>pcap</strong>(3) library and accessible through a high-level filter language that might be familiar to many people as tcpdump-like filters.</p><p>However, it is quite often useful to bypass that compiler and write optimized code that cannot be produced by the <strong>pcap</strong>(3) compiler, or is wrongly optimized, or is defective on purpose in order to debug test kernel code. Also, a reason to use bpfc could be to try out some new BPF extensions that are not supported by other compilers. Furthermore, bpfc can be useful to verify JIT compiler behavior or to find possible bugs that need to be fixed.</p><p>bpfc is implemented with the help of <strong>flex</strong>(1) and <strong>bison</strong>(1), tokenizes the source file in the first stage and parses its content into an AST. In two code generation stages it emits target opcodes. bpfc furthermore supports Linux kernel BPF extensions. More about that can be found in the syntax section.</p><p>The Linux kernel BPF JIT compiler is automatically turned on if detected by netsniff-ng. However, it can also be manually turned on through the command ''echo "1" &gt; /proc/sys/net/core/bpf_jit_enable'' (normal working mode) or ''echo "2" &gt; /proc/sys/net/core/bpf_jit_enable'' (debug mode where emitted opcodes of the image are printed to the kernel log). An architecture agnostic BPF JIT image disassembler can be found in the kernel source tree under ''tools/net/bpf_jit_disasm.c'' or within the netsniff-ng Git repository.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OPTIONS</h2>
        <div class="sectioncontent">
<h3>-i <source-file/->, --input <source-file/-></h3>
<p>Read BPF assembly instruction from an input file or from stdin.</p>
<h3>-p, --cpp</h3>
<p>Pass the bpf program through the C preprocessor before reading it in bpfc. This allows #define and #include directives (e.g. to include definitions from system headers) to be used in the bpf program.</p>
<h3>-D <name>=<definition>, --define <name>=<definition></h3>
<p>Add macro definition for the C preprocessor to use it within bpf file. This option is used in combination with the -p,--cpp option.</p>
<h3>-f <format>, --format <format></h3>
<p>Specify a different output format than the default that is netsniff-ng compatible. The &lt;format&gt; specifier can be: C, netsniff-ng, xt_bpf, tcpdump.</p>
<h3>-b, --bypass</h3>
<p>Bypass basic filter validation when emitting opcodes. This can be useful for explicitly creating malformed BPF expressions for injecting into the kernel, for example, for bug testing.</p>
<h3>-V, --verbose</h3>
<p>Be more verbose and display some bpfc debugging information.</p>
<h3>-d, --dump</h3>
<p>Dump all supported instructions to stdout.</p>
<h3>-v, --version</h3>
<p>Show version information and exit.</p>
<h3>-h, --help</h3>
<p>Show user help and exit.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SYNTAX</h2>
        <div class="sectioncontent">
<p>The BPF architecture resp. register machine consists of the following elements:</p>
<pre>
    Element          Description
</pre>

<pre>
    A                32 bit wide accumulator
    X                32 bit wide X register
    M[]              16 x 32 bit wide misc registers aka \[lq]scratch
</pre>
<p>memory store\[rq], addressable from 0 to 15</p><p>A program, that is translated by bpfc into ''opcodes'' is an array that consists of the following elements:</p>
<pre>
    o:16, jt:8, jf:8, k:32
</pre>
<p>The element o is a 16 bit wide opcode that has a particular instruction encoded, jt and jf are two 8 bit wide jump targets, one for condition  ''true'', one for condition ''false''. Last but not least the 32 bit wide element k contains a miscellaneous argument that can be interpreted in different ways depending on the given instruction resp. opcode.</p><p>The instruction set consists of load, store, branch, alu, miscellaneous and return instructions that are also represented in bpfc syntax. This table also includes bpfc's own extensions. All operations are based on unsigned data structures:</p>
<pre>
   Instruction      Addressing mode      Description
</pre>

<pre>
   ld               1, 2, 3, 4, 10       Load word into A
   ldi              4                    Load word into A
   ldh              1, 2                 Load half-word into A
   ldb              1, 2                 Load byte into A
   ldx              3, 4, 5, 10          Load word into X
   ldxi             4                    Load word into X
   ldxb             5                    Load byte into X
</pre>

<pre>
   st               3                    Copy A into M[]
   stx              3                    Copy X into M[]
</pre>

<pre>
   jmp              6                    Jump to label
   ja               6                    Jump to label
   jeq              7, 8                 Jump on k == A
   jneq             8                    Jump on k != A
   jne              8                    Jump on k != A
   jlt              8                    Jump on k &lt; A
   jle              8                    Jump on k &lt;= A
   jgt              7, 8                 Jump on k &gt; A
   jge              7, 8                 Jump on k &gt;= A
   jset             7, 8                 Jump on k & A
</pre>

<pre>
   add              0, 4                 A + &lt;x&gt;
   sub              0, 4                 A - &lt;x&gt;
   mul              0, 4                 A * &lt;x&gt;
   div              0, 4                 A / &lt;x&gt;
   mod              0, 4                 A % &lt;x&gt;
   neg              0, 4                 !A
   and              0, 4                 A & &lt;x&gt;
   or               0, 4                 A | &lt;x&gt;
   xor              0, 4                 A ^ &lt;x&gt;
   lsh              0, 4                 A &lt;&lt; &lt;x&gt;
   rsh              0, 4                 A &gt;&gt; &lt;x&gt;
</pre>

<pre>
   tax                                   Copy A into X
   txa                                   Copy X into A
</pre>

<pre>
   ret              4, 9                 Return
</pre>

<pre>
   Addressing mode  Syntax               Description
</pre>

<pre>
    0               x/%x                 Register X
    1               [k]                  BHW at byte offset k in the packet
    2               [x + k]              BHW at the offset X + k in the packet
    3               M[k]                 Word at offset k in M[]
    4               #k                   Literal value stored in k
    5               4*([k]&0xf)          Lower nibble * 4 at byte offset k in the packet
    6               L                    Jump label L
    7               #k,Lt,Lf             Jump to Lt if true, otherwise jump to Lf
    8               #k,Lt                Jump to Lt if predicate is true
    9               a/%a                 Accumulator A
   10               extension            BPF extension (see next table)
</pre>

<pre>
   Extension (and alias)                 Description
</pre>

<pre>
   #len, len, #pktlen, pktlen            Length of packet (skb-&gt;len)
   #pto, pto, #proto, proto              Ethernet type field (skb-&gt;protocol)
   #type, type                           Packet type (**) (skb-&gt;pkt_type)
   #poff, poff                           Detected payload start offset
   #ifx, ifx, #ifidx, ifidx              Interface index (skb-&gt;dev-&gt;ifindex)
   #nla, nla                             Netlink attribute of type X with offset A
   #nlan, nlan                           Nested Netlink attribute of type X with offset A
   #mark, mark                           Packet mark (skb-&gt;mark)
   #que, que, #queue, queue, #Q, Q       NIC queue index (skb-&gt;queue_mapping)
   #hat, hat, #hatype, hatype            NIC hardware type (**) (skb-&gt;dev-&gt;type)
   #rxh, rxh, #rxhash, rxhash            Receive hash (skb-&gt;rxhash)
   #cpu, cpu                             Current CPU (raw_smp_processor_id())
   #vlant, vlant, #vlan_tci, vlan_tci    VLAN TCI value (vlan_tx_tag_get(skb))
   #vlanp, vlanp                         VLAN present (vlan_tx_tag_present(skb))
</pre>

<pre>
   Further extension details (**)        Value
</pre>

<pre>
   #type, type                           0 - to us / host
                                         1 - to all / broadcast
                                         2 - to group / multicast
                                         3 - to others (promiscuous mode)
                                         4 - outgoing of any type
</pre>

<pre>
   #hat, hat, #hatype, hatype            1 - Ethernet 10Mbps
                                         8 - APPLEtalk
                                        19 - ATM
                                        24 - IEEE 1394 IPv4 - RFC 2734
                                        32 - InfiniBand
                                       768 - IPIP tunnel
                                       769 - IP6IP6 tunnel
                                       772 - Loopback device
                                       778 - GRE over IP
                                       783 - Linux-IrDA
                                       801 - IEEE 802.11
                                       802 - IEEE 802.11 + Prism2 header
                                       803 - IEEE 802.11 + radiotap header
                                       823 - GRE over IP6
                                       824 - Netlink
                                       [...] See include/uapi/linux/if_arp.h
</pre>
<p>Note that the majority of BPF extensions are available on Linux only.</p><p>There are two types of comments in bpfc source-files:</p>
<pre>
  1. Multi-line C-style comments:        /* put comment here */
  2. Single-line ASM-style comments:     ;  put comment here
</pre>
<p>Used Abbreviations:</p>
<pre>
  BHW: byte, half-word, or word
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SOURCE EXAMPLES</h2>
        <div class="sectioncontent">
<p>In this section, we give a couple of examples of bpfc source files, in other words, some small example filter programs:</p><h3>Only return packet headers (truncate packets):</h3>

<pre>
  ld poff
  ret a
</pre>

<h3>Only allow ARP packets:</h3>

<pre>
  ldh [12]
  jne #0x806, drop
  ret #-1
  drop: ret #0
</pre>

<h3>Only allow IPv4 TCP packets:</h3>

<pre>
  ldh [12]
  jne #0x800, drop
  ldb [23]
  jneq #6, drop
  ret #-1
  drop: ret #0
</pre>

<h3>Only allow IPv4 TCP SSH traffic:</h3>

<pre>
  ldh [12]
  jne #0x800, drop
  ldb [23]
  jneq #6, drop
  ldh [20]
  jset #0x1fff, drop
  ldxb 4 * ([14] & 0xf)
  ldh [x + 14]
  jeq #0x16, pass
  ldh [x + 16]
  jne #0x16, drop
  pass: ret #-1
  drop: ret #0
</pre>

<h3>A loadable x86_64 seccomp-BPF filter to allow a given set of syscalls:</h3>

<pre>
  ld [4]                  /* offsetof(struct seccomp_data, arch) */
  jne #0xc000003e, bad    /* AUDIT_ARCH_X86_64 */
  ld [0]                  /* offsetof(struct seccomp_data, nr) */
  jeq #15, good           /* __NR_rt_sigreturn */
  jeq #231, good          /* __NR_exit_group */
  jeq #60, good           /* __NR_exit */
  jeq #0, good            /* __NR_read */
  jeq #1, good            /* __NR_write */
  jeq #5, good            /* __NR_fstat */
  jeq #9, good            /* __NR_mmap */
  jeq #14, good           /* __NR_rt_sigprocmask */
  jeq #13, good           /* __NR_rt_sigaction */
  jeq #35, good           /* __NR_nanosleep */
  bad: ret #0             /* SECCOMP_RET_KILL */
  good: ret #0x7fff0000   /* SECCOMP_RET_ALLOW */
</pre>

<h3>Allow any (hardware accelerated) VLAN:</h3>

<pre>
  ld vlanp
  jeq #0, drop
  ret #-1
  drop: ret #0
</pre>

<h3>Only allow traffic for (hardware accelerated) VLAN 10:</h3>

<pre>
  ld vlant
  jneq #10, drop
  ret #-1
  drop: ret #0
</pre>

<h3>More pedantic check for the above VLAN example:</h3>

<pre>
  ld vlanp
  jeq #0, drop
  ld vlant
  jneq #10, drop
  ret #-1
  drop: ret #0
</pre>

<h3>Filter rtnetlink messages</h3>

<pre>
  ldh #proto       /* A = skb-&gt;protocol */
</pre>

<pre>
  jneq #0, skip    /* check for NETLINK_ROUTE */
  ldb [4]          /* A = nlmsg_type */
</pre>

<pre>
  jneq #0x10, skip /* check type == RTNL_NEWLINK */
  ldx #16          /* X = offset(ifinfomsg) */
</pre>

<pre>
  ldb [x + 4]      /* offset(ifi_index) */
  jneq #0x3, skip  /* check ifindex == 3 */
</pre>

<pre>
  ld #32           /* A = len(nlmsghdr) + len(ifinfomsg), payload offset */
  ldx #16          /* X = IFLA_OPERSTATE */
  ld #nla          /* A = offset(IFLA_OPERSTATE) */
  jeq #0, skip
  tax
  ldb [x + 4]      /* A = value(IFLA_OPERSTATE) */
  jneq #0x6, skip  /* check oper state is UP */
</pre>

<pre>
  ret #-1
  skip: ret #0
</pre>


        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">USAGE EXAMPLE</h2>
        <div class="sectioncontent">
<h3>bpfc fubar</h3>
<p>Compile the source file ''fubar'' into BPF opcodes. Opcodes will be directed to stdout.</p>
<h3>bpfc -f xt_bpf -b -p -i fubar, resp. iptables -A INPUT -m bpf --bytecode `bpfc -f xt_bpf -i fubar` -j LOG</h3>
<p>Compile the source file ''fubar'' into BPF opcodes, bypass basic filter validation and emit opcodes in netfilter's xt_bpf readable format. Note that the source file ''fubar'' is first passed to the C preprocessor for textual replacements before handing over to the bpfc compiler.</p>
<h3>bpfc -</h3>
<p>Read bpfc instruction from stdin and emit opcodes to stdout.</p>
<h3>bpfc foo > bar, resp. netsniff-ng -f bar ...</h3>
<p>Compile filter instructions from file foo and redirect bpfc's output into the file bar, that can then be read by <a href="../man8/netsniff-ng.8.html"><strong>netsniff-ng</strong>(8)</a> through option -f.</p>
<h3>bpfc -f tcpdump -i fubar</h3>
<p>Output opcodes from source file fubar in the same behavior as ''tcpdump -ddd''.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">LEGAL</h2>
        <div class="sectioncontent">
<p>bpfc is licensed under the GNU GPL version 2.0.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">HISTORY</h2>
        <div class="sectioncontent">
<p><strong>bpfc</strong> was originally written for the netsniff-ng toolkit by Daniel Borkmann. It is currently maintained by Tobias Klauser &lt;tklauser@distanz.ch&gt; and Daniel Borkmann &lt;dborkma@tik.ee.ethz.ch&gt;.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO bpfc&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man8/netsniff-ng.8.html"><strong>netsniff-ng</strong>(8)</a>, <a href="../man8/trafgen.8.html"><strong>trafgen</strong>(8)</a>, <a href="../man8/mausezahn.8.html"><strong>mausezahn</strong>(8)</a>, <a href="../man8/ifpps.8.html"><strong>ifpps</strong>(8)</a>, <a href="../man8/flowtop.8.html"><strong>flowtop</strong>(8)</a>, <a href="../man8/astraceroute.8.html"><strong>astraceroute</strong>(8)</a>, <a href="../man8/curvetun.8.html"><strong>curvetun</strong>(8)</a></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Manpage was written by Daniel Borkmann.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COLOPHON</h2>
        <div class="sectioncontent">
<p>This page is part of the Linux netsniff-ng toolkit project. A description of the project, and information about reporting bugs, can be found at http://netsniff-ng.org/.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="booleans.8.html"><span aria-hidden="true">&larr;</span> booleans.8: Policy booleans enable runtime customization of selinux policy</a></li>
   <li class="next"><a href="bridge.8.html">bridge.8: Show / manipulate bridge addresses and devices <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
