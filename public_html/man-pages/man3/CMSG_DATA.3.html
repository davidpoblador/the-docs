<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>cmsg: Access ancillary data</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Access ancillary data">
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">cmsg<small> (3)</small></h1>
        <p class="lead">Access ancillary data</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/">
      <span itemprop="name">Library calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/cmsg.3.html">
      <span itemprop="name">cmsg: Access ancillary data</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/man-pages/">
      <span itemprop="name">man-pages</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/cmsg.3.html">
      <span itemprop="name">cmsg: Access ancillary data</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>#include <sys/socket.h></strong></p><p><strong>struct</strong> <strong>cmsghdr</strong> <strong>*CMSG_FIRSTHDR(struct</strong> <strong>msghdr</strong> <strong>*</strong><em>msgh</em><strong>);</strong></p><p><strong>struct</strong> <strong>cmsghdr</strong> <strong>*CMSG_NXTHDR(struct</strong> <strong>msghdr</strong> <strong>*</strong><em>msgh</em><strong>,</strong> <strong>struct</strong> <strong>cmsghdr</strong> <strong>*</strong><em>cmsg</em><strong>);</strong></p><p><strong>size_t</strong> <strong>CMSG_ALIGN(size_t</strong> <strong></strong><em>length</em><strong>);</strong></p><p><strong>size_t</strong> <strong>CMSG_SPACE(size_t</strong> <strong></strong><em>length</em><strong>);</strong></p><p><strong>size_t</strong> <strong>CMSG_LEN(size_t</strong> <strong></strong><em>length</em><strong>);</strong></p><p><strong>unsigned</strong> <strong>char</strong> <strong>*CMSG_DATA(struct</strong> <strong>cmsghdr</strong> <strong>*</strong><em>cmsg</em><strong>);</strong></p>
<pre>
struct cmsghdr {
    size_t cmsg_len;    /* Data byte count, including header
                           (type is socklen_t in POSIX) */
    int    cmsg_level;  /* Originating protocol */
    int    cmsg_type;   /* Protocol-specific type */
/* followed by
   unsigned char cmsg_data[]; */
};
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>These macros are used to create and access control messages (also called ancillary data) that are not a part of the socket payload. This control information may include the interface the packet was received on, various rarely used header fields, an extended error description, a set of file descriptors or UNIX credentials. For instance, control messages can be used to send additional header fields such as IP options. Ancillary data is sent by calling <a href="../man2/sendmsg.2.html"><strong>sendmsg</strong>(2)</a> and received by calling <a href="../man2/recvmsg.2.html"><strong>recvmsg</strong>(2)</a>. See their manual pages for more information.</p><p>Ancillary data is a sequence of <em>struct cmsghdr</em> structures with appended data. This sequence should be accessed using only the macros described in this manual page and never directly. See the specific protocol man pages for the available control message types. The maximum ancillary buffer size allowed per socket can be set using <em>/proc/sys/net/core/optmem_max</em>; see <a href="../man7/socket.7.html"><strong>socket</strong>(7)</a>.</p><p><strong>CMSG_FIRSTHDR</strong>() returns a pointer to the first <em>cmsghdr</em> in the ancillary data buffer associated with the passed <em>msghdr</em>.</p><p><strong>CMSG_NXTHDR</strong>() returns the next valid <em>cmsghdr</em> after the passed <em>cmsghdr</em>. It returns NULL when there isn't enough space left in the buffer.</p><p><strong>CMSG_ALIGN</strong>(), given a length, returns it including the required alignment. This is a constant expression.</p><p><strong>CMSG_SPACE</strong>() returns the number of bytes an ancillary element with payload of the passed data length occupies. This is a constant expression.</p><p><strong>CMSG_DATA</strong>() returns a pointer to the data portion of a <em>cmsghdr</em>.</p><p><strong>CMSG_LEN</strong>() returns the value to store in the <em>cmsg_len</em> member of the <em>cmsghdr</em> structure, taking into account any necessary alignment. It takes the data length as an argument. This is a constant expression.</p><p>To create ancillary data, first initialize the <em>msg_controllen</em> member of the <em>msghdr</em> with the length of the control message buffer. Use <strong>CMSG_FIRSTHDR</strong>() on the <em>msghdr</em> to get the first control message and <strong>CMSG_NXTHDR</strong>() to get all subsequent ones. In each control message, initialize <em>cmsg_len</em> (with <strong>CMSG_LEN</strong>()), the other <em>cmsghdr</em> header fields, and the data portion using <strong>CMSG_DATA</strong>(). Finally, the <em>msg_controllen</em> field of the <em>msghdr</em> should be set to the sum of the <strong>CMSG_SPACE</strong>() of the length of all control messages in the buffer. For more information on the <em>msghdr</em>, see <a href="../man2/recvmsg.2.html"><strong>recvmsg</strong>(2)</a>.</p><p>When the control message buffer is too short to store all messages, the <strong>MSG_CTRUNC</strong> flag is set in the <em>msg_flags</em> member of the <em>msghdr</em>.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CONFORMING TO</h2>
        <div class="sectioncontent">
<p>This ancillary data model conforms to the POSIX.1g draft, 4.4BSD-Lite, the IPv6 advanced API described in RFC&nbsp;2292 and SUSv2. <strong>CMSG_ALIGN</strong>() is a Linux extension.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">NOTES</h2>
        <div class="sectioncontent">
<p>For portability, ancillary data should be accessed using only the macros described here. <strong>CMSG_ALIGN</strong>() is a Linux extension and should not be used in portable programs.</p><p>In Linux, <strong>CMSG_LEN</strong>(), <strong>CMSG_DATA</strong>(), and <strong>CMSG_ALIGN</strong>() are constant expressions (assuming their argument is constant); this could be used to declare the size of global variables. This may not be portable, however.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLE</h2>
        <div class="sectioncontent">
<p>This code looks for the <strong>IP_TTL</strong> option in a received ancillary buffer:</p>
<pre>
struct msghdr msgh;
struct cmsghdr *cmsg;
int *ttlptr;
int received_ttl;

/* Receive auxiliary data in msgh */

for (cmsg = CMSG_FIRSTHDR(&msgh); cmsg != NULL;
        cmsg = CMSG_NXTHDR(&msgh, cmsg)) {
    if (cmsg-&gt;cmsg_level == IPPROTO_IP
            && cmsg-&gt;cmsg_type == IP_TTL) {
        ttlptr = (int *) CMSG_DATA(cmsg);
        received_ttl = *ttlptr;
        break;
    }
}

if (cmsg == NULL) {
    /* Error: IP_TTL not enabled or small buffer or I/O error */
}
</pre>
<p>The code below passes an array of file descriptors over a UNIX domain socket using <strong>SCM_RIGHTS</strong>:</p>
<pre>
struct msghdr msg = { 0 };
struct cmsghdr *cmsg;
int myfds[NUM_FD];  /* Contains the file descriptors to pass */
int *fdptr;
union {         /* Ancillary data buffer, wrapped in a union
                   in order to ensure it is suitably aligned */
    char buf[CMSG_SPACE(sizeof(myfds))];
    struct cmsghdr align;
} u;

msg.msg_control = u.buf;
msg.msg_controllen = sizeof(u.buf);
cmsg = CMSG_FIRSTHDR(&msg);
cmsg-&gt;cmsg_level = SOL_SOCKET;
cmsg-&gt;cmsg_type = SCM_RIGHTS;
cmsg-&gt;cmsg_len = CMSG_LEN(sizeof(int) * NUM_FD);
fdptr = (int *) CMSG_DATA(cmsg);    /* Initialize the payload */
memcpy(fdptr, myfds, NUM_FD * sizeof(int));
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO cmsg&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man2/recvmsg.2.html"><strong>recvmsg</strong>(2)</a>, <a href="../man2/sendmsg.2.html"><strong>sendmsg</strong>(2)</a></p><p>RFC&nbsp;2292</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="CMSG_ALIGN.3.html"><span aria-hidden="true">&larr;</span> CMSG_ALIGN.3: Access ancillary data</a></li>
   <li class="next"><a href="CMSG_FIRSTHDR.3.html">CMSG_FIRSTHDR.3: Access ancillary data <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
