<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ioctl_fat - manipulating the FAT filesystem</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Manipulating the fat filesystem">
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">ioctl_fat<small> (2)</small></h1>
        <p class="lead">Manipulating the fat filesystem</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man2/">
      <span itemprop="name">System calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man2/ioctl_fat.2.html">
      <span itemprop="name">ioctl_fat</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/man-pages/">
      <span itemprop="name">man-pages</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre><strong>#include &lt;linux/msdos_fs.h&gt;</strong>

<strong>#include &lt;sys/ioctl.h&gt;</strong>

<strong>int ioctl(int </strong><em>fd</em><strong>, FAT_IOCTL_GET_ATTRIBUTES, uint32_t * </strong><em>attr</em><strong>);</strong>
<strong>int ioctl(int </strong><em>fd</em><strong>, FAT_IOCTL_SET_ATTRIBUTES, uint32_t * </strong><em>attr</em><strong>);</strong>
<strong>int ioctl(int </strong><em>fd</em><strong>, FAT_IOCTL_GET_VOLUME_ID, uint32_t * </strong><em>id</em><strong>);</strong>
<strong>int ioctl(int </strong><em>fd</em><strong>, VFAT_IOCTL_READDIR_BOTH,</strong>
<strong>          struct __fat_dirent[2] </strong><em>entry</em><strong>);</strong>
<strong>int ioctl(int </strong><em>fd</em><strong>, VFAT_IOCTL_READDIR_SHORT,</strong>
<strong>          struct __fat_dirent[2] </strong><em>entry</em><strong>);</strong></pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">

<p>The <a href="../man2/ioctl.2.html"><strong>ioctl</strong>(2)</a> system call can be used to read and write metadata of FAT filesystems that are not accessible using other system calls.</p>
  <h3>Reading and setting file attributes</h3>
<p>Files and directories in the FAT filesystem possess an attribute bit mask that can be read with <strong>FAT_IOCTL_GET_ATTRIBUTES</strong> and written with <strong>FAT_IOCTL_SET_ATTRIBUTES</strong>.</p>
<p class='spacer'>

<p>The <em>fd</em> argument contains a file descriptor for a file or directory. It is sufficient to create the file descriptor by calling <a href="../man2/open.2.html"><strong>open</strong>(2)</a> with the <strong>O_RDONLY</strong> flag.</p>
<p class='spacer'>

  <p>The <em>attr</em> argument contains a pointer to a bit mask. The bits of the bit mask are:</p>
  <dl class='dl-vertical'>
    <dt><strong>ATTR_RO</strong></dt>
    <dd>
  <p>This bit specifies that the file or directory is read-only.</p>
    </dd>
    <dt><strong>ATTR_HIDDEN</strong></dt>
    <dd>
  <p>This bit specifies that the file or directory is hidden.</p>
    </dd>
    <dt><strong>ATTR_SYS</strong></dt>
    <dd>
  <p>This bit specifies that the file is a system file.</p>
    </dd>
    <dt><strong>ATTR_VOLUME</strong></dt>
    <dd>
  <p>This bit specifies that the file is a volume label. This attribute is read-only.</p>
    </dd>
    <dt><strong>ATTR_DIR</strong></dt>
    <dd>
  <p>This bit specifies that this is a directory. This attribute is read-only.</p>
    </dd>
    <dt><strong>ATTR_ARCH</strong></dt>
    <dd>
  <p>This bit indicates that this file or directory should be archived. It is set when a file is created or modified. It is reset by an archiving system.</p>
    </dd>
  </dl>
<p class='spacer'>

<p>The zero value <strong>ATTR_NONE</strong> can be used to indicate that no attribute bit is set.</p>
  <h3>Reading the volume label</h3>
<p>FAT filesystems are identified by a volume label. The volume label can be read with <strong>FAT_IOCTL_GET_VOLUME_ID</strong>.</p>
<p class='spacer'>

<p>The <em>fd</em> argument can be a file descriptor for any file or directory of the filesystem. It is sufficient to create the file descriptor by calling <a href="../man2/open.2.html"><strong>open</strong>(2)</a> with the <strong>O_RDONLY</strong> flag.</p>
<p class='spacer'>

<p>The <em>id</em> argument is a pointer to the field that will be filled with the volume ID. Typically the volume label is displayed to the user as a group of two 16-bit fields:</p>
<p class='spacer'>

<pre>printf("Volume ID %04x-%04x&#92;n", id &gt;&gt; 16, id & 0xFFFF);</pre>

  <h3>Reading short file names of a directory</h3>
<p>A file or directory on a FAT filesystem always has a short filename consisting of up to 8 capital letters, optionally followed by a period and up to 3 capital letters for the file extension. If the actual filename does not fit into this scheme, it is stored as a long filename of up to 255 UTF-16 characters.</p>
<p class='spacer'>

<p>The short filenames in a directory can be read with <strong>VFAT_IOCTL_READDIR_SHORT</strong>. <strong>VFAT_IOCTL_READDIR_BOTH</strong> reads both the short and the long filenames.</p>
<p class='spacer'>

<p>The <em>fd</em> argument must be a file descriptor for a directory. It is sufficient to create the file descriptor by calling <a href="../man2/open.2.html"><strong>open</strong>(2)</a> with the <strong>O_RDONLY</strong> flag. The file descriptor can be used only once to iterate over the directory entries by calling <a href="../man2/ioctl.2.html"><strong>ioctl</strong>(2)</a> repeatedly.</p>
<p class='spacer'>

<p>The <em>entry</em> argument is a two-element array of the following structures:</p>
<p class='spacer'>

<pre>struct __fat_dirent {
    long            d_ino;
    __kernel_off_t  d_off;
    uint32_t short  d_reclen;
    char            d_name[256];
};</pre>

<p class='spacer'>

<p>The first entry in the array is for the short filename. The second entry is for the long filename.</p>
<p class='spacer'>

<p>The <em>d_ino</em> and <em>d_off</em> fields are filled only for long filenames. The <em>d_ino</em> field holds the inode number of the directory. The <em>d_off</em> field holds the offset of the file entry in the directory. As these values are not available for short filenames, the user code should simply ignore them.</p>
<p class='spacer'>

<p>The field <em>d_reclen</em> contains the length of the filename in the field <em>d_name</em>. To keep backward compatibility, a length of 0 for the short filename signals that the end of the directory has been reached. However, the preferred method for detecting the end of the directory is to test the <strong>ioctl</strong>() return value. If no long filename exists, field <em>d_reclen</em> is set to 0 and <em>d_name</em> is a character string of length 0 for the long filename.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RETURN VALUE</h2>
        <div class="sectioncontent">

<p>On error, -1 is returned, and <em>errno</em> is set to indicate the error.</p>
<p class='spacer'>

<p>For <strong>VFAT_IOCTL_READDIR_BOTH</strong> and <strong>VFAT_IOCTL_READDIR_SHORT</strong> a return value of 1 signals that a new directory entry has been read and a return value of 0 signals that the end of the directory has been reached.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">ERRORS</h2>
        <div class="sectioncontent">

  <dl class='dl-vertical'>
    <dt><strong>ENOENT</strong></dt>
    <dd>
  <p>This error is returned by <strong>VFAT_IOCTL_READDIR_BOTH</strong> and <strong>VFAT_IOCTL_READDIR_SHORT</strong> if the file descriptor <em>fd</em> refers to a removed, but still open directory.</p>
    </dd>
    <dt><strong>ENOTDIR</strong></dt>
    <dd>
  <p>This error is returned by <strong>VFAT_IOCTL_READDIR_BOTH</strong> and <strong>VFAT_IOCTL_READDIR_SHORT</strong> if the file descriptor <em>fd</em> does not refer to a directory.</p>
    </dd>
    <dt><strong>ENOTTY</strong></dt>
    <dd>
  <p>The file descriptor <em>fd</em> does not refer to an object in a FAT filesystem.</p>
    </dd>
  </dl>
<p class='spacer'>

<p>For further error values, see <a href="../man2/ioctl.2.html"><strong>ioctl</strong>(2)</a>.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">VERSIONS</h2>
        <div class="sectioncontent">

<p><strong>VFAT_IOCTL_READDIR_BOTH</strong> and <strong>VFAT_IOCTL_READDIR_SHORT</strong> first appeared in Linux 2.0.</p>
<p class='spacer'>

<p><strong>FAT_IOCTL_GET_ATTRIBUTES</strong> and <strong>FAT_IOCTL_SET_ATTRIBUTES</strong> first appeared in Linux 2.6.12.</p>
<p class='spacer'>

<p><strong>FAT_IOCTL_GET_VOLUME_ID</strong> was introduced in version 3.11 of the Linux kernel.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CONFORMING TO</h2>
        <div class="sectioncontent">

<p>This API is Linux-specific.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLE</h2>
        <div class="sectioncontent">

  <h3>Toggling the archive flag</h3>
<p>The following program demonstrates the usage of <strong>ioctl</strong>() to manipulate file attributes. The program reads and displays the archive attribute of a file. After inverting the value of the attribute, the program reads and displays the attribute again.</p>
<p class='spacer'>

<p>The following was recorded when applying the program for the file <em>/mnt/user/foo</em>:</p>
<p class='spacer'>

<pre># ./toggle_fat_archive_flag /mnt/user/foo
Archive flag is set
Toggling archive flag
Archive flag is not set</pre>

  <h3>Program source (toggle_fat_archive_flag.c)</h3>
<pre>#include &lt;fcntl.h&gt;
#include &lt;linux/msdos_fs.h&gt;
#include &lt;stdint.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;unistd.h&gt;

/*
 * Read file attributes of a file on a FAT filesystem.
 * Output the state of the archive flag.
 */
static uint32_t
readattr(int fd)
{
    uint32_t attr;
    int ret;

    ret = ioctl(fd, FAT_IOCTL_GET_ATTRIBUTES, &attr);
    if (ret == -1) {
        perror("ioctl");
        exit(EXIT_FAILURE);
    }

    if (attr & ATTR_ARCH)
        printf("Archive flag is set&#92;n");
    else
        printf("Archive flag is not set&#92;n");

    return attr;
}

int
main(int argc, char *argv[])
{
    uint32_t attr;
    int fd;
    int ret;

    if (argc != 2) {
        printf("Usage: %s FILENAME&#92;n", argv[0]);
        exit(EXIT_FAILURE);
    }

    fd = open(argv[1], O_RDONLY);
    if (fd == -1) {
        perror("open");
        exit(EXIT_FAILURE);
    }

    /*
     * Read and display the FAT file attributes.
     */
    attr = readattr(fd);

    /*
     * Invert archive attribute.
     */
    printf("Toggling archive flag&#92;n");
    attr ^= ATTR_ARCH;

    /*
     * Write the changed FAT file attributes.
     */
    ret = ioctl(fd, FAT_IOCTL_SET_ATTRIBUTES, &attr);
    if (ret == -1) {
        perror("ioctl");
        exit(EXIT_FAILURE);
    }

    /*
     * Read and display the FAT file attributes.
     */
    readattr(fd);

    close(fd);

    exit(EXIT_SUCCESS);
}</pre>

  <h3>Reading the volume label</h3>
<p>The following program demonstrates the use of <a href="../man2/ioctl.2.html"><strong>ioctl</strong>(2)</a> to display the volume label of a FAT filesystem.</p>
<p class='spacer'>

<p>The following output was recorded when applying the program for directory <em>/mnt/user</em>:</p>
<p class='spacer'>

<pre>$ ./display_fat_volume_id /mnt/user
Volume ID 6443-6241</pre>

  <h3>Program source (display_fat_volume_id.c)</h3>
<pre>#include &lt;fcntl.h&gt;
#include &lt;linux/msdos_fs.h&gt;
#include &lt;stdint.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;unistd.h&gt;

int
main(int argc, char *argv[])
{
    uint32_t id;
    int fd;
    int ret;

    if (argc != 2) {
        printf("Usage: %s FILENAME&#92;n", argv[0]);
        exit(EXIT_FAILURE);
    }

    fd = open(argv[1], O_RDONLY);
    if (fd == -1) {
        perror("open");
        exit(EXIT_FAILURE);
    }

    /*
     * Read volume ID.
     */
    ret = ioctl(fd, FAT_IOCTL_GET_VOLUME_ID, &id);
    if (ret == -1) {
        perror("ioctl");
        exit(EXIT_FAILURE);
    }

    /*
     * Format the output as two groups of 16 bits each.
     */
    printf("Volume ID %04x-%04x&#92;n", id &gt;&gt; 16, id & 0xFFFF);

    close(fd);

    exit(EXIT_SUCCESS);
}</pre>

  <h3>Listing a directory</h3>
<p>The following program demonstrates the use of <a href="../man2/ioctl.2.html"><strong>ioctl</strong>(2)</a> to list a directory.</p>
<p class='spacer'>

<p>The following was recorded when applying the program to the directory <em>/mnt/user</em>:</p>
<p class='spacer'>

<pre>$ ./fat_dir /mnt/user
&#46; -&gt; ''
&#46;. -&gt; ''
ALONGF~1.TXT -&gt; 'a long filename.txt'
UPPER.TXT -&gt; ''
LOWER.TXT -&gt; 'lower.txt'</pre>

  <h3>Program source</h3>
<pre>#include &lt;fcntl.h&gt;
#include &lt;linux/msdos_fs.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;unistd.h&gt;

int
main(int argc, char *argv[])
{
    struct __fat_dirent entry[2];
    int fd;
    int ret;

    if (argc != 2) {
        printf("Usage: %s DIRECTORY&#92;n", argv[0]);
        exit(EXIT_FAILURE);
    }

    /*
     * Open file descriptor for the directory.
     */
    fd = open(argv[1], O_RDONLY | O_DIRECTORY);
    if (fd == -1) {
        perror("open");
        exit(EXIT_FAILURE);
    }

    for (;;) {

        /*
         * Read next directory entry.
         */
        ret = ioctl( fd, VFAT_IOCTL_READDIR_BOTH, entry);

        /*
         * If an error occurs, the return value is -1.
         * If the end of the directory list has been reached,
         * the return value is 0.
         * For backward compatibility the end of the directory
         * list is also signaled by d_reclen == 0.
         */
        if (ret &lt; 1)
            break;

        /*
         * Write both the short name and the long name.
         */
        printf("%s -&gt; '%s'&#92;n", entry[0].d_name, entry[1].d_name);
    }

    if (ret == -1) {
        perror("VFAT_IOCTL_READDIR_BOTH");
        exit(EXIT_FAILURE);
    }

    /*
     * Close the file descriptor.
     */
    close(fd);

    exit(EXIT_SUCCESS);
}</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SEE ALSO</h2>
        <div class="sectioncontent">

<p><a href="../man2/ioctl.2.html"><strong>ioctl</strong>(2)</a></p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="ioctl.2.html"><span aria-hidden="true">&larr;</span> ioctl.2: control device</a></li>
   <li class="next"><a href="ioctl_ficlone.2.html">ioctl_ficlone.2: share some the data of one file with another file <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
