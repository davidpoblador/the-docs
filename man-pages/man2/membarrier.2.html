<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>membarrier: Issue memory barriers on a set of threads</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Issue memory barriers on a set of threads">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="membarrier (2) manual">
  <meta name="twitter:description" content="Issue memory barriers on a set of threads">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man2/membarrier.2.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="membarrier (2) manual" />
  <meta property="og:description" content="Issue memory barriers on a set of threads" />
  <meta property="fb:app_id" content="1241677679199500" />

</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">membarrier<small> (2)</small></h1>
        <p class="lead">Issue memory barriers on a set of threads</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man2/">
      <span itemprop="name">System calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man2/membarrier.2.html">
      <span itemprop="name">membarrier: Issue memory barriers on a set of threads</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/man-pages/">
      <span itemprop="name">man-pages</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man2/membarrier.2.html">
      <span itemprop="name">membarrier: Issue memory barriers on a set of threads</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>#include &lt;linux/membarrier.h&gt;</strong></p><p><strong>int membarrier(int </strong><em>cmd</em><strong>, int </strong><em>flags</em><strong>);</strong></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>The <strong>membarrier</strong>() system call helps reducing the overhead of the memory barrier instructions required to order memory accesses on multi-core systems. However, this system call is heavier than a memory barrier, so using it effectively is <em>not</em> as simple as replacing memory barriers with this system call, but requires understanding of the details below.</p><p>Use of memory barriers needs to be done taking into account that a memory barrier always needs to be either matched with its memory barrier counterparts, or that the architecture's memory model doesn't require the matching barriers.</p><p>There are cases where one side of the matching barriers (which we will refer to as "fast side") is executed much more often than the other (which we will refer to as "slow side"). This is a prime target for the use of <strong>membarrier</strong>(). The key idea is to replace, for these matching barriers, the fast-side memory barriers by simple compiler barriers, for example:</p>
<pre>
    asm volatile ("" : : : "memory")
</pre>
<p>and replace the slow-side memory barriers by calls to <strong>membarrier</strong>().</p><p>This will add overhead to the slow side, and remove overhead from the fast side, thus resulting in an overall performance increase as long as the slow side is infrequent enough that the overhead of the <strong>membarrier</strong>() calls does not outweigh the performance gain on the fast side.</p><p>The <em>cmd</em> argument is one of the following:</p>
<dl class='dl-vertical'>
  <dt>
    <p><strong>MEMBARRIER_CMD_QUERY</strong></p>
  </dt>
  <dd>
    <p>Query the set of supported commands. The return value of the call is a bit mask of supported commands. <strong>MEMBARRIER_CMD_QUERY</strong>, which has the value 0, is not itself included in this bit mask. This command is always supported (on kernels where <strong>membarrier</strong>() is provided).</p>
  </dd>
  <dt>
    <p><strong>MEMBARRIER_CMD_SHARED</strong></p>
  </dt>
  <dd>
    <p>Ensure that all threads from all processes on the system pass through a state where all memory accesses to user-space addresses match program order between entry to and return from the <strong>membarrier</strong>() system call. All threads on the system are targeted by this command.</p>
  </dd>

</dl>
<p>The <em>flags</em> argument is currently unused and must be specified as 0.</p><p>All memory accesses performed in program order from each targeted thread are guaranteed to be ordered with respect to <strong>membarrier</strong>().</p><p>If we use the semantic <em>barrier()</em> to represent a compiler barrier forcing memory accesses to be performed in program order across the barrier, and <em>smp_mb()</em> to represent explicit memory barriers forcing full memory ordering across the barrier, we have the following ordering table for each pairing of <em>barrier()</em>, <strong>membarrier</strong>() and <em>smp_mb()</em>. The pair ordering is detailed as (O: ordered, X: not ordered):</p>
<pre>
                       barrier()  smp_mb()  membarrier()
       barrier()          X          X          O
       smp_mb()           X          O          O
       membarrier()       O          O          O
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RETURN VALUE</h2>
        <div class="sectioncontent">
<p>On success, the <strong>MEMBARRIER_CMD_QUERY</strong> operation returns a bit mask of supported commands and the <strong>MEMBARRIER_CMD_SHARED</strong> operation returns zero. On error, -1 is returned, and <em>errno</em> is set appropriately.</p><p>For a given command, with <em>flags</em> set to 0, this system call is guaranteed to always return the same value until reboot. Further calls with the same arguments will lead to the same result. Therefore, with <em>flags</em> set to 0, error handling is required only for the first call to <strong>membarrier</strong>().</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">ERRORS</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    <p><strong>EINVAL</strong></p>
  </dt>
  <dd>
    <p><em>cmd</em> is invalid or <em>flags</em> is non-zero.</p>
  </dd>
  <dt>
    <p><strong>ENOSYS</strong></p>
  </dt>
  <dd>
    <p>The <strong>membarrier</strong>() system call is not implemented by this kernel.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">VERSIONS</h2>
        <div class="sectioncontent">
<p>The <strong>membarrier</strong>() system call was added in Linux 4.3.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CONFORMING TO</h2>
        <div class="sectioncontent">
<p><strong>membarrier</strong>() is Linux-specific.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">NOTES</h2>
        <div class="sectioncontent">
<p>A memory barrier instruction is part of the instruction set of architectures with weakly-ordered memory models. It orders memory accesses prior to the barrier and after the barrier with respect to matching barriers on other cores. For instance, a load fence can order loads prior to and following that fence with respect to stores ordered by store fences.</p><p>Program order is the order in which instructions are ordered in the program assembly code.</p><p>Examples where <strong>membarrier</strong>() can be useful include implementations of Read-Copy-Update libraries and garbage collectors.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLE</h2>
        <div class="sectioncontent">
<p>Assuming a multithreaded application where "fast_path()" is executed very frequently, and where "slow_path()" is executed infrequently, the following code (x86) can be transformed using <strong>membarrier</strong>():</p>
<pre>
#include &lt;stdlib.h&gt;

static volatile int a, b;

static void
fast_path(void)
{
    int read_a, read_b;

    read_b = b;
    asm volatile ("mfence" : : : "memory");
    read_a = a;

    /* read_b == 1 implies read_a == 1. */

    if (read_b == 1 && read_a == 0)
        abort();
}

static void
slow_path(void)
{
    a = 1;
    asm volatile ("mfence" : : : "memory");
    b = 1;
}

int
main(int argc, char **argv)
{
    /*
     * Real applications would call fast_path() and slow_path()
     * from different threads. Call those from main() to keep
     * this example short.
     */

    slow_path();
    fast_path();

    exit(EXIT_SUCCESS);
}
</pre>
<p>The code above transformed to use <strong>membarrier</strong>() becomes:</p>
<pre>
#define _GNU_SOURCE
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/syscall.h&gt;
#include &lt;linux/membarrier.h&gt;

static volatile int a, b;

static int
membarrier(int cmd, int flags)
{
    return syscall(__NR_membarrier, cmd, flags);
}

static int
init_membarrier(void)
{
    int ret;

    /* Check that membarrier() is supported. */

    ret = membarrier(MEMBARRIER_CMD_QUERY, 0);
    if (ret &lt; 0) {
        perror("membarrier");
        return -1;
    }

    if (!(ret & MEMBARRIER_CMD_SHARED)) {
        fprintf(stderr,
            "membarrier does not support MEMBARRIER_CMD_SHARED&#92;n");
        return -1;
    }

    return 0;
}

static void
fast_path(void)
{
    int read_a, read_b;

    read_b = b;
    asm volatile ("" : : : "memory");
    read_a = a;

    /* read_b == 1 implies read_a == 1. */

    if (read_b == 1 && read_a == 0)
        abort();
}

static void
slow_path(void)
{
    a = 1;
    membarrier(MEMBARRIER_CMD_SHARED, 0);
    b = 1;
}

int
main(int argc, char **argv)
{
    if (init_membarrier())
        exit(EXIT_FAILURE);

    /*
     * Real applications would call fast_path() and slow_path()
     * from different threads. Call those from main() to keep
     * this example short.
     */

    slow_path();
    fast_path();

    exit(EXIT_SUCCESS);
}
</pre>

        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="mbind.2.html"><span aria-hidden="true">&larr;</span> mbind.2: Set memory policy for a memory range</a></li>
   <li class="next"><a href="memfd_create.2.html">memfd_create.2: Create an anonymous file <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
