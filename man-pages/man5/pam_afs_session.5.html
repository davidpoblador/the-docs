<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>pam_afs_session: Afs pag and token pam module</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Afs pag and token pam module">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="pam_afs_session (5) manual">
  <meta name="twitter:description" content="Afs pag and token pam module">
  <meta name="twitter:image" content="https://www.carta.tech/images/libpam-afs-session-pam_afs_session-5.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man5/pam_afs_session.5.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="pam_afs_session (5) manual" />
  <meta property="og:description" content="Afs pag and token pam module" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libpam-afs-session-pam_afs_session-5.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">pam_afs_session<small> (5)</small></h1>
        <p class="lead">Afs pag and token pam module</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man5/">
      <span itemprop="name">File formats and conventions</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man5/pam_afs_session.5.html">
      <span itemprop="name">pam_afs_session: Afs pag and token pam module</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libpam-afs-session/">
      <span itemprop="name">libpam-afs-session</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man5/pam_afs_session.5.html">
      <span itemprop="name">pam_afs_session: Afs pag and token pam module</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
  auth          optional        pam_afs_session.so
  session       required        pam_afs_session.so
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>The \s-1AFS\s0 session service module for \s-1PAM\s0, typically installed at <em>/lib/security/pam_afs_session.so</em>, establishes new \s-1AFS\s0 sessions and obtains \s-1AFS\s0 tokens when a new session is opened for a user.  It is a shared object that is dynamically loaded by the \s-1PAM\s0 subsystem as necessary, based on the system \s-1PAM\s0 configuration.  \s-1PAM\s0 is a system for plugging in external authentication and session management modules so that each application doesn't have to know the best way to check user authentication or create a user session on that system.  For details on how to configure \s-1PAM\s0 on your system, see the \s-1PAM\s0 man page, often <em>pam</em>\|(7).</p><p>This module provides pam_setcred, pam_open_session, and pam_close_session implementations for \s-1AFS\s0.  Because pam_setcred is part of the auth \s-1PAM\s0 group, it also implements a dummy pam_authenticate that always succeeds (otherwise, it can't provide a pam_setcred).</p><p>Make sure that this module is \s-1NEVER\s0 listed as \*(C`sufficient\*(C' or as the only \*(C`required\*(C' module in the auth group.  Doing so will potentially allow users to log on without any password.  There unfortunately isn't a way to work around this and still provide pam_setcred without running afoul of a bug in (at least) Linux \s-1PAM\s0 0.99.7.1 and probably earlier that causes authentication to fail when the final module in the auth group returns \s-1PAM_IGNORE\s0 and \*(C`[default=done]\*(C' was given as the action.</p><p>Here are the actions of this module:</p>
<dl class='dl-vertical'>
  <dt>
    pam_open_session
  </dt>
  <dd>
    <p>When a new session is opened, this module will first check to see if \s-1AFS\s0 is running on the system.  If not, it will log a message and exit successfully.  If \s-1AFS\s0 is running, it will place the user's session in a new \s-1PAG\s0 (Process Authentication Group, often implemented as supplemental groups, which limits user tokens to only processes in that \s-1PAG\s0).  It will then attempt to obtain tokens, either directly if built with the Heimdal libkafs library and Kerberos support or by running an external <strong>aklog</strong> program.  If \s-1PAG\s0 creation fails, the module will fail; if obtaining tokens fails, the module will log a warning but still return success. The module will only attempt to obtain tokens if the environment variable \s-1KRB5CCNAME\s0 is set in the environment, unless otherwise configured (see the always_aklog option).  It will always create a new \s-1PAG\s0, however.</p>
  </dd>
  <dt>
    pam_close_session
  </dt>
  <dd>
    <p>If and only if pam_open_session successfully obtained \s-1AFS\s0 tokens and \s-1AFS\s0 is still running on the system, pam_close_session will delete the tokens in the current \s-1PAG\s0 (equivalent to running <strong>unlog</strong>).  To leave the tokens after session close, set the retain_after_close option.</p>
  </dd>
  <dt>
    pam_setcred
  </dt>
  <dd>
    <p>When pam_setcred is called with the \s-1PAM_ESTABLISH_CRED\s0 flag, it will do the same as if pam_open_session was called.  When pam_setcred is called with the \s-1PAM_DELETE_CRED\s0 flag, it will do the same as if pam_close_session was called.  When called with the \s-1PAM_REINITIALIZE_CRED\s0 flag or the \s-1PAM_REFRESH_CRED\s0 flag, it won't create a new \s-1PAG\s0 but instead will only attempt to get new tokens (still skipping this unless \s-1KRB5CCNAME\s0 is set in the environment or always_aklog is set).</p>
  </dd>

</dl>
<p>This module is primarily intended for use with a Kerberos v5 authentication module.  It does not itself do any user authentication; it cannot, for instance, be used to authenticate users to a <strong>kaserver</strong>. While it is intended for use with an <strong>aklog</strong> that uses Kerberos v5 ticket caches to obtain tokens, it can be used with any <strong>aklog</strong> implementation (always_aklog may have to be set if no Kerberos v5 ticket cache will be present).</p><p>This module performs no authorization checks and does not hook into password changes; it only implements the session functions and pam_setcred.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CONFIGURATION</h2>
        <div class="sectioncontent">
<p>The \s-1AFS\s0 session \s-1PAM\s0 module supports the following configuration options, which may be set in the \s-1PAM\s0 configuration as arguments listed after \*(C`pam_afs_session.so\*(C' or in the system <em>krb5.conf</em>.</p><p>Some of them take arguments, in which case the argument will be given after \*(C`=\*(C'.  The rest are boolean options.  To set a boolean option in the \s-1PAM\s0 configuration, just give the name of the option in the arguments.  To set an option that takes an argument, follow the option name with an equal sign (\*(C`=\*(C') and the value, with no separating whitespace.  Whitespace in option arguments is not supported in the \s-1PAM\s0 configuration files of most \s-1PAM\s0 implementations.</p><p>To set an option for the \s-1PAM\s0 module in the system <em>krb5.conf</em> file, put that option in the [appdefaults] section.  The \s-1AFS\s0 session \s-1PAM\s0 module will look for options either at the top level of the [appdefaults] section or in a subsection named \*(C`pam-afs-session\*(C' (currently, realm-specific configuration is not checked).  For example, the following fragment of a <em>krb5.conf</em> file would set <em>aklog_homedir</em> to true and <em>minimum_uid</em> to 100.</p><p>    [appdefaults]         aklog_homedir = true         pam-afs-session = {             minimum_uid = 100         }</p><p>There is no difference to the \s-1PAM\s0 module whether options are specified at the top level or in a \*(C`pam-afs-session\*(C' section; the \*(C`pam-afs-session\*(C' section is supported in case there are options that should be set for the \s-1PAM\s0 module but not for other applications.  For more information on the syntax of <em>krb5.conf</em>, see <em>krb5.conf</em>\|(5).</p><p>If the same option is set in <em>krb5.conf</em> and in the \s-1PAM\s0 configuration, the latter takes precedent.  Note, however, that due to the configuration syntax, there's no way to turn off a boolean option in the \s-1PAM\s0 configuration that was turned on in <em>krb5.conf</em>.</p>
<dl class='dl-vertical'>
  <dt>
    afs_cells=<em>cell</em>[,<em>cell</em>...]
  </dt>
  <dd>
    <p>Obtain tokens for the listed cells instead of the default local cell.  If more than one cell is listed, try to obtain tokens for each cell.  If specified in <em>krb5.conf</em>, the cells can be separated by any combination of spaces and commas; if specified in the \s-1PAM\s0 configuration, they must be separated by commas. If the \s-1AFS\s0 session \s-1PAM\s0 module is running an external program, this option is implemented by passing a <strong>-c</strong> flag with the cell as its argument for each listed cell to that program.  If aklog_homedir is also set, the <strong>-c</strong> flags and the <strong>-p</strong> flag will all be passed to the external program.</p>
  </dd>
  <dt>
    aklog_homedir
  </dt>
  <dd>
    <p>Try to obtain the necessary tokens to access the user's home directory. If the libkafs token-obtaining \s-1API\s0 is used, setting this will cause the \s-1AFS\s0 session \s-1PAM\s0 module to pass the user's home directory into that \s-1API\s0 and request that the appropriate tokens be obtained.  If running an external <strong>aklog</strong> program, <strong>aklog</strong> will be called with <strong>-p</strong> <em>home-directory</em> where <em>home-directory</em> is the home directory of the local user for which the session is being opened or refreshed.  This generally will tell <strong>aklog</strong> to check that path, find all \s-1AFS\s0 cells involved in access to that path, and attempt to obtain tokens for each one.  Note that this means that if the user's home directory is not in \s-1AFS\s0, no tokens will be obtained. In either case, the user's home directory is obtained via <em>getpwnam()</em> based on the username \s-1PAM\s0 says we are authenticating.</p>
  </dd>
  <dt>
    always_aklog
  </dt>
  <dd>
    <p>Normally, the \s-1AFS\s0 session \s-1PAM\s0 module only tries to obtain tokens if \s-1KRB5CCNAME\s0 is set in the \s-1PAM\s0 environment.  If this option is set, it will always attempt to obtain tokens.  This is only useful if it is configured to run an external <strong>aklog</strong> program. This can be used if your environment doesn't correctly set \s-1KRB5CCNAME\s0 in the environment for some reason, or if your <strong>aklog</strong> doesn't rely on a Kerberos ticket cache to obtain tokens (or can find the cache on its own via some other means).</p>
  </dd>
  <dt>
    debug
  </dt>
  <dd>
    <p>If this option is set, additional trace information will be logged to syslog with priority \s-1LOG_DEBUG\s0.</p>
  </dd>
  <dt>
    ignore_root
  </dt>
  <dd>
    <p>If this option is set, the \s-1AFS\s0 session \s-1PAM\s0 module won't take any action (and will exit successfully) if the account for which the session is being established is named \*(C`root\*(C'.</p>
  </dd>
  <dt>
    kdestroy
  </dt>
  <dd>
    <p>If this option is set and the \s-1AFS\s0 session \s-1PAM\s0 module was built with Kerberos support, the user's ticket cache will be destroyed after tokens are obtained successfully.  If tokens are not obtained successfully, the ticket cache will be left intact.  Please note that this is not properly a security feature, since the ticket cache will still be written to disk between the time the Kerberos \s-1PAM\s0 module authenticates the user and the time the \s-1AFS\s0 session \s-1PAM\s0 module is run.  It can, however, be used to reduce the window during which Kerberos ticket caches are lying about if the only use one has for ticket caches is to obtain \s-1AFS\s0 tokens.</p>
  </dd>
  <dt>
    minimum_uid=<em>uid</em>
  </dt>
  <dd>
    <p>If this option is set, the \s-1AFS\s0 session \s-1PAM\s0 module won't take any action (and will exit successfully) if the account for which the session is being established has a \s-1UID\s0 lower than <em>uid</em>.</p>
  </dd>
  <dt>
    nopag
  </dt>
  <dd>
    <p>If this option is set, no \s-1PAG\s0 will be created.  Be careful when using this option, since it means that the user will inherit a \s-1PAG\s0 from the process managing the login.  If <strong>sshd</strong>, for instance, is started in a \s-1PAG\s0, every user who logs in via ssh will be put in the same \s-1PAG\s0 and will share tokens if this option is used. This is the default on Mac \s-1OS\s0 X, where PAGs are not supported.</p>
  </dd>
  <dt>
    notokens
  </dt>
  <dd>
    <p>If this option is set, the \s-1AFS\s0 session \s-1PAM\s0 module will only create a \s-1PAG\s0 and not attempt to obtain tokens.  Setting this option overrides all other settings related to acquiring tokens, including always_aklog.  If both nopag and notokens are set, the module essentially does nothing. Setting notokens also implies retain_after_close, meaning that the \s-1AFS\s0 session \s-1PAM\s0 module will also not attempt to delete tokens when the user's session ends.</p>
  </dd>
  <dt>
    program=<em>path</em>
  </dt>
  <dd>
    <p>The path to the <strong>aklog</strong> program to run.  Setting this option tells the \s-1AFS\s0 session \s-1PAM\s0 module to always run an external program to obtain tokens and never use the libkafs interface, even if the latter is available. You may pass options to this program by separating them with commas (or spaces or tabs in <em>krb5.conf</em> or if the configuration syntax of your \s-1PAM\s0 configuration allows this).  For example, the setting:     program=/usr/bin/aklog,-noprdb,-524 will run \*(C`/usr/bin/aklog -noprdb -524\*(C' as the program to obtain tokens. The arguments are passed directly, not parsed by the shell. If this option is not set, the default behavior is to call the libkafs function to obtain tokens, if available, and otherwise to use a default path to <strong>aklog</strong> determined at compile time (the first <strong>aklog</strong> found on the compiler's path by default).  If no <strong>aklog</strong> could be found at compile time and libkafs isn't used, this option must be set.</p>
  </dd>
  <dt>
    retain_after_close
  </dt>
  <dd>
    <p>If this option is set, pam_close_session will do nothing (successfully) rather than deleting tokens.  This will allow programs started in the user's \s-1PAG\s0 that are still running when the log out to continue to use the user's tokens until they expire.  Normally, the \s-1AFS\s0 kernel module will automatically clean up tokens once every process in that \s-1PAG\s0 has terminated.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">ENVIRONMENT</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    \s-1KRB5CCNAME\s0
  </dt>
  <dd>
    <p>This module looks for \s-1KRB5CCNAME\s0 in the \s-1PAM\s0 environment and by default does not run <strong>aklog</strong> if it is not set.</p>
  </dd>

</dl>
<p>The entire \s-1PAM\s0 environment is passed to <strong>aklog</strong> as its environment (rather than the environment of the process running the \s-1PAM\s0 functions).</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">WARNINGS</h2>
        <div class="sectioncontent">
<p>As mentioned above, this module implements a dummy pam_authenticate function so that it can provide a pam_setcred function.  Never list this module as \*(C`sufficient\*(C' or as the only \*(C`required\*(C' module or you may allow users to log on without a password.</p><p>While spawning an external <strong>aklog</strong> program, the \s-1AFS\s0 session \s-1PAM\s0 module resets the \s-1SIGCHLD\s0 signal handler to the default handler while the program runs and then restores it afterward.  This is done to avoid having aklog interfere with process handling in the calling application, but it means that there's a race condition that can cause children to be incorrectly handled if they exit while aklog is running.  There is unfortunately no good solution to this other than building against Heimdal and using the libkafs interface to obtain tokens instead of an external program.</p><p>To detect whether \s-1AFS\s0 is running on the system, the \s-1AFS\s0 session \s-1PAM\s0 module temporarily sets a \s-1SIGSYS\s0 handler before attempting an \s-1AFS\s0 system call. That handler may also modify a static variable.  Neither of these should ideally be done in a \s-1PAM\s0 module, but there is no other good way of checking for the non-existence of a system call that doesn't crash the application on some operating systems.  The \s-1PAM\s0 module will attempt to restore the previous \s-1SIGSYS\s0 handler, if any, after the test is done, and the static variable is used in such a way that running it from multiple threads shouldn't be an issue, but be aware that the \s-1PAM\s0 module is doing this behind the back of the application and may interfere with unusual \s-1SIGSYS\s0 handlers or similar application actions.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">NOTES</h2>
        <div class="sectioncontent">
<p>When using the libkafs interface to obtain tokens, be sure that it is configured properly for the type of \s-1AFS\s0 tokens expected at your site.  As of Heimdal 0.7, the default behavior is to contact the krb524 service to translate Kerberos v5 tickets into Kerberos v4 tickets to use as tokens. \s-1AFS\s0 cells running current server software no longer need this, and if your site doesn't run the krb524 service, this may break token acquisition.</p><p>Sites running \s-1AFS\s0 servers that understand Kerberos-v5-derived tokens should add configuration like:</p><p>    libkafs = {         EXAMPLE.ORG = {             afs-use-524 = no         }     }</p><p>to the [appdefaults] section of their <em>krb5.conf</em> files to disable use of the krb524 service.  See the Heimdal <em>kafs</em>\|(3) man page for more information.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO pam_afs_session&hellip;</h2>
        <div class="sectioncontent">
<p><em>aklog</em>\|(1), <em>kafs</em>\|(3), <em>pam</em>\|(7), <em>syslog</em>\|(3), <em>unlog</em>\|(1)</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="pam_abl.conf.5.html"><span aria-hidden="true">&larr;</span> pam_abl.conf.5: Configuration file for pam_abl pam module.</a></li>
   <li class="next"><a href="pam_env.conf.5.html">pam_env.conf.5: The environment variables config file <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
