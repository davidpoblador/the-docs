<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>shorewall-nesting: Shorewall nested zones</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Shorewall nested zones">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="shorewall-nesting (5) manual">
  <meta name="twitter:description" content="Shorewall nested zones">
  <meta name="twitter:image" content="https://www.carta.tech/images/shorewall-shorewall-nesting-5.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man5/shorewall-nesting.5.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="shorewall-nesting (5) manual" />
  <meta property="og:description" content="Shorewall nested zones" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/shorewall-shorewall-nesting-5.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">shorewall-nesting<small> (5)</small></h1>
        <p class="lead">Shorewall nested zones</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man5/">
      <span itemprop="name">File formats and conventions</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man5/shorewall-nesting.5.html">
      <span itemprop="name">shorewall-nesting: Shorewall nested zones</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/shorewall/">
      <span itemprop="name">shorewall</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man5/shorewall-nesting.5.html">
      <span itemprop="name">shorewall-nesting: Shorewall nested zones</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><em>child-zone</em>[:<em>parent-zone</em>[,<em>parent-zone</em>]...]</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>In \m[blue]<strong>shorewall-zones</strong>\m[]\s-2\u[1]\d\s+2(5), a zone may be declared to be a sub-zone of one or more other zones using the above syntax. The <em>child-zone</em> may be neither the firewall zone nor a vserver zone. The firewall zone may not appear as a parent zone, although all vserver zones are handled as sub-zones of the firewall zone.</p><p>Where zones are nested, the CONTINUE policy in \m[blue]<strong>shorewall-policy</strong>\m[]\s-2\u[2]\d\s+2(5) allows hosts that are within multiple zones to be managed under the rules of all of these zones.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLE</h2>
        <div class="sectioncontent">
<p>/etc/shorewall/zones:</p>
<pre>
        #ZONE    TYPE        OPTION
        fw       firewall
        net      ipv4
        sam:net  ipv4
        loc      ipv4
</pre>
<p>/etc/shorewall/interfaces:</p>
<pre>
        #ZONE     INTERFACE     BROADCAST     OPTIONS
        -         eth0          detect        dhcp,norfc1918
        loc       eth1          detect
</pre>
<p>/etc/shorewall/hosts:</p>
<pre>
        #ZONE     HOST(S)                     OPTIONS
        net       eth0:0.0.0.0/0
        sam       eth0:206.191.149.197
</pre>
<p>/etc/shorewall/policy:</p>
<pre>
        #SOURCE      DEST        POLICY       LOG LEVEL
        loc          net         ACCEPT
        sam          all         CONTINUE
        net          all         DROP         info
        all          all         REJECT       info
</pre>
<p>The second entry above says that when Sam is the client, connection requests should first be processed under rules where the source zone is sam and if there is no match then the connection request should be treated under rules where the source zone is net. It is important that this policy be listed BEFORE the next policy (net to all). You can have this policy generated for you automatically by using the IMPLICIT_CONTINUE option in \m[blue]<strong>shorewall.conf</strong>\m[]\s-2\u[3]\d\s+2(5).</p><p>Partial /etc/shorewall/rules:</p>
<pre>
        #ACTION   SOURCE    DEST            PROTO    DEST PORT(S)
        ...
        DNAT      sam       loc:192.168.1.3 tcp      ssh
        DNAT      net       loc:192.168.1.5 tcp      www
        ...
</pre>
<p>Given these two rules, Sam can connect to the firewall&apos;s internet interface with ssh and the connection request will be forwarded to 192.168.1.3. Like all hosts in the net zone, Sam can connect to the firewall&apos;s internet interface on TCP port 80 and the connection request will be forwarded to 192.168.1.5. The order of the rules is not significant. Sometimes it is necessary to suppress port forwarding for a sub-zone. For example, suppose that all hosts can SSH to the firewall and be forwarded to 192.168.1.5 EXCEPT Sam. When Sam connects to the firewall&apos;s external IP, he should be connected to the firewall itself. Because of the way that Netfilter is constructed, this requires two rules as follows:</p>
<pre>
        #ACTION   SOURCE    DEST            PROTO    DEST PORT(S)
        ...
        ACCEPT+   sam       $FW             tcp      ssh
        DNAT      net       loc:192.168.1.3 tcp      ssh
        ...
</pre>
<p>The first rule allows Sam SSH access to the firewall. The second rule says that any clients from the net zone with the exception of those in the &ldquo;sam&rdquo; zone should have their connection port forwarded to 192.168.1.3. If you need to exclude more than one zone, simply use multiple ACCEPT+ rules. This technique also may be used when the ACTION is REDIRECT.</p><p>Care must be taken when nesting occurs as a result of the use of wildcard interfaces (interface names ends in &apos;+&apos;).</p><p>Here&apos;s an example. /etc/shorewall/zones:</p><p>/etc/shorewall/interfaces:</p>
<pre>
        #ZONE    INTERFACE      BROADCAST        OPTIONS
        net      ppp0
        loc      eth1
        loc      ppp+
        dmz      eth2
</pre>
<p>Because the net zone is declared before the loc zone, net is an implicit sub-zone of loc and in the absence of a net-&gt;... CONTINUE policy, traffic from the net zone will not be passed through loc-&gt;... rules. But DNAT and REDIRECT rules are an exception!</p><p>DNAT and REDIRECT rules generate two Netfilter rules: a &apos;nat&apos; table rule that rewrites the destination IP address and/or port number, and a &apos;filter&apos; table rule that ACCEPTs the rewritten connection.</p><p>Policies only affect the &apos;filter&apos; table.</p><p>As a consequence, the following rules will have unexpected behavior:</p>
<pre>
        #ACTION     SOURCE               DEST      PROTO        DEST
        #                                                       PORT(S)
        ACCEPT      net                  dmz       tcp          80
        REDIRECT    loc                  3128      tcp          80
</pre>
<p>The second rule is intended to redirect local web requests to a proxy running on the firewall and listening on TCP port 3128. But the &apos;nat&apos; part of that rule will cause all connection requests for TCP port 80 arriving on interface ppp+ (including ppp0!) to have their destination port rewritten to 3128. Hence, the web server running in the DMZ will be inaccessible from the web.</p><p>The above problem can be corrected in several ways.</p><p>The preferred way is to use the <strong>ifname</strong> pppd option to change the &apos;net&apos; interface to something other than ppp0. That way, it won&apos;t match ppp+.</p><p>If you are running Shorewall version 4.1.4 or later, a second way is to simply make the nested zones explicit:</p>
<pre>
        #ZONE    TYPE        OPTION
        fw       firewall
        loc      ipv4
        net:loc  ipv4
        dmz      ipv4
</pre>
<p>If you take this approach, be sure to set IMPLICIT_CONTINUE=No in shorewall.conf.</p><p>When using other Shorewall versions, another way is to rewrite the DNAT rule (assume that the local zone is entirely within 192.168.2.0/23):</p>
<pre>
        #ACTION     SOURCE                 DEST      PROTO      DEST
        #                                                       PORT(S)
        ACCEPT      net                    dmz       tcp        80
        REDIRECT    loc:192.168.2.0/23     3128      tcp        80
</pre>
<p>Another way is to restrict the definition of the loc zone:</p><p>/etc/shorewall/interfaces:</p>
<pre>
        #ZONE    INTERFACE      BROADCAST        OPTIONS
        net      ppp0
        loc      eth1
        -        ppp+
        dmz      eth2
</pre>
<p>/etc/shorewall/hosts:</p>
<pre>
        #ZONE    HOST(S)             OPTIONS
        loc      ppp+:192.168.2.0/23
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">FILES</h2>
        <div class="sectioncontent">
<p>/etc/shorewall/zones</p><p>/etc/shorewall/interfaces</p><p>/etc/shorewall/hosts</p><p>/etc/shorewall/policy</p><p>/etc/shorewall/rules</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO shorewall-nesting&hellip;</h2>
        <div class="sectioncontent">
<p><strong>shorewall</strong>(8), <a href="../man5/shorewall-accounting.5.html"><strong>shorewall-accounting</strong>(5)</a>, <a href="../man5/shorewall-actions.5.html"><strong>shorewall-actions</strong>(5)</a>, <a href="../man5/shorewall-blacklist.5.html"><strong>shorewall-blacklist</strong>(5)</a>, <a href="../man5/shorewall-hosts.5.html"><strong>shorewall-hosts</strong>(5)</a>, <strong>shorewall_interfaces</strong>(5), <a href="../man5/shorewall-ipsets.5.html"><strong>shorewall-ipsets</strong>(5)</a>, <a href="../man5/shorewall-maclist.5.html"><strong>shorewall-maclist</strong>(5)</a>, <a href="../man5/shorewall-masq.5.html"><strong>shorewall-masq</strong>(5)</a>, <a href="../man5/shorewall-nat.5.html"><strong>shorewall-nat</strong>(5)</a>, <a href="../man5/shorewall-netmap.5.html"><strong>shorewall-netmap</strong>(5)</a>, <a href="../man5/shorewall-params.5.html"><strong>shorewall-params</strong>(5)</a>, <a href="../man5/shorewall-policy.5.html"><strong>shorewall-policy</strong>(5)</a>, <a href="../man5/shorewall-providers.5.html"><strong>shorewall-providers</strong>(5)</a>, <a href="../man5/shorewall-proxyarp.5.html"><strong>shorewall-proxyarp</strong>(5)</a>, <a href="../man5/shorewall-rtrules.5.html"><strong>shorewall-rtrules</strong>(5)</a>, <a href="../man5/shorewall-routestopped.5.html"><strong>shorewall-routestopped</strong>(5)</a>, <a href="../man5/shorewall-rules.5.html"><strong>shorewall-rules</strong>(5)</a>, <strong>shorewall.conf</strong>(5), <a href="../man5/shorewall-secmarks.5.html"><strong>shorewall-secmarks</strong>(5)</a>, <a href="../man5/shorewall-tcclasses.5.html"><strong>shorewall-tcclasses</strong>(5)</a>, <a href="../man5/shorewall-tcdevices.5.html"><strong>shorewall-tcdevices</strong>(5)</a>, <a href="../man5/shorewall-mangle.5.html"><strong>shorewall-mangle</strong>(5)</a>, <a href="../man5/shorewall-tos.5.html"><strong>shorewall-tos</strong>(5)</a>, <a href="../man5/shorewall-tunnels.5.html"><strong>shorewall-tunnels</strong>(5)</a>, <a href="../man5/shorewall-zones.5.html"><strong>shorewall-zones</strong>(5)</a></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">NOTES</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
     1.
  </dt>
  <dd>
    <p>shorewall-zones</p><p>http://www.shorewall.net/manpages/shorewall-zones.html</p>
  </dd>
  <dt>
     2.
  </dt>
  <dd>
    <p>shorewall-policy</p><p>http://www.shorewall.net/manpages/shorewall-policy.html</p>
  </dd>
  <dt>
     3.
  </dt>
  <dd>
    <p>shorewall.conf</p><p>http://www.shorewall.net/manpages/shorewall.conf.html</p>
  </dd>

</dl>

        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="shorewall-nat.5.html"><span aria-hidden="true">&larr;</span> shorewall-nat.5: Shorewall one-to-one nat file</a></li>
   <li class="next"><a href="shorewall-netmap.5.html">shorewall-netmap.5: Shorewall netmap definition file <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
