<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>maildroprc: Maildrops filtering language</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Maildrops filtering language">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="maildroprc (5) manual">
  <meta name="twitter:description" content="Maildrops filtering language">
  <meta name="twitter:image" content="https://www.carta.tech/images/maildrop-maildroprc-5.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man5/maildroprc.5.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="maildroprc (5) manual" />
  <meta property="og:description" content="Maildrops filtering language" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/maildrop-maildroprc-5.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">maildroprc<small> (5)</small></h1>
        <p class="lead">Maildrops filtering language</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man5/">
      <span itemprop="name">File formats and conventions</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man5/maildroprc.5.html">
      <span itemprop="name">maildroprc: Maildrops filtering language</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/maildrop/">
      <span itemprop="name">maildrop</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man5/maildroprc.5.html">
      <span itemprop="name">maildroprc: Maildrops filtering language</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p>/etc/maildroprc, $HOME/.mailfilter, $HOME/.mailfilters/*, and friends...</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>This manual page describes the language used by <strong>maildrop</strong> to filter E-mail messages. The mail filtering instructions are read from a file. The language is loosely structured, it is based on pattern matching. The language has a distinct lexical and syntactical structure, very similar to Perl&apos;s, but it is important to note that it is not Perl, and is very different from Perl, in certain cases.</p><p>If the filtering instructions do not exist, <strong>maildrop</strong> delivers the message to the default mailbox without doing any additional processing, making it indistinguishable from the usual mail delivery agent.</p><p>It is important to note that <strong>maildrop</strong> reads and parses the filter file before doing anything. If there are any errors <strong>maildrop</strong> prints an error message, and terminates with the exit code set to <strong>EX_TEMPFAIL</strong>. A compliant mail transport agent should re-queue the message for a later delivery attempt. Hopefully, most simple syntax errors will not cause mail to be bounced back if the error is caught and fixed quickly.</p><h3>Environment</h3>
<p><strong>maildrop</strong> uses variables to access and manipulate messages. Variables are arbitrary text accessed by referring to the name of the variable, such as <em>HOME</em>, or <em>DEFAULT</em>. Text is placed into a variable by using an assignment statement, such as:</p>
<pre>
FILE="IN.junk"
</pre>
<p>This statement puts the text "IN.junk" (without the quotes) into a variable whose name is <em>FILE</em>. Later, the contents of a variable are accessed by using the $ symbol and the name for the variable. For example:</p>
<pre>
to $FILE
</pre>
<p>This will deliver the current message to the mailbox file (or a maildir directory) named "IN.junk".</p><p><strong>maildrop</strong> initially creates variables from the environment variables of the operating system, UNLESS <strong>maildrop</strong> runs in delivery mode. Each operating system environment variable becomes a <strong>maildrop</strong> variable. When running in delivery mode, <strong>maildrop</strong> does not import the environment for security reasons, except for the environment variables that define the process locale (<em>LANG</em>, <em>LANGUAGE</em>, and <em>LC_</em><em></em><em>*</em>), which are still imported.</p><p>In all cases <strong>maildrop</strong> resets the following variables to their default values: <em>HOME</em>, <em>DEFAULT</em>, <em>SHELL</em>, <em>PATH</em>, <em>LOCKEXT</em>, <em>LOCKREFRESH</em>, <em>LOCKSLEEP</em>, <em>LOCKTIMEOUT</em>, <em>MAILDIRQUOTA</em>, <em>SENDMAIL</em> and <em>LOGNAME</em>.</p><p>There&apos;s one exception to this rule which applies to the version of <strong>maildrop</strong> that comes with the \m[blue]<strong>Courier mail server</strong>\m[]\s-2\u[1]\d\s+2. The following does not apply to the standalone version of <strong>maildrop</strong>: when running in delivery mode, if the <strong>-d</strong> flag was not used, or if it specifies the same userid as the one that&apos;s running <strong>maildrop</strong>: the following variables are automatically imported from the environment: <em>HOME</em>, <em>SHELL</em>, <em>LOGNAME</em> and <em>MAILDIRQUOTA</em>. These environment variables are initialized by the Courier mail server prior to running <strong>maildrop</strong>. Additionally, the initial value for the <em>DEFAULT</em> maildrop variable is imported from the <em>MAILDROPDEFAULT</em> environment variable. This is because the Courier mail server overloads the DEFAULT environment variable to store the defaulted portion of the local mailbox address. See the \m[blue]<strong></strong><a href="../man5/dot-courier.5.html"><strong>dot-courier</strong>(5)</a>\m[]\s-2\u[2]\d\s+2 man page in the Courier mail server distribution. You can get the Courier mail server&apos;s <em>DEFAULT</em> value by using the <strong>import</strong> command. Note, however, that this will clobber the old contents of <em>DEFAULT</em>, which is probably not what you want. The right way to do this would be something like this:</p>
<pre>
SAVEDEFAULT=$DEFAULT
import DEFAULT
LOCALDEFAULT=$DEFAULT
DEFAULT=$SAVEDEFAULT
</pre>
<p>All internal variables are exported back as environment variables when <strong>maildrop</strong> runs an external command. Changes to internal variables, made by the filter file, are reflected in the exported environment.</p>
<h3>Lexical structure</h3>
<p>Most whitespace is generally ignored. The # character introduces a comment running to the end of the line, which is also ignored. Unlike other mail filters, <strong>maildrop</strong> parses the filter file before taking any action with the message. If there are syntax errors in the file, <strong>maildrop</strong> displays an error message, and returns <strong>EX_TEMPFAIL</strong>. That should cause the mail message to remain in the queue, and, hopefully allow the problem to be corrected, without bouncing any mail.</p><p><strong>Note</strong></p><p>In <strong>maildrop</strong>, the end of line is a lexical token. In order to continue a long statement on the next line, terminate the line with a backslash character.</p>
<h3>Literal text</h3>
<p>Literal text in the <strong>maildrop</strong> filtering language is surrounded by either single or double quotes. In order to enter a single quote into a text literal surrounded by single quotes, or a double quote into a literal surrounded by double quotes, prefix it with a backslash character. Use two backslash characters characters to enter one backslash character in the text literal.</p><p><strong>Note</strong></p><p>A backslash followed by either a backslash, or a matching quote, is the only situation where the backslash character is actually removed, leaving only the following character in the actual text literal. If a backslash character is followed by any other character, the backslash is NOT removed.</p><p>Multiple text literals in a row are automatically concatenated, even if they use different quotes. For example:</p>
<pre>
FOOBAR="Foo"&apos;bar&apos;
SAVEDEFAULT=$DEFAULT
import DEFAULT
LOCALDEFAULT=$DEFAULT
DEFAULT=$SAVEDEFAULT
</pre>
<p>This sets the variable <em>FOOBAR</em> to the text "Foobar".</p>
<h3>Variable substitution</h3>
<p>Variable substitution is performed on text literals that&apos;s surrounded by double quotation marks. The "$" character, followed by a variable name, is replaced by that variable&apos;s contents.</p>
<pre>
MAILBOX="$HOME/Mailbox"
</pre>
<p>This sets the variable <em>MAILBOX</em> to the contents of the variable <em>HOME</em> followed by "/Mailbox". Variable names must begin with an uppercase letter, a lowercase letter, or an underscore. Following that, all letters, digits, and underscores are taken as a variable name, and its contents replace the $ sign, and the variable name. It is possible to access variables whose name includes other characters, by using braces as follows:</p>
<pre>
MAILBOX="${HOME-WORD}/Mailbox"
</pre>
<p>Inserts the contents of the <em>HOME-WORD</em> variable. If the variable does not exist, the empty text literal is used to replace the variable name. It is not possible to access variables whose names include the } character.</p><p>If the $ character is not followed by a left brace, letter, or an underscore, the $ character remains unmolested in the text literal. A backslash followed by the $ character results in a $ character in the text literal, without doing any variable substitution.</p><p>Variable substitution is not done in text literals which are surrounded by single quotes (apostrophes).</p>
<h3>Command line arguments</h3>
<p><strong>maildrop</strong> initializes special variables: <em>$1</em>, <em>$2</em>, and so on, with additional parameters specified on the <strong>maildrop</strong> command line. A filter file may use those variables just like any other variables.</p>
<h3>Predefined variables</h3>
<p>The following variables are automatically defined by <strong>maildrop</strong>. The default values for the following variables may be changed by the system administrator. For security reasons, the values of the following variables are always reset to their default values, and are never imported from the environment:</p><p><em>DEFAULT</em></p><p>The default mailbox to deliver the message to. If the filter file does not indicate a mailbox to deliver this message to, the message is delivered to this mailbox. The default mailbox is defined by the system administrator.</p><p><em>FROM</em></p><p>Message envelope sender. This is usually the same address as what appears in the From: header, but may not be. This information may or may not be available to <strong>maildrop</strong> on your system. The message envelope sender is usually specified with the <strong>-f</strong> option to <strong>maildrop</strong>. If the <strong>-f</strong> option is not given, <strong>maildrop</strong> looks for the Return-Path: header in the message. As the last resort, FROM defaults to &ldquo;MAILER-DAEMON&rdquo;. Note that <em>FROM</em> may be empty - the message envelope sender is empty for bounce messages.</p><p><em>HOME</em></p><p>Home directory of the user running <strong>maildrop</strong>.</p><p><em>HOSTNAME</em></p><p>Network name of the machine running maildrop. Obtained from <strong>gethostname</strong>(3).</p><p><em>LOCKEXT</em></p><p>Extension for dot-lock files (default: .lock).</p><p><em>LOCKREFRESH</em></p><p>Refresh interval, in seconds, for dot-locks (default: 15). When <strong>maildrop</strong> dot-locks a mailbox, <strong>maildrop</strong> tries to refresh the lock periodically in order to keep other programs from removing a stale dot-lock. This is only required if a dot-lock exists for a prolonged period of time, which should be discouraged anyway.</p><p><em>LOCKSLEEP</em></p><p>Number of seconds to wait to try again to create a dot-lock file, if one already exists (default: 5).</p><p><em>LOCKTIMEOUT</em></p><p>Number of seconds to wait before removing a stale dot-lock file (default: 60). If a dot-lock file still exists after <em>LOCKTIMEOUT</em> seconds, <strong>maildrop</strong> assumes that the process holding the lock no longer exists, and the dot-lock file can be safely removed. After removing the dot-lock file, <strong>maildrop</strong> waits <em>LOCKSLEEP</em> seconds before trying to create its own dot-lock file, in order to avoid a race condition with another process which is also trying to remove the same stale dot-lock, at the same time.</p><p><em>LOGNAME</em></p><p>Name of the user to who the message is being delivered.</p><p><em>MAILDROP_OLD_REGEXP</em></p><p>Revert to using the old legacy pattern matching engine. Versions of <strong>maildrop</strong> prior to version 2.0 (included in the Courier mail server 0.51, and earlier), used a built-in pattern matching engine, instead of using the PCRE library (see the &ldquo;Patterns&rdquo; section). <strong>maildrop</strong> 1.x used a different syntax for patterns, which is no longer described in this manual page. The old pattern matching engine is still available, by setting <em>MAILDROP_OLD_REGEXP</em> to &ldquo;1&rdquo;. Setting this variable will use the legacy pattern matching engine for the rest of the <strong>maildrop</strong> recipe file.</p><p>The pattern matching engine will be removed completely in a future version of maildrop. This setting provides for a transitional period of converting old recipes. <em>MAILDROP_OLD_REGEXP</em> can be set to &ldquo;1&rdquo; in the global maildroprc file, then reset to &ldquo;0&rdquo; in each individual <strong>maildrop</strong> recipe file, after it gets converted to the new syntax.</p><p><em>MAILFILTER</em></p><p>This is the name of the original filter file that was given to <strong>maildrop</strong> on the command line. This is mostly useful to -defaultfilter files, it allows them to obtain the \m[blue]<strong>value of the -M option</strong>\m[]\s-2\u[3]\d\s+2 specified on the command line.</p><p><em>PATH</em></p><p>Command execution path. <strong>maildrop</strong> resets PATH to the system default (usually /bin:/usr/bin:/usr/local/bin).</p><p><em>SENDMAIL</em></p><p>The mail delivery agent. When <strong>maildrop</strong> is instructed to deliver the message to a mailbox whose name begins with the ! character, this is interpreted as a request to forward the message. The <em>SENDMAIL</em> command is executed to forward the message.</p><p><em>SHELL</em></p><p>The login shell. The shell is used to execute all commands invoked by <strong>maildrop</strong>.</p><p><em>VERBOSE</em></p><p>Current Debug level (default: 0). Setting <em>VERBOSE</em> to progressive higher values, between 1 and 9, produces debugging output on standard error. <strong>maildrop</strong> ignores the <em>VERBOSE</em> variable in delivery mode (in order not to confuse the mail transport agent).</p><p><em>UMASK</em></p><p>The file creation mode mask, in octal. The default setting of 077 creates mailboxes that are readable and writable by the owner only. Use 007 to create mailboxes that are readable/writable by both owner and the group. Use 037 to create mailboxes that are readable by both owner and group, but writable by owner only. Permissions on existing mailboxes are not changed, this setting affects only new mailboxes. When delivering to maildirs this setting sets the permissions on new messages only. Access permissions on messages in maildirs are also affected by the permissions on the maildir directories.</p>
<h3>Other special variables</h3>
<p>The following variables are automatically used by <strong>maildrop</strong> when the filter file is being processed:</p><p><em>EXITCODE</em></p><p>Return code for <strong>maildrop</strong>. When <strong>maildrop</strong> successfully delivers a message, it terminates with this exit code, which defaults to 0. When the <strong>to</strong> or the <strong>cc</strong> command is used to deliver the message to an external process, via a pipe, <strong>maildrop</strong> will set this variable to the exit code of the external process. Since <strong>maildrop</strong> immediately terminates after completing the <strong>to</strong> command this means that <strong>maildrop</strong>&apos;s exit code will be the exit code of the external process. If the <strong>to</strong> command does not deliver the message to a process you must set <em>EXITCODE</em> before the <strong>to</strong> command, since <strong>maildrop</strong> terminates immediately after finishing the delivery.</p><p><em>KEYWORDS</em></p><p>The <em>KEYWORDS</em> variable is used only when delivering a message to a maildir, and implements the optional IMAP keyword extension as implemented in the \m[blue]<strong>Courier IMAP server</strong>\m[]\s-2\u[1]\d\s+2. It may be optionally initialized to contain a comma-separate list of keywords. The <strong>to</strong>, or the <strong>cc</strong> command, delivers the message to the maildir normally, but also associated the list of keywords in <em>KEYWORDS</em> with the newly delivered message.</p><p><em>KEYWORDS</em> must be set before the message is delivered to a maildir. The contents of <em>KEYWORDS</em> are ignored, when delivering on an mbox folder.</p><p><em>LINES</em></p><p>Number of lines in the current message. Note that this may be an approximation. It may or may not take into account the -A option. Use this as criteria for filtering, nothing more.</p><p><em>MAILDIRQUOTA</em></p><p>Set this variable in order to manually enforce a maximum size on ANY maildir where the message is delivered. This is an optional feature that must be enabled by the system administrator, see \m[blue]<strong></strong><strong>maildirquota</strong>(8)\m[]\s-2\u[4]\d\s+2 for more information.</p><p><em>RETURNCODE</em></p><p>This variable is set when <strong>maildrop</strong> runs the \m[blue]<strong>xfilter</strong>\m[]\s-2\u[5]\d\s+2 command, or a command that&apos;s specified within a pair of backtick characters ( command substitution ). The <em>RETURNCODE</em> variable will be set to the exit code of the command, after it completes.</p><p><em>SIZE</em></p><p>Number of bytes in the message. This may or may not include the -A option. Use this as a criteria for filtering, nothing more.</p>
<h3>Unquoted text</h3>
<p>All text strings in filter files should be in single, or double quotes. However, for convenience sake, quotes can be omitted under certain circumstances.</p><p>Text that includes ONLY letters, digits, and the following characters: _-.:/${}@ may appear without quotes. Note that this does not allow spaces, or backslashes to be entered, however the text is still variable-substituted, and the substituted text may contain other characters.</p><p>Also, note that patterns (see below) begin with the slash character. Normally, anything that begins with the slash is interpreted as a pattern. However, text immediately after &ldquo;VARIABLE=&rdquo; is interpreted as a string even if it begins with a slash. This is why something like:</p>
<pre>
MAILDIR=/var/mail
</pre>
<p>works as expected. Using quotes, though, is highly recommended. You must use quotes to set a variable to a lone slash, because an unquoted slash is interpreted as a division sign.</p><p>Long double or singly-quoted text can be broken across multiple lines by ending the line with a lone backslash character, like this:</p>
<pre>
TEXT="This is a long &#92;
 text string"
</pre>
<p>The backslash, the newline, and all leading whitespace on the next line is removed, resulting in "This is a long text string".</p>
<h3>Command substitution</h3>
<p>Text enclosed in back-tick characters is interpreted as a shell command. The shell command is executed as a child process by <strong>maildrop</strong>. Its output is used in place of the command. For example:</p>
<pre>
DIR=`ls`
</pre>
<p>places the names of the files in the current directory into the DIR variable.</p><p>The output of the command will have all newline characters replaced by spaces, and leading and trailing spaces will be stripped (multiple spaces are not removed, though). Also, the contents of the message being delivered is made available to the command on standard input.</p>
<h3>Patterns</h3>
<p>The pattern syntax in <strong>maildrop</strong> is similar to the <strong>grep</strong> command&apos;s syntax, with some minor differences. A pattern takes the following form in the filter file:</p>
<pre>
/<em>pattern</em>/:<em>options</em>
</pre>
<p><em>pattern</em> specifies the text to look for in the message, in the UTF-8 codeset. <em>pattern</em> must not begin with a space, otherwise the leading slash will then be interpreted as a division sign. If you must search for text that starts with a space, use something like "/[ ] ... /".</p><p>The general syntax of <strong>maildrop</strong>&apos;s patterns is described in the <a href="../man3/pcrepattern.3.html"><strong>pcrepattern</strong>(3)</a> manual page, with certain exceptions noted below. <strong>maildrop</strong> uses the \m[blue]<strong>PCRE</strong>\m[]\s-2\u[6]\d\s+2 library to implement pattern matching. Not all features in PCRE are available in <strong>maildrop</strong>, and the &ldquo;options&rdquo; part, which follows the pattern specification, changes the pattern matching further. Consult the <a href="../man3/pcrepattern.3.html"><strong>pcrepattern</strong>(3)</a> manual page for more information, but note the following exceptions:</p><p>Internal options settings are not supported (but see the &ldquo;D&rdquo; maildrop option, below). Do not include option settings in the <em>pattern</em>, doing so will lead to undefined results.</p><p>Named subpatterns are not implemented. Numbered subpatterns are implemented, see &ldquo;Pattern Match Results&rdquo;, below.</p>
<h3>Pattern options</h3>
<p>Following /<em>pattern</em>/, there may be an optional colon, followed by one. or more options. The following options may be specified in any order:</p><p>h</p><p>Match this pattern against the message header.</p><p>b</p><p>Match this pattern against the message body.</p><p>D</p><p>This is a case sensitive match. Normally the patterns match either uppercase or lowercase text. /john/ will match "John", "john", or "JOHN". Specify the D option for a case-sensitive search: lowercase letters in the pattern must match lowercase letters in the message; ditto for uppercase.</p><p>If neither &apos;h&apos; or &apos;b&apos; is specified, the pattern is matched against the header only. Specifying the &apos;b&apos; option causes the pattern to be matched against the message body. Specifying both causes the pattern to be matched against the entire message.</p><p>Normally, each line in the message gets matched against the pattern individually. When applying patterns to a header, multi-line headers (headers split on several lines by beginning each continuation line with whitespace) are silently combined into a single line, before the pattern is applied.</p>
<h3>MIME encoding</h3>
<p>The pattern must be a valid text string in the UTF-8 codeset, and <strong>maildrop</strong> should handle messages that use MIME encodings in other known character sets. Options that specify a message header search result in <strong>maildrop</strong> searching the initial message headers, and any headers of additional MIME sections, in a multipart MIME message. Options that specify a message body search will search through all "text" MIME content.</p><p>For a MIME search to succeed, the message must be a well-formed MIME message (with a Mime-Version: 1.0 header).</p>
<h3>Weighted scoring</h3>
<p>Patterns are evaluated by <strong>maildrop</strong> as any other numerical expression. If a pattern is found, <strong>maildrop</strong>&apos;s filter interprets the results of the pattern match as number 1, or true, for filtering purposes. If a pattern is not found the results of the pattern search is zero. Once a pattern is found, the search stops. Second, and subsequent occurrences of the same pattern are NOT searched for.</p><p><strong>maildrop</strong> can also do weighted scoring. In weighted scoring, multiple occurrences of the same pattern are used to calculate a numerical score.</p><p>To use a weighted search, specify the pattern as follows:</p>
<pre>
/<em>pattern</em>/:<em>options</em>,<em>xxx</em>,<em>yyy</em>
</pre>
<p>where <em>xxx</em> and <em>yyy</em> are two numbers. <em>yyy</em> is optional -- it will default to 1, if missing.</p><p>The first occurrence of the pattern is evaluated as xxx. The second occurrence of the pattern is evaluated as xxx*yyy, the third as xxx*yyy*yyy, etc... All occurrences of the pattern are added up to calculate the final score.</p><p><strong>Note</strong></p><p><strong>maildrop</strong> does not recognize multiple occurrences of the same pattern in the same line. Multiple occurences of the same pattern in one line count as one occurence.</p>
<h3>Pattern Match Results</h3>
<p>After a pattern is successfully matched, the actual text that is matched is placed in the <em>MATCH</em> variable. For example:</p>
<pre>
/^From:.*/
</pre>
<p>matches a line of the form:</p><p>From: postmaster@localhost 	  .PP Here the variable <em>MATCH</em> will be set to "From: postmaster@localhost", which can be used in subsequent statements.</p><p>If the pattern contains subpatterns, the portions of the text that match the first subpattern is placed in the <em>MATCH1</em> variable. The second subpattern, if any, is placed in <em>MATCH2</em>, and so on:</p>
<pre>
/^From:&#92;s+(.*)@(.*)/
</pre>
<p>matched against the same line will set <em>MATCH</em> to &ldquo;From: postmaster@localhost&rdquo;, <em>MATCH1</em> to &ldquo;postmaster&rdquo;, and <em>MATCH2</em> to &ldquo;localhost&rdquo;. Of course, in real world the &ldquo;From:&rdquo; header is usually much more complicated, and can&apos;t be handled that easily. This is just an illustrative example.</p><p><strong>Note</strong></p><p>Subpatterns are not processed in the foreach statement.</p>
<h3>Conversion of maildrop 1.x patterns to 2.0</h3>
<p>Although the new PCRE-based pattern matching code in <strong>maildrop</strong> is completely different from the built-in pattern matching code in <strong>maildrop</strong> 1.x, very few changes will be required to convert recipes to the new syntax. The only major differences are:</p><p>The subexpression format has changed. Any pattern that uses subexpression needs to be converted. Additionally, references to <em>MATCH2</em> must be replaced with <em>MATCH1</em>, <em>MATCH3</em> to <em>MATCH2</em>, and so on. References to plain old <em>MATCH</em> will remain the same.</p><p>The &ldquo;w&rdquo; pattern option is no longer possible, with PCRE. The very few recipes that use this option, if any actually exist, will have to be rewritten in some other fashion.</p>
<h3>Expressions</h3>
<p>Although <strong>maildrop</strong> evaluates expressions numerically, results of expressions are stored as text literals. When necessary, text literals are converted to numbers, then the results of a mathematical operation is converted back into a text literal.</p><p><strong>Operators</strong></p><p>The following operators carry their usual meaning, and are listed in order from lowest precedence, to the highest:</p>
<pre>
||
&&
&lt;  &lt;=  &gt;  &gt;=  ==  !=  lt  le  gt  ge  eq  ne
|
&
+  -
*  /
=~ /<em>pattern</em>/
/<em>pattern</em>/  !  ~  <em>function()</em>

</pre>
<p><strong>Variable assignment</strong></p>
<pre>
VARIABLE=<em>expression</em>
</pre>
<p>Assigns the result of the expression to <em>VARIABLE</em> (note no leading $ in front of variable).</p><p><strong>Note</strong></p><p>If <em>VARIABLE</em> is NOT surrounded by quotes, then it may contain only letters, numbers, underscores, dashes, and a selected few other characters. In order to initialize a variable whose name contains non-standard punctuation marks, surround the name of the variable with quotes.</p><p><strong>cc - deliver a copy of the message</strong></p>
<pre>
cc <em>expression</em>
</pre>
<p>The <strong>cc</strong> statement is very similar to the <strong>to</strong> statement, except that after delivering the message <strong>maildrop</strong> continues to process the filter file, unlike the <strong>to</strong> statement which immediately terminates <strong>maildrop</strong> after the delivery is complete. Essentially, the message is carbon copied to the given mailbox, and may be delivered again to another mailbox by another <strong>cc</strong> or <strong>to</strong> statement.</p><p>\m[blue]<strong>See the </strong><strong>to</strong> statement\m[]\s-2\u[7]\d\s+2 for more details. When <strong>cc</strong> is used to deliver a message to a process <strong>maildrop</strong> will set the <em>EXITCODE</em> variable to the process&apos;s exit code.</p><p><strong>dotlock - create a manual dot-lock</strong></p>
<pre>
dotlock <em>expression</em> {

      ...

}
</pre>
<p><strong>maildrop</strong> automatically creates a lock when a message is delivered to a mailbox. Depending upon your system configuration, <strong>maildrop</strong> will use either dot-locks, or the flock() system call.</p><p>The <strong>dotlock</strong> statement creates an explicit dot-lock file. Use the \m[blue]<strong></strong><strong>flock</strong> statement\m[]\s-2\u[8]\d\s+2 to create an explicit flock() lock.</p><p>The <em>expression</em> is a filename that should be used as a lock file. <strong>maildrop</strong> creates the indicated dot-lock, executes the filtering instructions contained within the { ... } block, and removes the lock. The expression <em>must</em> be the name of the dot-lock file itself, <em>NOT</em> the name of the mailbox file you want to lock.</p><p><strong>Note</strong></p><p>With manual locking, it is possible to deadlock multiple <strong>maildrop</strong> processes (or any other processes that try to claim the same locks).</p><p>No deadlock detection is possible with dot-locks, and since <strong>maildrop</strong> automatically refreshes all of its dot-locks regularly, they will never go stale. You&apos;ll have <strong>maildrop</strong> processes hanging in limbo, until their watchdog timers go off, aborting the mail delivery.</p><p><strong>echo - output diagnostic information</strong></p>
<pre>
echo <em>expression</em>
</pre>
<p><strong>maildrop</strong> will print the given text. This is usually used when <strong>maildrop</strong> runs in embedded mode, but can be used for debugging purposes. Normally, a newline is printed after the text. If text is terminated with a &#92;c, no newline will be printed.</p><p><strong>exception - trap fatal errors</strong></p>
<pre>
exception {

   ...

}
</pre>
<p>The <strong>exception</strong> statement traps errors that would normally cause <strong>maildrop</strong> to terminate. If a fatal error is encountered anywhere within the block of statements enclosed by the <strong>exception</strong> clause, execution will resume immediately following the <strong>exception</strong> clause.</p><p><strong>exit - terminate filtering unconditionally</strong></p>
<pre>
exit
</pre>
<p>The <strong>exit</strong> statement immediately terminates filtering. <strong>maildrop</strong>&apos;s return code is set to the value of the <em>EXITCODE</em> variable. Normally, <strong>maildrop</strong> terminates immediately after \m[blue]<strong>successfully delivering the message</strong>\m[]\s-2\u[7]\d\s+2 to a mailbox. The <strong>exit</strong> statement causes <strong>maildrop</strong> to terminate without delivering the message anywhere.</p><p>The <strong>exit</strong> statement is usually used when <strong>maildrop</strong> runs in \m[blue]<strong>embedded mode</strong>\m[]\s-2\u[9]\d\s+2, when message delivery instructions are not allowed.</p><p><strong>flock - create an manual flock() lock</strong></p>
<pre>
flock <em>expression</em> {

      ...

}
</pre>
<p><strong>maildrop</strong> automatically creates a lock when a message is delivered to a mailbox. Depending upon your system configuration, <strong>maildrop</strong> will use either dot-locks, or the flock() system call.</p><p>The <strong>flock</strong> statement creates a manual flock() lock. Use the \m[blue]<strong></strong><strong>dotlock</strong> statement\m[]\s-2\u[10]\d\s+2 to create a manual dot-lock file.</p><p>The <em>expression</em> is the name of the file that should be locked. <strong>maildrop</strong> creates the lock on the indicated file, executes the filtering instructions contained within the { ... } block, and removes the lock.</p><p><strong>Note</strong></p><p>With manual locking, it is possible to deadlock multiple <strong>maildrop</strong> processes (or any other processes that try to claim the same locks). The operating system will automatically break flock() deadlocks. When that happens, one of the <strong>maildrop</strong> processes will terminate immediately. Use the <strong>exception</strong> statement in order to trap this exception condition, and execute an alternative set of filtering instructions.</p><p><strong>foreach - iterate over text sections matched by a pattern</strong></p>
<pre>
foreach /pattern/:options
{
    ...
}

foreach (expression) =~ /pattern/:options
{
    ...
}
</pre>
<p>The <strong>foreach</strong> statement executes a block of statements for each occurrence of the given pattern in the given message, or expression. On every iteration <em>MATCH</em> variable will be set to the matched string. All the usual options may be applied to the pattern match, EXCEPT the following:</p><p>,xxx,yyy</p><p>Weighted scoring is meaningless, in this context.</p><p>( ... )</p><p>Subpatterns are not processed. Only the <em>MATCH</em> variable will be set for each found pattern.</p><p><strong>if - conditional execution</strong></p>
<pre>
if (<em>expression</em>)
{
    ...
}
else
{
    ...
}
</pre>
<p>Conditional execution. If <em>expression</em> evaluates to a logical true (note - parenthesis are required) then the first set of statements is executed. The <strong>else</strong> keyword, and the subsequent statements, are optional. If present, and the expression evaluates to a logical false, the <strong>else</strong> part is executed.</p><p><strong>maildrop</strong> evaluates all expression as text strings. In the context of a logical expression, an empty string, or the number 0 constitutes a logical false value, anything else is a logical true value.</p><p>If the <strong>if</strong> part, or the <strong>else</strong> part consists of only one statement, the braces may be omitted.</p><p><strong>Note</strong></p><p>The grammar of this <strong>if</strong> statement is stricter than usual. If you get baffling syntax errors from <strong>maildrop</strong>, make sure that the braces, and the if statement, appear on separate lines. Specifically: the closing parenthesis, the closing braces, and the else statement, must be at the end of the line (comments are allowed), and there may not be any blank lines in between (not even ones containing comments only).</p><p>If the <strong>else</strong> part contains a single <strong>if</strong>, and nothing else, this may be combined into an <strong>elsif</strong>:</p>
<pre>
if (<em>expression</em>)
{
    ...
}
elsif (<em>expression</em>)
{
    ...
}
</pre>
<p>The above example is logically identical to:</p>
<pre>
if (<em>expression</em>)
{
    ...
}
else
{
    if (<em>expression</em>)
    {
        ...
    }
}
</pre>
<p>Consecutive <strong>elsif</strong> sequences are allowed:</p>
<pre>
if (<em>expression</em>)
{
    ...
}
elsif (<em>expression</em>)
{
    ...
}
elsif (<em>expression</em>)
{
    ...
}
</pre>
<p>Consecutive occurences of <strong>elsif</strong> commands eliminate a significant amount of indentation, and the resulting code is more readable.</p><p><strong>import - access original environment variable</strong></p>
<pre>
import <em>variable</em>
</pre>
<p>When <strong>maildrop</strong> starts, it normally imports the contents of the environment variables, and assigns them to internal <strong>maildrop</strong> variables. For example, if there was an environment variable <em>FOO</em>, the internal <strong>maildrop</strong> variable <em>FOO</em> will have the contents of the environment variable. From then on, <em>FOO</em> will be no different than any other variable, and when <strong>maildrop</strong> runs an external command, the contents of <strong>maildrop</strong>&apos;s variables will be exported as the environment for the command.</p><p>Certain variables, like <em>HOME</em> and <em>PATH</em>, are always reset to fixed defaults, for security reasons. Also, in delivery and embedded modes, the environment is not imported at all (with the exception of system locale environment variables), and <strong>maildrop</strong> starts with only the fixed default variables.</p><p>The <strong>import</strong> statement initializes the specified variable with the contents of the original environment variable when <strong>maildrop</strong> started. For example:</p>
<pre>
echo "PATH is $PATH"
PATH="/bin"
echo "PATH is $PATH"
import PATH
echo "PATH is $PATH"
exit
</pre>
<p>This results in the following output:</p>
<pre>
PATH is /bin:/usr/bin:/usr/local/bin
PATH is /bin
PATH is /home/root/bin:/sbin:/usr/sbin:/bin:/usr/bin:/usr/local/bin
</pre>
<p>This shows that when <strong>maildrop</strong> starts <em>PATH</em> is set to the fixed default of /bin:/usr/bin:/usr/local/bin. However, the original contents of the <em>PATH</em> environment variable we different, and the <strong>import</strong> statement shows what it was.</p><p><strong>include - execute filtering instructions from another file</strong></p>
<pre>
include <em>expression</em>
</pre>
<p>The include statement reads a file, and executes filtering instructions contained in that file. Note that the include statement is processed when the current filter file is being executed. When <strong>maildrop</strong> reads the initial filter file, any syntax errors in the filtering instructions are immediately reported, and <strong>maildrop</strong> will terminate with a return code of <strong>EX_TEMPFAIL</strong>. Any errors in files specified by <strong>include</strong> statements are NOT reported, because those files will not be read until the <strong>include</strong> statement is itself executed.</p><p>If the specified file does not exist, or if there are any syntax errors in the file, <strong>maildrop</strong> reports the error, and terminates with a return code of <strong>EX_TEMPFAIL</strong>.</p><p><strong>log, logfile - log message deliveries</strong></p>
<pre>
logfile <em>expression</em>

log <em>expression</em>
</pre>
<p>Logging in <strong>maildrop</strong> is normally turned off. The <strong>logfile</strong> statement specifies the file where <strong>maildrop</strong> will log how the message has been disposed of. The parameter is then name of the file. If the file exists <strong>maildrop</strong> appends to the file.</p><p>For each delivery (the \m[blue]<strong></strong><strong>to</strong>\m[]\s-2\u[7]\d\s+2 and \m[blue]<strong></strong><strong>cc</strong>\m[]\s-2\u[11]\d\s+2 statements, and default deliveries) <strong>maildrop</strong> records the From: and the Subject: fields, together with the current time, in the log file.</p><p>The <strong>log</strong> statement adds additional logging text to the log file. The <strong>log</strong> statement works exactly like the <strong>echo</strong> statement, except that the text is written to the logfile, instead of standard output.</p><p><strong>to - deliver message to a mailbox</strong></p>
<pre>
to <em>expression</em>
</pre>
<p>The <strong>to</strong> statement delivers the message to a mailbox. <em>expression</em> must evaluate to a valid mailbox. A valid mailbox is either a mailbox file, a maildir, or an external program (which includes forwarding to another address).</p><p>The <strong>to</strong> statement is the final delivery statement. <strong>maildrop</strong> delivers message, then immediately terminates, with its return code set to the <em>EXITCODE</em> variable. If there was an error while delivering the message, <strong>maildrop</strong> terminates with the <strong>EX_TEMPFAIL</strong> exit code. A properly-written mail transport agent should re-queue the message, and re-attempt delivery at some later time.</p><p>An <em>expression</em> that begins with the "|" character specifies an external program to run to handle the actual delivery. The <em>SHELL</em> variable specifies the shell to execute the given command. The message is provided to the command on standard input. <strong>maildrop</strong>&apos;s exit code will be the process&apos;s exit code.</p><p>An <em>expression</em> that begins with an exclamation mark, "!" specifies a whitespace-delimited list of E-mail addresses to forward the message to. The program specified by the <em>SENDMAIL</em> variable is run as an external program, with the list of E-mail addresses provided as parameters to the program.</p><p>Otherwise, <em>expression</em> names the mailbox where <strong>maildrop</strong> delivers the message. If <em>expression</em> is a directory, <strong>maildrop</strong> assumes that the directory is a maildir directory. Otherwise, <strong>maildrop</strong> will deliver the message to a file, formatted in traditional mailbox format. <strong>maildrop</strong> will use either dot-locking, or flock()-locking when delivering the message to the file.</p><p><strong>while - repeatedly execute a block of statements</strong></p>
<pre>
while (<em>expression</em>)
{
    ...
}
</pre>
<p>The <em>expression</em> is repeatedly evaluated. Each time it \m[blue]<strong>evaluates to a logical true</strong>\m[]\s-2\u[12]\d\s+2, the statements inside the braces are executed. When <em>expression</em> evaluates to a logical false, the while loop is over. Take care to avoid infinite loops.</p><p><strong>xfilter - filter message through another program</strong></p>
<pre>
xfilter <em>expression</em>
</pre>
<p><em>expression</em> specifies an external program that <strong>maildrop</strong> runs to filter the current message. The current message will be piped to the filter program as standard input. The output of the filter program replaces the current message being delivered. The external program must terminate with an exit code of 0. If the external program does not terminate with an exit code of 0, or if it does not read the message from the standard input, <strong>maildrop</strong> terminates with an exit code of <strong>EX_TEMPFAIL</strong>.</p><p><strong>|| - logical or</strong></p>
<pre>
<em>expression1</em> || <em>expression2</em>

</pre>
<p>If <em>expression1</em> evaluates to a logical true, the result of the || is <em>expression1</em>, otherwise it&apos;s <em>expression2</em>, which is evaluated.</p><p><strong>maildrop</strong> uses the following concept of true/false: an empty text literal, or a text literal that consists of the single character "0" is a logical false value. Anything else is a logical true value.</p><p><strong>&& - logical and</strong></p>
<pre>
<em>expression1</em> && <em>expression2</em>

</pre>
<p>If <em>expression1</em> evaluates to a logical false, the result of the && is <em>expression1</em>, otherwise it&apos;s <em>expression2</em>, which is evaluated.</p><p><strong>maildrop</strong> uses the following concept of true/false: an empty text literal, or a text literal that consists of the single character "0" is a logical false value. Anything else is a logical true value.</p><p><strong>&lt;, &lt;=, &gt;, &gt;=, ==, != - numerical comparison</strong></p>
<pre>
<em>expression1</em> &lt; <em>expression2</em>

<em>expression1</em> &lt;= <em>expression2</em>

<em>expression1</em> &gt; <em>expression2</em>

<em>expression1</em> &gt;= <em>expression2</em>

<em>expression1</em> == <em>expression2</em>

<em>expression1</em> != <em>expression2</em>

</pre>
<p>These operators compare their left hand side expression against their right hand side. These operators compare the numerical values of each side, as floating point numbers. If the numbers compare as indicated, the result of the comparison is the text string "1", otherwise it is the text string 0.</p><p><strong>Note</strong></p><p>Ccomparisons are not associative: "a &lt; b &lt; c" is an error. If it is absolutely necessary, use "(a &lt; b) &lt; c".</p><p><strong>lt, le, gt, ge, eq, ne - text comparison</strong></p>
<pre>
<em>expression1</em> lt <em>expression2</em>

<em>expression1</em> le <em>expression2</em>

<em>expression1</em> gt <em>expression2</em>

<em>expression1</em> ge <em>expression2</em>

<em>expression1</em> eq <em>expression2</em>

<em>expression1</em> ne <em>expression2</em>

</pre>
<p>These operators compare their left hand side expression against their right hand side. These operators compare each side as text strings (alphabetically, although the text may include anything). If the text strings compare as indicated, the result of the comparison is the text string "1", otherwise it is the text string 0.</p><p><strong>Note</strong></p><p>Comparisons are not associative: "a lt b lt c" is an error. If it is absolutely necessary, use "(a lt b) lt c". (But why would you?).</p><p><strong>| - bitwise or</strong></p>
<pre>
<em>expression1</em> | <em>expression2</em>
</pre>
<p>This is the bitwise or operator. Its result is a 32 bit integer, which is a bitwise-or combination of the left hand side and the right hand side.</p><p><strong>& - bitwise and</strong></p>
<pre>
<em>expression1</em> & <em>expression2</em>
</pre>
<p>This is the bitwise and operator. Its result is a 32 bit integer, which is a bitwise-and combination of the left hand side and the right hand side.</p><p><strong>+, -, *, / - numerical operations</strong></p>
<pre>
<em>expression1</em> + <em>expression2</em>

<em>expression1</em> - <em>expression2</em>

<em>expression1</em> * <em>expression2</em>

<em>expression1</em> / <em>expression2</em>

</pre>
<p>These are numerical, floating point, operators.</p><p><strong>=~ /pattern/:options - pattern match against string</strong></p>
<pre>
<em>expression</em> =~ /<em>pattern</em>/:<em>option</em>
</pre>
<p>The left hand side of the =~ operator can be any expression. The right hand side is always a pattern specification. The result of the operator is the weighted match of the pattern against <em>expression</em> (if the options do not specify weighted scoring, the result is simply 1 if the pattern was found, 0 if not).</p><p>See "\m[blue]<strong>Patterns</strong>\m[]\s-2\u[13]\d\s+2" for more information.</p><p><strong>/pattern/:options - pattern match against message</strong></p>
<pre>
/<em>pattern</em>/:<em>option</em>
</pre>
<p>The result of this operator is the weighted match of the pattern against the current message (if the options do not specify weighted scoring, the result is simply 1 if the pattern was found, 0 if not).</p><p>See "\m[blue]<strong>Patterns</strong>\m[]\s-2\u[13]\d\s+2" for more information.</p><p><strong>!, ~ - logical/bitwise not operator.</strong></p>
<pre>
! <em>expression</em>

~ <em>expression</em>
</pre>
<p>The result of the ! operator is a logical opposite of its right hand side expression. If the right hand side expression evaluated to a logical true, the result is a logical false. If it evaluated to a logical false, the result is a logical true.</p><p><strong>maildrop</strong> uses the following concept of true/false: an empty text literal, or a text literal that consists of the single character "0" is a logical false value. Anything else is a logical true value.</p><p>The result of the ~ operator is a bitwise complement of its right hand side expression. The right hand side expression is evaluated as a 32 bit integer, and the result of this operator is a bitwise complement of the result.</p><p><strong>escape(string) - escape special characters in a string.</strong></p>
<pre>
<strong>escape</strong>(<em>expression</em>)
</pre>
<p>The <strong>escape</strong> function returns its sole argument with every occurrence of a special character prefixed by a backslash. A special character is any of the following characters:</p>
<pre>
|!$()[]&#92;+*?.&;`&apos;-~&lt;&gt;^{}"
</pre>
<p>This can used when \m[blue]<strong>matching pattern sections</strong>\m[]\s-2\u[14]\d\s+2, and then taking one section and matching it again. For example:</p>
<pre>
if ( /^From:&#92;s*(.*)/ )
{
     MATCH1=escape($MATCH1)
     if ( /^Subject:.*$MATCH1/ )
     {
        ...
     }
}
</pre>
<p>This example checks if the contents of the From: header can also be found in the Subject: header. If the <strong>escape</strong> function were not used, then any special characters in the From: header that are also used in regular expressions, such as * or +, would introduce unpredictable behavior, most likely a syntax error.</p><p>The reason why this list of special characters also includes characters not used in <strong>maildrop</strong>&apos;s regular expressions is to allow <strong>maildrop</strong>&apos;s variables to be used on the command line of a shell command executed by the <strong>xfilter</strong> command, backtick characters, or <strong>to</strong> or <strong>cc</strong> commands.</p><p>Although using data from an external data source is dangerous, and it may result in inadvertent exploits, using the escape function should hopefully result in fewer surprises.</p><p><strong>gdbmopen, gdbmclose, gdbmfetch, gdbmstore - GDBM support in maildrop</strong></p><p>These functions provide support for GDBM database files. See \m[blue]<strong></strong><strong>maildropgdbm</strong>(5)\m[]\s-2\u[15]\d\s+2 for more information.</p><p><strong>Note</strong></p><p>The system administrator can disable GDBM support in <strong>maildrop</strong>, so these commands may not be available to you.</p><p><strong>getaddr(string) - extract RFC 2822 addresses from a header.</strong></p>
<pre>
if ( /^From:&#92;s*(.*)/ )
{
     ADDR=getaddr($MATCH1)
}
</pre>
<p>This function is usually applied to a header that contains \m[blue]<strong>RFC 2822</strong>\m[]\s-2\u[16]\d\s+2 addresses. It extracts the actual addresses from the header, without any comments or extraneous punctuation. Each address is followed by a newline character. For example, if <em>string</em> contains:</p>
<pre>
joe@domain.com (Joe Brown), "Alex Smith" &lt;alex@domain.com&gt;, tom@domain.com
</pre>
<p>The result of the <strong>getaddr</strong> function is the following string:</p>
<pre>
joe@domain.com&lt;NL&gt;alex@domain.com&lt;NL&gt;tom@domain.com&lt;NL&gt;
</pre>
<p><strong>Note</strong></p><p>Because <strong>getaddr</strong>() interprets \m[blue]<strong>RFC 2822</strong>\m[]\s-2\u[17]\d\s+2 loosely, it is not necessary to strip off the "To:" or the "Cc:" header from the string, before feeding it to <strong>getaddr()</strong>. For example, the following snippet of code takes all addresses in the message, and concatenates them into a single string, separated by spaces:</p>
<pre>
ADDRLIST=""
foreach /^(To|Cc): .*/
{
    foreach (getaddr $MATCH) =~ /.+/
    {
       ADDRLIST="$ADDRLIST $MATCH"
    }
}
</pre>
<p><strong>Note</strong></p><p>In certain rare situations, \m[blue]<strong>RFC 2822</strong>\m[]\s-2\u[17]\d\s+2 allows spaces to be included in E-mail addresses, so this example is just educational.</p><p><strong>hasaddr(string) - Search for an address.</strong></p>
<pre>
if ( hasaddr(<em>string</em>) )
{
   ...
}
</pre>
<p>"<em>string</em>" is of the form user@domain. The hasaddr function returns 1 if this address is included in any To:, Cc:,Resent-To:, or Resent-Cc:, header in the message, otherwise this function returns 0.</p><p>This is more than just a simple text search. Each header is parsed according to RFC822. Addresses found in the header are extracted, ignoring all comments and names. The remaining addresses are checked, and if "<em>string</em>" is one of them, <strong>hasaddr</strong> returns 1, otherwise it returns 0.</p><p>The comparison is case-insensitive. This actually violates RFC822 (and several others) a little bit, because the user part of the address may be (but is not required to be) case sensitive.</p><p><strong>length (string) - length of a string</strong></p>
<pre>
if (length(<em>string</em>) &gt; 80)
{
   ...
}
</pre>
<p>The <strong>length</strong> function returns the number of characters in <em>string</em>.</p><p><strong>lookup (expr, 'filename', 'options') - read file for patterns</strong></p>
<pre>
if (lookup(<em>expr</em>, file, "<em>option</em>"))
{
   ...
}
</pre>
<p><em>expr</em> is any expression. filename is a name of a file containing a list of patterns. Note that filename is relative to the current directory, which is the home directory of the user when <strong>maildrop</strong> runs in delivery mode, or embedded mode. <strong>maildrop</strong> then reads the file. Blank lines will be ignored, as well as any lines that begin with the # character (comments).</p><p>Leading whitespace (but not trailing whitespace, take care) is removed, and the remaining contents of each line are interpreted as a pattern which is matched against <em>expr</em>. As soon as the match is found, <strong>lookup</strong> returns "1". If no match is found after reading the entire file, <strong>lookup</strong> returns "0". For example:</p>
<pre>
if ( /^To:&#92;s*(.*)/ && lookup( $MATCH1, "badto.dat" ))
{
   exit
}
</pre>
<p>The file badto.dat contains the following two lines:</p>
<pre>
friend@public
^[^@]*$
</pre>
<p>If a message has a To: header that contains the text "friend@public", or does not contain at least one @ character, then the message will be silently dropped on the floor ( <strong>maildrop</strong> will terminate without delivering the message anywhere).</p><p><em>options</em> are the pattern matching options to use. The only supported option is "D" (the rest are meaningless, in this case).</p><p><strong>Note</strong></p><p>Be careful with discarding messages like that. Pattern matching can be tricky, and a slight miscalculation can cause mail to be unintentionally discarded. It is much desirable to first deliver message to a separate folder or mailbox, and once the filter is verified to work correctly, change it so the messages are discarded completely.</p><p><strong>substr(string,start [,count]) - return substring</strong></p>
<pre>
foo=substr($foo, 1, 10)
</pre>
<p>The <strong>substr</strong> function extracts characters from <em>string</em> beginning with character #<em>start</em>. If <em>count</em> is specified, at most <em>count</em> characters starting at position <em>start</em> are kept, any excess is trimmed.</p><p><strong>time - return current time</strong></p>
<pre>
foo=time
</pre>
<p>The <strong>time</strong> function returns the current time, in seconds, since January 1, 1970. This function is useful when using GDBM files. See \m[blue]<strong></strong><a href="../man7/maildropex.7.html"><strong>maildropex</strong>(7)</a>\m[]\s-2\u[18]\d\s+2 for an example of using the <strong>time</strong> function.</p><p><strong>tolower(string) - Convert string to lowercase.</strong></p>
<pre>
foo=tolower(<em>string</em>)
</pre>
<p>This function returns the <em>string</em> with all uppercase characters replaced by lowercase characters.</p><p><strong>toupper(string) - Convert string to uppercase.</strong></p>
<pre>
foo=toupper(<em>string</em>)
</pre>
<p>This function returns the <em>string</em> with all lowercase characters replaced by uppercase characters.</p>
<h3>Statements</h3>
<p>The filter file is read by <strong>maildrop</strong> ($HOME/.mailfilter or another file), and it contains filtering statements, one per line. The filtering language used by <strong>maildrop</strong> has a loosely - defined grammatical structure.</p><p>Statements are listed one per line. Multiple statements may be listed on the same line by separating them with semicolons. To continue a long statement on the next line, terminate the line with a backslash character.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BUGS</h2>
        <div class="sectioncontent">
<p>If <strong>getaddr</strong>() or <strong>hasaddr</strong>() functions are used on broken headers, the results are unpredictable.</p><p><strong>hasaddr</strong>() is completely case insensitive. This actually violates a few RFCs, because the userid portion of the address could be case-sensitive, but it&apos;s not in too many cases, so there.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO maildroprc&hellip;</h2>
        <div class="sectioncontent">
<p>\m[blue]<strong></strong><strong>lockmail</strong>(1)\m[]\s-2\u[19]\d\s+2, \m[blue]<strong></strong><a href="../man1/maildrop.1.html"><strong>maildrop</strong>(1)</a>\m[]\s-2\u[20]\d\s+2, \m[blue]<strong></strong><strong>maildropgdbm</strong>(5)\m[]\s-2\u[15]\d\s+2, \m[blue]<strong></strong><strong>maildirquota</strong>(8)\m[]\s-2\u[4]\d\s+2, \m[blue]<strong></strong><a href="../man1/reformail.1.html"><strong>reformail</strong>(1)</a>\m[]\s-2\u[21]\d\s+2, <a href="../man1/egrep.1.html"><strong>egrep</strong>(1)</a>, <a href="../man8/sendmail.8.html"><strong>sendmail</strong>(8)</a>.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p><strong>Sam Varshavchik</strong></p><p>Author</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">NOTES</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
     1.
  </dt>
  <dd>
    <p>Courier mail server</p><p>http://www.courier-mta.org/</p>
  </dd>
  <dt>
     2.
  </dt>
  <dd>
    <p><a href="../man5/dot-courier.5.html"><strong>dot-courier</strong>(5)</a></p><p>[set $man.base.url.for.relative.links]/dot-courier.html</p>
  </dd>
  <dt>
     3.
  </dt>
  <dd>
    <p>value of the -M option</p><p>[set $man.base.url.for.relative.links]/maildrop.html#moption</p>
  </dd>
  <dt>
     4.
  </dt>
  <dd>
    <p><strong>maildirquota</strong>(8)</p><p>[set $man.base.url.for.relative.links]/maildirquota.html</p>
  </dd>
  <dt>
     5.
  </dt>
  <dd>
    <p>xfilter</p><p>[set $man.base.url.for.relative.links]/#xfilter</p>
  </dd>
  <dt>
     6.
  </dt>
  <dd>
    <p>PCRE</p><p>http://www.pcre.org</p>
  </dd>
  <dt>
     7.
  </dt>
  <dd>
    <p>See the <strong>to</strong> statement</p><p>[set $man.base.url.for.relative.links]/#to</p>
  </dd>
  <dt>
     8.
  </dt>
  <dd>
    <p><strong>flock</strong> statement</p><p>[set $man.base.url.for.relative.links]/#flock</p>
  </dd>
  <dt>
     9.
  </dt>
  <dd>
    <p>embedded mode</p><p>[set $man.base.url.for.relative.links]/maildrop.html#embedded</p>
  </dd>
  <dt>
    10.
  </dt>
  <dd>
    <p><strong>dotlock</strong> statement</p><p>[set $man.base.url.for.relative.links]/#dotlock</p>
  </dd>
  <dt>
    11.
  </dt>
  <dd>
    <p><strong>cc</strong></p><p>[set $man.base.url.for.relative.links]/#cc</p>
  </dd>
  <dt>
    12.
  </dt>
  <dd>
    <p>evaluates to a logical true</p><p>[set $man.base.url.for.relative.links]/#if</p>
  </dd>
  <dt>
    13.
  </dt>
  <dd>
    <p>Patterns</p><p>[set $man.base.url.for.relative.links]/#patterns</p>
  </dd>
  <dt>
    14.
  </dt>
  <dd>
    <p>matching pattern sections</p><p>[set $man.base.url.for.relative.links]/#patmatch</p>
  </dd>
  <dt>
    15.
  </dt>
  <dd>
    <p><strong>maildropgdbm</strong>(5)</p><p>[set $man.base.url.for.relative.links]/maildropgdbm.html</p>
  </dd>
  <dt>
    16.
  </dt>
  <dd>
    <p>RFC 2822</p><p>http://www.rfc-editor.org/rfc/rfc2822.txt</p>
  </dd>
  <dt>
    17.
  </dt>
  <dd>
    <p>RFC 2822</p><p>http://www.rfc-editor.org/rfc/rfc822.txt</p>
  </dd>
  <dt>
    18.
  </dt>
  <dd>
    <p><a href="../man7/maildropex.7.html"><strong>maildropex</strong>(7)</a></p><p>[set $man.base.url.for.relative.links]/maildropex.html</p>
  </dd>
  <dt>
    19.
  </dt>
  <dd>
    <p><strong>lockmail</strong>(1)</p><p>[set $man.base.url.for.relative.links]/lockmail.html</p>
  </dd>
  <dt>
    20.
  </dt>
  <dd>
    <p><a href="../man1/maildrop.1.html"><strong>maildrop</strong>(1)</a></p><p>[set $man.base.url.for.relative.links]/maildrop.html</p>
  </dd>
  <dt>
    21.
  </dt>
  <dd>
    <p><a href="../man1/reformail.1.html"><strong>reformail</strong>(1)</a></p><p>[set $man.base.url.for.relative.links]/reformail.html</p>
  </dd>

</dl>

        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="maildir.maildrop.5.html"><span aria-hidden="true">&larr;</span> maildir.maildrop.5: E-mail directory</a></li>
   <li class="next"><a href="mailfilter.5.html">mailfilter.5: Maildrops filtering language <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
