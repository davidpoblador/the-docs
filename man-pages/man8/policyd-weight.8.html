<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>policyd-weight: Weighted smtp policy daemon</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Weighted smtp policy daemon">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="policyd-weight (8) manual">
  <meta name="twitter:description" content="Weighted smtp policy daemon">
  <meta name="twitter:image" content="https://www.carta.tech/images/policyd-weight-policyd-weight-8.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man8/policyd-weight.8.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="policyd-weight (8) manual" />
  <meta property="og:description" content="Weighted smtp policy daemon" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/policyd-weight-policyd-weight-8.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">policyd-weight<small> (8)</small></h1>
        <p class="lead">Weighted smtp policy daemon</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/">
      <span itemprop="name">System administration commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/policyd-weight.8.html">
      <span itemprop="name">policyd-weight: Weighted smtp policy daemon</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/policyd-weight/">
      <span itemprop="name">policyd-weight</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/policyd-weight.8.html">
      <span itemprop="name">policyd-weight: Weighted smtp policy daemon</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">STATUS</h2>
        <div class="sectioncontent">
<p>Beta, Documentation incomplete</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>

</pre>
<p><strong>policyd-weight</strong> [<strong>-option</strong>] [<strong>-option2 &lt;arg&gt;</strong>] <em>command</em></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p><a href="../man8/policyd-weight.8.html"><strong>policyd-weight</strong>(8)</a> is a SMTP policy daemon written in <strong>perl</strong>(1) for <strong>postfix</strong>(1). It evaluates based on RBL/RHSBL results, HELO and MAIL FROM domain and subdomain arguments and the client IP address the possibility of forgery or SPAM. It is designed to be called before the SMTP DATA command at the RCPT TO stage. This way it is a) possible to reject a mail attempt before the body has been received and b) to keep multirecipient mail intact, i.e. provide the functionality of selective usage based on recipients.</p><p>To make <a href="../man8/policyd-weight.8.html"><strong>policyd-weight</strong>(8)</a> work with <strong>postfix</strong>(1), it is required to add a system account for $USER (default: polw)</p><p>Policyd-weight can operate in master.cf <strong>or</strong> daemon mode. In master.cf mode it uses postfix' <strong>spawn</strong>(8), which results in number of simultanous requests perl instances. In daemon mode it uses shared memory and forks on load, and only if all child processes are busy.</p><p>At the time of writing the man-pages for policyd-weight assume a postfix installation. It has been reported that policyd-weight works with other MTAs like Exim, too.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SETUP</h2>
        <div class="sectioncontent">

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">master.cf mode:</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    <strong>master.cf:</strong>
  </dt>
  <dd>
    <p>policy   unix   -   n   n   -   -   spawn   user=polw</p><p>&nbsp;&nbsp;&nbsp;argv=/usr/bin/perl /usr/local/bin/policyd-weight</p>
  </dd>
  <dt>
    <strong>main.cf:</strong>
  </dt>
  <dd>
    <p>smtpd_recipient_restrictions =</p><p>&nbsp;&nbsp;&nbsp;permit_mynetworks,</p><p>&nbsp;&nbsp;&nbsp;... authenticated permits ...</p><p>&nbsp;&nbsp;&nbsp;reject_unauth_destination,</p><p>&nbsp;&nbsp;&nbsp;... whitelists, role accounts, clients ...</p><p>&nbsp;&nbsp;&nbsp;check_policy_service unix:private/policy</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">daemon mode:</h2>
        <div class="sectioncontent">
<p>start the daemon with <strong>policyd-weight start</strong>. Poliyd-weight then listens on $TCP_PORT (default: 12525)  for policy requests. To make postfix talk to that port do following changes to main.cf:</p>
<dl class='dl-vertical'>
  <dt>
    <strong>main.cf:</strong>
  </dt>
  <dd>
    <p>smtpd_recipient_restrictions =</p><p>&nbsp;&nbsp;&nbsp;permit_mynetworks,</p><p>&nbsp;&nbsp;&nbsp;... authenticated permits ...</p><p>&nbsp;&nbsp;&nbsp;reject_unauth_destination,</p><p>&nbsp;&nbsp;&nbsp;... whitelists, role accounts, clients ...</p><p>&nbsp;&nbsp;&nbsp;check_policy_service inet:127.0.0.1:12525</p><p>It is possible to have more than one postfix server talk to the <strong>daemonized</strong> policyd-weight by configuring each postfix machine to query the policy server with check_policy_service inet:IP:12525 where IP is the host on which policyd-weight runs.</p><p>Please note that <strong>check_policy_service</strong> should come at last, or at least <strong>after</strong> reject_unauth_destination, or else you may become an open relay.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COMMANDS</h2>
        <div class="sectioncontent">
<p>Following commands exist and are reserved for daemon mode only:</p>
<dl class='dl-vertical'>
  <dt>
    <strong>start</strong>     start the policy server
  </dt>
  <dd>
    
  </dd>
  <dt>
    <strong>stop</strong>      stop the policy server
  </dt>
  <dd>
    
  </dd>
  <dt>
    <strong>restart</strong>   restart the policy server
  </dt>
  <dd>
    
  </dd>
  <dt>
    <strong>reload</strong>    tells the policy server to reload its configuration
  </dt>
  <dd>
    
  </dd>
  <dt>
    <strong>defaults</strong>  prints the default settings to STDOUT and exits
  </dt>
  <dd>
    
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OPTIONS</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    <strong>-d</strong> operate in debug mode
  </dt>
  <dd>
    <p><strong>Not for use in master.cf</strong>. In debug mode everything is reported on STDOUT instead of <a href="../man3/syslog.3.html"><strong>syslog</strong>(3)</a>. Also an own debug cache daemon will be spawned. The socket-file is named after the value of $SPATH with ".debug" as suffix.</p>
  </dd>
  <dt>
    <strong>-f</strong> /path/to/file
  </dt>
  <dd>
    <p>Pass a configuration file to policyd-weight</p>
  </dd>
  <dt>
    <strong>-h</strong> show help
  </dt>
  <dd>
    
  </dd>
  <dt>
    <strong>-k</strong> kill cache daemon
  </dt>
  <dd>
    <p><strong>Not for use in master.cf</strong>. Together with <strong>-d</strong> this kills the debug cache daemon. Without <strong>-d</strong> it kills the global running cache daemon.</p>
  </dd>
  <dt>
    <strong>-s</strong> show cache entries
  </dt>
  <dd>
    <p><strong>Not for use in master.cf</strong>.</p>
  </dd>
  <dt>
    <strong>-v</strong> show version
  </dt>
  <dd>
    
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">LOGGING</h2>
        <div class="sectioncontent">
<p>Logging is done via <a href="../man3/syslog.3.html"><strong>syslog</strong>(3)</a> with facility "mail" and priority "info". For a complete list of log entries and their correspondending configuration parameters refer to <strong>policyd-weight.conf</strong>(5).</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BUGS</h2>
        <div class="sectioncontent">

<pre>
Please report bugs to r.felber@ek-muc.de

</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">HISTORY</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    March 2005
  </dt>
  <dd>
    <p>Ralf Hildebrandt (Author of the Book of Postfix) is the spiritual father of policyd-weight. It was his idea to have a scored RBL evaluation, I've added the weighted MAIL FROM/HELO DNS-evaluation. For that purpose I used Meng Wong's spf.pl which was shipped with the postfix source as example.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">FILES</h2>
        <div class="sectioncontent">

<pre>
/etc/policyd-weight.conf, Policyd-weight configuration file
/etc/postfix/main.cf, Postfix configuration parameters
/etc/postfix/master.cf, Postfix daemon processes
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO policyd-weight&hellip;</h2>
        <div class="sectioncontent">

<pre>
<strong>policyd-weight.conf</strong>(5), Policyd-weight configuration file
<strong>master</strong>(5), Postfix master.cf file syntax
<a href="../man5/postconf.5.html"><strong>postconf</strong>(5)</a>, Postfix main.cf file syntax
<strong>access</strong>(5), Postfix SMTP access control table

</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">LICENSE</h2>
        <div class="sectioncontent">

<pre>
GNU General Public License
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">

<pre>
Robert Felber &lt;r.felber@ek-muc.de&gt;
Autohaus Erich Kuttendreier
81827 Munich, Germany
</pre>

        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="pokerconfigupgrade.8.html"><span aria-hidden="true">&larr;</span> pokerconfigupgrade.8: Upgrade poker xml configuration files to match the software version</a></li>
   <li class="next"><a href="polkit.8.html">polkit.8: Authorization framework <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
