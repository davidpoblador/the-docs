<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>crushtool: Crush map manipulation tool</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Crush map manipulation tool">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="crushtool (8) manual">
  <meta name="twitter:description" content="Crush map manipulation tool">
  <meta name="twitter:image" content="https://www.carta.tech/images/ceph-crushtool-8.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man8/crushtool.8.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="crushtool (8) manual" />
  <meta property="og:description" content="Crush map manipulation tool" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/ceph-crushtool-8.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">crushtool<small> (8)</small></h1>
        <p class="lead">Crush map manipulation tool</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/">
      <span itemprop="name">System administration commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/crushtool.8.html">
      <span itemprop="name">crushtool: Crush map manipulation tool</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/ceph/">
      <span itemprop="name">ceph</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/crushtool.8.html">
      <span itemprop="name">crushtool: Crush map manipulation tool</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
<strong>crushtool</strong> ( -d <em>map</em> | -c <em>map.txt</em> | --build --num_osds <em>numosds</em>
<em>layer1</em> <em>...</em> | --test ) [ -o <em>outfile</em> ]
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    <p><strong></strong><strong>crushtool</strong><strong> is a utility that lets you create, compile, decompile</strong></p>
  </dt>
  <dd>
    <p>and test CRUSH map files.</p>
  </dd>

</dl>
<p>CRUSH is a pseudo-random data distribution algorithm that efficiently maps input values (typically data objects) across a heterogeneous, hierarchically structured device map. The algorithm was originally described in detail in the following paper (although it has evolved some since then): <em>http://www.ssrc.ucsc.edu/Papers/weil-sc06.pdf</em></p><p>The tool has four modes of operation.</p>
<dl class='dl-vertical'>
  <dt>
    <p><strong>--compile|-c map.txt</strong></p>
  </dt>
  <dd>
    <p>will compile a plaintext map.txt into a binary map file.</p>
  </dd>
  <dt>
    <p><strong>--decompile|-d map</strong></p>
  </dt>
  <dd>
    <p>will take the compiled map and decompile it into a plaintext source file, suitable for editing.</p>
  </dd>
  <dt>
    <p><strong>--build --num_osds {num-osds} layer1 ...</strong></p>
  </dt>
  <dd>
    <p>will create map with the given layer structure. See below for a detailed explanation.</p>
  </dd>
  <dt>
    <p><strong>--test</strong></p>
  </dt>
  <dd>
    <p>will perform a dry run of a CRUSH mapping for a range of input object names. See below for a detailed explanation.</p><p>Unlike other Ceph tools, <strong>crushtool</strong> does not accept generic options such as <strong>--debug-crush</strong> from the command line. They can however be provided via the CEPH_ARGS environment variable. For instance, to silence all output from the CRUSH subsystem:</p>
<pre>
CEPH_ARGS="--debug-crush 0" crushtool ...
</pre>

  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RUNNING TESTS WITH --TEST</h2>
        <div class="sectioncontent">
<p>The test mode will use the input crush map ( as specified with <strong>-i</strong> map ) and perform a dry run of CRUSH mapping or random placement ( if <strong>--simulate</strong> is set ). On completion, two kinds of reports can be created. The <strong>--show-...</strong> options output human readable information on stderr. The <strong>--output-csv</strong> option creates CSV files that are documented by the <strong>--help-output</strong> option.</p>
<dl class='dl-vertical'>
  <dt>
    <p><strong>--show-statistics</strong></p>
  </dt>
  <dd>
    <p>for each rule display the mapping of each object. For instance:</p>
<pre>
CRUSH rule 1 x 24 [11,6]
</pre>
<p>shows that object <strong>24</strong> is mapped to devices <strong>[11,6]</strong> by rule <strong>1</strong>. At the end of the mapping details, a summary of the distribution is displayed. For instance:</p>
<pre>
rule 1 (metadata) num_rep 5 result size == 5:    1024/1024
</pre>
<p>shows that rule <strong>1</strong> which is named <strong>metadata</strong> successfully mapped <strong>1024</strong> objects to <strong>result size == 5</strong> devices when trying to map them to <strong>num_rep 5</strong> replicas. When it fails to provide the required mapping, presumably because the number of <strong>tries</strong> must be increased, a breakdown of the failures is displays. For instance:</p>
<pre>
rule 1 (metadata) num_rep 10 result size == 8:   4/1024
rule 1 (metadata) num_rep 10 result size == 9:   93/1024
rule 1 (metadata) num_rep 10 result size == 10:  927/1024
</pre>
<p>shows that although <strong>num_rep 10</strong> replicas were required, <strong>4</strong> out of <strong>1024</strong> objects ( <strong>4/1024</strong> ) were mapped to <strong>result size</strong> == 8 devices only.</p>
  </dd>
  <dt>
    <p><strong>--show-bad-mappings</strong></p>
  </dt>
  <dd>
    <p>display which object failed to be mapped to the required number of devices. For instance:</p>
<pre>
bad mapping rule 1 x 781 num_rep 7 result [8,10,2,11,6,9]
</pre>
<p>shows that when rule <strong>1</strong> was required to map <strong>7</strong> devices, it could only map six : <strong>[8,10,2,11,6,9]</strong>.</p>
  </dd>
  <dt>
    <p><strong>--show-utilization</strong></p>
  </dt>
  <dd>
    <p>display the expected and actual utilisation for each device, for each number of replicas. For instance:</p>
<pre>
device 0: stored : 951      expected : 853.333
device 1: stored : 963      expected : 853.333
...
</pre>
<p>shows that device <strong>0</strong> stored <strong>951</strong> objects and was expected to store <strong>853</strong>. Implies <strong>--show-statistics</strong>.</p>
  </dd>
  <dt>
    <p><strong>--show-utilization-all</strong></p>
  </dt>
  <dd>
    <p>displays the same as <strong>--show-utilization</strong> but does not suppress output when the weight of a device is zero. Implies <strong>--show-statistics</strong>.</p>
  </dd>
  <dt>
    <p><strong>--show-choose-tries</strong></p>
  </dt>
  <dd>
    <p>display how many attempts were needed to find a device mapping. For instance:</p>
<pre>
0:     95224
1:      3745
2:      2225
..
</pre>
<p>shows that <strong>95224</strong> mappings succeeded without retries, <strong>3745</strong> mappings succeeded with one attempts, etc. There are as many rows as the value of the <strong>--set-choose-total-tries</strong> option.</p>
  </dd>
  <dt>
    <p><strong>--output-csv</strong></p>
  </dt>
  <dd>
    <p>create CSV files (in the current directory) containing information documented by <strong>--help-output</strong>. The files are named after the rule used when collecting the statistics. For instance, if the rule metadata is used, the CSV files will be:</p>
<pre>
metadata-absolute_weights.csv
metadata-device_utilization.csv
...
</pre>
<p>The first line of the file shortly explains the column layout. For instance:</p>
<pre>
metadata-absolute_weights.csv
Device ID, Absolute Weight
0,1
...
</pre>

  </dd>
  <dt>
    <p><strong>--output-name NAME</strong></p>
  </dt>
  <dd>
    <p>prepend <strong>NAME</strong> to the file names generated when <strong>--output-csv</strong> is specified. For instance <strong>--output-name FOO</strong> will create files:</p>
<pre>
FOO-metadata-absolute_weights.csv
FOO-metadata-device_utilization.csv
...
</pre>
<p>The <strong>--set-...</strong> options can be used to modify the tunables of the input crush map. The input crush map is modified in memory. For example:</p>
<pre>
$ crushtool -i mymap --test --show-bad-mappings
bad mapping rule 1 x 781 num_rep 7 result [8,10,2,11,6,9]
</pre>
<p>could be fixed by increasing the <strong>choose-total-tries</strong> as follows:</p>
  </dd>
  <dt>
    <p><strong>$ crushtool -i mymap --test</strong></p>
  </dt>
  <dd>
    <p>--show-bad-mappings --set-choose-total-tries 500</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BUILDING A MAP WITH --BUILD</h2>
        <div class="sectioncontent">
<p>The build mode will generate hierarchical maps. The first argument specifies the number of devices (leaves) in the CRUSH hierarchy. Each layer describes how the layer (or devices) preceding it should be grouped.</p><p>Each layer consists of:</p>
<pre>
bucket ( uniform | list | tree | straw ) size
</pre>
<p>The <strong>bucket</strong> is the type of the buckets in the layer (e.g. "rack"). Each bucket name will be built by appending a unique number to the <strong>bucket</strong> string (e.g. "rack0", "rack1"...).</p><p>The second component is the type of bucket: <strong>straw</strong> should be used most of the time.</p><p>The third component is the maximum size of the bucket. A size of zero means a bucket of infinite capacity.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLE</h2>
        <div class="sectioncontent">
<p>Suppose we have two rows with two racks each and 20 nodes per rack. Suppose each node contains 4 storage devices for Ceph OSD Daemons. This configuration allows us to deploy 320 Ceph OSD Daemons. Lets assume a 42U rack with 2U nodes, leaving an extra 2U for a rack switch.</p><p>To reflect our hierarchy of devices, nodes, racks and rows, we would execute the following:</p>
<pre>
$ crushtool -o crushmap --build --num_osds 320 &#92;
       node straw 4 &#92;
       rack straw 20 &#92;
       row straw 2 &#92;
       root straw 0
# id        weight  type name       reweight
-87 320     root root
-85 160             row row0
-81 80                      rack rack0
-1  4                               node node0
0   1                                       osd.0   1
1   1                                       osd.1   1
2   1                                       osd.2   1
3   1                                       osd.3   1
-2  4                               node node1
4   1                                       osd.4   1
5   1                                       osd.5   1
...
</pre>
<p>CRUSH rulesets are created so the generated crushmap can be tested. They are the same rulesets as the one created by default when creating a new Ceph cluster. They can be further edited with:</p>
<pre>
# decompile
crushtool -d crushmap -o map.txt

# edit
emacs map.txt

# recompile
crushtool -c map.txt -o crushmap
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AVAILABILITY</h2>
        <div class="sectioncontent">
<p><strong>crushtool</strong> is part of the Ceph distributed storage system. Please refer to the Ceph documentation at <em>http://ceph.com/docs</em> for more information.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO crushtool&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man8/ceph.8.html"><strong>ceph</strong>(8)</a>, <a href="../man8/osdmaptool.8.html"><strong>osdmaptool</strong>(8)</a>,</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHORS</h2>
        <div class="sectioncontent">
<p>John Wilkins, Sage Weil, Loic Dachary</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COPYRIGHT</h2>
        <div class="sectioncontent">
<p>2010-2014, Inktank Storage, Inc. and contributors. Licensed under Creative Commons BY-SA</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="cruft.8.html"><span aria-hidden="true">&larr;</span> cruft.8: Check the filesystem for cruft (missing and unexplained files)</a></li>
   <li class="next"><a href="cryptdisks_start.8.html">cryptdisks_start.8: Wrapper around cryptsetup that parses /etc/crypttab. <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
