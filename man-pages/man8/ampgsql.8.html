<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ampgsql: Amanda application to interface with postgresql</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Amanda application to interface with postgresql">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="ampgsql (8) manual">
  <meta name="twitter:description" content="Amanda application to interface with postgresql">
  <meta name="twitter:image" content="https://www.carta.tech/images/amanda-common-ampgsql-8.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man8/ampgsql.8.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ampgsql (8) manual" />
  <meta property="og:description" content="Amanda application to interface with postgresql" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/amanda-common-ampgsql-8.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">ampgsql<small> (8)</small></h1>
        <p class="lead">Amanda application to interface with postgresql</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/">
      <span itemprop="name">System administration commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/ampgsql.8.html">
      <span itemprop="name">ampgsql: Amanda application to interface with postgresql</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/amanda-common/">
      <span itemprop="name">amanda-common</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/ampgsql.8.html">
      <span itemprop="name">ampgsql: Amanda application to interface with postgresql</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>Ampgsql is an Amanda Application API script. It should not be run by users directly. It implements on-line backups of PostgreSQL databases in conjunction with WAL archiving.</p><p><strong>Note</strong></p><p>Tablespaces are not currently supported.</p><p><strong>Note</strong></p><p>On versions of PostgreSQL earlier than 8.2, if the database is quiet during a full backup, then the backup may not complete until enough database activity takes place to trigger the archiving of the current WAL file. Consider adjusting the PG-MAX-WAL-WAIT property from its default (60s) to compensate. Note that you will need to increase <strong>dtimeout</strong> on the server accordingly.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DISKLIST</h2>
        <div class="sectioncontent">
<p>The <strong>diskdevice</strong> must be the cluster data directory, if it is "/var/lib/pgsql/data":</p>
<pre>
  HOST DISKNAME /var/lib/pgsql/data DUMPTYPE
or
  HOST /var/lib/pgsql/data DUMTYPE
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OPERATION</h2>
        <div class="sectioncontent">
<p>This application implements the backup strategy described in http://www.postgresql.org/docs/current/static/continuous-archiving.html. For a level zero (full) backup, ampgsql:</p><p>execute PG_START_BACKUP()</p><p>dump the data directory</p><p>execute PG_STOP_BACKUP()</p><p>wait for the final WAL file to be archived</p><p>back up the required WAL files</p><p>optionally delete WAL files that are no longer necessary</p><p>The two dumps are made with GNU Tar, to data_dir.tar and archive_dir, respectively. They are then combined into a single tar file.</p><p>A level N backup creates a single tar file containing all WAL files since the previous level N-1 backup.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">PROPERTIES</h2>
        <div class="sectioncontent">
<p>This section lists the <a href="../man5/amanda.conf.5.html"><strong>amanda.conf</strong>(5)</a> properties that control ampsql&apos;s functionality. See <a href="../man7/amanda-applications.7.html"><strong>amanda-applications</strong>(7)</a> for information on application properties and how they are configured.</p><p>ARCHIVEDIR</p><p>Directory that WAL segment files are archived to, as specified by the archive_command in PosgreSQL&apos;s postgresql.conf. The amanda user on the client must have at least read and execute permission on this directory, and preferably write. Without write permission, Amanda cannot clean up expired WAL and backup files.</p><p>CLEANUPWAL</p><p>Whether or not to remove old WAL segment files during base backups. Defaults to yes.</p><p>DB</p><p>Database to connect to. Defaults to "template1" (which exists by default).</p><p>DIRECTORY</p><p>For restore command only, the data is recoved in that directory. Must be a unix path.</p><p>GNUTAR-PATH</p><p>Path to the GNU tar executable. This option only has an effect during restore. The default is set when Amanda is built by the --with-gnutar configure option.</p><p>HOST</p><p>Host to connect to. If it starts with "/" it will be interepreted as a directory that holds the socket file. PostgreSQL defaults to /tmp.</p><p>MAX-WAL-WAIT</p><p>The maximum amount of time to wait for PG_STOP_BACKUP to archive a WAL file. In versions of PostgreSQL before 8.2, PG_STOP_BACKUP does not automatically archive the latest WAL file, so a quiet database may wait a very long time before archiving the WAL file. Default: 60 seconds. Set to 0 to wait forever.</p><p>PASSFILE</p><p>Connect using the creditials in this file. Each line should have the format "hostname:port:database:username:password". The permissions must permit it to be read only by the user, or the file will not be used. Only usable with Postgres 8.1 and up.</p><p>PORT</p><p>The TCP port to connect to, or the suffix of the socket file. PostgreSQL defaults to 5432.</p><p>PSQL-PATH</p><p>Path to the psql binary. If not specified, the PATH environment variable will be searched.</p><p>STATEDIR</p><p>Directory for saving state about backups already made. The default is set when Amanda is built by the --with-gnutar-listdir configure option.</p><p>TMPDIR</p><p>Directory to use for temporary files during the backup process. It should have enough space to store a complete copy of the database. The default is set when Amanda is built by the --with-tmpdir configure option.</p><p>USER</p><p>User to connect as. It must be a superuser.</p><p>VERBOSE</p><p>Do not use the --quiet output of psql.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CLIENT PROPERTIES</h2>
        <div class="sectioncontent">
<p>Client properties are deprecated. All properties should be set in the dumptype.</p><p>This section lists the <a href="../man5/amanda-client.conf.5.html"><strong>amanda-client.conf</strong>(5)</a> properties that control ampsql&apos;s functionality. If a property is prefixed with the diskname and an underscore, then it will be used when that diskname is being backed up. For example, if the properties PG-DATADIR and foo-PG-DATADIR are set, the value of PG-DATADIR will be used when bar and baz are being backed up, but foo-PG-DATADIR will be used when foo is being backed up. Disknames are specified in the <a href="../man5/disklist.5.html"><strong>disklist</strong>(5)</a>.</p><p>PG-ARCHIVEDIR</p><p>Directory that WAL segment files are archived to, as specified by the archive_command in PosgreSQL&apos;s postgresql.conf.  The amanda user on the client must have at least read and execute permission on this directory, and preferably write.  Without write permission, Amanda cannot clean up expired WAL and backup files.</p><p>PG-CLEANUPWAL</p><p>Whether or not to remove old WAL segment files during base backups. Defaults to yes.</p><p>PG-DATADIR</p><p>Cluster data directory</p><p>PG-DB</p><p>Database to connect to. Defaults to "template1" (which exists by default).</p><p>PG-HOST</p><p>Host to connect to. If it starts with "/" it will be interepreted as a directory that holds the socket file. PostgreSQL defaults to /tmp.</p><p>PG-MAX-WAL-WAIT</p><p>The maximum amount of time to wait for PG_STOP_BACKUP to archive a WAL file. In versions of PostgreSQL before 8.2, PG_STOP_BACKUP does not automatically archive the latest WAL file, so a quiet database may wait a very long time before archiving the WAL file. Default: 60 seconds. Set to 0 to wait forever.</p><p>PG-PASSFILE</p><p>Connect using the creditials in this file. Each line should have the format "hostname:port:database:username:password". The permissions must permit it to be read only by the user, or the file will not be used. Only usable with Postgres 8.1 and up.</p><p>PG-PASSWORD</p><p>Password to use when connecting. Deprecated in favor of passfiles.</p><p>PG-PORT</p><p>The TCP port to connect to, or the suffix of the socket file. PostgreSQL defaults to 5432.</p><p>PG-USER</p><p>User to connect as. It must be a superuser.</p><p>PSQL-PATH</p><p>Path to the psql binary. If not specified, the PATH environment variable will be searched.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RECOVERY</h2>
        <div class="sectioncontent">
<p>Read the postgres documentation carefully before attempting a recovery. This section is only a rough guide to the process.</p><p>The data recovered from a postgres backup consists of a data tarball and one or more archive tarballs. The data contains the state of the database at the time the full backup was performed, and the archive tarballs contain postgres WAL files that must be re-run to generate a consistent state.</p><p>Ensure that the database server is shut down, and move the existing data directory aside. Untar the data tarball over this directory, and verify that ownership and permissions are correct. Untar all of the archive tarballs into a single directory - the archive directory. Create a recovery.conf in the data directory, owned by the proper user and with proper permissions. Add a <strong>restore_command</strong> to it, e.g.,</p>
<pre>
restore_command = &apos;cp /path/to/archive_dir/%f "%p"&apos;
</pre>
<p>Start the database server, and examine the logs to track the process of the recovery. When the recovery is complete, the server will transition into a running state, and will move the recovery.conf file aside so that it will not attempt a recovery on the next invocation.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLE</h2>
        <div class="sectioncontent">
<p>In amanda.conf:</p>
<pre>
define application app_ampgsql {
  plugin "ampgsql"
  property "HOST" "localhost"
  property "ARCHIVEDIR" "/tmp/archivedir"
  property "PASSFILE" "/etc/amanda/ampgsql.passwd"
}
define dumptype dump_ampgsql {
  global
  program "APPLICATION"
  application app_ampgsql
}
</pre>
<p>The disklist file:</p>
<pre>
  localhost /var/lib/pgsql/data dump_ampgsql
or
  localhost postgres /var/lib/pgsql/data dump_ampgsql
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO ampgsql&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man8/amanda.8.html"><strong>amanda</strong>(8)</a>, <a href="../man5/amanda.conf.5.html"><strong>amanda.conf</strong>(5)</a>, <a href="../man5/amanda-client.conf.5.html"><strong>amanda-client.conf</strong>(5)</a>, <a href="../man7/amanda-applications.7.html"><strong>amanda-applications</strong>(7)</a></p><p>The Amanda Wiki: : http://wiki.zmanda.com/</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p><strong>Nikolas Coukouma</strong> &lt;atrus@zmanda.com&gt;</p><p>Zmanda, Inc. (http://www.zmanda.com)</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="amoverview.8.html"><span aria-hidden="true">&larr;</span> amoverview.8: Display file systems processed by amanda over time</a></li>
   <li class="next"><a href="amplot.8.html">amplot.8: Visualize the behavior of amanda <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
