<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>courierfilter: Courier mail filters</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Courier mail filters">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="courierfilter (8) manual">
  <meta name="twitter:description" content="Courier mail filters">
  <meta name="twitter:image" content="https://www.carta.tech/images/courier-mta-courierfilter-8.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man8/courierfilter.8.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="courierfilter (8) manual" />
  <meta property="og:description" content="Courier mail filters" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/courier-mta-courierfilter-8.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">courierfilter<small> (8)</small></h1>
        <p class="lead">Courier mail filters</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/">
      <span itemprop="name">System administration commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/courierfilter.8.html">
      <span itemprop="name">courierfilter: Courier mail filters</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/courier-mta/">
      <span itemprop="name">courier-mta</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man8/courierfilter.8.html">
      <span itemprop="name">courierfilter: Courier mail filters</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>courierfilter</strong> [[start] | [stop] | [restart]] <strong>filterctl</strong> [[start] | [stop]] [<em>filter</em>]</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>The <strong>filterctl</strong> commands install or uninstall global mail <em>filter</em>s. Global mail filters are used to selectively block unwanted mail. More than one mail filter can be enabled at the same time. Two filters - \m[blue]<strong></strong><a href="../man8/dupfilter.8.html"><strong>dupfilter</strong>(8)</a>\m[]\s-2\u[1]\d\s+2 and \m[blue]<strong></strong><a href="../man8/courierperlfilter.8.html"><strong>courierperlfilter</strong>(8)</a>\m[]\s-2\u[2]\d\s+2 - are provided as examples for writing mail filters.</p><p><strong>courierfilter start</strong> runs all mail filters that have been installed by <strong>filterctl</strong>. <strong>courierfilter stop</strong> shuts down all running mail filters. After <strong>courierfilter start</strong>, any <strong>filterctl</strong> commands take effect immediately. After <strong>courierfilter stop</strong> any <strong>filterctl</strong> commands will take effect at the next <strong>courierfilter start</strong>.</p><p><strong>courierfilter restart</strong> signals the running <strong>courierfilter</strong> to reread its configuration files. This is normally done automatically, by <strong>filterctl</strong>.</p><p>If any mail filter is installed, the mail filter must be running in order for any mail to be processed. Mail filters are assumed to be empowered to enforce system-wide mail policies, so if an installed mail filter is not running then mail will not be accepted by the system. Note that mail will not be rejected, if possible. Every attempt will be made to send a temporary error code to an external mail system, asking it to try again later.</p><p>For this reason, you should modify your system boot script to run <strong>courierfilter start</strong> as soon as possible, and run <strong>courierfilter stop</strong> during the final portion of your system shutdown script. It is not necessary to run <strong>courierfilter</strong> if you do not install a mail filter with <strong>filterctl</strong>.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">MAIL FILTER IMPLEMENTATION</h2>
        <div class="sectioncontent">
<p>This section explains how mail filters are implemented, and how to write a new global mail filter.</p><p>Available mail filter binaries are located in the directory /usr/lib/courier/filters. The <strong>filterctl</strong> script looks in this directory to see which mail filters are available to be installed. Installing a mail filter consists of simply creating a soft link from the directory /etc/courier/filters/active to its corresponding binary in /usr/lib/courier/filters. The courierfilter start command simply reads /etc/courier/filters/active and runs every program in this directory.</p><p>The <strong>filterctl</strong> script sends a HUP signal to <strong>courierfilter</strong> after installing or uninstalling a filter. <strong>courierfilter</strong> will reread the contents of /etc/courier/filters/active then start or stop individual mail filters.</p><p>After starting, an individual mail filter must create a filesystem domain socket in one of two directories: /var/lib/courier/filters or /var/lib/courier/allfilters. The name of the socket should be the same as a name of the filter, and the mail filter must make sure to remove any socket by the same name in the other directory. For various silly reasons, the recommended implementation is to create /var/lib/courier/filters/.<em>NAME</em> or /var/lib/courier/allfilters/.<em>NAME</em> (after making sure that it doesn&apos;t exist) then rename <em>.NAME</em> to <em>NAME</em>.</p><p>After initializing the socket, the mail filter must then close its file descriptor #3. File descriptor 3 is inherited by every mail filter that&apos;s executed by the <strong>courierfilter start</strong> command. The mail filter&apos;s file descriptor 3 is connected to the <em>write</em> end of a pipe, which may be relevant to certain ways of implementing the closing of the file descriptor, for instance in Perl where you may be forced to pseudo-open the descriptor (in write mode) before closing it. The <strong>courierfilter start</strong> command will not exit until every started mail filter closes its file descriptor 3. This allows for all mail filters to orderly initialize themselves before <strong>courierfilter start</strong> command returns.</p><p>All mail filters also inherit a pipe on standard input, and must terminate when the pipe is closed. Mail filters must simultaneously listen for new connections on the mail filter socket, and for their standard input to close.</p><p>The mail filter receives a new connection on its socket for every message that needs to be filtered. After establishing a connection, the mail filter will immediately read the following information from the new socket:</p><p>A pathname to a file containing the contents of the message.</p><p>One or more pathnames to control files for this message.</p><p>Each pathname is terminated by a single newline character. The last pathname is followed by a second newline character. The pathnames may either be relative pathnames to /usr or absolute pathnames, depending on the system configuration.</p><p>The mail filter is free to judge the message&apos;s worthiness by reading its contents and/or control file(s) as soon as a second consecutive newline character is received. The final verdict is rendered by writing back a result code on the same socket. The result code follows the same format as regular SMTP replies (even though the message may not have been received via SMTP), and can be used to communicate acceptance, temporary failure, or a permanent failure. If it&apos;s a failure, then the text portion of the result code will be used, if possible. The result code may be a multiline response, just like a regular SMTP reply. The mail filter must immediately close the connection after writing the result code. After closing the socket the mail filter must then proceed to wait for another connection request on the original listening socket.</p><p>The mail filter can be multithreaded or multitasked, and can accept multiple connections simultaneously. When its standard input is closed the mail filter should stop accepting new connections and wait for any existing connections to be closed, prior to exiting.</p><p>Global mail filters must be EXTREMELY resilient to runtime failures. Since mail will not be processed if an installed mail filter is not running, if a mail filter crashes it will effectively shut down the mail server. Currently <strong>courierfilter</strong> does not attempt to restart mail filters which crash.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">MAIL FILTER INVOCATION</h2>
        <div class="sectioncontent">
<p>The system administrator defines what mail gets filtered by editing the contents of the enablefiltering configuration file in /etc/courier. This configuration file contains a list of mail sources that should be filtered, like esmtp or local. See \m[blue]<strong></strong><a href="../man8/courier.8.html"><strong>courier</strong>(8)</a>\m[]\s-2\u[3]\d\s+2 for more information. A default /etc/courier/enablefiltering file is installed that specifies only the esmtp mail source as subject to filtering.</p><p>A message is not subject to filtering if its source is not listed in /etc/courier/enablefiltering. Otherwise the following rules apply.</p><p>Certain mail destinations have the ability to selectively whitelist arbitrary messages. For example, local mail recipients have the ability to selectively whitelist individual messages, provided that a local mail filter (independent of any global mail filter) is installed that implements the \m[blue]<strong>maildrop filtering API</strong>\m[]\s-2\u[4]\d\s+2.</p><p>New messages are filtered by connecting to every socket in /var/lib/courier/filters and/or /var/lib/courier/allfilters, one at a time. All mail filters must accept the message, for it to be accepted by Courier. If a socket exists but a connection cannot be established then the message is not accepted, and a temporary failure indication is returned. That&apos;s why no mail will be accepted unless all installed mail filters are running.</p><p>Mail recipients that did not whitelist the sender, via the maildrop API, will have their mail filtered against everything in /var/lib/courier/filters and /var/lib/courier/allfilters. Mail to recipients that whitelisted the sender, or mail to destinations that do not use a maildrop API-compatible filter, will be filtered only against the contents of /var/lib/courier/allfilters.</p><p>This gives system administrators a choice whether to install selective, or mandatory mail filters, or a combination of both.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BUGS</h2>
        <div class="sectioncontent">
<p>Many filesystem domain socket implementation are buggy.</p><p>Handling of crashed mail filters could be improved.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">FILES</h2>
        <div class="sectioncontent">
<p>/usr/lib/courier/filters</p><p>Available mail filters.</p><p>/etc/courier/filters</p><p>Miscellaneous configuration files.</p><p>/etc/courier/filters/active</p><p>Installed mail filters.</p><p>/etc/courier/enablefiltering</p><p>Which mail sources to filter.</p><p>/var/lib/courier/allfilters</p><p>Mandatory filters.</p><p>/var/lib/courier/filters</p><p>Optional filters.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO courierfilter&hellip;</h2>
        <div class="sectioncontent">
<p>\m[blue]<strong></strong><a href="../man7/localmailfilter.7.html"><strong>localmailfilter</strong>(7)</a>\m[]\s-2\u[4]\d\s+2, \m[blue]<strong></strong><a href="../man8/courier.8.html"><strong>courier</strong>(8)</a>\m[]\s-2\u[3]\d\s+2, \m[blue]<strong></strong><a href="../man8/dupfilter.8.html"><strong>dupfilter</strong>(8)</a>\m[]\s-2\u[1]\d\s+2, \m[blue]<strong></strong><a href="../man8/ratefilter.8.html"><strong>ratefilter</strong>(8)</a>\m[]\s-2\u[5]\d\s+2, \m[blue]<strong></strong><a href="../man8/courierperlfilter.8.html"><strong>courierperlfilter</strong>(8)</a>\m[]\s-2\u[2]\d\s+2.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p><strong>Sam Varshavchik</strong></p><p>Author</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">NOTES</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
     1.
  </dt>
  <dd>
    <p><a href="../man8/dupfilter.8.html"><strong>dupfilter</strong>(8)</a></p><p>[set $man.base.url.for.relative.links]/dupfilter.html</p>
  </dd>
  <dt>
     2.
  </dt>
  <dd>
    <p><a href="../man8/courierperlfilter.8.html"><strong>courierperlfilter</strong>(8)</a></p><p>[set $man.base.url.for.relative.links]/courierperlfilter.html</p>
  </dd>
  <dt>
     3.
  </dt>
  <dd>
    <p><a href="../man8/courier.8.html"><strong>courier</strong>(8)</a></p><p>[set $man.base.url.for.relative.links]/courier.html</p>
  </dd>
  <dt>
     4.
  </dt>
  <dd>
    <p>maildrop filtering API</p><p>[set $man.base.url.for.relative.links]/localmailfilter.html</p>
  </dd>
  <dt>
     5.
  </dt>
  <dd>
    <p><a href="../man8/ratefilter.8.html"><strong>ratefilter</strong>(8)</a></p><p>[set $man.base.url.for.relative.links]/ratefilter.html</p>
  </dd>

</dl>

        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="courierfax.8.html"><span aria-hidden="true">&larr;</span> courierfax.8: Send faxes via e-mail</a></li>
   <li class="next"><a href="couriergrey.8.html">couriergrey.8: Greylisting filter for courier mta <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
