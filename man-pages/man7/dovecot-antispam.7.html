<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>dovecot-antispam: The dovecot antispam plugin.</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="The dovecot antispam plugin.">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="dovecot-antispam (7) manual">
  <meta name="twitter:description" content="The dovecot antispam plugin.">
  <meta name="twitter:image" content="https://www.carta.tech/images/dovecot-antispam-dovecot-antispam-7.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man7/dovecot-antispam.7.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="dovecot-antispam (7) manual" />
  <meta property="og:description" content="The dovecot antispam plugin." />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/dovecot-antispam-dovecot-antispam-7.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">dovecot-antispam<small> (7)</small></h1>
        <p class="lead">The dovecot antispam plugin.</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man7/">
      <span itemprop="name">Miscellaneous</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man7/dovecot-antispam.7.html">
      <span itemprop="name">dovecot-antispam: The dovecot antispam plugin.</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/dovecot-antispam/">
      <span itemprop="name">dovecot-antispam</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man7/dovecot-antispam.7.html">
      <span itemprop="name">dovecot-antispam: The dovecot antispam plugin.</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>The dovecot antispam plugin watches a defined spam folder (defaults to "SPAM"). It works together with a spam system that classifies each message as it is delivered. When the message is classified as spam, it shall be delivered to the spam folder, otherwise via the regular filtering file the user may have (maildrop, sieve, ...). Now the user has everything classified as spam in the special spam folder, everything else where it should be sorted to.</p><p>This is not enough because our spam scanner needs training. We'll occasionally have false positives and false negatives. Now this is the point where the dovecot antispam plugin comes into play. Instead of moving mail into special folders or forwarding them to special mail addresses for retraining, the plugin offers two actions for the user:</p>
<dl class='dl-vertical'>
  <dt>
     1.
  </dt>
  <dd>
    <p>moving mail out of the SPAM folder and</p>
  </dd>
  <dt>
     2.
  </dt>
  <dd>
    <p>moving mail into the SPAM folder.</p>
  </dd>

</dl>
<p>The dovecot plugin watches these actions (and additionally prohibits APPENDs to the SPAM folder, more for technical reasons than others) and tells the spam classifier that it made an error and needs to re-classify the message (as spam/not spam depending on which way it was moved.)</p><p>The advantage of this approach is that the mail ends up in the right target folder directly and needs not be touched twice.</p><p>When other classifiers like crm114 that have an `unsure' state are used, the plugin can also help, it supports an `unsure' folder feature. The unsure folder cannot be written to, but moving out from there into a folder that is considered a spam folder will learn as spam, any other folder (except trashes) will cause learning as not-spam.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">INSTALLATION</h2>
        <div class="sectioncontent">
<p>First copy the `defconfig' file to `.config' and edit it as necessary. You need to have the dovecot headers installed and possibly other things depending on the backend you choose. Then, assuming you have configured the INSTALLDIR correctly, simply run `make install'.</p><p>If you do not wish to use the install target, simply copy the plugin (that is, the file lib90_antispam_plugin.so) to your dovecot imap plugin directory; by default this is /usr/lib/dovecot/modules/imap/ or any dir you have configured (look for the mail_plugin_dir configuration directive.)</p><p>Open your dovecot configuration file (usually /etc/dovecot/dovecot.conf) and add the antispam plugin to the imap protocol section:</p>
<pre>
protocol imap {
    mail_plugins = antispam
    # mail_plugin_dir = /usr/lib/dovecot/modules/imap
}
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BACKENDS</h2>
        <div class="sectioncontent">
<p>The plugin supports multiple backends, there are currently a few working backends included in the distribution:</p><h3>dspam executable backend (dspam specific)</h3>
<p>This backend instantly retrains by calling dspam. There are some problems with this approach including (1) it can take a long time during which the IMAP session is blocked (2) when many users retrain many messages at once server load may spike</p>
<h3>pipe backend (spam filter agnostic)</h3>
<p>This backend simply pipes the mail to train to a process it executes. This can for example be used to send it as email to mail aliases for retraining. This backend can be very easy to set up if you already have a working setup that uses training addresses as recommended by many spam filter setups.</p><p>Since this backend simply pipes the message to a program (by default sendmail) it can also be used for all kinds of other spam filters, for example spamassassin (by calling sa-learn instead of sendmail.)</p>
<h3>crm114 executable backend (crm114 specific)</h3>
<p>This backend instantly retrains by calling mailreaver.crm which needs to be configured (defaulting to /bin/false!); the argument --good or --spam is given depending on how mail is moved.</p><p>You need to use the unsure folder option (see below) together with this plugin and deliver unsure mail into an unsure folder, spam mail into a spam folder and other mail regularly.</p><p>Has the same drawbacks as the dspam approach.</p>
<h3>spool2dir backend (general)</h3>
<p>This backend spools the message into a file. No further processing is performed. You need to write an extra daemon that picks up the spooled files and trains the spam filter as appropriate. You can, for example, use incron to pick up new emails.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CONFIGURATION</h2>
        <div class="sectioncontent">
<p>Aside from the build-configuration done in the `.config' file, you have the following run-time options (shown along with the default):</p>
<pre>
plugin {
    ##################
    # GENERIC OPTIONS

    # Debugging options
    # Uncomment to get the desired debugging behaviour.
    # Note that in some cases stderr debugging will not be as
    # verbose as syslog debugging due to internal limitations.
    #
    # antispam_debug_target = syslog
    # antispam_debug_target = stderr
    # antispam_verbose_debug = 1

    # backend selection, MUST be configured first,
    # there's no default so you need to set one of
    # these options:
    # antispam_backend = crm114
    # antispam_backend = dspam
    # antispam_backend = pipe
    # antispam_backend = spool2dir

    # mail signature (used with any backend requiring a signature)
    antispam_signature = X-DSPAM-Signature

    # action to take on mails without signature
    # (used with any backend requiring a signature)
    # (we recommend only setting this to 'move' after verifying that the
    # whole setup is working)
    # antispam_signature_missing = move # move silently without training
    antispam_signature_missing = error

    # The list of folders for trash, spam and unsure can be given
    # with three options, e.g. "trash" matches the given folders
    # exactly as written, "trash_pattern" accept the * wildcard at
    # the end of the foldername, "trash_pattern_ignorecase"
    # accepts the * wildcard at the end of the foldername _and_
    # matches the name case insensitivly.

    # the *-wildcard with the following meaning:
    #    * at the end: any folder that _start_ with the string
    # e.g.:
    #	antispam_trash_pattern = deleted *;Gel&APY-schte *
    # match any folders that start with "deleted " or "Gelöschte "
    # match is _case_senstive_!
    #
    #	antispam_trash_pattern_ignorecase = deleted *;Gel&APY-schte *
    # match any folders that start with "deleted " or "gelöschte "
    # match is _case_insenstive_, except the non-USASCII letters,
    # "ö" in this example.
    # To match the upper-case Ö, too, you need to add yet another
    # pattern "gel&ANY-schte *", note the different UTF7 encoding:
    # &ANY- instead of &APY-.


    # semicolon-separated list of Trash folders (default unset i.e. none)
    # antispam_trash =
    # antispam_trash = trash;Trash;Deleted Items; Deleted Messages
    # antispam_trash_pattern = trash;Trash;Deleted *
    # antispam_trash_pattern_ignorecase = trash;Deleted *

    # semicolon-separated list of spam folders
    antispam_spam = SPAM
    # antispam_spam_pattern = SPAM
    # antispam_spam_pattern_ignorecase = SPAM

    # semicolon-separated list of unsure folders (default unset i.e. none)
    # antispam_unsure =
    # antispam_unsure_pattern =
    # antispam_unsure_pattern_ignorecase =

    # Whether to allow APPENDing to SPAM folders or not. Must be set to
    # "yes" (case insensitive) to be activated. Before activating, please
    # read the discussion below.
    # antispam_allow_append_to_spam = no

    ###########################
    # BACKEND SPECIFIC OPTIONS
    #

    #===================
    # dspam plugin

    # dspam binary
    antispam_dspam_binary = /usr/bin/dspam

    # semicolon-separated list of extra arguments to dspam
    # (default unset i.e. none)
    # antispam_dspam_args =
    # antispam_dspam_args = --deliver=;--user;%u  # % expansion done by dovecot
    # antispam_dspam_args = --mode=teft

    # Ignore mails where the DSPAM result header contains any of the
    # strings listed in the blacklist
    # (default unset i.e. none)
    # antispam_dspam_result_header = X-DSPAM-Result
    # semicolon-separated list of blacklisted results, case insensitive
    # antispam_dspam_result_blacklist = Virus

    # semicolon-separated list of environment variables to set
    # (default unset i.e. none)
    # antispam_dspam_env =
    # antispam_dspam_env = HOME=%h;USER=%u

    #=====================
    # pipe plugin
    #
    # This plug can be used to train via an arbitrary program that
    # receives the message on standard input. Since sendmail can be
    # such a program, it can be used to send the message to another
    # email address for training there.
    #
    # For example:
    #   antispam_pipe_program = /path/to/mailtrain
    #        (defaults to /usr/sbin/sendmail)
    #   antispam_pipe_program_args = --for;%u
    #   antispam_pipe_program_spam_arg = --spam
    #   antispam_pipe_program_notspam_arg = --ham
    #   antispam_pipe_tmpdir = /tmp
    # will call it, for example, like this:
    #   /path/to/mailtrain --for jberg --spam
    #
    # The old configuration options from when this plugin was called
    # "mailtrain" are still valid, these are, in the same order as
    # above: antispam_mail_sendmail, antispam_mail_sendmail_args,
    # antispam_mail_spam, antispam_mail_notspam and antispam_mail_tmpdir.
    #
    # Alternatively, if you need to give multiple options, you can use
    # the spam_args/notspam_args parameters (which are used in preference
    # of the singular form):
    #   antispam_pipe_program_spam_args = --spam;--my-other-param1
    #   antispam_pipe_program_notspam_args = --ham;--my-other-param2
    # which will then call
    #   /path/to/mailtrain --for jberg --spam --my-other-param1

    # temporary directory
    antispam_pipe_tmpdir = /tmp

    # spam/not-spam argument (default unset which will is not what you want)
    # antispam_pipe_program_spam_arg =
    # antispam_pipe_program_notspam_arg =

    # binary to pipe mail to
    antispam_pipe_program = /usr/sbin/sendmail
    #antispam_pipe_program_args = -f;%u@example.com # % expansion done by dovecot

    #===================
    # crm114 plugin

    # mailreaver binary
    antispam_crm_binary = /bin/false
    # antispam_crm_binary = /usr/share/crm114/mailreaver.crm

    # semicolon-separated list of extra arguments to crm114
    # (default unset i.e. none)
    # antispam_crm_args =
    # antispam_crm_args = --config=/path/to/config

    # semicolon-separated list of environment variables to set
    # (default unset i.e. none)
    # antispam_crm_env =
    # antispam_crm_env = HOME=%h;USER=%u

    # NOTE: you need to set the signature for this backend
    antispam_signature = X-CRM114-CacheID

    #===================
    # spool2dir plugin

    # spam/not-spam spool2dir drop (default unset which will give errors)
    # The first %%lu is replaced by the current time.
    # The second %%lu is replaced by a counter to generate unique names.
    # These two tokens MUST be present in the template! However
    # you can insert any C-style modifier as shown.
    # antispam_spool2dir_spam    = /tmp/spamspool/%%020lu-%u-%%05lus
    # antispam_spool2dir_notspam = /tmp/spamspool/%%020lu-%u-%%05luh
}
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">ALLOWING APPENDS?</h2>
        <div class="sectioncontent">
<p>You should be careful with allowing APPENDs to SPAM folders. The reason for possibly allowing it is to allow not-SPAM --&gt; SPAM transitions to work with offlineimap. However, because with APPEND the plugin cannot know the source of the message, multiple bad scenarios can happen:</p>
<dl class='dl-vertical'>
  <dt>
     1.
  </dt>
  <dd>
    <p>SPAM --&gt; SPAM transitions cannot be recognised and are trained</p>
  </dd>
  <dt>
     2.
  </dt>
  <dd>
    <p>the same holds for Trash --&gt; SPAM transitions</p>
  </dd>

</dl>
<p>Additionally, because we cannot recognise SPAM --&gt; not-SPAM transitions, training good messages will never work with APPEND.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHORS</h2>
        <div class="sectioncontent">
<p>Johannes Berg, Frank Cusack, Benedikt Boehm, Andreas Schneider</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="doveadm-search-query.7.html"><span aria-hidden="true">&larr;</span> doveadm-search-query.7: Overview of search queries for doveadm mailbox  commands</a></li>
   <li class="next"><a href="dpatch.7.html">dpatch.7: Self applying patch <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
