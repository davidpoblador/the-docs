<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>localmailfilter: Local mail filtering</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Local mail filtering">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="localmailfilter (7) manual">
  <meta name="twitter:description" content="Local mail filtering">
  <meta name="twitter:image" content="https://www.carta.tech/images/courier-mta-localmailfilter-7.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man7/localmailfilter.7.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="localmailfilter (7) manual" />
  <meta property="og:description" content="Local mail filtering" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/courier-mta-localmailfilter-7.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">localmailfilter<small> (7)</small></h1>
        <p class="lead">Local mail filtering</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man7/">
      <span itemprop="name">Miscellaneous</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man7/localmailfilter.7.html">
      <span itemprop="name">localmailfilter: Local mail filtering</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/courier-mta/">
      <span itemprop="name">courier-mta</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man7/localmailfilter.7.html">
      <span itemprop="name">localmailfilter: Local mail filtering</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
echo /usr/bin/maildrop &gt;/etc/courier/maildropfilter

mkdir $HOME/.mailfilters

vi $HOME/.mailfilters/rcptfilter $HOME/.mailfilters/rcptfilter-ext

vi $HOME/.mailfilters/smtpfilter $HOME/.mailfilters/smtpfilter-ext

chmod 700 $HOME/.mailfilters

chmod 600 $HOME/.mailfilters/*
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>The <strong>maildrop</strong> mail filter can be used by the Courier mail server as a mail filtering engine, rejecting unwanted mail on a per-recipient basis.</p><p>The actual filtering interface used by the Courier mail server does not really require that <strong>maildrop</strong> must be used as a mail filtering engine, it just so happens that <strong>maildrop</strong> has a compatible interface that can be used right out of the box. The following brief information can be used to craft a homebrewed mail filter to take <strong>maildrop</strong>&apos;s place.</p><p>The local mail filter only works for addresses that correspond to local accounts. This filtering is not used if the recipient is a remote address on another mail server. The local mail filter is disabled by default. To enable local mail filtering you will need to initialize the /etc/courier/maildropfilter configuration file to contain the pathname to your local mail filter.</p><p>Local mail filtering is performed in two distinct phases:</p><p>Recipient filters</p><p>When the Courier mail server receives an address naming a local mail recipient, the local mail recipient&apos;s mail filter is executed before the Courier mail server acknowledges the address. The local mail filter tells the Courier mail server whether to: A) accept message unconditionally - the message is whitelisted; B) reject the message unconditionally - the Courier mail server tells the other mail server that the recipient address is invalid; or C) accept this recipient, but run the content mail filter, once the message&apos;s contents are available.</p><p>Content filters</p><p>After receiving the contents of the message, the mail filter is executed again for any recipients whose recipient filters used the third option. The content filter can now examine the contents of the message, and indicate whether the message should be accepted or rejected. Content filtering is not available for alias addresses.</p><p>It should be noted that mail filtering is executed as an integral part of receiving a message from a remote mail server. If the message is rejected, the Courier mail server refuses to accept the message for delivery.</p><p>The local mail filter will be invoked as follows:</p>
<pre>
HOME=$HOME FILTER -D <em>uid/gid</em> -M <em>filter</em>
</pre>
<p>The local mail filter will NOT be invoked as root, so if it needs to access files in the recipient&apos;s account, it must be installed setuid to root (as <strong>maildrop</strong> is installed by default).</p><p>"<em>uid/gid</em>" is the recipient account&apos;s system userid and group id, respectively. The recipient account&apos;s home directory is placed in the <strong>HOME</strong> environment variable, prior to running <em>FILTER</em>, and "<em>filter</em>" is set as follows:</p><p>rcptfilter</p><p>The mail filter is invoked initially when the remote mail server specifies this address as a recipient. <em>FILTER</em> should terminate with one of the following exit codes: 0 - this sender is acceptable; 99 - this sender is acceptable, but I want to run the content filter for this the message; any other non-zero exit code - the sender is not acceptable, reject the message.</p><p>smtpfilter</p><p>If <em>FILTER</em> terminates with exit code <strong>99</strong>, <em>FILTER</em> runs again with this parameter set to the word smtpfilter. FILTER will be invoked once the message has been received from the remote mail server, but not yet acknowledged. If <em>FILTER</em> terminates with a non-zero exit code, the message is rejected. If <em>FILTER</em> terminated with the exit code of zero, the message is accepted.</p><p>rcptfilter-<em>ext</em>, smtpfilter-<em>ext</em></p><p>If the recipient created sub-addresses - see \m[blue]<strong></strong><a href="../man5/dot-courier.5.html"><strong>dot-courier</strong>(5)</a>\m[]\s-2\u[1]\d\s+2 - a dash followed by the subaddress "ext" is appended to the name of the filter.</p><p>rcptfilter-alias-<em>ext</em></p><p>This is how <em>FILTER</em> gets invoked if the address is a locally defined mail alias (ext is the alias name).</p><p>The rcptfilter invocation must terminate with a zero exit code when the message originates from a mailing list or any other source that should be considered as "whitelisted". This filtering model does not fit very well with some mail transfer protocols, so unless trusted sources are explicitly declared to be whitelisted, there is a remote possibility that the recipient will be removed from a mailing list because of a poorly-written mail filter from some other recipient of the same message. The 0 return exit code (which is the implied default if no mail filtering is installed) protects the recipient from being adversely affected, in any way, by anyone else&apos;s mail filter.</p><p>The mail filters may print a diagnostic message before rejecting a message. The diagnostic message will be returned to the sending mail relay, where possible.</p><p>The mail filters inherit environment variables that describe the incoming mail. The following environment variables are provided by default:</p><p><strong>SENDER</strong></p><p>The return address on the message.</p><p><strong>TCPREMOTEHOST</strong>, <strong>TCPREMOTEIP</strong></p><p>When the message is received via ESMTP, these variables specify the remote IP address and the corresponding hostname. Hostname is empty if the IP address does not have a reverse DNS record, or is set to "softdnserr" if there was a temporary failure while looking up this IP address.</p><p><strong>BLOCK2</strong></p><p>The default the Courier mail server configuration sets this environment variable if the remote IP address is listed in an unsecured relay blacklist. See /etc/courier/esmtpd for more information. Other environment variables may also be available. For mail received via ESMTP, environment variables are usually set in the /etc/courier/smtpaccess configuration file.</p><h3>maildrop implementation</h3>
<p>Maildrop implements this mail filtering API as follows:</p><p>$HOME/.mailfilters</p><p>This directory contains the filtering recipes. This directory, and its contents, cannot have any group or world permissions.</p><p>smtpfilter*, rcptfilter*</p><p>These mail filtering recipes directly correspond to the events defined in the previous section. Maildrop&apos;s "import" statement can be used to gain access to the environment variables (these mail filters are executed in <strong>maildrop</strong>&apos;s embedded mode). The mail filtering recipes can set the <strong>EXITCODE</strong> variable appropriately before terminating, in order to accept or reject the message.</p><p>See \m[blue]<strong></strong><a href="../man1/maildrop.1.html"><strong>maildrop</strong>(1)</a>\m[]\s-2\u[2]\d\s+2 for more information.</p>
<h3>Filtering mail to aliases</h3>
<p>The /etc/courier/aliases configuration file is used to mail aliases, see \m[blue]<strong></strong><a href="../man8/makealiases.8.html"><strong>makealiases</strong>(8)</a>\m[]\s-2\u[3]\d\s+2. The system administrator may set aside a reserved local account that will be used to specify a local mail filter for messages addressed to aliases. The configuration file /etc/courier/aliasfilteracct specifies the home directory of the mail account that will be used to filter alias recipients.</p><p>For example, if /etc/courier/aliasfilteracct contains /home/admin, then the Courier mail server runs the mail filter as follows:</p>
<pre>
HOME=/home/admin FILTER -D <em>uid/gid</em> -M rcptfilter-alias-<em>name</em>
</pre>
<p>Here, "uid/gid" is owner uid and gid of the specified directory NOTE: "name" is a fully qualified address, and the local aliases listed in /etc/courier/aliases do not typically include the domain name. If defines an alias called "system", for example, the <strong>-M</strong> option will probably be "system@example.com", if example.com is the contents of /etc/courier/me configuration file.</p><p>Unfortunately, currently it is not possible to specify content filters (a.k.a. smtpfilters) for aliases, only recipient filters.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">FILES</h2>
        <div class="sectioncontent">
<p>/etc/courier/maildropfilter</p><p>Local mail filtering engine.</p><p>/etc/courier/aliasfilteracct</p><p>Account that is used to filter mail to aliases.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO localmailfilter&hellip;</h2>
        <div class="sectioncontent">
<p>\m[blue]<strong></strong><a href="../man8/courierfilter.8.html"><strong>courierfilter</strong>(8)</a>\m[]\s-2\u[4]\d\s+2, \m[blue]<strong></strong><a href="../man1/maildrop.1.html"><strong>maildrop</strong>(1)</a>\m[]\s-2\u[2]\d\s+2.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p><strong>Sam Varshavchik</strong></p><p>Author</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">NOTES</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
     1.
  </dt>
  <dd>
    <p><a href="../man5/dot-courier.5.html"><strong>dot-courier</strong>(5)</a></p><p>[set $man.base.url.for.relative.links]/dot-courier.html</p>
  </dd>
  <dt>
     2.
  </dt>
  <dd>
    <p><a href="../man1/maildrop.1.html"><strong>maildrop</strong>(1)</a></p><p>[set $man.base.url.for.relative.links]/maildrop.html</p>
  </dd>
  <dt>
     3.
  </dt>
  <dd>
    <p><a href="../man8/makealiases.8.html"><strong>makealiases</strong>(8)</a></p><p>[set $man.base.url.for.relative.links]/makealiases.html</p>
  </dd>
  <dt>
     4.
  </dt>
  <dd>
    <p><a href="../man8/courierfilter.8.html"><strong>courierfilter</strong>(8)</a></p><p>[set $man.base.url.for.relative.links]/courierfilter.html</p>
  </dd>

</dl>

        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="locale.7.html"><span aria-hidden="true">&larr;</span> locale.7: Description of multilanguage support</a></li>
   <li class="next"><a href="lutefisk-doc.7.html">lutefisk-doc.7: Software for the de novo interpretation of peptide cid spectra (documentation) <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
