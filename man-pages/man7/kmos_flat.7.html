<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>kmos_flat: Create master flatfield frame and badpixel map</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Create master flatfield frame and badpixel map">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="kmos_flat (7) manual">
  <meta name="twitter:description" content="Create master flatfield frame and badpixel map">
  <meta name="twitter:image" content="https://www.carta.tech/images/cpl-plugin-kmos-doc-kmos_flat-7.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man7/kmos_flat.7.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="kmos_flat (7) manual" />
  <meta property="og:description" content="Create master flatfield frame and badpixel map" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/cpl-plugin-kmos-doc-kmos_flat-7.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">kmos_flat<small> (7)</small></h1>
        <p class="lead">Create master flatfield frame and badpixel map</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man7/">
      <span itemprop="name">Miscellaneous</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man7/kmos_flat.7.html">
      <span itemprop="name">kmos_flat: Create master flatfield frame and badpixel map</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/cpl-plugin-kmos-doc/">
      <span itemprop="name">cpl-plugin-kmos-doc</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man7/kmos_flat.7.html">
      <span itemprop="name">kmos_flat: Create master flatfield frame and badpixel map</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p>esorex <strong>kmos_flat</strong> [OPTIONS] FILE.sof</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>This recipe creates the master flat field and calibration frames needed for spatial calibration for all three detectors. It must be called after the kmo_dark-recipe, which generates a bad pixel mask (badpixel_dark.fits). The bad pixel mask will be updated in this recipe.</p><p>As input at least 3 dark frames, 3 frames with the flat lamp on are recommended. Additionally a badpixel mask from kmo_dark is required.</p><p>The badpixel mask contains 0 for bad pixels and 1 for good ones.</p><p>The structure of the resulting xcal and ycal frames is quite complex since the arrangement of the IFUs isn\'t just linear on the detector. Basically the integer part of the calibration data shows the offset of each pixels centre in mas (Milli arcsec) from the field centre. The viewing of an IFU is 2800 mas (14pix*0.2arcsec/pix). So the values in these two frames will vary between +/-1500 (One would expect 1400, but since the slitlets aren\'t expected to be exactly vertical, the values can even go up to around 1500).</p><p>Additionally in the calibration data in y-direction the decimal part of the data designates the IFU to which the slitlet corresponds to (for each detector from 1 to 8).</p><p>Because of the irregular arrangement of the IFUs not all x-direction calibration data is found in xcal and similarly not all y-direction calibration data is located in ycal. For certain IFUs they are switched  and/or flipped in x- or y-direction: For IFUs 1,2,3,4,13,14,15,16:  x- and y- data is switched For IFUs 17,18,19,20:          y-data is flipped For IFUs 21,22,23,24:          x-data is flipped For IFUs 5,6,7,8,9,10,11,12:   x- and y- data is switched and</p>
<pre>
                               x- and y- data is flipped
</pre>
<p>Furthermore frames can be provided for several rotator angles. In this case the resulting calibration frames for each detector are repeatedly saved as extension for every angle.</p><p>Advanced features: ------------------ To create the badpixel mask the edges of all slitlets are fitted to a polynomial. Since it can happen that some of these fits (3 detectors 8 IFUs * 14slitlets * 2 edges  (left and right edge of slitlet)= 672 edges) fail, the fit parameters are themselves fitted again to detect any outliers.</p><p>By default, the parameters of all left and all right edges are grouped individually and then fitted using chebyshev polynomials. The advantage of a chebyshev polynomial is, that it consists in fact of a series of orthogonal polynomials. This implies that the parameters of the polynomials are independent. This fact predestines the use of chebyshev polynomials for our case. So each individual parameter can be examined independently.</p><p>The reason why the left and right edges are fitted individually is that there is a systematic pattern specific to these groups. The reason for this pattern is probably to be found in the optical path the light is traversing.</p><p>The behaviour of this fitting step can be influenced via environment parameters: * KF_ALLPARS (default: 1)</p>
<pre>
  When set to 1 all coefficients of the polynomial of an edge are to be
  corrected, also when just one of these coefficients is an outlier. When
  set to 0 only the outlier is to be corrected.
</pre>
<p>* KF_CH (default: 1)</p>
<pre>
  When set to 1 chebyshev polynomials are used to fit the fitted parameters.
</pre>

<pre>
  When set to 0 normal polynomials are used.
</pre>
<p>* KF_SIDES (default: 2)</p>
<pre>
  This variable can either be set to 1 or 2. When set to 2 the left and
  right edges are examined individually. When set to 1 all edges are
  examined as one group.
</pre>
<p>* KF_FACTOR(default: 4)</p>
<pre>
  This factor defines the threshold factor. All parameters deviating
  KF_FACTOR*stddev are to be corrected
</pre>
<h3>BASIC PARAMETERS</h3>
<p>--badpix_thresh The threshold level to mark pixels as bad on the dark subtracted frames [%] --surrounding_pixels The amount of bad pixels to surround a specific pixel, to let it be marked bad as well.</p><p>--cmethod Following methods of frame combination are available:</p>
<pre>
   * \'ksigma\' (Default)
   An iterative sigma clipping. For each position all pixels in the
   spectrum are examined. If they deviate significantly, they will be
   rejected according to the conditions:
       val &gt; mean + stdev * cpos_rej
   and
       val &lt; mean - stdev * cneg_rej
   where --cpos_rej, --cneg_rej and --citer are the configuration
   parameters. In the first iteration median and percentile level are used.
</pre>

<pre>
   * \'median\'
   At each pixel position the median is calculated.
</pre>

<pre>
   * \'average\'
   At each pixel position the average is calculated.
</pre>

<pre>
   * \'sum\'
   At each pixel position the sum is calculated.
</pre>

<pre>
   * \'min_max\'
   The specified number of min and max pixel values will be rejected.
</pre>

<pre>
   --cmax and --cmin apply to this method.
</pre>

<h3>ADVANCED PARAMETERS</h3>
<p>--cpos_rej --cneg_rej --citer see --cmethod=\'ksigma\'</p><p>--cmax --cmin see --cmethod=\'min_max\'</p><p>--suppress_extension If set to TRUE, the arbitrary filename extensions are supressed. If multiple products with the same category are produced, they will be numered consecutively starting from 0.</p>
<pre>
  Input files:
   DO CATG           Type   Explanation                    Required #Frames
   -------           -----  -----------                    -------- -------
   FLAT_ON           RAW    Flatlamp-on exposures             Y       1-n
                            (at least 3 frames recommended)
   FLAT_OFF          RAW    Flatlamp-off exposures            Y       1-n
                            (at least 3 frames recommended)
   BADPIXEL_DARK     B2D    Bad pixel mask                    Y        1
</pre>

<pre>
  Output files:
   DO CATG           Type   Explanation
   -------           -----  -----------
   MASTER_FLAT       F2D    Normalised flat field
                            (6 extensions: alternating data & noise
   BADPIXEL_FLAT     B2D    Updated bad pixel mask (3 Extensions)
   XCAL              F2D    Calibration frame 1 (3 Extensions)
   YCAL              F2D    Calibration frame 2 (3 Extensions)
   FLAT_EDGE         F2L    Frame containing parameters of fitted
                            slitlets of all IFUs of all detectors
</pre>


        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OPTIONS</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    <p><strong>--badpix_thresh</strong> <em>&lt;long&gt;</em></p>
  </dt>
  <dd>
    <p>The threshold level to mark bad pixels [%]. (long; default: 35). The full name of this option for the EsoRex configuration file is <strong>kmos.kmos_flat.badpix_thresh</strong> [default = <em>35</em>].</p>
  </dd>
  <dt>
    <p><strong>--surrounding_pixels</strong> <em>&lt;long&gt;</em></p>
  </dt>
  <dd>
    <p>The nb of bad surrounding pix to mark a pixel bad (long; default: 5). The full name of this option for the EsoRex configuration file is <strong>kmos.kmos_flat.surrounding_pixels</strong> [default = <em>5</em>].</p>
  </dd>
  <dt>
    <p><strong>--suppress_extension</strong> <em>&lt;bool&gt;</em></p>
  </dt>
  <dd>
    <p>Suppress arbitrary filename extension (bool; default: False). The full name of this option for the EsoRex configuration file is <strong>kmos.kmos_flat.suppress_extension</strong> [default = <em>False</em>].</p>
  </dd>
  <dt>
    <p><strong>--cmethod</strong> <em>&lt;str&gt;</em></p>
  </dt>
  <dd>
    <p>Apply "average", "median", "sum", "min_max." or "ksigma". (str; default: \'ksigma\'). The full name of this option for the EsoRex configuration file is <strong>kmos.kmos_flat.cmethod</strong> [default = <em>ksigma</em>].</p>
  </dd>
  <dt>
    <p><strong>--cpos_rej</strong> <em>&lt;float&gt;</em></p>
  </dt>
  <dd>
    <p>The positive rejection threshold for kappa-sigma-clipping (sigma). (float; default: 3.0). The full name of this option for the EsoRex configuration file is <strong>kmos.kmos_flat.cpos_rej</strong> [default = <em>3.0</em>].</p>
  </dd>
  <dt>
    <p><strong>--cneg_rej</strong> <em>&lt;float&gt;</em></p>
  </dt>
  <dd>
    <p>The negative rejection threshold for kappa-sigma-clipping (sigma). (float; default: 3.0). The full name of this option for the EsoRex configuration file is <strong>kmos.kmos_flat.cneg_rej</strong> [default = <em>3.0</em>].</p>
  </dd>
  <dt>
    <p><strong>--citer</strong> <em>&lt;long&gt;</em></p>
  </dt>
  <dd>
    <p>The number of iterations for kappa-sigma-clipping. (long; default: 3). The full name of this option for the EsoRex configuration file is <strong>kmos.kmos_flat.citer</strong> [default = <em>3</em>].</p>
  </dd>
  <dt>
    <p><strong>--cmax</strong> <em>&lt;long&gt;</em></p>
  </dt>
  <dd>
    <p>The number of maximum pixel values to clip with min/max-clipping. (long; default: 1). The full name of this option for the EsoRex configuration file is <strong>kmos.kmos_flat.cmax</strong> [default = <em>1</em>].</p>
  </dd>
  <dt>
    <p><strong>--cmin</strong> <em>&lt;long&gt;</em></p>
  </dt>
  <dd>
    <p>The number of minimum pixel values to clip with min/max-clipping. (long; default: 1). The full name of this option for the EsoRex configuration file is <strong>kmos.kmos_flat.cmin</strong> [default = <em>1</em>].</p>
  </dd>
  <dt>
    <p><strong>--det</strong> <em>&lt;long&gt;</em></p>
  </dt>
  <dd>
    <p>Only reduce the specified detector (long; default: 0). The full name of this option for the EsoRex configuration file is <strong>kmos.kmos_flat.detector</strong> [default = <em>0</em>].</p>
  </dd>
  <dt>
    <p><strong>--angle</strong> <em>&lt;float&gt;</em></p>
  </dt>
  <dd>
    <p>Only reduce the specified angle (float; default: 370.0). The full name of this option for the EsoRex configuration file is <strong>kmos.kmos_flat.angle</strong> [default = <em>370.0</em>].</p>
  </dd>

</dl>
<p>Note that it is possible to create a configuration file containing these options, along with suitable default values. Please refer to the details provided by the 'esorex --help' command.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO kmos_flat&hellip;</h2>
        <div class="sectioncontent">
<p>The full documentation for the kmos pipeline can be downloaded as a PDF file using the following URL:</p><ul>
<li><p><strong>ftp://ftp.eso.org/pub/dfs/pipelines/kmos/kmos-pipeline-manual-2.9.pdf</strong></p></li>
</ul><p>An overview over the existing ESO pipelines can be found on the web page <strong>http://www.eso.org/sci/software/pipelines/</strong>.</p><p>Basic documentation about the EsoRex program can be found at the esorex (1) man page.</p><p>It is possible to call the pipelines from python using the python-cpl package. See <strong>http://packages.python.org/python-cpl/index.html</strong> for further information.</p><p>The other recipes of the kmos pipeline are <a href="../man7/kmo_copy.7.html"><strong>kmo_copy</strong>(7)</a>, <a href="../man7/kmo_fits_check.7.html"><strong>kmo_fits_check</strong>(7)</a>, <a href="../man7/kmo_sci_red.7.html"><strong>kmo_sci_red</strong>(7)</a>, <a href="../man7/kmo_fits_stack.7.html"><strong>kmo_fits_stack</strong>(7)</a>, <a href="../man7/kmo_noise_map.7.html"><strong>kmo_noise_map</strong>(7)</a>, <a href="../man7/kmo_rotate.7.html"><strong>kmo_rotate</strong>(7)</a>, <a href="../man7/kmo_extract_spec.7.html"><strong>kmo_extract_spec</strong>(7)</a>, <a href="../man7/kmo_multi_reconstruct.7.html"><strong>kmo_multi_reconstruct</strong>(7)</a>, <a href="../man7/kmo_sky_tweak.7.html"><strong>kmo_sky_tweak</strong>(7)</a>, <a href="../man7/kmo_shift.7.html"><strong>kmo_shift</strong>(7)</a>, <a href="../man7/kmos_gen_reflines.7.html"><strong>kmos_gen_reflines</strong>(7)</a>, <a href="../man7/kmo_stats.7.html"><strong>kmo_stats</strong>(7)</a>, <a href="../man7/kmo_arithmetic.7.html"><strong>kmo_arithmetic</strong>(7)</a>, <a href="../man7/kmos_dark.7.html"><strong>kmos_dark</strong>(7)</a>, <a href="../man7/kmo_fits_strip.7.html"><strong>kmo_fits_strip</strong>(7)</a>, <a href="../man7/kmo_combine.7.html"><strong>kmo_combine</strong>(7)</a>, <a href="../man7/kmo_std_star.7.html"><strong>kmo_std_star</strong>(7)</a>, <a href="../man7/kmo_illumination_flat.7.html"><strong>kmo_illumination_flat</strong>(7)</a>, <a href="../man7/kmo_make_image.7.html"><strong>kmo_make_image</strong>(7)</a>, <a href="../man7/kmo_fit_profile.7.html"><strong>kmo_fit_profile</strong>(7)</a>, <a href="../man7/kmo_sky_mask.7.html"><strong>kmo_sky_mask</strong>(7)</a>, <a href="../man7/kmos_illumination.7.html"><strong>kmos_illumination</strong>(7)</a>, <a href="../man7/kmos_wave_cal.7.html"><strong>kmos_wave_cal</strong>(7)</a>, <a href="../man7/kmo_reconstruct.7.html"><strong>kmo_reconstruct</strong>(7)</a></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">VERSION</h2>
        <div class="sectioncontent">
<p>kmos_flat 1.3.5</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Alex Agudo Berbel, Yves Jung &lt;usd-help@eso.org&gt;</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BUG REPORTS</h2>
        <div class="sectioncontent">
<p>Please report any problems to usd-help@eso.org. Alternatively, you may send a report to the ESO User Support Department &lt;usd-help@eso.org&gt;.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">LICENSE</h2>
        <div class="sectioncontent">
<p>This file is part of the CRIRES Instrument Pipeline Copyright (C) 2002,2003 European Southern Observatory</p><p>This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</p><p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.</p><p>You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="kmos_dark.7.html"><span aria-hidden="true">&larr;</span> kmos_dark.7: Create master dark frame & bad pixel mask</a></li>
   <li class="next"><a href="kmos_gen_reflines.7.html">kmos_gen_reflines.7: Create reflines calibration file <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
