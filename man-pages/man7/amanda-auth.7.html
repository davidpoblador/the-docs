<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>amanda-auth: Communication/authentication methods between amanda server and client</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Communication/authentication methods between amanda server and client">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="amanda-auth (7) manual">
  <meta name="twitter:description" content="Communication/authentication methods between amanda server and client">
  <meta name="twitter:image" content="https://www.carta.tech/images/amanda-common-amanda-auth-7.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man7/amanda-auth.7.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="amanda-auth (7) manual" />
  <meta property="og:description" content="Communication/authentication methods between amanda server and client" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/amanda-common-amanda-auth-7.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">amanda-auth<small> (7)</small></h1>
        <p class="lead">Communication/authentication methods between amanda server and client</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man7/">
      <span itemprop="name">Miscellaneous</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man7/amanda-auth.7.html">
      <span itemprop="name">amanda-auth: Communication/authentication methods between amanda server and client</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/amanda-common/">
      <span itemprop="name">amanda-common</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man7/amanda-auth.7.html">
      <span itemprop="name">amanda-auth: Communication/authentication methods between amanda server and client</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>Amanda offers 7 methods of communication between Amanda server (sometimes also called the tape server) and clients, each with its own authentication method. The desired communication method is specified by the <em>auth</em> parameter in the amanda.conf file (<a href="../man5/amanda.conf.5.html"><strong>amanda.conf</strong>(5)</a>) commonly as a dumptype. Valid values to the <em>auth</em> parameter are <strong>bsd</strong>, <strong>bsdudp</strong>, <strong>bsdtcp</strong>, <strong>krb5</strong>, <strong>local</strong>, <strong>rsh</strong>, and <strong>ssh</strong>. The authentication and communication method is used during the backup process <strong>amdump</strong> (<a href="../man8/amdump.8.html"><strong>amdump</strong>(8)</a>) as well as the recovery process <strong>amrecover</strong> (<a href="../man8/amrecover.8.html"><strong>amrecover</strong>(8)</a>).</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COMPILATION AND GENERAL INFORMATION</h2>
        <div class="sectioncontent">
<p>The communication method and thus type of authentication that will be used by the Amanda server is specified by the <em>auth</em> parameter in the dumptype for each disklist entry (DLE). The <em>auth</em> parameter thus may be easily and globally specified in the "global" dumptype. If <em>auth</em> is not specified, the <strong>bsdtcp</strong> communication method is used. See <a href="../man5/amanda.conf.5.html"><strong>amanda.conf</strong>(5)</a> for more information on Amanda configuration and dumptypes, and <a href="../man5/disklist.5.html"><strong>disklist</strong>(5)</a> for more information on disklists.</p><p>On the client side, the Amanda daemon <strong>amandad</strong> validates the connection depending on the value of the <strong>auth</strong> argument passed to it (see <a href="../man8/amanda.8.html"><strong>Amanda</strong>(8)</a>). Also, when it comes to recovery, the <strong>auth</strong> parameter can be specified in the <a href="../man5/amanda-client.conf.5.html"><strong>amanda-client.conf</strong>(5)</a> file to specify the communication method to be used by the client to the server.</p><p>When Amanda is being built from source code, desired communication and thus authentication methods (shown as "Authentication") must be specified as configure options at compilation time.</p>
<pre>
Authentication	  Configure option(s)
 bsd			--with-bsd-security      --with-amandahosts (pre-2.6)
 bsdtcp		--with-bsdtcp-security   --with-amandahosts (pre-2.6)
 bsdudp		--with-bsdudp-security   --with-amandahosts (pre-2.6)
 krb5		--with-krb5-security
 local		 (always included)
 rsh			--with-rsh-security
 ssh			--with-ssh-security
</pre>
<p>There are additional configure options for <strong>bsd</strong>, <strong>bsdudp</strong>, and <strong>bsdtcp</strong> to allow for specifying explicit UDP and TCP port ranges.</p>
<pre>
   --with-udpportrange
   --with-tcpportrange
   --with-low-tcpportrange
</pre>
<p>See <strong>PORT USAGE</strong> below for more information.</p><p>There are additional configure options for Kerberos if you so desire. All but the last option are for Kerberos 4. Defaults shown in square brackets.</p>
<pre>
   --with-server-principal=ARG    server host principal  [amanda]
   --with-server-instance=ARG     server host instance   []
   --with-server-keyfile=ARG      server host key file   [/.amanda]
   --with-client-principal=ARG    client host principal  [rcmd]
   --with-client-instance=ARG     client host instance   [HOSTNAME_INSTANCE]
   --with-client-keyfile=ARG      client host key file   [KEYFILE]
   --with-ticket-lifetime=ARG     ticket lifetime        [128]
   --with-krb5-security=DIR       where libkrb.a lives   [see below]
</pre>
<p>If configuring with --with-krb5-security, the configure script will search under /usr/kerberos/lib, /usr/cygnus/lib, /usr/lib, and /opt/kerberos/lib for the kerberos bits, libkrb.a, in this order. Kerberos support will not be added if it does not find them. If the kerberos bits are found under some other hierarchy, you can specify this via --with-krb5-security=DIR where DIR is where the kerberos bits live. The configure script will then look in the &apos;lib&apos; directory under this hierarchy for libkrb.a.</p><p>The <strong>auth</strong> parameter selects a communication/authentication method to use between the client and the backup server. These methods are described each in their own section below.</p><h3>Usernames</h3>
<p>When Amanda is built, a username is specified with the <strong>--with-user</strong> option. Most Amanda processes run under this user&apos;s identity, to minimize security risks. In binary distributions, this username is usually one of &apos;amanda&apos;, &apos;backup&apos;, or &apos;backup&apos;. The examples below use &apos;backup&apos; since it is unambiguous. You may need to adjust accordingly for your system.</p>
<h3>Authenticated Peer Hostnames</h3>
<p>Amanda&apos;s authentication mechanisms provide an authenticated hostname of the system on the other end of the connection, which is used to restrict access to only particular hosts. The degree of "authentication" performed on this hostname varies with the authentication mechanism, and is discussed below.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BSD, BSDUDP, AND BSDTCP COMMUNICATION AND AUTHENTICATION</h2>
        <div class="sectioncontent">
<p>For additional information including example configurations, see http://wiki.zmanda.com/index.php/Configuring_bsd/bsdudp/bsdtcp_authentication.</p><p>The <strong>bsd</strong>, <strong>bsdudp</strong>, and <strong>bsdtcp</strong> communication methods use either UDP, TCP, or both protocols operating as a network service to authenticate and exchange data between server and clients.</p><p>The authentication proceeds as follows: for a new, incoming connection, Amanda verifies that the source port is in the reserved range (less than 1024), which for UNIX hosts suggests that the remote user has root privileges. Amanda then verifies that the reverse DNS for the remote address matches the forward DNS; that is, that the address maps to a hostname which maps back to the same address. Finally, the remote system must provide a username that matches the username in .amandahosts.</p><p>In addition to compilation and general configuration (see <strong>COMPILATION AND GENERAL INFORMATION</strong> above), the authentication method that the client is configured to receive is specified by the <strong>auth</strong> parameter in the network service configuration for Amanda. The authentication method used by an Amanda client to reach the server during recovery is the authentication method specified by the <em>auth</em> parameter in the client&apos;s Amanda network service configuration or in its amanda-client.conf file (see <a href="../man5/amanda-client.conf.5.html"><strong>amanda-client.conf</strong>(5)</a>).</p><p>By default, Amanda use the "amanda" service name and associated port set in /etc/services. It can be changed by setting the dumptype <em>client-port</em> option to a different port number or a different service name. All examples are for the service name "amanda" that uses the default port 10080.</p><h3>.amandahosts file</h3>
<p>Servers and clients using the bsd, bsdudp, and bsdtcp authentication methods refer to the .amandahosts file to control access. Amanda should be compiled for this access control if one of these methods will be used and is the default compilation option for Amanda 2.6 (use --with-amandahosts when compiling pre-2.6 versions of Amanda).</p><p>Amanda looks for the .amandahosts file in the Amanda user&apos;s home directory, commonly /var/lib/amanda.</p><p>Each authorization is on its own line in the following format</p><p><em>hostname</em> [ <em>username</em> [ <em>service...</em> ] ]</p><p>If <em>username</em> is omitted, it defaults to the user running <strong>amandad</strong>, i.e. the user listed in the <strong>inetd</strong> or <strong>xinetd</strong> configuration file.</p><p><em>service...</em> is a space-delimited list of services the client is authorized to execute: <strong>noop</strong>, <strong>selfcheck</strong>, <strong>sendsize</strong>, <strong>sendbackup</strong>, <strong>amdump</strong> (a shortcut for the previous four services which are required on clients), <strong>amindexd</strong>, and <strong>amidxtaped</strong>. The last two services are required on a server for clients to connect to it using <strong>amrecover</strong>.</p><p>If service is omitted, it defaults to <strong>noop selfcheck sendsize sendbackup</strong> (which is equivalent to <strong>amdump</strong>).</p><p>Example of the .amandahosts file on an Amanda client, where &apos;backup&apos; is the Amanda dumpuser.</p>
<pre>
    <strong>amandaserver.example.com   backup   amdump</strong>
</pre>
<p>Example of the .amandahosts file on an Amanda server</p>
<pre>
    <strong>amandaclient1.example.com   root   amindexd amidxtaped</strong>
</pre>

<h3>bsd communication and authentication</h3>
<p>The authentication is done using .amandahosts file in the Amanda user&apos;s home directory. The protocol between Amanda server and client is UDP. The number of disk list entries (DLEs)--number of Amanda clients--is limited by the UDP packet size. This authentication protocol will use a different port for each data stream (see PORT USAGE below)</p>
<h3>bsdudp communication and authentication</h3>
<p>The authentication is done using .amandahosts files in the Amanda user&apos;s home directory. It uses UDP protocol between Amanda server and client for data and hence the number of DLEs is limited by the UDP packet size. It uses one TCP port to establish the connection and multiplexes all data streams using one port on the server (see PORT USAGE below).</p>
<h3>bsdtcp communication and authentication</h3>
<p>The authentication is done using .amandahosts files in the backup user&apos;s (for example: backup) home directory. It uses TCP protocol between Amanda server and client. On the client, two reserved ports are used. On the server, all data streams are multiplexed to one port (see PORT USAGE below).</p>
<h3>USING INETD SERVER</h3>
<p>Template for Amanda client inetd service entry</p>
<pre>
<em>   service_name</em> <em>socket_type</em> <em>protocol</em> <em>wait/nowait</em> <em>amanda_backup_user</em> <em>absolute_path_to_amandad</em> amandad <em>server_args</em>
</pre>
<p>Client example of using <strong>bsd</strong> authorization for inetd server given Amanda user is "backup":</p>
<pre>
<strong>   amanda dgram udp wait backup /path/to/amandad amandad -auth=bsd amdump</strong>
</pre>
<p>The same could be used for <strong>bsdudp</strong> if specifying -auth=bsdudp instead of -auth=bsd.</p><p>Client example of using <strong>bsdtcp</strong> authorization for inetd server given Amanda user is "backup":</p>
<pre>
<strong>   amanda stream tcp nowait backup /path/to/amandad amandad -auth=bsdtcp amdump</strong>
</pre>
<p><strong>amindexd</strong> and <strong>amidxtaped</strong> would typically be added at the end of the line as <strong>amandad</strong> server arguments for an Amanda server.</p><p>Server example of using <strong>bsdtcp</strong> authorization for inetd server given Amanda user is "backup":</p>
<pre>
<strong>   amanda stream tcp nowait backup /path/to/amandad amandad -auth=bsdtcp amdump amindexd amidxtaped</strong>
</pre>
<p>For Amanda version 2.5.0 and earlier, remember that neither <strong>bsdudp</strong> nor <strong>bsdtcp</strong> are supported and the Amanda daemon <strong>amandad</strong> accepts no arguments. Because of the latter, <strong>amrecover</strong> as of Amanda version 2.5.1 is not compatible with 2.5.0 and earlier servers. Thus, servers that are 2.5.0 or earlier must, in addition to the <em>amanda</em> service, run <em>amindexd</em> and <em>amidxtaped</em> Amanda services as their own network services, amandaidx and amidxtape, respectively (see below).</p><p>There are no compatibility issues if server and clients are all 2.5.0 or earlier. If your server is 2.5.1 or later, you can still have clients that are 2.5.0 and earlier although you must then use <strong>bsd</strong> communication/authentication with these clients and must also run <em>amindexd</em> and <em>amidxtaped</em> Amanda services on the server as their own network services, amandaidx and amidxtape, respectively (see below). If you have a server that is 2.5.0 and earlier, clients of a later version on which you wish to run <strong>amrecover</strong> must use <strong>amoldrecover</strong> instead and, again, the server must be running the amandaidx and amidxtape network services.</p><p>Example of amindexd and amidxtaped Amanda daemon services configured as their own network services for a 2.5.0 or earlier server or a newer server having 2.5.0 or earlier clients</p>
<pre>
<strong>   amandaidx stream tcp nowait backup /usr/local/libexec/amanda/current/amindexd   amindexd</strong>
<strong>   amidxtape stream tcp nowait backup /usr/local/libexec/amanda/current/amidxtaped amidxtaped</strong>
</pre>

<h3>USING XINETD SERVER</h3>
<p>Template for Amanda client xinetd service file</p>
<pre>
service amanda
{
	only_from               = <em>Amanda server</em>
	socket_type             = <em>socket type</em>
	protocol                = <em>protocol</em>
	wait                    = <em>yes/no</em>
	user                    = <em>amanda backup user</em>
	group                   = <em>amanda backup user group id</em>
	groups                  = yes
	server                  = <em>absolute path to amandad</em>
	server_args             = <em>amandad server arguments</em>
	disable                 = no
}
</pre>
<p>The <em>only_from</em> parameter can be used with xinetd but is usually in addition to the primary form of access control via the .amandahosts file.</p><p>Client example of using <strong>bsd</strong> authorization for xinetd server and for Amanda user "backup":</p>
<pre>
service amanda
{
	only_from       = amandaserver.example.com
	socket_type     = dgram
	protocol        = udp
	wait            = yes
	user            = backup
	group           = disk
	groups          = yes
	server          = /path/to/amandad
	server_args     = -auth=bsd amdump
	disable         = no
}
</pre>
<p>The same could be used for <strong>bsdudp</strong> if specifying -auth=bsdudp instead of -auth=bsd.</p><p>Client example of using <strong>bsdtcp</strong> authorization for xinetd server and for Amanda user "backup":</p>
<pre>
service amanda
{
	only_from       = amandaserver.example.com amandaclient.example.com
	socket_type     = stream
	protocol        = tcp
	wait            = no
	user            = backup
	group           = disk
	groups          = yes
	server          = /path/to/amandad
	server_args     = -auth=bsdtcp amdump
	disable         = no
}
</pre>
<p><strong>amindexd</strong> and <strong>amidxtaped</strong> would typically be added as additional <strong>amandad</strong> <em>server_args</em> for an Amanda server.</p><p>For Amanda version 2.5.0 and earlier, remember that neither <strong>bsdudp</strong> nor <strong>bsdtcp</strong> are supported and the Amanda daemon <strong>amandad</strong> accepts no arguments. Because of the latter, <strong>amrecover</strong> as of Amanda version 2.5.1 is not compatible with 2.5.0 and earlier servers. Thus, servers that are 2.5.0 or earlier must, in addition to the <em>amanda</em> service, run <em>amindexd</em> and <em>amidxtaped</em> Amanda services as their own network services, amandaidx and amidxtape, respectively (see below).</p><p>There are no compatibility issues if server and clients are all 2.5.0 or earlier. If your server is 2.5.1 or later, you can still have clients that are 2.5.0 and earlier although you must then use <strong>bsd</strong> communication/authentication with these clients and must also run <em>amindexd</em> and <em>amidxtaped</em> Amanda services on the server as their own network services, amandaidx and amidxtape, respectively (see below). If you have a server that is 2.5.0 and earlier, clients of a later version on which you wish to run <strong>amrecover</strong> must use <strong>amoldrecover</strong> instead and, again, the server must be running the amandaidx and amidxtape network services.</p><p>Example of amindexd and amidxtaped Amanda daemon services configured as their own network services for a 2.5.0 or earlier server or a newer server having 2.5.0 or earlier clients</p>
<pre>
service amandaidx
{
	socket_type		= stream
	protocol		= tcp
	wait			= no
	user			= amanda
	group			= disk
	server			= /usr/local/libexec/amanda/amindexd
	disable			= no
}

service amidxtape
{
	socket_type		= stream
	protocol		= tcp
	wait			= no
	user			= amanda
	group			= disk
	server			= /usr/local/libexec/amanda/amidxtaped
	disable			= no
}
</pre>

<h3>PORT USAGE</h3>
<p>List of TCP/UDP ports used by network service communication methods for Amanda server and client.</p>
<pre>
   Key:
       UP = Unreserved Port
    RPpAP = Reserved Port per Amanda Process
   UPpDLE = Unreserved Port per DLE
     [..] = Configure options that can be used at compile time to define port ranges

Authentication	Protocol	Amanda server					Amanda client
bsd			udp		1 RPpAP [--with-udpportrange]		10080
			tcp		1 UP [--with-tcpportrange]		3 UPpDLE [--with-tcpportrange]
bsdudp		udp		1 RPpAP [--with-udpportrange]		10080
			tcp		1 UP [-with-tcpportrange]		1 UPpDLE [--with-tcpportrange]
bsdtcp		tcp		1 RPpAP [--with-low-tcpportrange]	10080
</pre>
<p>Amanda server also uses two ports (dumper process) to communicate with the chunker/taper processes. These ports are in the range set by --with-tcpportrange.</p><p>You can override the default port ranges that Amanda was compiled with in each configuration using the <em>reserved-udp-port</em>, <em>reserved-tcp-port</em>, and <em>unreserved-tcp-port</em> parameters in amanda.conf and amanda-client.conf configuration files (see <a href="../man5/amanda.conf.5.html"><strong>amanda.conf</strong>(5)</a> and <a href="../man5/amanda-client.conf.5.html"><strong>amanda-client.conf</strong>(5)</a>).</p>
<h3>Authenticated Peer Hostnames with BSD Authentications</h3>
<p>The BSD authentication mechanisms only verify that the remote host&apos;s DNS is configured correctly and that the remote user has access to reserved ports. As such, the peer hostname should only be trusted to the extent that the local DNS service is trusted.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">KERBEROS COMMUNICATION AND AUTHENTICATION</h2>
        <div class="sectioncontent">
<p>For more detail, see http://wiki.zmanda.com/index.php/Kerberos_authentication.</p><p>Amanda supports Kerberos 5 communication methods between Amanda server and client.</p><p>General information including compilation are given above (see <strong>COMPILATION AND GENERAL INFORMATION</strong> above).</p><p>Kerberos 5 uses TCP and the server uses only one TCP port and data streams are multiplexed to this port.</p><p>The <strong>krb5</strong> driver script defaults to:</p>
<pre>
/*
 * The lifetime of our tickets in minutes.
 */
#define AMANDA_TKT_LIFETIME     (12*60)

/*
 * The name of the service in /etc/services.
 */
#define AMANDA_KRB5_SERVICE_NAME        "k5amanda"
</pre>
<p>You can currently only override these by editing the source code.</p><p>The kerberized AMANDA service uses a different port on the client hosts. The /etc/services line is:</p>
<pre>
   k5amanda      10082/tcp
</pre>
<p>And the /etc/inetd.conf line is:</p>
<pre>
   k5amanda stream tcp nowait root /usr/local/libexec/amanda/amandad amandad -auth=krb5
</pre>
<p>Note that you&apos;re running this as root, rather than as your dump user. AMANDA will set its UID down to the dump user at times it doesn&apos;t need to read the keytab file, and give up root permissions entirely before it goes off and runs dump. Alternately you can change your keytab files to be readable by user amanda. You should understand the security implications of this before changing the permissions on the keytab.</p><p>The following dumptype options apply to <strong>krb5</strong>:</p>
<pre>
   auth "krb5"    # use krb5 auth for this host
                  # (you can mingle krb hosts and bsd .rhosts in one conf)
</pre>
<p>The principal and keytab files that Amanda uses must be set in the amanda.conf file for kerberos 5 dumps to work. You can hardcode this in the source code if you really want to (common-src/krb5-security.c)</p>
<pre>
   krb5keytab
   krb5principal
</pre>
<p>For example:</p>
<pre>
   krb5keytab	  "/etc/krb5.keytab-amanda"
   krb5principal  "amanda/saidin.omniscient.com"
</pre>
<p>The principal in the second option must be contained in the first. The keytab should be readable by the amanda user (and definitely not world readable!) and is (obviously) on the server. In MIT&apos;s kadmin, the following:</p>
<pre>
   addprinc -randkey amanda/saidin.omniscient.com
   ktadd -k /etc/krb5.keytab-amanda amanda/saidin.omniscient.com
</pre>
<p>will do the trick. You will obviously want to change the principal name to reflect something appropriate for the conventions at your site.</p><p>You must also configure each client to allow the amanda principal in for dumps.</p><p>There are several ways to go about authorizing a server to connect to a client.</p><p>The normal way is via a .k5amandausers file or a .k5login file in the client user&apos;s home directory. The determination of which file to use is based on the way you ran configure on AMANDA. By default, AMANDA will use .k5amandahosts, but if you configured with --without-amandahosts, AMANDA will use .k5login. (similar to the default for .rhosts/.amandahosts-style security). The .k5login file syntax is a superset of the default <strong>krb5</strong> .k5login. The routines to check it are implemented in amanda rather than using krb5_kuserok because the connections are actually gssapi based.</p><p>This .k5amandahosts/.k5login is a hybrid of the .amandahosts and a .k5login file. You can just list principal names, as in a .k5login file and the principal will be permitted in from any host. If you do NOT specify a realm, then there is no attempt to validate the realm (this is only really a concern if you have cross-realm authentication set up with another realm or something else that allows you multiple realms in your kdc. If you do specify a realm, only that principal@realm will be permitted to connect.</p><p>You may prepend this with a hostname and whitespace, and only that principal (with optional realm as above) will be permitted to access from that hostname.</p><p>Here are examples of valid entries in the .k5amandahosts:</p>
<pre>
   service/amanda
   service/amanda@TEST.COM
   dumpmaster.test.com service/amanda
   dumpmaster.test.com service/amanda@TEST.COM
</pre>
<p>Rather than using a .k5amandahosts or .k5login file, the easiest way is to use a principal named after the destination user, (such as amanda@TEST.COM in our example) and not have either a .k5amandahosts or .k5login file in the destination user&apos;s home directory.</p><p>There is no attempt to verify the realm in this case (only a concern if you have cross-realm authentication setup).</p><h3>Authenticated Peer Hostnames with Kerberos Authentication</h3>
<p>When accepting a new incoming connection, the Kerberos authentication mechanism performs a similar check to that done by the BSD authentications: the forward and reverse DNS entries for the remote host must match. As such, while Kerberos authentication can cryptographically ensure that the remote system is recognized (since it has a ticket), its assurances about the remote host&apos;s identity are weaker and depend on the integrity of the DNS.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">LOCAL COMMUNICATION</h2>
        <div class="sectioncontent">
<p>The Amanda server communicates with the client internally versus over the network, ie. the client is also the server.</p><p>This is the only method that requires no authentication as it is clearly not needed.</p><p>The authenticated peer hostname for this authentication is always "localhost".</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RSH COMMUNICATION AND AUTHENTICATION</h2>
        <div class="sectioncontent">
<p>For more detail, see http://wiki.zmanda.com/index.php/Configuring_rsh_authentication.</p><p>The Amanda server communicates with its client as the Amanda user via the RSH protocol.</p><p>Please note that RSH protocol itself is insecure and should be used with caution especially on any servers and clients with public IPs.</p><p>Each Amanda client communicates with the server using one TCP port and all data streams from the client are multiplexed over one port. The number of Amanda clients is limited by the number of reserved ports available on the Amanda server. Some versions of RSH do not use reserved ports and, thus, this restriction is not valid.</p><p>General information including compilation is given above (see <strong>COMPILATION AND GENERAL INFORMATION</strong> above).</p><p>In addition to specifying the <em>auth</em> field in dumptype definition, it might be required to specify <em>client-username</em> and <strong>amandad</strong> fields. If the backup user name is different on the Amanda client, the user name is specified as <strong>client-username</strong>. If the location of the Amanda daemon <strong>amandad</strong> is different on the Amanda client, the location is specified as <em>amandad-path</em> field value.</p>
<pre>
For example:
define dumptype rsh_example {
         ...
         auth "rsh"
         client-username "backup"
         amandad-path "/usr/lib/exec/amandad"
         ...
}
</pre>
<h3>Authenticated Peer Hostnames with RSH Authentication</h3>
<p>The RSH authentication mechanism does not provide an authenticated peer hostname.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SSH COMMUNICATION AND AUTHENTICATION</h2>
        <div class="sectioncontent">
<p>For more detail, see http://wiki.zmanda.com/index.php/How_To:Set_up_transport_encryption_with_SSH.</p><p>Amanda client sends data to the server using SSH. SSH keys have to be set up so that Amanda server can communicate with its clients using SSH.</p><p>General information including compilation is given above (see <strong>COMPILATION AND GENERAL INFORMATION</strong> above).</p><p>SSH provides transport encryption and authentication. To set up an SSH authentication session, Amanda will run the equivalent of the following to start the backup process.</p><p><strong>   /path/to/ssh -l </strong><strong></strong><em>user_name</em><strong> client.zmanda.com $libexecdir/amandad</strong></p><p>To use SSH, you need to set up SSH keys either by storing the passphrase in cleartext, using ssh-agent, or using no passphrase at all.  All of these options have security implications which should be carefully considered before adoption.</p><p>When you use a public key on the client to do data encryption (see http://wiki.zmanda.com/index.php/How_To:Set_up_data_encryption), you can lock away the private key in a secure place. Both, transport and storage will be encrypted with such a setup. See http://wiki.zmanda.com/index.php/Encryption for an overview of encryption options.</p><p>Enable SSH authentication and set the <strong>ssh-keys</strong> option in all DLEs for that host by adding the following to the DLE itself or to the corresponding dumptype in amanda.conf:</p>
<pre>
  auth "ssh"
  ssh-keys "/home/backup/.ssh/id_rsa_amdump"
</pre>
<p><strong>ssh-keys</strong> is the path to the private key on the client. If the username to which Amanda should connect is different from the default, then you should also add</p>
<pre>
  client-username "otherusername"
</pre>
<p>If your server  <strong>amandad</strong> path and client  <strong>amandad</strong> path are different, you should also add</p>
<pre>
  amandad-path "/client/amandad/path"
</pre>
<p>For a marginal increase in security, prepend the keys used for AMANDA in the clients&apos; authorized_keys file with the following:</p>
<pre>
  from="amanda_server.your.domain.com",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,command="/absolute/path/to/amandad -auth=ssh amdump"
</pre>
<p>This will limit that key to connect only from Amanda server and only be able to execute <strong>amandad</strong>(8).</p><p>In the same way, prepend the key used for AMANDA in the server&apos;s authorized_keys file with:</p>
<pre>
  from="amanda_client.your.domain.com",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,command="/absolute/path/to/amandad -auth=ssh amindexd amidxtaped"
</pre>
<p>You can omit the from=.. option if you have too many clients to list, although this has obvious security implications.</p><p>Set <strong>ssh-keys</strong> and any other necessary options in /etc/amanda/amanda_client.conf:</p>
<pre>
  auth "ssh"
  ssh-keys "/root/.ssh/id_rsa_amrecover"
  client-username "amanda"
  amandad-path "/server/amandad/path"
</pre>
<p>Besides user keys, SSH uses host keys to uniquely identify each host, to prevent one host from impersonating another. Unfortunately, the only easy way to set up these host keys is to make a connection and tell SSH that you trust the identity:</p>
<pre>
  $ ssh client1.zmanda.com
  The authenticity of host &apos;client1.zmanda.com (192.168.10.1)&apos; can&apos;t be established.
  RSA key fingerprint is 26:4e:df:a2:be:c8:cb:20:1c:68:8b:cc:c0:3b:8e:9d.
  Are you sure you want to continue connecting (yes/no)?yes
</pre>
<p>As Amanda will not answer this question itself, you must manually make every connection (server to client and client to server) that you expect Amanda to make. Note that you must use the same username that Amanda will use (that is, ssh client and ssh client.domain.com are distinct).</p><h3>Authenticated Peer Hostnames with SSH Authentication</h3>
<p>When accepting an incoming conneciton, the SSH daemon gives Amanda information about the remote system in the $SSH_CONNECTION environment variable. Amanda parses this information to determine the remote address, and then performs a similar check to that done by the BSD authentications: the forward and reverse DNS entries for the remote host must match. As such, while SSH authentication can cryptographically ensure that the remote system is recognized (since it had a recognized secret key), its assurances about the remote host&apos;s identity are weaker and depend on the integrity of the DNS.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO amanda-auth&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man8/amanda.8.html"><strong>amanda</strong>(8)</a>, <a href="../man5/amanda.conf.5.html"><strong>amanda.conf</strong>(5)</a>, <a href="../man5/amanda-client.conf.5.html"><strong>amanda-client.conf</strong>(5)</a>, <a href="../man5/disklist.5.html"><strong>disklist</strong>(5)</a>, <a href="../man8/amdump.8.html"><strong>amdump</strong>(8)</a>, <a href="../man8/amrecover.8.html"><strong>amrecover</strong>(8)</a></p><p>The Amanda Wiki: : http://wiki.zmanda.com/</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHORS</h2>
        <div class="sectioncontent">
<p><strong>Jean-Louis Martineau</strong> &lt;martineau@zmanda.com&gt;</p><p>Zmanda, Inc. (http://www.zmanda.com)</p><p><strong>Dustin J. Mitchell</strong> &lt;dustin@zmanda.com&gt;</p><p>Zmanda, Inc. (http://www.zmanda.com)</p><p><strong>Paul Yeatman</strong> &lt;pyeatman@zmanda.com&gt;</p><p>Zmanda, Inc. (http://www.zmanda.com)</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="amanda-applications.7.html"><span aria-hidden="true">&larr;</span> amanda-applications.7: Application-api for amanda</a></li>
   <li class="next"><a href="amanda-changers.7.html">amanda-changers.7: Configuring and using amanda changers <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
