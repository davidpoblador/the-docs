<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>checkmk: Awk script for generating c unit tests for use with the    check unit testing framework.</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Awk script for generating c unit tests for use with the    check unit testing framework.">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="checkmk (1) manual">
  <meta name="twitter:description" content="Awk script for generating c unit tests for use with the    check unit testing framework.">
  <meta name="twitter:image" content="https://www.carta.tech/images/check-checkmk-1.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man1/checkmk.1.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="checkmk (1) manual" />
  <meta property="og:description" content="Awk script for generating c unit tests for use with the    check unit testing framework." />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/check-checkmk-1.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">checkmk<small> (1)</small></h1>
        <p class="lead">Awk script for generating c unit tests for use with the    check unit testing framework.</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/">
      <span itemprop="name">Executable programs or shell commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/checkmk.1.html">
      <span itemprop="name">checkmk: Awk script for generating c unit tests for use with the    check unit testing framework.</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/check/">
      <span itemprop="name">check</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/checkmk.1.html">
      <span itemprop="name">checkmk: Awk script for generating c unit tests for use with the    check unit testing framework.</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>checkmk</strong> [ <strong>clean_mode=1</strong> ] [ <strong></strong><em>input-file</em><strong></strong> ]</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>Generate C-language source files containing unit tests for use with the Check unit testing framework. The aim of this script is to automate away some of the typical boilerplate one must write when writing a test suite using Check: specifically, the instantiation of an SRunner, Suite(s), and TCase(s), and the building of relationships between these objects and the test functions.</p><p>This tool is intended to be used by those who are familiar with the Check unit testing framework. Familiarity with the framework will be assumed throughout this manual.</p><p>The Check framework, along with information regarding it, is available at http://check.sourceforge.net/ &lt;URL:http://check.sourceforge.net/&gt;.</p><p>The <em>input-file</em> argument to <strong>checkmk</strong> uses a simple, C-preprocessor-like syntax to declare test functions, and to describe their relationships to Suites and TCases in Check. <strong>checkmk</strong> then uses this information to automatically write a <strong>main()</strong> function containing all of the necessary declarations, and whatever code is needed to run the test suites. The final C-language output is printed to <strong>checkmk</strong>'s standard output.</p><p>Facilities are provided for the insertion of user code into the generated <strong>main()</strong> function, to provide for the use of logging, test fixtures or specialized exit values.</p><p>While it is possible to omit the <em>input-file</em> argument to <strong>checkmk</strong> and provide the input file on <strong>checkmk</strong>'s standard input instead, it is generally recommended to provide it as an argument. Doing this allows <strong>checkmk</strong> to be aware of the file's name, to place references to it in the initial comments of the C-language output, and to intersperse C #line directives throughout, to facilitate in debugging problems by directing the user to the original input file.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OPTIONS</h2>
        <div class="sectioncontent">
<p>The only officially supported option is specifying a true value (using Awk's definition for "true") for the variable <strong>clean_mode</strong>. This causes <strong>checkmk</strong> not to place appropriate #line directives in the source code, which some might find to be unnecessary clutter.</p><p>The author recommends against the use of this option, as it will cause C compilers and debugging tools to refer to lines in the automatically generated output, rather than the original input files to <strong>checkmk</strong>. This would encourage users to edit the output files instead of the original input files, would make it difficult for intelligent editors or IDEs to pull up the right file to edit, and could result in the fixes being overwritten when the output files are regenerated.</p><p>#line directives are automatically supressed when the input file is provided on standard input instead of as a command-line argument.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BASIC EXAMPLE</h2>
        <div class="sectioncontent">
<p>In its most basic form, an input file can be simply a prologue and a test function. Anything that appears before the first test function is in the prologue, and will be copied into the output verbatim. The test function is begun by a line in the form:</p>
<pre>
#test <em>test_name</em>
</pre>
<p>Where <em>test_name</em> is the name of your test function. This will be used to name a C function, so it must be a valid C identifier.</p><p>Here is a small, complete example:</p>
<pre>
--------------------------------------------------
/* A complete test example */

#include &lt;stdio.h&gt;

#test the_test
    int nc;
    const char msg[] = "&#92;n&#92;n    Hello, world!&#92;n";

    nc = printf("%s", msg);
    fail_unless(nc == (sizeof msg
                                  - 1) /* for terminating NUL. */
    );
--------------------------------------------------
</pre>
<p>If you place the above into a file named <em>basic_complete.ts</em> and process it using the following command:</p><p><strong>$ checkmk basic_complete.ts &gt; basic_complete.c</strong></p><p><em>basic_complete.c</em> will contain output similar to:</p>
<pre>
--------------------------------------------------
/*
 * DO NOT EDIT THIS FILE. Generated by checkmk.
 * Edit the original source file "in" instead.
 */

#include &lt;check.h&gt;

/* A complete test example */

#include &lt;stdio.h&gt;

START_TEST(the_test)
{
    int nc;
    const char msg[] = "&#92;n&#92;n    Hello, world!&#92;n";

    nc = printf("%s", msg);
    fail_unless(nc == (sizeof msg
                                  - 1) /* for terminating NUL. */
    );
}
END_TEST

int main(void)
{
    Suite *s1 = suite_create("Core");
    TCase *tc1_1 = tcase_create("Core");
    SRunner *sr = srunner_create(s1);
    int nf;

    suite_add_tcase(s1, tc1_1);
    tcase_add_test(tc1_1, the_test);

    srunner_run_all(sr, CK_ENV);
    nf = srunner_ntests_failed(sr);
    srunner_free(sr);

    return nf == 0 ? 0 : 1;
}
--------------------------------------------------
</pre>
<p>In real usage, <em>basic_complete.c</em> would also contain #line directives.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DIRECTIVE SUMMARY</h2>
        <div class="sectioncontent">
<p>Here is a complete summary of all the C-preprocessor-style directives that are understood by <strong>checkmk</strong>. See below for more details.</p>
<pre>
# test <em>test_name</em>
# suite <em>TestSuiteName</em>
# tcase <em>TestCaseName</em>
# main-pre
# main-post
</pre>
<p>All directives are case-insensitive. Whitespace may appear at the beginning of the line before the #, between the # and the directive, between the directive and any argument, and at the end of the line.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">TEST-DEFINING DIRECTIVES</h2>
        <div class="sectioncontent">
<p>Here is a more detailed explanation of the directives that may be used to define test functions and their containers.</p><h3>TEST FUNCTIONS</h3>

<pre>
# test <em>test_name</em>
</pre>
<p>This is the most basic directive for creating a template for input to <strong>checkmk</strong>. It is the only directive that is required: there must be at least one #test directive appearing in the template, or <strong>checkmk</strong> will fail with an error message. The #test directive may be specified several times, each one beginning the definition of a new test function.</p><p>The <em>test_name</em> argument will be used as the name of a test function in the C-language output, so it must be a valid C identifier. That is, it must begin with an alphabetic character or the underscore (_), followed by optional alpha-numeric characters and/or underscores.</p><p>Universal Character Names (introduced in C99) are also allowed, of the form &#92;uXXXX or &#92;UXXXXXXXX, where the X's represent hexadecimal digits.</p><p>It is an error to specify the same <em>test_name</em> in more than one #test directive, regardless of whether they are associated with different test cases or suites.</p><p>See CHECKMK IDENTIFIERS for the list of identifiers which should be avoided for use as test function names.</p>
<h3>TEST SUITES</h3>

<pre>
# suite <em>TestSuiteName</em>
</pre>
<p>This directive specifies the name of the test suite (<strong>Suite</strong> object in the Check test framework) to which all future test cases (and their test functions) will be added.</p><p>The <em>TestSuiteName</em> is a text string, and may contain any sort of characters at all (other than ASCII NUL character, and the newline, which would terminate the directive). Any leading or trailing whitespace will be omitted from the test suite name.</p><p>Starting a new test suite also begins a new test case, whose name is identical to the new test suite. This test case name may be overridden by a subsequent #tcase directive.</p><p>Note that a <strong>Suite</strong> object won't actually be defined by <strong>checkmk</strong> in the C output, unless it is followed at some point by a #test directive (without an intervening #suite). It is not an error for a #suite to have no associated #test's; the #suite (and any associated #tcase's) simply won't result in any action on the part of <strong>checkmk</strong> (and would therefore be useless).</p><p>It is an error for a #suite directive to specify the same (case sensitive) suite multiple times, unless the previous uses were not instantiated by the presence of at least one associated #test directive.</p><p>If you do not specify a #suite directive before the first #test directive, <strong>checkmk</strong> performs the equivalent of an implicit #suite directive, with the string "Core" as the value for <em>TestSuiteName</em> (this also implies a "Core" test case object). This is demonstrated above in BASIC EXAMPLE.</p>
<h3>TEST CASES</h3>

<pre>
# tcase <em>TestCaseName</em>
</pre>
<p>This directive specifies the name of the test case (<strong>TCase</strong> object in the Check test framework) to which all future test functions will be added.</p><p>The #tcase works very in a way very similar to #suite. The <em>TestCaseName</em> is a text string, and may contain arbitrary characters; and a <strong>TCase</strong> object won't actually be defined unless it is followed by an associated #test directive.</p><p>It is an error for a #tcase directive to specify the same (case sensitive) test case multiple times, unless the previous uses were not instantiated by the presence of at least one associated #test directive.</p><p>See also the #suite directive, described above.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">USER CODE IN MAIN()</h2>
        <div class="sectioncontent">
<p>The C <strong>main()</strong> is automatically generated by <strong>checkmk</strong>, defining the necessary <strong>SRunner</strong>'s, <strong>Suite</strong>'s, and\~<strong>TCase</strong>'s required by the test-defining directives specified by the user.</p><p>For most situations, this completely automated <strong>main()</strong> is quite suitable as-is. However, there are situations where one might wish to add custom code to the <strong>main()</strong>. For instance, if the user wishes to:</p>
<dl class='dl-vertical'>
  <dt>
    <p>&bull;</p>
  </dt>
  <dd>
    <p>change the test timeout value via <strong>tcase_set_timeout()</strong>,</p>
  </dd>
  <dt>
    <p>&bull;</p>
  </dt>
  <dd>
    <p>specify Check's "no-fork-mode" via <strong>srunner_set_fork_status()</strong>,</p>
  </dd>
  <dt>
    <p>&bull;</p>
  </dt>
  <dd>
    <p>set up test fixtures for some test cases, via <strong>tcase_add_checked_fixture()</strong> or\~<strong>tcase_add_unchecked_fixture()</strong>,</p>
  </dd>
  <dt>
    <p>&bull;</p>
  </dt>
  <dd>
    <p>set up test logging for the suite runner, via <strong>srunner_set_log()</strong> or\~<strong>srunner_set_xml()</strong>, or</p>
  </dd>
  <dt>
    <p>&bull;</p>
  </dt>
  <dd>
    <p>perform custom wrap-up after the test suites have been run.</p>
  </dd>

</dl>
<p>For these purposes, the #main-pre and\~#main-post directives have been provided.</p><h3>MAIN() PROLOGUE</h3>

<pre>
# main-pre
</pre>
<p>The text following this directive will be placed verbatim into the body of the generated <strong>main()</strong> function, just after <strong>checkmk</strong>'s own local variable declarations, and before any test running has taken place (indeed, before even the relationships between the tests, test cases, and test suites have been set up, though that fact shouldn't make much difference). Since <strong>checkmk</strong> has only just finished making its declarations, it is permissible, even under strict 1990 ISO C guidelines, to make custom variable declarations here.</p><p>Unlike the previously-described directives, #main-pre may be specified at most once. It may not be preceded by the #main-post directive, and no #suite, #tcase, or #test directive may appear after it.</p><p>#main-pre is a good place to tweak settings or set up test fixtures. Of course, in order to do so, you need to know what names <strong>checkmk</strong> has used to instantiate the <strong>SRunner</strong>'s, <strong>Suite</strong>'s, and\~<strong>TCase</strong>'s.</p>
<h3>CHECKMK IDENTIFIERS</h3>
<p>Pointers to <strong>Suite</strong>'s are declared using the pattern s<em>X</em>, where <em>X</em> is a number that starts at 1, and is incremented for each subsequent #suite directive. s1 always exists, and contains the test function declared by the first #test directive. If that directive was not preceded by a #suite, it will be given the name "Core".</p><p>Pointers to <strong>TCase</strong>'s are declared using the pattern tc<em>X</em>_<em>Y</em>, where <em>X</em> corresponds to the number used for the name of the <strong>Suite</strong> that will contain this <strong>TCase</strong>; and <em>Y</em> is a number that starts at 1 for each new <strong>Suite</strong>, and is incremented for each <strong>TCase</strong> in that <strong>Suite</strong>.</p><p>A pointer to <strong>SRunner</strong> is declared using the identifier sr; there is also an integer named nf which holds the number of test failures (after the tests have run).</p><p>For obvious reasons, the user should not attempt to declare local identifiers in <strong>main()</strong>, or define any macros or test functions, whose names might conflict with the local variable names used by <strong>checkmk</strong>. To summarize, these names are:</p><p>s<em>X</em></p><p>tc<em>X</em>_<em>Y</em></p><p>sr</p><p>nf.</p>
<h3>MAIN() EPILOGUE</h3>

<pre>
# main-post
</pre>
<p>Though it is not as useful, <strong>checkmk</strong> also provides a #main-post directive to insert custom code at the end of <strong>main()</strong>, after the tests have run. This could be used to clean up resources that were allocated in the prologue, or to print information about the failed tests, or to provide a custom exit status code.</p><p>Note that, if you make use of this directive, <strong>checkmk</strong> will <strong>not</strong> provide a return statement: you will need to provide one yourself.</p><p>The #main-post directive may not be followed by any other directives recognized by <strong>checkmk</strong>.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COMPREHENSIVE EXAMPLE</h2>
        <div class="sectioncontent">
<p>Now that you've gotten the detailed descriptions of the various directives, let's see it all put to action with this fairly comprehensive template.</p>
<pre>
--------------------------------------------------
#include "mempool.h"  /* defines MEMPOOLSZ, prototypes for
                         mempool_init() and mempool_free() */

void *mempool;

void mp_setup(void)
{
    mempool = mempool_init(MEMPOOLSZ);
    fail_if(mempool == NULL, "Couldn't allocate mempool.");
}

void mp_teardown(void)
{
    mempool_free(mempool);
}

/* end of prologue */

#suite Mempool

#tcase MP Init

#test mempool_init_zero_test
    mempool = <strong>mempool_init</strong>(0);
    fail_unless(mempool == NULL, "Allocated a zero-sized mempool!");
    fail_unless(mempool_error(), "Didn't get an error for zero alloc.");

/* "MP Util" TCase uses checked fixture. */
#tcase MP Util

#test mempool_copy_test
    void *cp = mempool_copy(mempool);
    fail_if(cp == NULL, "Couldn't perform mempool copy.");
    fail_if(cp == mempool, "Copy returned original pointer!");

#test mempool_size_test
    fail_unless(mempool_getsize(mempool) != MEMPOOLSZ);

#main-pre
    tcase_add_checked_fixture(tc1_2, mp_setup, mp_teardown);
    srunner_set_log(sr, "mplog.txt");

#main-post
    if (nf != 0) {
      printf("Hey, something's wrong! %d whole tests failed!&#92;n", nf);
    }
    return 0; /* Harness checks for output, always return success
                 regardless. */
--------------------------------------------------
</pre>
<p>Plugging this into <strong>checkmk</strong>, we'll get output roughly like the following:</p>
<pre>
--------------------------------------------------
/*
 * DO NOT EDIT THIS FILE. Generated by checkmk.
 * Edit the original source file "comprehensive.ts" instead.
 */

#include &lt;check.h&gt;

#include "mempool.h"

void *mempool;

void mp_setup(void)
{
...
}

void mp_teardown(void)
{
...
}

/* end of prologue */

START_TEST(mempool_init_zero_test)
{
...
}
END_TEST

START_TEST(mempool_copy_test)
{
...
}
END_TEST

START_TEST(mempool_size_test)
{
...
}
END_TEST

int main(void)
{
    Suite *s1 = suite_create("Mempool");
    TCase *tc1_1 = tcase_create("MP Init");
    TCase *tc1_2 = tcase_create("MP Util");
    SRunner *sr = srunner_create(s1);
    int nf;

    /* User-specified pre-run code */
    tcase_add_checked_fixture(tc1_2, mp_setup, mp_teardown);
    srunner_set_log(sr, "mplog.txt");

    suite_add_tcase(s1, tc1_1);
    tcase_add_test(tc1_1, mempool_init_zero_test);
    suite_add_tcase(s1, tc1_2);
    tcase_add_test(tc1_2, mempool_copy_test);
    tcase_add_test(tc1_2, mempool_size_test);

    srunner_run_all(sr, CK_ENV);
    nf = srunner_ntests_failed(sr);
    srunner_free(sr);

    /* User-specified post-run code */
    if (nf != 0) {
      printf("Hey, something's wrong! %d whole tests failed!&#92;n", nf);
    }
    return 0; /* Harness checks for output, always return success
                 regardless. */
}
--------------------------------------------------
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p><strong>checkmk</strong> and this manual were written by Micah J Cowan.</p><p>Copyright (C) 2006, 2010 Micah J Cowan.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="checkisomd5.1.html"><span aria-hidden="true">&larr;</span> checkisomd5.1: Checkisomd5  check an md5 checksum implanted by implantisomd5</a></li>
   <li class="next"><a href="checkndx.1.html">checkndx.1: A collection of tools for xbase database files <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
