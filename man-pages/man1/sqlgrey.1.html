<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>sqlgrey: Postfix greylisting policy server</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Postfix greylisting policy server">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="sqlgrey (1) manual">
  <meta name="twitter:description" content="Postfix greylisting policy server">
  <meta name="twitter:image" content="https://www.carta.tech/images/sqlgrey-sqlgrey-1.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man1/sqlgrey.1.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="sqlgrey (1) manual" />
  <meta property="og:description" content="Postfix greylisting policy server" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/sqlgrey-sqlgrey-1.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">sqlgrey<small> (1)</small></h1>
        <p class="lead">Postfix greylisting policy server</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/">
      <span itemprop="name">Executable programs or shell commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/sqlgrey.1.html">
      <span itemprop="name">sqlgrey: Postfix greylisting policy server</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/sqlgrey/">
      <span itemprop="name">sqlgrey</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/sqlgrey.1.html">
      <span itemprop="name">sqlgrey: Postfix greylisting policy server</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>sqlgrey</strong> [<em>options</em>...]</p>
<pre>
 -h, --help                 display this help and exit
     --man                  display man page
     --version              output version information and exit
 -d, --daemonize            run in the background
 -p, --pidfile=FILE         write process ID to FILE
                            (overrides &apos;pidfile&apos; in configfile)
 -k, --kill                 kill a running sqlgrey
                            (identified by &apos;pidfile&apos; content)
 -f, --configfile=FILE      read config from FILE
                            (default /etc/sqlgrey/sqlgrey.conf)
                            expecting config_param=value lines,
                            - spaces are ignored,
                            - &apos;#&apos; is used for comments
</pre>
<p>See the default config file at /etc/sqlgrey/sqlgrey.conf for runtime parameters. If you got sqlgrey from sources, read the \s-1HOWTO\s0 file in the compressed archive. If it came prepackaged, look into the documentation tree for this file: /usr/share/doc/sqlgrey-&lt;version&gt;/ on most Linux distributions for example.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>Sqlgrey is a Postfix policy server implementing greylisting.</p><p>When a request for delivery of a mail is received by Postfix via \s-1SMTP\s0, the triplet \*(C`CLIENT_IP\*(C' / \*(C`SENDER\*(C' / \*(C`RECIPIENT\*(C' is built. If it is the first time that this triplet is seen, or if the triplet was first seen less than <em>reconnect-delay</em> minutes (1 is the default), then the mail gets rejected with a temporary error. Hopefully spammers or viruses will not try again later, as it is however required per \s-1RFC\s0.</p><p>In order to alleviate the reconnect delay, sqlgrey uses a 2-level auto-white-list (\s-1AWL\s0) system:</p><ul>
<li><p>As soon as a \*(C`CLIENT IP\*(C' / \*(C`SENDER\*(C' is accepted, it is added to an \s-1AWL\s0. The couple expires when it isn't seen for more than <em>awl-age</em> days (60 is the default).</p></li><li><p>If <em>group-domain-level</em> \*(C`SENDER\*(C's (2 is the default) from the same domain or more use the same \*(C`CLIENT IP\*(C', another \s-1AWL\s0 is used based on a \*(C`CLIENT IP\*(C' / \*(C`DOMAIN\*(C' couple. This couple expires after awl-age days too. This \s-1AWL\s0 is meant to be used on high throughput sites in order to :</p><ul>
<li><p>minimize the amount of data stored in database,</p></li><li><p>minimize the amount of processing required to find an entry in the \s-1AWL\s0.</p></li><li><p>don't impose any further mail delay when a \*(C`CLIENT IP\*(C' / \*(C`DOMAIN\*(C' couple is known.</p></li>
</ul><p>It can be disabled by setting <em>group-domain-level</em> to 0.</p></li>
</ul><p>General idea:</p><p>When a \s-1SMTP\s0 client has been accepted once, if the \s-1IP\s0 isn't dynamic, greylisting the \s-1IP\s0 again is only a waste of time when it sends another e-mail. As we already know that this \s-1IP\s0 runs an RFC-compliant \s-1MTA\s0 (at least the 4xx error code handling) and will get the new e-mail through anyway.</p><p>In the case of mail relays, these AWLs works very well as the same senders and mail domains are constantly coming through the same \s-1IP\s0 addresses -&gt; the e-mails are quickly accepted on the first try. In the case of individual \s-1SMTP\s0 servers, this works well if the \s-1IP\s0 is fixed too. When using a floating \s-1IP\s0 address, the AWLs are defeated, but it should be the least common case by far.</p><p>Why do we put the domain in the \s-1AWL\s0 and not the \s-1IP\s0 only ? If we did only store \s-1IP\s0 addresses, polluting the \s-1AWL\s0 would be far too easy. It would only take one correctly configured \s-1MTA\s0 sending one e-mail from one \s-1IP\s0 one single time to put it in a whitelist used whatever future mails from this \s-1IP\s0 look like.</p><p>With this \s-1AWL\s0 system, one single mail can only allow whitelisting of mails from a single sender from the same \s-1IP\s0...</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">INSTALLATION</h2>
        <div class="sectioncontent">
<ul>
<li><p>Create a \*(C`sqlgrey\*(C' user. This will be the user the daemon runs as.</p></li><li><p>When using a full-fledge \s-1SGBD\s0 (MySQL and PostgreSQL, not SQLite), create a 'sqlgrey' db user and a 'sqlgrey' database. Grant access to the newly created database to sqlgrey.</p></li><li><p>Use the packaged init script to start sqlgrey at boot and start it manually.</p></li>
</ul>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CONFIGURATION</h2>
        <div class="sectioncontent">
<h3>General</h3>
<ul>
<li><p>Start by adding check_policy_service after reject_unauth_destination in /etc/postfix/main.cf :  smtpd_recipient_restrictions =                ...                reject_unauth_destination                check_policy_service inet:127.0.0.1:2501</p></li><li><p>Be aware that some servers do not behave correctly and do not resend mails (as required by the standard) or use unique return addresses. This is the reason why you should maintain whitelists for them. SQLgrey comes with a comprehensive whitelisting system. It can even be configured to fetch up-to-date whitelists from a repository. See the \s-1HOWTO\s0 for the details.</p></li>
</ul>
<h3>Disabling greylisting for some users</h3>
<p>If you want to disable greylisting for some users you can configure Postfix like this:</p><p>/etc/postfix/sqlgrey_recipient_access:</p>
<pre>
  i_like_spam@ee.ethz.ch                \s-1OK\s0
</pre>
<p>Then you'll add a check_recipient_access in main.cf before the check_policy_service :  smtpd_recipient_restrictions =</p>
<pre>
       ...
       reject_unauth_destination
       check_client_access    hash:/etc/postfix/sqlgrey_client_access
       check_recipient_access hash:/etc/postfix/sqlgrey_recipient_access
       check_policy_service inet:127.0.0.1:10023
</pre>


        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO sqlgrey&hellip;</h2>
        <div class="sectioncontent">
<p>See &lt;http://www.greylisting.org/&gt; for a description of what greylisting is and &lt;http://www.postfix.org/SMTPD_POLICY_README.html&gt; for a description of how Postfix policy servers work.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COPYRIGHT</h2>
        <div class="sectioncontent">
<p>Copyright (c) 2004 by Lionel Bouton.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">LICENSE</h2>
        <div class="sectioncontent">
<p>This program is free software; you can redistribute it and/or modify it under the terms of the \s-1GNU\s0 General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</p><p>This program is distributed in the hope that it will be useful, but \s-1WITHOUT\s0 \s-1ANY\s0 \s-1WARRANTY\s0; without even the implied warranty of \s-1MERCHANTABILITY\s0 or \s-1FITNESS\s0 \s-1FOR\s0 A \s-1PARTICULAR\s0 \s-1PURPOSE\s0.  See the \s-1GNU\s0 General Public License for more details.</p><p>You should have received a copy of the \s-1GNU\s0 General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, \s-1MA\s0  02111-1307  \s-1USA\s0</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Lionel&nbsp;Bouton&nbsp;&lt;lionel-dev@bouton.name&gt;</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="sqlformat.1.html"><span aria-hidden="true">&larr;</span> sqlformat.1: Reformat sql</a></li>
   <li class="next"><a href="sqlgrey-logstats.1.html">sqlgrey-logstats.1: Sqlgrey log parser <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
