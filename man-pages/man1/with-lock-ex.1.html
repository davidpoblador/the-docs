<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>with-lock-ex: File locker</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="File locker">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="with-lock-ex (1) manual">
  <meta name="twitter:description" content="File locker">
  <meta name="twitter:image" content="https://www.carta.tech/images/chiark-utils-bin-with-lock-ex-1.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man1/with-lock-ex.1.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="with-lock-ex (1) manual" />
  <meta property="og:description" content="File locker" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/chiark-utils-bin-with-lock-ex-1.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">with-lock-ex<small> (1)</small></h1>
        <p class="lead">File locker</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/">
      <span itemprop="name">Executable programs or shell commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/with-lock-ex.1.html">
      <span itemprop="name">with-lock-ex: File locker</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/chiark-utils-bin/">
      <span itemprop="name">chiark-utils-bin</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/with-lock-ex.1.html">
      <span itemprop="name">with-lock-ex: File locker</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>with-lock-ex</strong> <strong>-w</strong>\||\|<strong>-q</strong>\||\|<strong>-f</strong> <em>lockfile command</em> <em>args</em><em>\|.\|.\|.</em></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>with-lock-ex will open and lock the lockfile for writing and then feed the remainder of its arguments to <strong>exec</strong>(2); when that process terminates the fd will be closed and the file unlocked automatically by the kernel.</p><p>If the file does not exist it is created, with permissions <strong>rw</strong> for each user class for which the umask has <strong>w</strong>.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OPTIONS</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    <p><strong>-w</strong></p>
  </dt>
  <dd>
    <p>Wait for the lock to be available.</p>
  </dd>
  <dt>
    <p><strong>-f</strong></p>
  </dt>
  <dd>
    <p>Fail (printing a message to stderr and exiting 255) if the lock cannot be acquired immediately because another process has it.</p>
  </dd>
  <dt>
    <p><strong>-q</strong></p>
  </dt>
  <dd>
    <p>Silently do nothing (ie, exit 0 instead of executing the specified process) if the lock cannot be acquired immediately because another process has it.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">STALE LOCKS</h2>
        <div class="sectioncontent">
<p>The locking protocol used does not suffer from stale locks.  If the lock cannot be acquired, one or more running processes must currently hold the lock; if the lock needs to be freed those processes should be killed.</p><p>Under no circumstances should `stale lock cleaner' cron jobs, or the like, be instituted.  In systems where a great many locks may exist, old lockfiles may be removed from cron but only if each lock is acquired before the lockfile is removed, for example with</p><ul>
<li><p><strong>with-lock-ex -q</strong> <em>lockfile</em> <strong>rm</strong> <em>lockfile</em></p></li>
</ul>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DEADLOCKS</h2>
        <div class="sectioncontent">
<p>There is no deadlock detection.  In a system with several locks, a lock hierarchy should be established, such that for every pair of locks <em>A</em> and <em>B</em> which a process might lock simultaneously, either <em>A</em>&gt;<em>B</em> or <em>B</em>&gt;<em>A</em> where the relation &gt; is transitive and noncyclic.</p><p>Then, for any two locks <em>X</em> and <em>Y</em> with <em>X</em>&gt;<em>Y</em> it is forbidden to acquire <em>X</em> while holding <em>Y</em>. Instead, acquire <em>X</em> first, or release <em>Y</em> before (re)acquiring <em>X</em> and <em>Y</em> in that order.</p><p>(There are more complicated ways of avoiding deadlocks, but a lock hierarchy is simple to understand and implement.  If it does not meet your needs, consult the literature.)</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">LOCKING PROTOCOL</h2>
        <div class="sectioncontent">
<p>The locking protocol used by <strong>with-lock-ex</strong> is as follows:</p><p>The lock is held by a process (or group of processes) which holds an fcntl exclusive lock on the first byte of the plain file which has the specified name.  A holder of the lock (and only a holder of the lock) may delete the file or change the inode to which the name refers, and as soon as it does so it ceases to hold the lock.</p><p>Any process may create the file if it does not exist.  There is no need for the file to contain any actual data.  Indeed, actually using the file for data storage is strongly disrecommended, as this will foreclose most strategies for reliable update.  Use a separate lockfile instead.</p><p>Ability to obtain the lock corresponds to write permission on the file (and of course permission to create the  file, if it does not already exist).  However, processes with only read permission on the file can prevent the lock being acquired at all; therefore lockfiles should not usually be world-readable.</p><p>When a (group of) processes wishes to acquire the lock, it should open the file (with <strong>O_CREAT</strong>) and lock it with <a href="../man2/fcntl.2.html"><strong>fcntl</strong>(2)</a> <strong>F_RWLCK</strong>, operation <strong>F_SETLK</strong> or <strong>F_SETLKW</strong>. If this succeeds it should fstat the file descriptor it has, and the file by its path.  If the device and inode match then the lock has been acquired and remains acquired until that group of processes changes which file the name refers to, deletes the file, or releases the fcntl lock.  If they do not then another process acquired the lock and deleted the file in the meantime; you must now close your filedescriptor and start again. <strong>with-lock-ex</strong> follows this specification.</p><p>Note that <a href="../man2/flock.2.html"><strong>flock</strong>(2)</a> is a different kind of lock to <a href="../man2/fcntl.2.html"><strong>fcntl</strong>(2)</a>. <strong>with-lock-ex</strong> uses <strong>fcntl</strong>.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>This Manual page was written by Matthew Vernon &lt;matthew@debian.org&gt; and enhanced by Ian Jackson &lt;ian@chiark.greenend.org.uk&gt;, in 2003, but may be used by anyone.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COPYRIGHT</h2>
        <div class="sectioncontent">
<p>with-lock-ex was written by Ian Jackson &lt;ian@chiark.greenend.org.uk&gt; in 1993, 1994, 1995, 1996, 1998, 1999. He has placed it in the public domain.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO with-lock-ex&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man2/fcntl.2.html"><strong>fcntl</strong>(2)</a>, <a href="../man2/flock.2.html"><strong>flock</strong>(2)</a>, <a href="../man2/chmod.2.html"><strong>chmod</strong>(2)</a></p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="wit.1.html"><span aria-hidden="true">&larr;</span> wit.1: Manipulate wii and gamecube iso images and wbfs containers</a></li>
   <li class="next"><a href="withsctp.1.html">withsctp.1: Run tcp binaries over sctp <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
