<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>nat-traverse: Use of udp to traverse nat gateways</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Use of udp to traverse nat gateways">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="nat-traverse (1) manual">
  <meta name="twitter:description" content="Use of udp to traverse nat gateways">
  <meta name="twitter:image" content="https://www.carta.tech/images/nat-traverse-nat-traverse-1.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man1/nat-traverse.1.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="nat-traverse (1) manual" />
  <meta property="og:description" content="Use of udp to traverse nat gateways" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/nat-traverse-nat-traverse-1.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">nat-traverse<small> (1)</small></h1>
        <p class="lead">Use of udp to traverse nat gateways</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/">
      <span itemprop="name">Executable programs or shell commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/nat-traverse.1.html">
      <span itemprop="name">nat-traverse: Use of udp to traverse nat gateways</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/nat-traverse/">
      <span itemprop="name">nat-traverse</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/nat-traverse.1.html">
      <span itemprop="name">nat-traverse: Use of udp to traverse nat gateways</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p>To create a simple text-only tunnel, use the commands</p>
<pre>
  user@left  $ nat-traverse 40000:natgw-of-right:40001
  user@right $ nat-traverse 40001:natgw-of-left:40000
</pre>
<p>where 40000 is an unused \s-1UDP\s0 port on \*(C`left\*(C' and 40001 is an unused port on \*(C`right\*(C'. See \*(L"\s-1EXAMPLES\s0\*(R" for more.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">VERSION</h2>
        <div class="sectioncontent">
<p>This document describes nat-traverse v0.5.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>nat-traverse establishes connections between nodes which are behind \s-1NAT\s0 gateways, i.e. hosts which do <em>not</em> have public \s-1IP\s0 addresses. Additionally, you can setup a small \s-1VPN\s0 by using pppd on top of nat-traverse (see \*(L"\s-1EXAMPLES\s0\*(R").  nat-traverse does <em>not</em> need an external server on the Internet, and it isn't necessary to reconfigure the involved \s-1NAT\s0 gateways, either. <em>nat-traverse works out-of-the-box.</em></p><p>See \*(L"\s-1TECHNIQUE\s0\*(R" for how this is achieved.</p><p>Limitation: nat-traverse does not work with gateways which change the port numbers. This is a fundamental problem of nat-traverse's design, as the changed port numbers are (in general) not predictable.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OPTIONS</h2>
        <div class="sectioncontent">
<p>Sets the local port to use and the remote address to connect to. Note that you have to give the \s-1IP\s0 address or hostname of the <em>\s-1NAT\s0 gateway</em> of the host you want to connect to, as the target host doesn't have a public \s-1IP\s0 address. Runs the specified command after establishing the connection. The command will be run with its \s-1STDIN\s0 and \s-1STDOUT\s0 bound to the socket, i.e. everything the command writes to \s-1STDOUT\s0 will be forwarded to the peer. If no command is specified, nat-traverse will relay input from \s-1STDIN\s0 to the peer and vice versa, i.e. nat-traverse degrades to netcat. Sets the number of initial garbage packets to send. The default, 10, should work with most firewalls. Sets the maximum number of seconds to wait for an acknowledgement by the peer. Quits nat-traverse after the tunnel has been established successfully. nat-traverse returns a non-0 statuscode to indicate that it wasn't able to establish the tunnel. \*(C`--quit-after-connect\*(C' is useful if you want another program to use the tunnel. For example, you could configure OpenVPN to use the the same ports as nat-traverse \*(-- thus OpenVPN would be able to cross \s-1NAT\s0 gateways.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">TECHNIQUE</h2>
        <div class="sectioncontent">
<p>nat-traverse establishes connections between hosts behind \s-1NAT\s0 gateways without need for reconfiguration of the involved \s-1NAT\s0 gateways.</p>
<dl class='dl-vertical'>
  <dt>
    1.
  </dt>
  <dd>
    <p>Firstly, nat-traverse on host \*(C`left\*(C' sends garbage \s-1UDP\s0 packets to the \s-1NAT\s0 gateway of \*(C`right\*(C'. These packets are, of course, discarded by the firewall.</p>
  </dd>
  <dt>
    2.
  </dt>
  <dd>
    <p>Then \*(C`right\*(C''s nat-traverse sends garbage \s-1UDP\s0 packets to the \s-1NAT\s0 gateway of \*(C`left\*(C'. These packets are <em>not</em> discarded, as \*(C`left\*(C''s \s-1NAT\s0 gateway thinks these packets are replies to the packets sent in step 1!</p>
  </dd>
  <dt>
    3.
  </dt>
  <dd>
    <p>\*(C`left\*(C''s nat-traverse continues to send garbage packets to \*(C`right\*(C''s \s-1NAT\s0 gateway. These packets are now not dropped either, as the \s-1NAT\s0 gateway thinks the packets are replies to the packets sent in step 2.</p>
  </dd>
  <dt>
    4.
  </dt>
  <dd>
    <p>Finally, both hosts send an acknowledgement packet to signal readiness. When these packets are received, the connection is established and nat-traverse can either relay \s-1STDIN/STDOUT\s0 to the socket or execute a program.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLES</h2>
        <div class="sectioncontent">
<h3>Setup of a small \s-1VPN\s0 with \s-1PPP\s0</h3>
<p>It's easy to setup a \s-1VPN\s0 (Virtual Private Network) by using the Point-to-Point Protocol Daemon, \*(C`pppd\*(C':</p><p>  root@left # nat-traverse &#92;       --cmd="pppd updetach noauth passive notty &#92;              ipparam vpn 10.0.0.1:10.0.0.2"       40000:natgw-of-right:40001   root@right # nat-traverse &#92;       --cmd="pppd nodetach notty noauth"       40001:natgw-of-left:40000</p><p>\*(C`pppd\*(C' creates a new interface, typically \*(C`ppp0\*(C'.  Using this interface, you can ping 10.0.0.1 or 10.0.0.2. As you can see, \*(C`pppd\*(C' upgrades the data-only tunnel nat-traverse provides to a full \s-1IP\s0 tunnel. Thus you can establish reliable \s-1TCP\s0 connections over the tunnel, even though the tunnel uses \s-1UDP\s0!  Furthermore, you could even add IPv6 addresses to \*(C`ppp0\*(C' by running \*(C`ip -6 addr add...\*(C'!</p><p>Note though that although this \s-1VPN\s0 <em>is</em> arguably a private network, it is <em>not</em> secured in any way. You may want to use \s-1SSH\s0 to encrypt the connection.</p>
<h3>Port Forwarding with netcat</h3>
<p>You can use \*(C`netcat\*(C' to forward one of your local \s-1UDP\s0 or \s-1TCP\s0 ports to an arbitrary \s-1UDP\s0 or \s-1TCP\s0 port of the remote host, similar to \*(C`ssh -L\*(C' or \*(C`ssh -R\*(C':</p><p>  user@left  $ nat-traverse 10001:natgw-of-right:10002 &#92;         --cmd="nc -vl 20000"   user@right $ nat-traverse 10002:natgw-of-left:10001 &#92;         --cmd="nc -v localhost 22"</p><p>As soon as the tunnel is established (using \s-1UDP\s0 ports 10001 and 10002), \*(C`left\*(C''s \s-1TCP\s0 port 20000 is forwarded to \*(C`right\*(C''s \s-1SSH\s0 Daemon (\s-1TCP\s0 port 22):</p><p>  user@some-other-host $ ssh -p 20000 user@left   # Will connect to right&apos;s SSH daemon!</p><p>But do note that you lose the reliability of \s-1TCP\s0 in this example, as the actual data is transported via \s-1UDP\s0; so this is only a toy example. If you want reliable streams, use \s-1PPP\s0 on top of nat-traverse, as described above.</p>
<h3>Setup of a \s-1VPN\s0 with OpenVPN</h3>
<p>You can use &lt;OpenVPN&gt; over nat-traverse if you want to have a <em>secure</em> \s-1VPN\s0.</p><p>Using OpenVPN over nat-traverse requires only one change to OpenVPN's configuration file, presuming that you don't want to use OpenVPN's multi-client mode: You have to adjust the \*(C`code\*(C' and \*(C`lport\*(C' options accordingly, for example:</p><p>  # Options to add to left&apos;s and right&apos;s OpenVPN config:   port  60001   lport 60001</p><p>  # Command to execute on left resp. right:   root@left  # until &#92;                  nat-traverse --quit-after-connect 60001:right:60001 &#92;                do &#92;                  sleep 5 &#92;                done; &#92;                openvpn [...]   root@right # until &#92;                  nat-traverse --quit-after-connect 60001:left:60001 &#92;                do &#92;                  sleep 5 &#92;                done; &#92;                openvpn [...]&lt;!--</p><p>The \*(C`until\*(C' loop ensures that OpenVPN will not be started before nat-traverse was able to establish the connection. Michael Kugele (\*(C`michael (at) kugele.net\*(C') also reported a way to still be able to use OpenVPN's multi-client mode with nat-traverse: As all instances of nat-traverse have to use unique ports (because a connection is identified by the source/destination port combination), you've to use redirection rules to redirect the ports used by nat-traverse to the port the OpenVPN daemon listens on:</p><p>  iptables -t nat -A PREROUTING -p udp &#92;     --dport $LPORT -j DNAT --to $HOST:$PORT   iptables -t nat -A PREROUTING -p udp &#92;     --dport $PORT -j REDIRECT --to-port $LPORT</p><p>$LPORT specifies the source port nat-traverse uses on the server side, and \*(C`$HOST:$PORT\*(C' is the address of the OpenVPN server.)</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">LIMITATIONS</h2>
        <div class="sectioncontent">
<p>Only IPv4 is supported, nat-traverse won't work with IPv6 addresses. Drop me a note if you do need IPv6 support.</p><p>nat-traverse does not work with gateways which change the port numbers. This is a fundamental problem of nat-traverse's design, as the changed port numbers are (in general) not predictable.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO nat-traverse&hellip;</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    &lt;\s-1RFC\s0 1631 at http://www.ietf.org/rfc/rfc1631.txt&gt;
  </dt>
  <dd>
    <p>The \s-1IP\s0 Network Address Translator (\s-1NAT\s0). K. Egevang, P. Francis.  May 1994. (Obsoleted by \s-1RFC3022\s0) (Status: \s-1INFORMATIONAL\s0)</p>
  </dd>
  <dt>
    &lt;\s-1RFC\s0 3022 at http://www.ietf.org/rfc/rfc3022.txt&gt;
  </dt>
  <dd>
    <p>Traditional \s-1IP\s0 Network Address Translator (Traditional \s-1NAT\s0). P.  Srisuresh, K. Egevang. January 2001.  (Obsoletes \s-1RFC1631\s0) (Status: \s-1INFORMATIONAL\s0)</p>
  </dd>
  <dt>
    &lt;\s-1RFC\s0 1661 at http://www.ietf.org/rfc/rfc1661.txt&gt;
  </dt>
  <dd>
    <p>The Point-to-Point Protocol (\s-1PPP\s0). W. Simpson, Ed.. July 1994.  (Obsoletes \s-1RFC1548\s0) (Updated by \s-1RFC2153\s0) (Also \s-1STD0051\s0) (Status: \s-1STANDARD\s0)</p>
  </dd>
  <dt>
    &lt;http://ppp.samba.org/&gt;
  </dt>
  <dd>
    <p>Website of Paul's \s-1PPP\s0 Package (open source implementation of the Point-to-Point Protocol (\s-1PPP\s0) on Linux and Solaris)</p>
  </dd>
  <dt>
    &lt;German talk about nat-traverse at http://linide.sourceforge.net/nat-traverse/nat-traverse-talk.pdf&gt;
  </dt>
  <dd>
    <p>Dieser Vortrag zeigt, wie man einen Tunnel zwischen zwei Computern, die beide hinter NAT-Gateways sitzen, hinbekommt. Dazu wird ein neues Programm vorgestellt, welches sowohl einfache TastendrA\*~Xcke an die Gegenseite weiterleiten, als auch beliebige Programme mit Verbindungen zur Gegenseite starten kann. Damit ist ein einfaches \s-1VPN\s0 schnell aufgebaut.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Copyright (C) 2005, 2012 Ingo Blechschmidt, &lt;iblech@web.de&gt;.</p><p>You may want to visit nat-traverse's Freecode project page, &lt;http://freecode.com/projects/nat-traverse/&gt;.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">LICENSE</h2>
        <div class="sectioncontent">
<p>This program is free software; you can redistribute it and/or modify it under the terms of the \s-1GNU\s0 General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</p><p>This program is distributed in the hope that it will be useful, but \s-1WITHOUT\s0 \s-1ANY\s0 \s-1WARRANTY\s0; without even the implied warranty of \s-1MERCHANTABILITY\s0 or \s-1FITNESS\s0 \s-1FOR\s0 A \s-1PARTICULAR\s0 \s-1PURPOSE\s0.  See the \s-1GNU\s0 General Public License for more details.</p><p>You should have received a copy of the \s-1GNU\s0 General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, \s-1MA\s0  02110-1301, \s-1USA\s0.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="nasty.1.html"><span aria-hidden="true">&larr;</span> nasty.1: A tool which helps you to recover your gpg passphrase</a></li>
   <li class="next"><a href="natbraille.1.html">natbraille.1: French braille typesetting <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
