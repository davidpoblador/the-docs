<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>queue_splitter3: Pgq consumer that transports events from one queue into several target queues</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Pgq consumer that transports events from one queue into several target queues">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="queue_splitter3 (1) manual">
  <meta name="twitter:description" content="Pgq consumer that transports events from one queue into several target queues">
  <meta name="twitter:image" content="https://www.carta.tech/images/skytools3-queue_splitter3-1.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man1/queue_splitter3.1.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="queue_splitter3 (1) manual" />
  <meta property="og:description" content="Pgq consumer that transports events from one queue into several target queues" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/skytools3-queue_splitter3-1.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">queue_splitter3<small> (1)</small></h1>
        <p class="lead">Pgq consumer that transports events from one queue into several target queues</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/">
      <span itemprop="name">Executable programs or shell commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/queue_splitter3.1.html">
      <span itemprop="name">queue_splitter3: Pgq consumer that transports events from one queue into several target queues</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/skytools3/">
      <span itemprop="name">skytools3</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/queue_splitter3.1.html">
      <span itemprop="name">queue_splitter3: Pgq consumer that transports events from one queue into several target queues</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
queue_splitter3 [switches] config.ini
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>queue_spliter is PgQ consumer that transports events from source queue into several target queues. ev_extra1 field in each event shows into which target queue it must go. (pgq.logutriga() puts there the table name.)</p><p>One use case is to move events from OLTP database to batch processing server. By using queue spliter it is possible to move all kinds of events for batch processing with one consumer thus keeping OLTP database less crowded.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">QUICK-START</h2>
        <div class="sectioncontent">
<p>Basic queue_splitter setup and usage can be summarized by the following steps:</p><p>pgq must be installed both in source and target databases. See pgqadm man page for details. Target database must also have pgq_ext schema installed.</p><p>edit a queue_splitter configuration file, say queue_splitter_sourcedb_sourceq_targetdb.ini</p><p>create source and target queues</p>
<pre>
$ pgqadm.py ticker.ini create &lt;queue&gt;
</pre>
<p>launch queue splitter in daemon mode</p>
<pre>
$ queue_splitter3 queue_splitter_sourcedb_sourceq_targetdb.ini -d
</pre>
<p>start producing and consuming events</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CONFIG</h2>
        <div class="sectioncontent">
<h3>Common configuration parameters</h3>
<p>job_name</p><p>Name for particulat job the script does. Script will log under this name to logdb/logserver. The name is also used as default for PgQ consumer name. It should be unique.</p><p>pidfile</p><p>Location for pid file. If not given, script is disallowed to daemonize.</p><p>logfile</p><p>Location for log file.</p><p>loop_delay</p><p>If continuisly running process, how long to sleep after each work loop, in seconds. Default: 1.</p><p>connection_lifetime</p><p>Close and reconnect older database connections.</p><p>use_skylog</p><p>foo.</p>
<h3>Common PgQ consumer parameters</h3>
<p>queue_name</p><p>Queue name to attach to. No default.</p><p>consumer_name</p><p>Consumers ID to use when registering. Default: %(job_name)s</p>
<h3>queue_splitter parameters</h3>
<p>src_db</p><p>Source database.</p><p>dst_db</p><p>Target database.</p>
<h3>Example config file</h3>

<pre>
[queue_splitter3]
job_name        = queue_spliter_sourcedb_sourceq_targetdb
</pre>

<pre>
src_db          = dbname=sourcedb
dst_db          = dbname=targetdb
</pre>

<pre>
pgq_queue_name  = sourceq
</pre>

<pre>
logfile         = ~/log/%(job_name)s.log
pidfile         = ~/pid/%(job_name)s.pid
</pre>


        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COMMAND LINE SWITCHES</h2>
        <div class="sectioncontent">
<p>Following switches are common to all skytools.DBScript-based Python programs.</p><p>-h, --help</p><p>show help message and exit</p><p>-q, --quiet</p><p>make program silent</p><p>-v, --verbose</p><p>make program more verbose</p><p>-d, --daemon</p><p>make program go background</p><p>--ini</p><p>show commented template config file.</p><p>Following switches are used to control already running process. The pidfile is read from config then signal is sent to process id specified there.</p><p>-r, --reload</p><p>reload config (send SIGHUP)</p><p>-s, --stop</p><p>stop program safely (send SIGINT)</p><p>-k, --kill</p><p>kill program immidiately (send SIGTERM)</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">USECASE</h2>
        <div class="sectioncontent">
<p>How to to process events created in secondary database with several queues but have only one queue in primary database. This also shows how to insert events into queues with regular SQL easily.</p>
<pre>
CREATE SCHEMA queue;
CREATE TABLE queue.event1 (
     -- this should correspond to event internal structure
     -- here you can put checks that correct data is put into queue
     id int4,
     name text,
     -- not needed, but good to have:
     primary key (id)
);
-- put data into queue in urlencoded format, skip actual insert
CREATE TRIGGER redirect_queue1_trg BEFORE INSERT ON queue.event1
FOR EACH ROW EXECUTE PROCEDURE pgq.logutriga(&apos;singlequeue&apos;, &apos;SKIP&apos;);
-- repeat the above for event2
</pre>

<pre>
-- now the data can be inserted:
INSERT INTO queue.event1 (id, name) VALUES (1, &apos;user&apos;);
</pre>
<p>If the queue_splitter is put on "singlequeue", it spreads the event on target to queues named "queue.event1", "queue.event2", etc. This keeps PgQ load on primary database minimal both CPU-wise and maintenance-wise.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="queue_mover3.1.html"><span aria-hidden="true">&larr;</span> queue_mover3.1: Pgq consumer that copies data from one queue to another.</a></li>
   <li class="next"><a href="quickbook.1.html">quickbook.1: Wikiwiki style documentation tool geared towards c++ documentation <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
