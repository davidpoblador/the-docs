<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>safecat: Safely write data to a file</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Safely write data to a file">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="safecat (1) manual">
  <meta name="twitter:description" content="Safely write data to a file">
  <meta name="twitter:image" content="https://www.carta.tech/images/safecat-safecat-1.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man1/safecat.1.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="safecat (1) manual" />
  <meta property="og:description" content="Safely write data to a file" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/safecat-safecat-1.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">safecat<small> (1)</small></h1>
        <p class="lead">Safely write data to a file</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/">
      <span itemprop="name">Executable programs or shell commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/safecat.1.html">
      <span itemprop="name">safecat: Safely write data to a file</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/safecat/">
      <span itemprop="name">safecat</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/safecat.1.html">
      <span itemprop="name">safecat: Safely write data to a file</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>safecat</strong> <em>tempdir</em> <em>destdir</em></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">INTRODUCTION</h2>
        <div class="sectioncontent">
<p><em>safecat</em> is a program which implements Professor Daniel Bernstein's <em>maildir</em> algorithm to copy <em>stdin</em> safely to a file in a specified directory.  With <em>safecat</em>, the user is offered two assurances.  First, if <em>safecat</em> returns a successful exit status, then all data is guaranteed to be saved in the destination directory. Second, if a file exists in the destination directory, placed there by <em>safecat</em>, then the file is guaranteed to be complete.</p><p>When saving data with <em>safecat</em>, the user specifies a destination directory, but not a file name. The file name is selected by <em>safecat</em> to ensure that no filename collisions occur, even if many <em>safecat</em> processes and other programs implementing the <em>maildir</em> algorithm are writing to the directory simultaneously.  If particular filenames are desired, then the user should rename the file after <em>safecat</em> completes.  In general, when spooling data with <em>safecat</em>, a single, separate process should handle naming, collecting, and deleting these files.  Examples of such a process are daemons, cron jobs, and mail readers.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELIABILITY ISSUES</h2>
        <div class="sectioncontent">
<p>A machine may crash while data is being written to disk. For many programs, including many mail delivery agents, this means that the data will be silently truncated. Using Professor Bernstein's <em>maildir</em> algorithm, every file is guaranteed complete or nonexistent.</p><p>Many people or programs may write data to a common "spool" directory.  Systems like <em>mh-mail</em> store files using numeric names in a directory.  Incautious writing to files can result in a collision, in which one write succeeds and the other appears to succeed but fails. Common strategies to resolve this problem involve creation of lock files or other synchronizing mechanisms, but such mechanisms are subject to failure.  Anyone who has deleted $HOME/.netscape/lock in order to start netscape can attest to this.  The <em>maildir</em> algorithm is immune to this problem because it uses no locks at all.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">THE MAILDIR ALGORITHM</h2>
        <div class="sectioncontent">
<p>As described in <a href="../man5/maildir.5.html"><strong>maildir</strong>(5)</a>, <em>safecat</em> applies the <em>maildir</em> algorithm by writing data in six steps. First, it <strong>stat()s</strong> the two directories <em>tempdir</em> and <em>destdir</em>, and exits unless both directories exist and are writable. Second, it <strong>stat()s</strong> the name <strong>tempdir/</strong><em>time.pid.host</em>, where <em>time</em> is the number of seconds since the beginning of 1970 GMT, <em>pid</em> is the program's process ID, and <em>host</em> is the host name. Third, if <strong>stat()</strong> returned anything other than ENOENT, the program sleeps for two seconds, updates <em>time</em>, and tries the <strong>stat()</strong> again, a limited number of times. Fourth, the program creates <strong>tempdir/</strong><em>time.pid.host</em>. Fifth, the program <em>NFS-writes</em> the message to the file. Sixth, the program <strong>link()</strong>s the file to <strong>destdir/</strong><em>time.pid.host</em>. At that instant the data has been successfully written.</p><p>In addition, <em>safecat</em> starts a 24-hour timer before creating <strong>tempdir/</strong><em>time.pid.host</em>, and aborts the write if the timer expires. Upon error, timeout, or normal completion, <em>safecat</em> attempts to <strong>unlink()</strong> <strong>tempdir/</strong><em>time.pid.host</em>.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXIT STATUS</h2>
        <div class="sectioncontent">
<p>An exit status of 0 (success) implies that all data has been safely committed to disk.  A non-zero exit status should be considered to mean failure, though there is an outside chance that <em>safecat</em> wrote the data successfully, but didn't think so.</p><p>Note again that if a file appears in the destination directory, then it is guaranteed to be complete.</p><p>If <em>safecat</em> completes successfully, then it will print the name of the newly created file (without its path) to standard output.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SUGGESTED APPLICATIONS</h2>
        <div class="sectioncontent">
<p>Exciting uses for <em>safecat</em> abound, obviously, but a word may be in order to suggest what they are.</p><p>If you run Linux and use qmail instead of sendmail, you should consider converting your inbox to <em>maildir</em> for its superior reliability.  If your home directory is NFS mounted, qmail forces you to use <em>maildir</em>.</p><p>If you write CGI applications to collect data over the World Wide Web, you might find <em>safecat</em> useful.  Web applications suffer from two major problems.  Their performance suffers from every stoppage or bottleneck in the internet; they cannot afford to introduce performance problems of their own. Additionally, web applications should NEVER leave the server and database in an inconsistent state.  This is likely, however, if CGI scripts directly frob some database--particularly if the database is overloaded or slow.  What happens when users get bored and click "Stop" or "Back"?  Maybe the database activity completes.  Maybe the CGI script is killed, leaving the DB in an inconsistent state.</p><p>Consider the following strategy.  Make your CGI script dump its request to a spool directory using <em>safecat</em>. Immediately return a receipt to the browser.  Now the browser has a complete guarantee that their submission is received, and the perceived performance of your web application is optimal.</p><p>Meanwhile, a spooler daemon notices the fresh request, snatches it and updates the database.  Browsers can be informed that their request will be fulfilled in X minutes.  The result is optimal performance despite a capricious internet.  In addition, users can be offered nearly 100% reliability.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLES</h2>
        <div class="sectioncontent">
<p>To convince sendmail to use <em>maildir</em> for message delivery, add the following line to your .forward file:</p>
<pre>
<strong>|SAFECAT HOME/Maildir/tmp HOME/Maildir/new || exit 75 #USERNAME</strong>

</pre>
<p>where <strong>SAFECAT</strong> is the complete path of the <em>safecat</em> program, <strong>HOME</strong> is the complete path to your home directory, and <strong>USERNAME</strong> is your login name. Making this change is likely to pay off; many campuses and companies mount user home directories with NFS.  Using <em>maildir</em> to deliver to your inbox folder helps ensure that your mail will not be lost due to some NFS error.  Of course, if you are a System Administrator, you should consider switching to qmail.</p><p>To run a program and catch its output safely into some directory, you can use a shell script like the following.</p>
<pre>
#!/bin/bash

MYPROGRAM=cat              # The program you want to run
TEMPDIR=/tmp               # The name of a temporary directory
DESTDIR=$HOME/work/data    # The directory for storing information

try() { $* 2&gt;/dev/null || echo NO 1&gt;&2 }

set `( try $MYPROGRAM | try safecat $TEMPDIR $DESTDIR ) 2&gt;&1`
test "$?" = "0"  || exit -1
test "$1" = "NO" && { rm -f $DESTDIR/$2; exit -1; }

</pre>
<p>This script illustrates the pitfalls of writing secure programs with the shell.  The script assumes that your program might generate some output, but then fail to complete.  There is no way for <em>safecat</em> to know whether your program completed successfully or not, because of the semantics of the shell.  As a result, safecat might create a file in the data directory which is "complete" but not useful.  The shell script deletes the file in that case.</p><p>More generally, the safest way to use <em>safecat</em> is from within a C program which invokes safecat with <em>fork()</em> and <em>execve()</em>. The parent process can the simply <em>kill()</em> the <em>safecat</em> process if any problems develop, and optionally can try again.  Whether to go to this trouble depends upon how serious you are about protecting your data.  Either way, <em>safecat</em> will not be the weak link in your data flow.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BUGS</h2>
        <div class="sectioncontent">
<p>In order to perform the last step and <em>link()</em> the temporary file into the destination directory, both directories must reside in the same file system.  If they do not, <em>safecat</em> will quietly fail every time.  In Professor Bernstein's implementation of <em>maildir</em>, the temporary and destination directories are required to belong to the same parent directory, which essentially avoids this problem. We relax this requirement to provide some flexibility, at the cost of some risk.  Caveat emptor.</p><p>Although <em>safecat</em> cleans up after itself, it may sometimes fail to delete the temporary file located in <em>tempdir</em>. Since safecat times out after 24 hours, you may freely delete any temporary files older than 36 hours.  Files newer than 36 hours should be left alone.  A system of data flow involving safecat should include a cron job to clean up temporary files, or should obligate consumers of the data to do the cleanup, or both.  In the case of qmail, mail readers using <em>maildir</em> are expected to scan and clean up the temporary directory.</p><p>The guarantee of safe delivery of data is only "as certain as UNIX will allow."  In particular, a disk hardware failure could result in <em>safecat</em> concluding that the data was safe, when it was not.  Similarly, a successful exit status from <em>safecat</em> is of no value if the computer, its disks and backups all explode at some subsequent time.</p><p>In other words, if your data is vital to you, then you won't just use <em>safecat</em>. You'll also invest in good equipment (possibly including a RAID disk), a UPS for the server and drives, a regular backup schedule, and competent system administration.  For many purposes, however, <em>safecat</em> can be considered 100% reliable.</p><p>Also note that <em>safecat</em> was designed for spooling email messages; it is not the right tool for spooling large files--files larger than 2GB, for example. Some operating systems have a bug which causes safecat to fail silently when spooling files larger than 2GB. When building <em>safecat</em>, you can take advantage of conditional support for large files on Linux; see <em>conf-cc</em> for further information.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CREDITS</h2>
        <div class="sectioncontent">
<p>The <em>maildir</em> algorithm was devised by Professor Daniel Bernstein, the author of qmail.  Parts of this manpage borrow directly from <a href="../man5/maildir.5.html"><strong>maildir</strong>(5)</a> by Professor Bernstein.  In particular, the section "THE MAILDIR ALGORITHM" transplants his explanation of the <em>maildir</em> algorithm in order to illustrate that <em>safecat</em> complies with it.</p><p>The original code for <em>safecat</em> was written by the present author, but was since augmented with heavy borrowings from qmail code.  However, under no circumstances should the author of qmail be contacted concerning safecat bugs; all are the fault, and the responsibility, of the present author.</p><p>Copyright (c) 2000, Len Budney. All rights reserved.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO safecat&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man5/mbox.5.html"><strong>mbox</strong>(5)</a>, <a href="../man8/qmail-local.8.html"><strong>qmail-local</strong>(8)</a>, <a href="../man5/maildir.5.html"><strong>maildir</strong>(5)</a></p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="sadf.1.html"><span aria-hidden="true">&larr;</span> sadf.1: Display data collected by sar in multiple formats.</a></li>
   <li class="next"><a href="safecopy.1.html">safecopy.1: A data recovery tool <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
