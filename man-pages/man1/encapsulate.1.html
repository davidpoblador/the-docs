<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>encapsulate: Multiplex several channels over a single socket with sampling of remote process exit status, and provide conversation termination without closing the socket.  netpipes 4.2</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Multiplex several channels over a single socket with sampling of remote process exit status, and provide conversation termination without closing the socket.  netpipes 4.2">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="encapsulate (1) manual">
  <meta name="twitter:description" content="Multiplex several channels over a single socket with sampling of remote process exit status, and provide conversation termination without closing the socket.  netpipes 4.2">
  <meta name="twitter:image" content="https://www.carta.tech/images/netpipes-encapsulate-1.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man1/encapsulate.1.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="encapsulate (1) manual" />
  <meta property="og:description" content="Multiplex several channels over a single socket with sampling of remote process exit status, and provide conversation termination without closing the socket.  netpipes 4.2" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/netpipes-encapsulate-1.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">encapsulate<small> (1)</small></h1>
        <p class="lead">Multiplex several channels over a single socket with sampling of remote process exit status, and provide conversation termination without closing the socket.  netpipes 4.2</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/">
      <span itemprop="name">Executable programs or shell commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/encapsulate.1.html">
      <span itemprop="name">encapsulate: Multiplex several channels over a single socket with sampling of remote process exit status, and provide conversation termination without closing the socket.  netpipes 4.2</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/netpipes/">
      <span itemprop="name">netpipes</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/encapsulate.1.html">
      <span itemprop="name">encapsulate: Multiplex several channels over a single socket with sampling of remote process exit status, and provide conversation termination without closing the socket.  netpipes 4.2</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>encapsulate</strong> <strong>--fd</strong> <em>n</em> [ <strong>--verbose</strong> ] [ <strong>--subproc</strong> [ <strong>--infd</strong> <em>n</em>[<strong>=</strong><em>sid</em>] ] [ <strong>--outfd</strong> <em>n</em>[<strong>=</strong><em>sid</em>] ] [ <strong>--duplex</strong> <em>n</em>[<strong>=</strong><em>sid</em>] ] [ <strong>--Duplex</strong> <em>n</em>[<strong>=</strong><em>sid</em>] ] [ <strong>--DUPLEX</strong> <em>n</em>[<strong>=</strong><em>sid</em>] ] [ <strong>--prefer-local</strong> ] [ <strong>--prefer-remote</strong> ] [ <strong>--local-only</strong> ] [ <strong>--remote-only</strong> ] ] [ <strong>--client</strong> ] [ <strong>--server</strong> ] <strong>-</strong>[<strong>#</strong><em>n</em>][<strong>v</strong>][<strong>s</strong>[<strong>i</strong><em>n</em>][<strong>o</strong><em>n</em>][<strong>d</strong><em>n</em>][<strong>io</strong><em>n</em>][<strong>oi</strong><em>n</em>][<strong>l</strong>][<strong>r</strong>][<strong>L</strong>][<strong>R</strong>]] <em>command args ...</em></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p><strong>encapsulate </strong> implements the Session Control Protocol (SCP) in a limited manner. <strong>encapsulate</strong> multiplexes several virtual channels over a single socket using SCP. <strong>encapsulate</strong> transmits the exit status of the local program to the remote end over a reserved SCP channel and receives the remote exit status back. <strong>encapsulate</strong> provides conversation boundaries without closing the socket.</p><p>Flags may appear in any order.  The first argument that isn't a flag is the command to spawn (assuming <strong>--subproc</strong> is specified, an error otherwise).</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OPTIONS</h2>
        <div class="sectioncontent">
<p><strong>--fd</strong> <em>n</em>, <strong>-#</strong><em>n</em> : specify the file descriptor of the socket we will be multiplexing subprocess channels over.  This argument is required</p><p><strong>--verbose</strong>, <strong>-v</strong> : Print extra information (including a copyright notice) to stderr.</p><p><strong>--subproc</strong>, <strong>-s</strong> : spawn a subprocess.  You must supply a <em>command</em> and <em>args</em>.  If you omit this flag, then you must <strong>not</strong> supply a <em>command</em> and <em>args</em>.  If you omit this flag, <strong>encapsulate</strong> will copy input from stdin to an outgoing channel in the SCP-muxed socket and copy to stdout from an incoming channel in the SCP-muxed socket.  If you omit this flag, all of the input and output channel flags are illegal.</p><p><strong>--infd</strong> <em>n</em>, <strong>-i</strong><em>n</em> : specify an input channel.  If there is a subprocess, it will be able to read from descriptor <em>n</em>.  If there is no subprocess <strong>encapsulate</strong> will read from its descriptor <em>n</em> (these are opposite polarities for the SCP channel).</p><p><strong>--outfd</strong> <em>n</em>, <strong>-o</strong><em>n</em> : specify an output channel.  If there is a subprocess, it will be able to write to descriptor <em>n</em>.  If there is no subprocess <strong>encapsulate</strong> will write to its descriptor <em>n</em> (these are opposite polarities for the SCP channel).</p><p><strong>--duplex</strong> <em>n</em>, <strong>-io</strong><em>n</em> : specify a bidirectional channel.  The remote <strong>encapsulate</strong> will send the SCP SYN packet, and the local will respond with a SYN for the same session.  The subprocess will be able to read and write to file descriptor <em>n</em>. The subprocess should use the <a href="../man1/sockdown.1.html"><strong>sockdown</strong>(1)</a> program if it must close one direction while leaving the other direction open.</p><p><strong>--Duplex</strong> <em>n</em>, <strong>-d</strong><em>n</em> : specify a bidirectional channel.  The <strong>--client</strong> end of the <strong>encapsulate</strong> connection sends the SCP SYN packet and <strong>--server</strong> responds with a SYN for the same session.  The subprocess will be able to read and write to file descriptor <em>n</em>.  The subprocess should use the <a href="../man1/sockdown.1.html"><strong>sockdown</strong>(1)</a> program if it must close one direction while leaving the other direction open.</p><p><strong>--DUPLEX</strong> <em>n</em>, <strong>-oi</strong><em>n</em> : specify a bidirectional channel.  The local <strong>encapsulate</strong> will send the SCP SYN packet, and the remote will respond with a SYN for the same session.  The subprocess will be able to read and write to file descriptor <em>n</em>. The subprocess should use the <a href="../man1/sockdown.1.html"><strong>sockdown</strong>(1)</a> program if it must close one direction while leaving the other direction open.</p><p>All of the long forms of the bidirectional channel have an optional <strong>=</strong><em>sid</em> component that can be used to specify the SCP Session ID.  This is not very useful when connecting encapsulate to another instance of itself, but could be handy when connecting to another piece of software that implements SCP.</p><p><strong>--prefer-local</strong>, <strong>-l</strong> : if both the remote and local subprocesses exit with non-zero (erroneous) codes, <strong>encapsulate</strong> will exit with the same code as the local subprocess.  <strong>This is the</strong> default.</p><p><strong>--prefer-remote</strong>, <strong>-r</strong> : if both the remote and local subprocesses exit with non-zero (erroneous) codes, <strong>encapsulate</strong> will exit with the same code as the remote subprocess.</p><p><strong>--local-only</strong>, <strong>-L</strong> : <strong>encapsulate</strong> exits with the local status and ignores the remote status.</p><p><strong>--remote-only</strong>, <strong>-R</strong> : <strong>encapsulate</strong> exits with the remote status and ignores the local status.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SESSION IDs AND SUBPROCESS CHANNELS</h2>
        <div class="sectioncontent">
<p>When specifying channels for the subprocess, the order of the flags is very important.  Every flag to the local <strong>encapsulate</strong> must have a corresponding flag on the remote <strong>encapsulate</strong> that is in the exact same position (in the list of channels).  The descriptor numbers need not correspond, but the position and type of each channel must.</p><p>A lamentably complicating factor is that the data flow implied by <strong>--infd</strong> and <strong>--outfd</strong> are different when you specify a subprocess.</p><table class="table table-striped">
<tr>
<th>Local</th>
<th>Remote</th></tr>

<tr>
<td><strong>--infd</strong> w/subproc</td>
<td><strong>--outfd</strong> w/subproc</td></tr>

<tr>
<td><strong>--infd</strong> w/subproc</td>
<td><strong>--infd</strong></td></tr>

<tr>
<td><strong>--infd</strong></td>
<td><strong>--infd</strong> w/subproc</td></tr>

<tr>
<td><strong>--infd</strong></td>
<td><strong>--outfd</strong></td></tr>

<tr>
<td><strong>--outfd</strong> w/subproc</td>
<td><strong>--infd</strong> w/subproc</td></tr>

<tr>
<td><strong>--outfd</strong> w/subproc</td>
<td><strong>--outfd</strong></td></tr>

<tr>
<td><strong>--outfd</strong></td>
<td><strong>--outfd</strong> w/subproc</td></tr>

<tr>
<td><strong>--outfd</strong></td>
<td><strong>--infd</strong></td></tr>

<tr>
<td><strong>--duplex</strong></td>
<td><strong>--DUPLEX</strong></td></tr>

<tr>
<td><strong>--Duplex</strong></td>
<td><strong>--Duplex</strong></td></tr>

<tr>
<td><strong>--DUPLEX</strong></td>
<td><strong>--duplex</strong></td></tr>
</table><p>RIGHT:</p>
<pre>
l$ encapsulate --infd 0 --duplex 5
r$ encapsulate --outfd 1 --DUPLEX 5
</pre>
<p>WRONG:</p>
<pre>
l$ encapsulate --infd 0 --duplex 5
r$ encapsulate --outfd 1 --duplex 5
</pre>
<p><strong>--duplex</strong> must have a corresponding <strong>--DUPLEX</strong> on the remote end.</p>
<pre>
l$ encapsulate --infd 0 --duplex 5
r$ encapsulate --DUPLEX 5 --outfd 1
</pre>
<p><strong>--infd</strong> must have a corresponding <strong>--outfd</strong> on the remote end.  It's out of order and the channels will be allocated incorrectly leading to protocol errors.</p><p>If you understand the source code for <strong>encapsulate</strong>, you can violate these guidelines, but it is unnecessary, error-prone, and ill-advised; besides, you don't really understand the source code. Don't do it.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CLIENT -VS- SERVER</h2>
        <div class="sectioncontent">
<p>The SCP has an implicit polarity.  One end is the server and the other end is the client.  You can specify which end is which using <strong>--client</strong> and <strong>--server</strong>.  If you do not specify one, then <strong>encapsulate</strong> will compare the addresses of both ends of the socket (specified with <strong>--fd</strong>) and use a deterministic algorithm to pick one to be the server and one to be the client.  If the remote address of the socket does not correspond to the remote <strong>encapsulate</strong> (e.g. the packets are being forwarded through a plugged gateway, the addresses are being masqueraded, or are otherwise percieved inconsistently by the two ends) then this algorithm has a good chance of "failing" and assigning both to be server or both to be client.</p><p>The only time you should ever let <strong>encapsulate</strong> choose between client and server is in interactive situations.  It is very likely that a software system built around <strong>encapsulate</strong> will be reused in a situation where the automatic polarity assignment fails.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLES</h2>
        <div class="sectioncontent">
<p>Here's a simple file transfer daemon:</p>
<pre>
server$ faucet 3001 --once --fd3 &#92;
     sh -c 'while ~/src/netpipes4.0/encapsulate --fd 3 -so5i4 &#92;
                sh -c "fname=`cat 0&lt;&4`; echo &#92;$fname; cat &lt; &#92;$fname 1&gt;&5"; &#92;
                do true; done'
client$ hose server 3001 --retry 10 --delay 1 --fd3 &#92;
        sh -c 'while read fname; do &#92;
                ~/src/netpipes4.0/encapsulate --fd 3 -si4o5 &#92;
                        sh -c "echo $fname 1&gt;&5; exec 5&gt;&-; cat 0&lt;&4" &#92;
                || break; done'
</pre>
<p>Just type the name of the file you want to retrieve into the hose and press return.  It will be dumped to stdout.  Repeat until enlightened or bored.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">TROUBLESHOOTING</h2>
        <div class="sectioncontent">
<p>Did you specify <strong>--client</strong> and <strong>--server</strong> properly?  One side should be server, the other side should be client.  If you specify them both as server or both as client, you have made a mistake.  Do not rely on the automatic polarity detection.  While it is theoretically a very good algorithm, it is fooled very easily.</p><p>Do all of your channel assignments (<strong>--infd</strong> et al) match up? If you get these wrong, <strong>encapsulate</strong> will freak out and drip spooge all over your shoes.</p><p>For deadlock avoidance, make sure you are closing channels when you don't need them anymore.  Use the &gt;&- redirection operator in sh or bash.  Make sure you close it in all of the background processes as well.</p><p>Unable to read stdin from a process that has been backgrounded with &&nbsp;?  Bash closes file descriptor 0 for any subprocess that is backgrounded (e.g. (command&) ).  You can get around this by copying 0 onto another descriptor, and then copying it back within the backgrounded process.</p>
<pre>
( ( cat 0&lt;&3 ) & ) 3&lt;&0
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO encapsulate&hellip;</h2>
        <div class="sectioncontent">
<p>netpipes (1), http://sunsite.unc.edu/ses/scp.html</p><p>The Session Control Protocol document on SunSite was a draft. There is a more recent one that doesn't specify header compression (which I don't use anyway).  It may eventually become an RFC.  Then again, encapsulate may be the only program which ever implements SCP.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BUGS</h2>
        <div class="sectioncontent">
<p><strong>encapsulate</strong> is not hard to deadlock.  Until I add unbounded buffering inside encapsulate, avoid constructing deadlock-vulnerable systems.</p><p>The <strong>encapsulate</strong> included with netpipes 4.0 totally failed to handle the case where no subprocess was specified.  No error message would be issued, and the program would do absolutely nothing. The 4.1 version should work.</p><p><strong>encapsulate</strong> has no other known bugs.  I'm sure there are unknown ones because this software is not yet mature; in fact, it's totally wet behind the ears.  Break it and send me the pieces.</p><p>Well, the command-line argument style is inconsistent with faucet & hose.  I'll be updating faucet & hose.</p><p>The Linux kernel from the beginning of time up through version 2.0.29 has a problem with sockets being shut down "too fast".  This results in loss of data at the end of a stream and an "Error: connection reset by peer" during reads.  2.0.30 supposedly fixes this. This state machine flaw is very likely present in many other OSes, because the strange conditions that exercise it are almost nonexistent in normal applications, but happen all the time in some applications of the NetPipes package.  <strong>encapsulate</strong> can be used to work around this bug in some cases because encapsulate does not perform a shutdown on the network socket ever (it doesn't even do a "close").</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CREDITS</h2>
        <div class="sectioncontent">
<p>Hi Mom!  Hi Dad!</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COPYRIGHT</h2>
        <div class="sectioncontent">
<p>Copyright (C) 1997-98 Robert Forsman</p><p>This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</p><p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.</p><p>You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Robert Forsman  thoth@purplefrog.com  Purple Frog Software  http://web.purplefrog.com/~thoth/</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="enca.1.html"><span aria-hidden="true">&larr;</span> enca.1: Detect and convert encoding of text files</a></li>
   <li class="next"><a href="encfs.1.html">encfs.1: Mounts or creates an encrypted virtual filesystem <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
