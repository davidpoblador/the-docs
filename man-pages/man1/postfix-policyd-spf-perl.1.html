<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>postfix-policyd-spf-perl: Pure-perl postfix policy server for spf checking</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Pure-perl postfix policy server for spf checking">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="postfix-policyd-spf-perl (1) manual">
  <meta name="twitter:description" content="Pure-perl postfix policy server for spf checking">
  <meta name="twitter:image" content="https://www.carta.tech/images/postfix-policyd-spf-perl-postfix-policyd-spf-perl-1.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man1/postfix-policyd-spf-perl.1.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="postfix-policyd-spf-perl (1) manual" />
  <meta property="og:description" content="Pure-perl postfix policy server for spf checking" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/postfix-policyd-spf-perl-postfix-policyd-spf-perl-1.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">postfix-policyd-spf-perl<small> (1)</small></h1>
        <p class="lead">Pure-perl postfix policy server for spf checking</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/">
      <span itemprop="name">Executable programs or shell commands</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/postfix-policyd-spf-perl.1.html">
      <span itemprop="name">postfix-policyd-spf-perl: Pure-perl postfix policy server for spf checking</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/postfix-policyd-spf-perl/">
      <span itemprop="name">postfix-policyd-spf-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man1/postfix-policyd-spf-perl.1.html">
      <span itemprop="name">postfix-policyd-spf-perl: Pure-perl postfix policy server for spf checking</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">VERSION</h2>
        <div class="sectioncontent">
<p>2.008</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">USAGE</h2>
        <div class="sectioncontent">
<p>Usage:</p>
<pre>
    policyd-spf-perl [-v]
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OTHER DOCUMENTATION</h2>
        <div class="sectioncontent">
<p>This documentation assumes you have read Postfix's README_FILES/ SMTPD_POLICY_README.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p>postfix-policyd-spf-perl is a Postfix SMTP policy server for SPF checking. It is implemented in pure Perl and uses the Mail::SPF CPAN module.  Note that Mail::SPF is a complete re-implementation of SPF based on the final SPF RFC, RFC 4408.  It shares no code with the older Mail::SPF::Query that was the original SPF development implementation.</p><p>This version of the policy server always checks HELO before Mail From (older versions just checked HELO if Mail From was null).  It will reject mail that fails either Mail From or HELO SPF checks.  It will defer mail if there is a temporary SPF error and the message would othersise be permitted (DEFER_IF_PERMIT).  If the HELO check produces a REJECT/DEFER result, Mail From will not be checked.</p><p>If the message is not rejected or deferred, the policy server will PREPEND the appropriate SPF Received header.  If Mail From is anything other than completely empty (i.e. &lt;&gt;) then the Mail From result will be used for SPF Received (e.g. Mail From None even if HELO is Pass).</p><p>The policy server skips SPF checks for connections from the localhost (127.) and instead prepends and logs 'SPF skipped - localhost is always allowed.'  If you have relays that you want to skip SPF checks for, you can add them to relay_addresses on line 78 using standard CIDR notation in a space separated list.  For these addresses, 'X-Comment: SPF skipped for whitelisted relay' is prepended and logged.</p><p>Error conditions within the policy server (that don't result in a crash) or from Mail::SPF will return DUNNO.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>Logging is sent to syslogd.</p><p>Each time a Postfix SMTP server process is started it connects to the policy service socket and Postfix runs one instance of this Perls script.  By default, a Postfix SMTP server process terminates after 100 seconds of idle time, or after serving 100 clients.  Thus, the cost of starting this Perl script is smoothed over time.</p><p>The default policy_time_limit is 1000 seconds.  This may be too short for some SMTP transactions to complete.  As recommended in SMTPD_POLICY_README, this should be extended to 3600 seconds.  To do so, set "policy_time_limit = 3600" in /etc/postfix/main.cf.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">TESTING THE POLICY DAEMON</h2>
        <div class="sectioncontent">
<p>Testing the policy daemon</p><p>To test the policy daemon by hand, execute:</p>
<pre>
    % /usr/sbin/postfix-policyd-spf-perl
</pre>
<p>Each query is a bunch of attributes.  Order does not matter, and the server uses only a few of all the attributes shown below:</p>
<pre>
    request=smtpd_access_policy
    protocol_state=RCPT
    protocol_name=SMTP
    helo_name=some.domain.tld
    queue_id=
    instance=71b0.45e2f5f1.d4da1.0
    sender=foo@bar.tld
    recipient=bar@foo.tld
    client_address=1.2.3.4
    client_name=another.domain.tld
    [empty line]
</pre>
<p>The policy daemon will answer in the same style, with an attribute list followed by a empty line:</p>
<pre>
    action=550 Please see http://www.openspf.org/Why?id=foo@bar.tld&ip=1.2.3.4&
           receiver=bar@foo.tld
    [empty line]
</pre>
<p>To test HELO checking sender should be empty:</p>
<pre>
    sender=
    ... More attributes...
    [empty line]
</pre>
<p>If you want more detail in the system logs change $VERBOSE to 1.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">POSTFIX INTEGRATION</h2>
        <div class="sectioncontent">
<p> 1. Add the following to /etc/postfix/master.cf:</p>
<pre>
        spfcheck  unix  -       n       n       -       0       spawn
            user=policyd-spf argv=/usr/sbin/postfix-policyd-spf-perl
</pre>
<p> 2. Configure the Postfix SPF policy service in /etc/postfix/main.cf:</p>
<pre>
        smtpd_recipient_restrictions =
            ...
            reject_unauth_destination
            check_policy_service unix:private/spfcheck
            ...
        spfcheck_time_limit = 3600
</pre>

<pre>
    NOTE:  Specify check_policy_service AFTER reject_unauth_destination or
    else your system can become an open relay.
</pre>
<p> 3. Set up machines which you expect to legitimately forward mail to this</p>
<pre>
    server (see description in synopsis).  This should typically include
    the IP addresses which backup Mail eXchangers, and known non-SRS
    forwarders will use to submit mail to this server (i.e. the source IPs
    of the other servers).
</pre>
<p> 4. Restart Postfix.</p><p> 5. Verify correct backup MX operation (if applicable).</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO postfix-policyd-spf-perl&hellip;</h2>
        <div class="sectioncontent">
<p>libmail-spf-perl, &lt;http://www.openspf.org&gt;</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHORS</h2>
        <div class="sectioncontent">
<p>This version of <strong>policyd-spf-perl</strong> was written by Meng Weng Wong &lt;mengwong+spf@pobox.com&gt; and updated for libmail-spf-perl by Scott Kitterman &lt;scott@kitterman.com&gt; and Julian Mehnle &lt;julian@mehnle.net&gt;.</p><p>This man-page was written by Scott Kitterman &lt;scott@kitterman.com&gt;.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="postbooks-updater.1.html"><span aria-hidden="true">&larr;</span> postbooks-updater.1: Qt-based gui for updating the postbooks schema</a></li>
   <li class="next"><a href="postfwd1.1.html">postfwd1.1: Postfix firewall daemon <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
