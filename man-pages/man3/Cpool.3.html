<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cpool: Lcg pool inferface</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Lcg pool inferface">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="Cpool (3) manual">
  <meta name="twitter:description" content="Lcg pool inferface">
  <meta name="twitter:image" content="https://www.carta.tech/images/liblcgdm-dev-Cpool-3.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3/Cpool.3.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Cpool (3) manual" />
  <meta property="og:description" content="Lcg pool inferface" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/liblcgdm-dev-Cpool-3.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">Cpool<small> (3)</small></h1>
        <p class="lead">Lcg pool inferface</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/">
      <span itemprop="name">Library calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/Cpool.3.html">
      <span itemprop="name">Cpool: Lcg pool inferface</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/liblcgdm-dev/">
      <span itemprop="name">liblcgdm-dev</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/Cpool.3.html">
      <span itemprop="name">Cpool: Lcg pool inferface</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>#include &lt;Cpool_api.h&gt;</strong></p><p><strong>int Cpool_create(int </strong><em>nbwanted</em><strong>, int * </strong><em>nbget</em><strong>);</strong></p><p><strong>int Cpool_assign(int </strong><em>poolid</em><strong>, void *(*</strong><em>startroutine</em><strong>)(void *), void *</strong><em>arg</em><strong>, int </strong><em>timeout</em><strong>);</strong></p><p><strong>int Cpool_next_index(int </strong><em>poolid</em><strong>);</strong></p><p><strong>int Cpool_next_index_timeout(int </strong><em>poolid</em><strong>, int </strong><em>timeout</em><strong>);</strong></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">ERRORS</h2>
        <div class="sectioncontent">
<p>See <strong>Cthread</strong> corresponding section.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p><strong>(Please read the NOTE section)</strong></p><p><strong>Cpool</strong> is a layer built upon <strong>Cthread</strong>, the <strong>LCG Thread</strong> interface. It allows the user to create dedicated pools, and then to assign to one of them a given routine to execute.</p><p>The created processes or threads will remain alive, unless the routines assigned to are crashing, or explicitly calling an exit statement, like exit() or pthread_exit().</p><p>Typical use might be writing a server, with a bunch of pre-created processes or pools (depending on the environment with which <strong>Cthread</strong> has been compiled), and assign to a given pool a routine with the socket file descriptor as argument address.</p><p>In principle <strong>Cpool</strong> should be compiled with the same relevant flags with which <strong>Cthread</strong> has been.</p><p><strong>int Cpool_create(int </strong><em>nbwanted</em><strong>, int * </strong><em>nbget</em><strong>);</strong></p><p>This method is creating a pool of <em>nbwanted</em> processes or threads. If the second argument, <em>nbget</em> , is not NULL, its location will contain the number of effectively created threads or processes.</p><p>Return value is the pool ID, a number greater or equal to zero, or -1 in case of error.</p><p><strong>int Cpool_assign(int </strong><em>poolid</em><strong>, void *(*</strong><em>startroutine</em><strong>)(void *), void *</strong><em>arg</em><strong>, int </strong><em>timeout</em><strong>);</strong></p><p>This method is assigning a routine to <em>poolid</em> as returned by <strong>Cpool_create</strong>, whose address is <em>startroutine</em> , that have the same prototype as every typical routine in multithread programming. This means that it returns a pointer, and it gets as entry a pointer identified by the <em>arg</em> parameter. The last argument is a possible <em>timeout</em> , in seconds, which will apply if it is greater than zero. If it is lower than zero, the assignment will wait forever until a thread is available. If it is equal to zero, the method will return immediately if no thread is available.</p><p>Return value is 0 if success, or -1 in case of error.</p><p><strong>int Cpool_next_index(int </strong><em>poolid</em><strong>);</strong></p><p><strong>int Cpool_next_index_timeout(int </strong><em>poolid</em><strong>, int </strong><em>timeout</em><strong>);</strong></p><p>Those methods returns that next available thread number that will be assigned if you ever call <strong>Cpool_assign</strong> immediately after. If you specify a timeout lower or equal than zero, then this is a blocking method until one thread is available at least. Those methods, so, returns a number greater or equal than zero, and -1 if there is an error.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">NOTE</h2>
        <div class="sectioncontent">
<p><strong>Arguments passing in a non-thread environment</strong></p><p>Since a forked process can only address its namespace data segment, the address of the arguments, if any, valid in its parent, will not be directly accessible for the child we are talking about.</p><p>This means that Cpool, in a non-thread environment, have to trace-back all the memory allocation visible for the parent. Then, Cpool is not passing the address of the arguments, but its content to the child through a child-parent communication, monitored with a simple protocol.</p><p>There are four cases:</p>
<pre>
    1.The address is NULL: nothing will be transmitted to the child
    2.The address is exactly a pointer returned by malloc() or realloc(): the full malloced area will be tranmitted.
    3.The address is somewhere in a memory allocate block: the remaining memory block, e.g. starting from the address up to its end, will be transmitted.
    4.the address do not point to any memory allocated area: Cpool will assume it is a pointer-like argument, probably to some static variables, visible for all processes, and will transmit the content of the memory pointed by the address, assuming it is coded on 64-bits.
</pre>
<p>In any case, the user is passing a pointer, and the routine will see a pointer, pointing to a (hopefully, see the point 4., listed upper) same-content area.</p><p><strong>Arguments design to work on both thread and non-thread environments</strong></p><p>The thread and non-thread arguments can have conceptually a different design when dealing with arguments;</p><p>In a thread environment, the routined passed to Cpool_assign, is sharing memory, so is allowed to free() the argument, because memory is then shared. On the contrary, in a non-thread environment, this may be a segmentation fault.</p><p>This means that it is recommended to use static variables, containing simple value, like an integer (for example: a socket file descriptor), and not allocated memory. If, neverthless, you persist to use free() in your routine, you can use the following trick:</p>
<pre>
/* ------------------------ */
/* In the Caller Routine    */
/* ------------------------ */

arg = malloc(...);

if (! Cpool_assign(...)) {
  if (Cthread_environment() != CTHREAD_TRUE_THREAD) {
    /* Non-Thread environment */
    free(arg);
  } else {
    /* Thread environment     */
    /* ... do nothing         */
  }
} else {
    /* In cany case it is OK  */
    free(arg);
}

/* ------------------------ */
/* In the Execution Routine */
/* ------------------------ */

void *routine(void *arg) {
  ./..
  if (Cthread_environment() == CTHREAD_TRUE_THREAD) {
    /* Thread environment */
    free(arg);
  } else {
    /* Non-Thread environment */
    /* ... do nothing         */
  }
  ./..
}

</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLE</h2>
        <div class="sectioncontent">

<pre>
#include &lt;Cpool_api.h&gt;
#include &lt;stdio.h&gt;
#include &lt;errno.h&gt;

#define NPOOL 2
#define PROCS_PER_POOL 2
#define TIMEOUT 2
void *testit(void *);

int main() {
  int pid;
  int i, j;
  int ipool[NPOOL];
  int npool[NPOOL];
  int *arg;

  pid = getpid();

  printf("... Defining %d pools with %d elements each&#92;n",
         NPOOL,PROCS_PER_POOL);

  for (i=0; i &lt; NPOOL; i++) {
    if ((ipool[i] = Cpool_create(PROCS_PER_POOL,&(npool[i]))) &lt; 0) {
      printf("### Error No %d creating pool (%s)&#92;n",
             errno,strerror(errno));
    } else {
      printf("... Pool No %d created with %d processes&#92;n",
             ipool[i],npool[i]);
    }
  }

  for (i=0; i &lt; NPOOL; i++) {
    /* Loop on the number of processes + 1 ... */
    for (j=0; j &lt;= npool[i]; j++) {
      if ((arg = malloc(sizeof(int))) == NULL) {
        printf("### Malloc error, errno = %d (%s)&#92;n",
               errno,strerror(errno));
        continue;
      }
      *arg = i*10+j;
      printf("... Assign to pool %d (timeout=%d) the %d-th routine 0x%x(%d)&#92;n",
             ipool[i],TIMEOUT,j+1,(unsigned int) testit,*arg);
      if (Cpool_assign(ipool[i], testit, arg, TIMEOUT)) {
        printf("### Can't assign to pool No %d (errno=%d [%s]) the %d-th routine&#92;n",
               ipool[i],errno,strerror(errno),j);
        free(arg);
      } else {
        printf("... Okay for assign to pool No %d of the %d-th routine&#92;n",
               ipool[i],j);
        If (Cthread_environment() != CTHREAD_TRUE_THREAD) {
          /* Non-thread environment: the child is in principle not allowed */
          /* to do free himself                                            */
          free(arg);
        }
      }
    }
  }

  /* We wait enough time for our threads to terminate... */
  sleep(TIMEOUT*NPOOL*PROCS_PER_POOL);

  exit(EXIT_SUCCESS);
}

void *testit(void *arg) {
  int caller_pid, my_pid;

  my_pid = getpid();

  caller_pid = (int) * (int *) arg;

  if (Cthread_environment() == CTHREAD_TRUE_THREAD) {
    /* Thread environment : we free the memory */
    free(arg);
  }

  printf("... I am PID=%d called by pool %d, try No %d&#92;n",
         my_pid,caller_pid/10,caller_pid - 10*(caller_pid/10));

  /*
   * Wait up to the timeout + 1
   */
  sleep(TIMEOUT*2);

  return(NULL);
}




</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO Cpool&hellip;</h2>
        <div class="sectioncontent">
<p><strong>Cthread</strong></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p><strong>LCG Grid Deployment</strong> Team</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="Core.3.html"><span aria-hidden="true">&larr;</span> Core.3: Core  the core widget class "core" "widget class" "core"</a></li>
   <li class="next"><a href="Cpwd.3.html">Cpwd.3: Lcg password file thread-safe inferface <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
