<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>lockfile_check: Manage lockfiles</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Manage lockfiles">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="lockfile_check (3) manual">
  <meta name="twitter:description" content="Manage lockfiles">
  <meta name="twitter:image" content="https://www.carta.tech/images/liblockfile-dev-lockfile_check-3.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3/lockfile_check.3.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="lockfile_check (3) manual" />
  <meta property="og:description" content="Manage lockfiles" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/liblockfile-dev-lockfile_check-3.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">lockfile_check<small> (3)</small></h1>
        <p class="lead">Manage lockfiles</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/">
      <span itemprop="name">Library calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/lockfile_check.3.html">
      <span itemprop="name">lockfile_check: Manage lockfiles</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/liblockfile-dev/">
      <span itemprop="name">liblockfile-dev</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/lockfile_check.3.html">
      <span itemprop="name">lockfile_check: Manage lockfiles</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>#include &lt;lockfile.h&gt;</strong></p><p><strong>cc [ </strong><em>flag</em><strong> ... ] </strong><em>file</em><strong> ... -llockfile [ </strong><em>library</em><strong> ] </strong></p><p><strong>int lockfile_create( const char *</strong><em>lockfile</em><strong>, int </strong><em>retrycnt</em><strong>, int </strong><em>flags</em><strong> );</strong></p><p><strong>int lockfile_remove( const char *</strong><em>lockfile</em><strong> );</strong></p><p><strong>int lockfile_touch( const char *</strong><em>lockfile</em><strong> );</strong></p><p><strong>int lockfile_check( const char *</strong><em>lockfile</em><strong>, int </strong><em>flags</em><strong>  );</strong></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>The <strong>lockfile_create</strong> function creates a lockfile in an NFS safe way.</p><p>If flags is set to <strong>L_PID</strong> then lockfile_create will not only check for an existing lockfile, but it will read the contents as well to see if it contains a process id in ASCII. If so, the lockfile is only valid if that process still exists.</p><p>If the lockfile is on a shared filesystem, it might have been created by a process on a remote host. Thus the process-id checking is useless and the L_PID flag should not be set. In this case, there is no good way to see if a lockfile is stale. Therefore if the lockfile is older then 5 minutes, it will be removed. That is why the <strong>lockfile_touch</strong> function is provided: while holding the lock, it needs to be refreshed regulary (every minute or so) by calling <strong>lockfile_touch ()  .</strong></p><p>The <strong></strong> lockfile_check function checks if a valid lockfile is already present without trying to create a new lockfile.</p><p>Finally the <strong>lockfile_remove</strong> function removes the lockfile.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RETURN VALUES</h2>
        <div class="sectioncontent">
<p><strong>lockfile_create</strong> returns one of the following status codes:</p>
<pre>
   #define L_SUCCESS   0    /* Lockfile created                     */
   #define L_NAMELEN   1    /* Recipient name too long (&gt; 13 chars) */
   #define L_TMPLOCK   2    /* Error creating tmp lockfile          */
   #define L_TMPWRITE  3    /* Can't write pid int tmp lockfile     */
   #define L_MAXTRYS   4    /* Failed after max. number of attempts */
   #define L_ERROR     5    /* Unknown error; check errno           */
</pre>
<p><strong>lockfile_check</strong> returns 0 if a valid lockfile is present. If no lockfile or no valid lockfile is present, -1 is returned.</p><p><strong>lockfile_touch</strong> and <strong>lockfile_remove</strong> return 0 on success. On failure -1 is returned and <em>errno</em> is set appropriately. It is not an error to lockfile_remove() a non-existing lockfile.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">ALGORITHM</h2>
        <div class="sectioncontent">
<p>The algorithm that is used to create a lockfile in an atomic way, even over NFS, is as follows:</p>
<dl class='dl-vertical'>
  <dt>
    1
  </dt>
  <dd>
    <p>A unique file is created. In printf format, the name of the file is .lk%05d%x%s. The first argument (%05d) is the current process id. The second argument (%x) consists of the 4 minor bits of the value returned by <a href="../man2/time.2.html"><strong>time</strong>(2)</a>. The last argument is the system hostname.</p>
  </dd>
  <dt>
    2
  </dt>
  <dd>
    <p>Then the lockfile is created using <a href="../man2/link.2.html"><strong>link</strong>(2)</a>. The return value of <em>link</em> is ignored.</p>
  </dd>
  <dt>
    3
  </dt>
  <dd>
    <p>Now the lockfile is <em>stat</em>()ed. If the stat fails, we go to step <em>6</em>.</p>
  </dd>
  <dt>
    4
  </dt>
  <dd>
    <p>The <em>stat</em> value of the lockfile is compared with that of the temporary file. If they are the same, we have the lock. The temporary file is deleted and a value of 0 (success) is returned to the caller.</p>
  </dd>
  <dt>
    5
  </dt>
  <dd>
    <p>A check is made to see if the existing lockfile is a valid one. If it isn't valid, the stale lockfile is deleted.</p>
  </dd>
  <dt>
    6
  </dt>
  <dd>
    <p>Before retrying, we sleep for <em>n</em> seconds. <em>n</em> is initially 5 seconds, but after every retry 5 extra seconds is added up to a maximum of 60 seconds (an incremental backoff). Then we go to step <em>2</em> up to <em>retries</em> times.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">REMOTE FILE SYSTEMS AND THE KERNEL ATTRIBUTE CACHE</h2>
        <div class="sectioncontent">
<p>These functions do not lock a file - they <em>generate</em> a <em>lockfile</em>. However in a lot of cases, such as Unix mailboxes, all concerned programs accessing the mailboxes agree on the fact that the presence of &lt;filename&gt;.lock means that &lt;filename&gt; is locked.</p><p>If you are using <strong>lockfile_create</strong> to create a lock on a file that resides on a remote server, and you already have that file open, you need to flush the NFS attribute cache after locking. This is needed to prevent the following scenario:</p>
<dl class='dl-vertical'>
  <dt>
    <p>o</p>
  </dt>
  <dd>
    <p>open /var/mail/USERNAME</p>
  </dd>
  <dt>
    <p>o</p>
  </dt>
  <dd>
    <p>attributes, such as size, inode, etc are now cached in the kernel!</p>
  </dd>
  <dt>
    <p>o</p>
  </dt>
  <dd>
    <p>meanwhile, another remote system appends data to /var/mail/USERNAME</p>
  </dd>
  <dt>
    <p>o</p>
  </dt>
  <dd>
    <p>grab lock using lockfile_create()</p>
  </dd>
  <dt>
    <p>o</p>
  </dt>
  <dd>
    <p>seek to end of file</p>
  </dd>
  <dt>
    <p>o</p>
  </dt>
  <dd>
    <p>write data</p>
  </dd>

</dl>
<p>Now the end of the file really isn't the end of the file - the kernel cached the attributes on open, and st_size is not the end of the file anymore. So after locking the file, you need to tell the kernel to flush the NFS file attribute cache.</p><p>The only <em>portable</em> way to do this is the POSIX <em>fcntl()</em> file locking primitives - locking a file using <em>fcntl()</em> has the fortunate side-effect of invalidating the NFS file attribute cache of the kernel.</p><p><strong>lockfile_create()</strong> cannot do this for you for two reasons. One, it just creates a lockfile- it doesn't know which file you are actually trying to lock! Two, even if it could deduce the file you're locking from the filename, by just opening and closing it, it would invalidate any existing POSIX locks the program might already have on that file (yes, POSIX locking semantics are insane!).</p><p>So basically what you need to do is something like this:</p>
<pre>
  fd = open("/var/mail/USER");
  .. program code ..

  lockfile_create("/var/mail/USER.lock", x, y);

  /* Invalidate NFS attribute cache using POSIX locks */
  if (lockf(fd, F_TLOCK, 0) == 0) lockf(fd, F_ULOCK, 0);
</pre>
<p>You have to be careful with this if you're putting this in an existing program that might already be using fcntl(), flock() or lockf() locking- you might invalidate existing locks.</p><p>There is also a non-portable way. A lot of NFS operations return the updated attributes - and the Linux kernel actually uses these to update the attribute cache. One of these operations is <a href="../man2/chmod.2.html"><strong>chmod</strong>(2)</a>.</strong></p><p>So stat()ing a file and then chmod()ing it to st.st_mode will not actually change the file, nor will it interfere with any locks on the file, but it will invalidate the attribute cache. The equivalent to use from a shell script would be</p>
<pre>
  chmod u=u /var/mail/USER
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">PERMISSIONS</h2>
        <div class="sectioncontent">
<p>If you are on a system that has a mail spool directory that is only writable by a special group (usually "mail") you cannot create a lockfile directly in the mailspool directory without special permissions.</p><p>Lockfile_create and lockfile_remove check if the lockfile ends in $USERNAME.lock, and if the directory the lockfile is writable by group "mail". If so, an external set group-id mail executable (<a href="../man1/dotlockfile.1.html"><strong>dotlockfile</strong>(1)</a> ) is spawned to do the actual locking / unlocking.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">FILES</h2>
        <div class="sectioncontent">
<p>/usr/lib/liblockfile.so.1</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Miquel van Smoorenburg &lt;miquels@cistron.nl&gt;</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO lockfile_check&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man1/dotlockfile.1.html"><strong>dotlockfile</strong>(1)</a>, <a href="../man3/maillock.3.html"><strong>maillock</strong>(3)</a>, <strong>touchlock</strong> (3), <a href="../man3/mailunlock.3.html"><strong>mailunlock</strong>(3)</a></p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="lockf.3.html"><span aria-hidden="true">&larr;</span> lockf.3: Apply, test or remove a posix lock on an open file</a></li>
   <li class="next"><a href="lockfile_create.3.html">lockfile_create.3: Manage lockfiles <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
