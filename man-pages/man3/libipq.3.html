<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>libipq: Libipq  iptables userspace packet queuing library.</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Libipq  iptables userspace packet queuing library.">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="libipq (3) manual">
  <meta name="twitter:description" content="Libipq  iptables userspace packet queuing library.">
  <meta name="twitter:image" content="https://www.carta.tech/images/iptables-dev-libipq-3.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3/libipq.3.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="libipq (3) manual" />
  <meta property="og:description" content="Libipq  iptables userspace packet queuing library." />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/iptables-dev-libipq-3.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">libipq<small> (3)</small></h1>
        <p class="lead">Libipq  iptables userspace packet queuing library.</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/">
      <span itemprop="name">Library calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/libipq.3.html">
      <span itemprop="name">libipq: Libipq  iptables userspace packet queuing library.</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/iptables-dev/">
      <span itemprop="name">iptables-dev</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/libipq.3.html">
      <span itemprop="name">libipq: Libipq  iptables userspace packet queuing library.</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>#include &lt;linux/netfilter.h&gt;</strong></p><p><strong>#include &lt;libipq.h&gt;</strong></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>libipq is a development library for iptables userspace packet queuing.</p><h3>Userspace Packet Queuing</h3>
<p>Netfilter provides a mechanism for passing packets out of the stack for queueing to userspace, then receiving these packets back into the kernel with a verdict specifying what to do with the packets (such as ACCEPT or DROP).  These packets may also be modified in userspace prior to reinjection back into the kernel.</p><p>For each supported protocol, a kernel module called a <em>queue handler</em> may register with Netfilter to perform the mechanics of passing packets to and from userspace.</p><p>The standard queue handler for IPv4 is ip_queue.  It is provided as an experimental module with 2.4 kernels, and uses a Netlink socket for kernel/userspace communication.</p><p>Once ip_queue is loaded, IP packets may be selected with iptables and queued for userspace processing via the QUEUE target.  For example, running the following commands:</p><p>	# modprobe iptable_filter</p><p>	# modprobe ip_queue</p><p>	# iptables -A OUTPUT -p icmp -j QUEUE</p><p>will cause any locally generated ICMP packets (e.g. ping output) to be sent to the ip_queue module, which will then attempt to deliver the packets to a userspace application.  If no userspace application is waiting, the packets will be dropped</p><p>An application may receive and process these packets via libipq.</p>
<h3>Libipq Overview</h3>
<p>Libipq provides an API for communicating with ip_queue.  The following is an overview of API usage, refer to individual man pages for more details on each function.</p><p><strong>Initialisation</strong></p><p>To initialise the library, call <a href="../man3/ipq_create_handle.3.html"><strong>ipq_create_handle</strong>(3)</a>. This will attempt to bind to the Netlink socket used by ip_queue and return an opaque context handle for subsequent library calls.</p><p><strong>Setting the Queue Mode</strong></p><p><a href="../man3/ipq_set_mode.3.html"><strong>ipq_set_mode</strong>(3)</a> allows the application to specify whether packet metadata, or packet payloads as well as metadata are copied to userspace.  It is also used to initially notify ip_queue that an application is ready to receive queue messages.</p><p><strong>Receiving Packets from the Queue</strong></p><p><a href="../man3/ipq_read.3.html"><strong>ipq_read</strong>(3)</a> waits for queue messages to arrive from ip_queue and copies them into a supplied buffer. Queue messages may be <em>packet messages</em> or <em>error messages.</em></p><p>The type of packet may be determined with <a href="../man3/ipq_message_type.3.html"><strong>ipq_message_type</strong>(3)</a>.</p><p>If it's a packet message, the metadata and optional payload may be retrieved with <a href="../man3/ipq_get_packet.3.html"><strong>ipq_get_packet</strong>(3)</a>.</p><p>To retrieve the value of an error message, use <a href="../man3/ipq_get_msgerr.3.html"><strong>ipq_get_msgerr</strong>(3)</a>.</p><p><strong>Issuing Verdicts on Packets</strong></p><p>To issue a verdict on a packet, and optionally return a modified version of the packet to the kernel, call <a href="../man3/ipq_set_verdict.3.html"><strong>ipq_set_verdict</strong>(3)</a>.</p><p><strong>Error Handling</strong></p><p>An error string corresponding to the current value of the internal error variable <strong>ipq_errno</strong> may be obtained with <a href="../man3/ipq_errstr.3.html"><strong>ipq_errstr</strong>(3)</a>.</p><p>For simple applications, calling <a href="../man3/ipq_perror.3.html"><strong>ipq_perror</strong>(3)</a> will print the same message as <a href="../man3/ipq_errstr.3.html"><strong>ipq_errstr</strong>(3)</a>, as well as the string corresponding to the global <strong>errno</strong> value (if set) to stderr.</p><p><strong>Cleaning Up</strong></p><p>To free up the Netlink socket and destroy resources associated with the context handle, call <a href="../man3/ipq_destroy_handle.3.html"><strong>ipq_destroy_handle</strong>(3)</a>.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SUMMARY</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    <p><a href="../man3/ipq_create_handle.3.html"><strong>ipq_create_handle</strong>(3)</a></p>
  </dt>
  <dd>
    <p>Initialise library, return context handle.</p>
  </dd>
  <dt>
    <p><a href="../man3/ipq_set_mode.3.html"><strong>ipq_set_mode</strong>(3)</a></p>
  </dt>
  <dd>
    <p>Set the queue mode, to copy either packet metadata, or payloads as well as metadata to userspace.</p>
  </dd>
  <dt>
    <p><a href="../man3/ipq_read.3.html"><strong>ipq_read</strong>(3)</a></p>
  </dt>
  <dd>
    <p>Wait for a queue message to arrive from ip_queue and read it into a buffer.</p>
  </dd>
  <dt>
    <p><a href="../man3/ipq_message_type.3.html"><strong>ipq_message_type</strong>(3)</a></p>
  </dt>
  <dd>
    <p>Determine message type in the buffer.</p>
  </dd>
  <dt>
    <p><a href="../man3/ipq_get_packet.3.html"><strong>ipq_get_packet</strong>(3)</a></p>
  </dt>
  <dd>
    <p>Retrieve a packet message from the buffer.</p>
  </dd>
  <dt>
    <p><a href="../man3/ipq_get_msgerr.3.html"><strong>ipq_get_msgerr</strong>(3)</a></p>
  </dt>
  <dd>
    <p>Retrieve an error message from the buffer.</p>
  </dd>
  <dt>
    <p><a href="../man3/ipq_set_verdict.3.html"><strong>ipq_set_verdict</strong>(3)</a></p>
  </dt>
  <dd>
    <p>Set a verdict on a packet, optionally replacing its contents.</p>
  </dd>
  <dt>
    <p><a href="../man3/ipq_errstr.3.html"><strong>ipq_errstr</strong>(3)</a></p>
  </dt>
  <dd>
    <p>Return an error message corresponding to the internal ipq_errno variable.</p>
  </dd>
  <dt>
    <p><a href="../man3/ipq_perror.3.html"><strong>ipq_perror</strong>(3)</a></p>
  </dt>
  <dd>
    <p>Helper function to print error messages to stderr.</p>
  </dd>
  <dt>
    <p><a href="../man3/ipq_destroy_handle.3.html"><strong>ipq_destroy_handle</strong>(3)</a></p>
  </dt>
  <dd>
    <p>Destroy context handle and associated resources.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLE</h2>
        <div class="sectioncontent">
<p>The following is an example of a simple application which receives packets and issues NF_ACCEPT verdicts on each packet.</p>
<pre>
/*
 * This code is GPL.
 */
#include &lt;linux/netfilter.h&gt;
#include &lt;libipq.h&gt;
#include &lt;stdio.h&gt;

#define BUFSIZE 2048

static void die(struct ipq_handle *h)
{
	ipq_perror("passer");
	ipq_destroy_handle(h);
	<strong>exit</strong>(1);
}

int main(int argc, char **argv)
{
	int status;
	unsigned char buf[BUFSIZE];
	struct ipq_handle *h;

	h = ipq_create_handle(0, NFPROTO_IPV4);
	if (!h)
		die(h);

	status = ipq_set_mode(h, IPQ_COPY_PACKET, BUFSIZE);
	if (status &lt; 0)
		die(h);

	do{
		status = ipq_read(h, buf, BUFSIZE, 0);
		if (status &lt; 0)
			die(h);

		switch (ipq_message_type(buf)) {
			case NLMSG_ERROR:
				fprintf(stderr, "Received error message %d&#92;n",
				        ipq_get_msgerr(buf));
				break;

			case IPQM_PACKET: {
				ipq_packet_msg_t *m = ipq_get_packet(buf);

				status = ipq_set_verdict(h, m-&gt;packet_id,
				                         NF_ACCEPT, 0, NULL);
				if (status &lt; 0)
					die(h);
				break;
			}

			default:
				fprintf(stderr, "Unknown message type!&#92;n");
				break;
		}
	} while (1);

	ipq_destroy_handle(h);
	return 0;
}
</pre>
<p>Pointers to more libipq application examples may be found in The Netfilter FAQ.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DIAGNOSTICS</h2>
        <div class="sectioncontent">
<p>For information about monitoring and tuning ip_queue, refer to the Linux 2.4 Packet Filtering HOWTO.</p><p>If an application modifies a packet, it needs to also update any checksums for the packet.  Typically, the kernel will silently discard modified packets with invalid checksums.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SECURITY</h2>
        <div class="sectioncontent">
<p>Processes require CAP_NET_ADMIN capabilty to access the kernel ip_queue module.  Such processes can potentially access and modify any IP packets received, generated or forwarded by the kernel.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">TODO</h2>
        <div class="sectioncontent">
<p>Per-handle <strong>ipq_errno</strong> values.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BUGS</h2>
        <div class="sectioncontent">
<p>Probably.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>James Morris &lt;jmorris@intercode.com.au&gt;</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COPYRIGHT</h2>
        <div class="sectioncontent">
<p>Copyright (c) 2000-2001 Netfilter Core Team.</p><p>Distributed under the GNU General Public License.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CREDITS</h2>
        <div class="sectioncontent">
<p>Joost Remijn implemented the <strong>ipq_read</strong> timeout feature, which appeared in the 1.2.4 release of iptables.</p><p>Fernando Anton added support for IPv6.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO libipq&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man8/iptables.8.html"><strong>iptables</strong>(8)</a>, <a href="../man3/ipq_create_handle.3.html"><strong>ipq_create_handle</strong>(3)</a>, <a href="../man3/ipq_destroy_handle.3.html"><strong>ipq_destroy_handle</strong>(3)</a>, <a href="../man3/ipq_errstr.3.html"><strong>ipq_errstr</strong>(3)</a>, <a href="../man3/ipq_get_msgerr.3.html"><strong>ipq_get_msgerr</strong>(3)</a>, <a href="../man3/ipq_get_packet.3.html"><strong>ipq_get_packet</strong>(3)</a>, <a href="../man3/ipq_message_type.3.html"><strong>ipq_message_type</strong>(3)</a>, <a href="../man3/ipq_perror.3.html"><strong>ipq_perror</strong>(3)</a>, <a href="../man3/ipq_read.3.html"><strong>ipq_read</strong>(3)</a>, <a href="../man3/ipq_set_mode.3.html"><strong>ipq_set_mode</strong>(3)</a>, <a href="../man3/ipq_set_verdict.3.html"><strong>ipq_set_verdict</strong>(3)</a>.</p><p>The Netfilter home page at http://netfilter.samba.org/ which has links to The Networking Concepts HOWTO, The Linux 2.4 Packet Filtering HOWTO, The Linux 2.4 NAT HOWTO, The Netfilter Hacking HOWTO, The Netfilter FAQ and many other useful resources.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="libipmimonitoring.3.html"><span aria-hidden="true">&larr;</span> libipmimonitoring.3: A library for ipmi system event and sensor monitoring</a></li>
   <li class="next"><a href="libixp.3.html">libixp.3: None <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
