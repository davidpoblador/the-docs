<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DB_File::Lock: Locking with flock wrapper for db_file</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Locking with flock wrapper for db_file">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="DB_File::Lock (3pm) manual">
  <meta name="twitter:description" content="Locking with flock wrapper for db_file">
  <meta name="twitter:image" content="https://www.carta.tech/images/libdb-file-lock-perl-DB_File::Lock-3pm.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3pm/DB_File::Lock.3pm.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="DB_File::Lock (3pm) manual" />
  <meta property="og:description" content="Locking with flock wrapper for db_file" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libdb-file-lock-perl-DB_File::Lock-3pm.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">DB_File::Lock<small> (3pm)</small></h1>
        <p class="lead">Locking with flock wrapper for db_file</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/">
      <span itemprop="name">MISSING SECTION</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/DB_File::Lock.3pm.html">
      <span itemprop="name">DB_File::Lock: Locking with flock wrapper for db_file</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libdb-file-lock-perl/">
      <span itemprop="name">libdb-file-lock-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/DB_File::Lock.3pm.html">
      <span itemprop="name">DB_File::Lock: Locking with flock wrapper for db_file</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
 use DB_File::Lock;
 use Fcntl qw(:flock O_RDWR O_CREAT);

 $locking = "read";
 $locking = "write";
 $locking = {
     mode            =&gt; "read",
     nonblocking     =&gt; 0,
     lockfile_name   =&gt; "/path/to/shared.lock",
     lockfile_mode   =&gt; 0600,
 };

 [$X =] tie %hash,  &apos;DB_File::Lock&apos;, $filename, $flags, $mode, $DB_HASH, $locking;
 [$X =] tie %hash,  &apos;DB_File::Lock&apos;, $filename, $flags, $mode, $DB_BTREE, $locking;
 [$X =] tie @array, &apos;DB_File::Lock&apos;, $filename, $flags, $mode, $DB_RECNO, $locking;

 # or place the DB_File arguments inside a list reference:
 [$X =] tie %hash,  &apos;DB_File::Lock&apos;, [$filename, $flags, $mode, $DB_HASH], $locking;

 ...use the same way as DB_File for the rest of the interface...
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>This module provides a wrapper for the DB_File module, adding locking.</p><p>When you need locking, simply use this module in place of DB_File and add an extra argument onto the tie command specifying if the file should be locked for reading or writing.</p><p>The alternative is to write code like:</p><p>  open(LOCK, "&lt;$db_filename.lock") or die;   flock(LOCK, LOCK_SH) or die;   tie(%db_hash, &apos;DB_File&apos;, $db_filename,  O_RDONLY, 0600, $DB_HASH) or die;   ... then read the database ...   untie(%db_hash);   close(LOCK);</p><p>This module lets you write</p><p>  tie(%db_hash, &apos;DB_File::Lock&apos;, $db_filename,  O_RDONLY, 0600, $DB_HASH, &apos;read&apos;) or die;   ... then read the database ...   untie(%db_hash);</p><p>This is better for two reasons:</p><p>(1) Less cumbersome to write.</p><p>(2) A fatal exception in the code working on the database which does not lead to process termination will probably not close the lockfile and therefore cause a dropped lock.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">USAGE DETAILS</h2>
        <div class="sectioncontent">
<p>Tie to the database file by adding an additional locking argument to the list of arguments to be passed through to DB_File, such as:</p><p>  tie(%db_hash, &apos;DB_File::Lock&apos;, $db_filename,  O_RDONLY, 0600, $DB_HASH, &apos;read&apos;);</p><p>or enclose the arguments for DB_File in a list reference:</p><p>  tie(%db_hash, &apos;DB_File::Lock&apos;, [$db_filename,  O_RDONLY, 0600, $DB_HASH], &apos;read&apos;);</p><p>The filename used for the lockfile defaults to \*(L"$filename.lock\*(R" (the filename of the DB_File with \*(L".lock\*(R" appended). Using a lockfile separate from the database file is recommended because it prevents weird interactions with the underlying database file library</p><p>The additional locking argument added to the tie call can be:</p><p>(1) \*(L"read\*(R" \*(-- acquires a shared lock for reading</p><p>(2) \*(L"write\*(R" \*(-- acquires an exclusive lock for writing</p><p>(3) A hash with the following keys (all optional except for the \*(L"mode\*(R"):</p>
<dl class='dl-vertical'>
  <dt>
    mode
  </dt>
  <dd>
    <p>the locking mode, \*(L"read\*(R" or \*(L"write\*(R".</p>
  </dd>
  <dt>
    lockfile_name
  </dt>
  <dd>
    <p>specifies the name of the lockfile to use. Default is \*(L"$filename.lock\*(R".  This is useful for locking multiple resources with the same lockfiles.</p>
  </dd>
  <dt>
    nonblocking
  </dt>
  <dd>
    <p>determines if the flock call on the lockfile should block waiting for a lock, or if it should return failure if a lock can not be immediately attained. If \*(L"nonblocking\*(R" is set and a lock can not be attained, the tie command will fail.  Currently, I'm not sure how to differentiate this between a failure form the DB_File layer.</p>
  </dd>
  <dt>
    lockfile_mode
  </dt>
  <dd>
    <p>determines the mode for the sysopen call in opening the lockfile. The default mode will be formulated to allow anyone that can read or write the DB_File permission to read and write the lockfile. (This is because some systems may require that one have write access to a file to lock it for reading, I understand.) The umask will be prevented from applying to this mode.</p>
  </dd>

</dl>
<p>Note: One may import the same values from DB_File::Lock as one may import from DB_File.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">GOOD LOCKING ETIQUETTE</h2>
        <div class="sectioncontent">
<p>To avoid locking problems, realize that it is <strong>critical</strong> that you release the lock as soon as possible. See the lock as a \*(L"hot potato\*(R", something that you must work with and get rid of as quickly as possible. See the sections of code where you have a lock as \*(L"critical\*(R" sections. Make sure that you call \*(L"untie\*(R" as soon as possible.</p><p>It is often better to write:</p><p>  # open database file with lock   # work with database   # lots of processing not related to database   # work with database   # close database and release lock</p><p>as:</p><p>  # open database file with lock   # work with database   # close database and release lock</p><p>  # lots of processing not related to database</p><p>  # open database file with lock   # work with database   # close database and release lock</p><p>Also realize that when acquiring two locks at the same time, a deadlock situation can be caused.</p><p>You can enter a deadlock situation if two processes simultaneously try to acquire locks on two separate databases. Each has locked only one of the databases, and cannot continue without locking the second. Yet this will never be freed because it is locked by the other process. If your processes all ask for their \s-1DB\s0 files in the same order, this situation cannot occur.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OTHER LOCKING MODULES</h2>
        <div class="sectioncontent">
<p>There are three locking wrappers for DB_File in \s-1CPAN\s0 right now. Each one implements locking differently and has different goals in mind. It is therefore worth knowing the difference, so that you can pick the right one for your application.</p><p>Here are the three locking wrappers:</p><p>Tie::DB_Lock \*(-- DB_File wrapper which creates copies of the database file for read access, so that you have kind of a multiversioning concurrent read system. However, updates are still serial. Use for databases where reads may be lengthy and consistency problems may occur.</p><p>Tie::DB_LockFile \*(-- DB_File wrapper that has the ability to lock and unlock the database while it is being used. Avoids the tie-before-flock problem by simply re-tie-ing the database when you get or drop a lock. Because of the flexibility in dropping and re-acquiring the lock in the middle of a session, this can be massaged into a system that will work with long updates and/or reads if the application follows the hints in the \s-1POD\s0 documentation.</p><p>DB_File::Lock (this module) \*(-- extremely lightweight DB_File wrapper that simply flocks a lockfile before tie-ing the database and drops the lock after the untie.  Allows one to use the same lockfile for multiple databases to avoid deadlock problems, if desired. Use for databases where updates are reads are quick and simple flock locking semantics are enough.</p><p>(This text duplicated in the \s-1POD\s0 documentation, by the way.)</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>David Harris &lt;dharris@drh.net&gt;</p><p>Helpful insight from Stas Bekman &lt;stas@stason.org&gt;</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO DB_File::Lock&hellip;</h2>
        <div class="sectioncontent">
<p><em>DB_File</em>\|(3).</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="DBIx::Simple::Examples.3pm.html"><span aria-hidden="true">&larr;</span> DBIx::Simple::Examples.3pm: Examples of how to use dbix::simple</a></li>
   <li class="next"><a href="DDP.3pm.html">DDP.3pm: Data::printer shortcut for faster debugging <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
