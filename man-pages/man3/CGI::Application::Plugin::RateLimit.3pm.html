<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CGI::Application::Plugin::RateLimit: Limits runmode call rate per user</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Limits runmode call rate per user">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="CGI::Application::Plugin::RateLimit (3pm) manual">
  <meta name="twitter:description" content="Limits runmode call rate per user">
  <meta name="twitter:image" content="https://www.carta.tech/images/libcgi-application-plugin-ratelimit-perl-CGI::Application::Plugin::RateLimit-3pm.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3pm/CGI::Application::Plugin::RateLimit.3pm.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="CGI::Application::Plugin::RateLimit (3pm) manual" />
  <meta property="og:description" content="Limits runmode call rate per user" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libcgi-application-plugin-ratelimit-perl-CGI::Application::Plugin::RateLimit-3pm.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">CGI::Application::Plugin::RateLimit<small> (3pm)</small></h1>
        <p class="lead">Limits runmode call rate per user</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/">
      <span itemprop="name">MISSING SECTION</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/CGI::Application::Plugin::RateLimit.3pm.html">
      <span itemprop="name">CGI::Application::Plugin::RateLimit: Limits runmode call rate per user</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libcgi-application-plugin-ratelimit-perl/">
      <span itemprop="name">libcgi-application-plugin-ratelimit-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/CGI::Application::Plugin::RateLimit.3pm.html">
      <span itemprop="name">CGI::Application::Plugin::RateLimit: Limits runmode call rate per user</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
  use CGI::Application::Plugin::RateLimit;

  sub setup {
    ...

    # call this in your setup routine to set
    my $rate_limit = $self-&gt;rate_limit();

    # set the database handle to use
    $rate_limit-&gt;dbh($dbh);

    # set the table name to use for storing hits, the default is
    # &apos;rate_limit_hits&apos;
    $rate_limit-&gt;table(&apos;rate_limit_hits&apos;);

    # keep people from calling &apos;send&apos; more often than 5 times in 10
    # minutes and &apos;list&apos; more often than once every 5 seconds.
    $rate_limit-&gt;protected_modes(send =&gt; {timeframe =&gt; &apos;10m&apos;,
                                          max_hits  =&gt; 5
                                         },
                                 list =&gt; {timeframe =&gt; &apos;5s&apos;,
                                          max_hits  =&gt; 1
                                         });

    # you can also protect abstract actions, for example to prevent a
    # flood of failed logins
    $rate_limit-&gt;protected_actions(failed_login =&gt; {timeframe =&gt; &apos;10s&apos;,
                                                    max_hits  =&gt; 2
                                                   });

    # call this runmode when a violation is detected
    $rate_limit-&gt;violation_mode(&apos;too_fast_buddy&apos;);

    # or, run this callback
    $rate_limit-&gt;violation_callback(sub { die(...) });

    # override the default identity function
    # ($ENV{REMOTE_USER} || $ENV{REMOTE_IP})
    $rate_limit-&gt;identity_callback(sub { ... });
  }

  # record a hit for an action (not needed for run-modes which are
  # handled automatically)
  $rate_limit-&gt;record_hit(action =&gt; &apos;failed_login&apos;);

  # check for a violation on an action and handle
  return $self-&gt;slow_down_buddy
    if( $rate_limit-&gt;check_violation(action =&gt; &apos;failed_login&apos;) );

  # revoke the most recent hit for this user, preventing it from
  # counting towards a violation
  $rate_limit-&gt;revoke_hit();

  # examine the violation in violation_mode or violation_callback:
  $mode   = $rate_limit-&gt;violated_mode;
  $action = $rate_limit-&gt;violated_action;
  $limits = $rate_limit-&gt;violated_limits;
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>This module provides protection against a user calling a runmode too frequently.  A typical use-case might be a contact form that sends email.  You'd like to allow your users to send you messages, but thousands of messages from a single user would be a problem.</p><p>This module works by maintaining a database of hits to protected runmodes.  It then checks this database to determine if a new hit should be allowed based on past activity by the user.  The user's identity is, by default, tied to login (via \s-1REMOTE_USER\s0) or \s-1IP\s0 address (via \s-1REMOTE_IP\s0) if login info is not available.  You may provide your own identity function via the <em>identity_callback()</em> method.</p><p>To use this module you must create a table in your database with the following schema (using MySQL-syntax, although other DBs may work as well with minor alterations):</p><p>  CREATE TABLE rate_limit_hits (      user_id   VARCHAR(255)      NOT NULL,      action    VARCHAR(255)      NOT NULL,      timestamp UNSIGNED INTEGER  NOT NULL,      INDEX (user_id, action, timestamp)   );</p><p>You may feel free to vary the storage-type and size of user_id and action to match your usage.  For example, if your <em>identity_callback()</em> always returns an integer you could make user_id an integer column.</p><p>This table should be periodically cleared of old data.  Anything older than the maximum timeframe being used can be safely deleted.</p><p><strong>\s-1IMPORTANT\s0 \s-1NOTE\s0</strong>: The protection offered by this module is not perfect.  Identifying a user on the internet is very hard and a sophisticated attacker can work around these checks, by switching IPs or automating login creation.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">INTERFACE</h2>
        <div class="sectioncontent">
<p>The object returned from calling \*(C`$self-&gt;rate_limit\*(C' on your CGI::App object supports the following method calls:</p><h3>dbh</h3>
<p>   $rate_limit-&gt;dbh($dbh);</p><p>Call this to set the database handle the object should use.  Must be set in <em>setup()</em>.</p>
<h3>table</h3>
<p>   $rate_limit-&gt;table(&apos;some_table_name&apos;);</p><p>Call this to determine the table to be used to store and lookup hits. The default is 'rate_limit_hits' if not set.  See the \s-1DESCRIPTION\s0 section for the required table schema.</p>
<h3>protected_modes</h3>
<p>    $rate_limit-&gt;protected_modes(send =&gt; {timeframe =&gt; &apos;10m&apos;,                                           max_hits  =&gt; 5                                          },                                  list =&gt; {timeframe =&gt; &apos;5s&apos;,                                           max_hits  =&gt; 1                                          });</p><p>Takes a list of key-value pairs describing the modes to protect.  Keys are names of run-modes.  Values are hashes with the following keys:</p><p>  timeframe - the timeframe to be considered for violations.  Values   must be numbers followed by either &apos;s&apos; for seconds, &apos;m&apos; for minutes   or &apos;h&apos; for hours.</p><p>  max_hits - how many hits to allow in the specified timeframe before   triggering a violation.</p>
<h3>protected_actions</h3>
<p>    $rate_limit-&gt;protected_actions(failed_login =&gt; {timeframe =&gt; &apos;10s&apos;,                                                     max_hits  =&gt; 2                                                    });</p><p>Specifies non-run-mode actions to protect.  These are arbitrary keys you can use with <em>record_hit()</em> and <em>check_violation()</em>.  Takes the same data-structure as <em>protected_modes()</em>.</p>
<h3>violation_mode</h3>
<p>  $rate_limit-&gt;violation_mode(&apos;too_fast_buddy&apos;);</p><p>Call to set a run-mode to call when a violation is triggered.  Either this or violation_callback must be set.</p>
<h3>violation_callback</h3>
<p>    $rate_limit-&gt;violation_callback(sub { ... });</p><p>Callback to call when a violation is detected.  Should either throw an exception or return the run-mode to run.  Called with the CGI::App object as its sole parameter.</p>
<h3>identity_callback</h3>
<p>    $rate_limit-&gt;identity_callback(sub { ... });</p><p>Call this to provide a customized mechanism for determining the identity of the user.  The default is:</p><p>  sub { $ENV{REMOTE_USER} || $ENV{REMOTE_IP} }</p><p>You might consider adding in session-ID or a hook to your authentication system if it doesn't use \s-1REMOTE_USER\s0.  Whatever you write should return a single scalar which is expected to be unique to each user.</p>
<h3>record_hit</h3>
<p>  $rate_limit-&gt;record_hit(action =&gt; &apos;failed_login&apos;);</p><p>Record a hit for an arbitrary action.  This is not needed for run-mode protection.  Takes the action name as an argument, which must match an action registered with <em>protected_actions()</em>.</p>
<h3>check_violation</h3>
<p>  return $self-&gt;slow_down_buddy     if( $rate_limit-&gt;check_violation(action =&gt; &apos;failed_login&apos;) );</p><p>Checks for a violation of a protected action.  This is not needed for run-mode protection.  Takes the action name as an argument, which must match an action registered with <em>protected_actions()</em>.</p><p>Returns 1 if a violation took place, 0 otherwise.</p>
<h3>revoke_hit</h3>
<p>  $rate_limit-&gt;revoke_hit();</p><p>Revokes the last hit for this user.  You might use this to prevent validation errors from counting against a user, for example.</p>
<h3>violated_mode</h3>
<p>  $mode = $rate_limit-&gt;violated_mode;</p><p>Returns the mode for the last violation, or undef if an action caused the violation.</p>
<h3>violated_action</h3>
<p>  $mode = $rate_limit-&gt;violated_action;</p><p>Returns the action for the last violation, or undef if an action caused the violation.</p>
<h3>violated_limits</h3>
<p>  $limits = $rate_limit-&gt;violated_limits;</p><p>Returns the hash-ref passed to <em>protected_actions()</em> or <em>protected_modes()</em> for the violated mode/action.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DATABASE SUPPORT</h2>
        <div class="sectioncontent">
<p>I've tested this module with MySQL and SQLite.  I think it's likely to work with many other databases - please let me know if you try one.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SUPPORT</h2>
        <div class="sectioncontent">
<p>Please send questions and suggestions about this module to the CGI::Application mailing-list.  To join the mailing list, simply send a blank message to:</p><p>  cgiapp-subscribe@lists.erlbaum.net</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">VERSION CONTROL</h2>
        <div class="sectioncontent">
<p>This module is in a public Subversion repository at SourceForge here:</p><p>   https://svn.sourceforge.net/svnroot/html-template/trunk/CGI-Application-Plugin-RateLimit</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BUGS</h2>
        <div class="sectioncontent">
<p>I know of no bugs.  If you find one, let me know by filing a report on http://rt.cpan.org.  Failing that, you can email me at sam@tregar.com. Please include the version of the module you're using and small test case demonstrating the problem.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Sam Tregar, sam@plusthree.com</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COPYRIGHT AND LICENSE</h2>
        <div class="sectioncontent">
<p>Copyright (C) 2006 by Sam Tregar</p><p>This library is free software; you can redistribute it and/or modify it under the same terms as Perl itself, either Perl version 5.8.6 or, at your option, any later version of Perl 5 you may have available.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="CGI::Application::Plugin::ProtectCSRF.3pm.html"><span aria-hidden="true">&larr;</span> CGI::Application::Plugin::ProtectCSRF.3pm: Generate and verify anti-csrf tickets</a></li>
   <li class="next"><a href="CGI::Application::Plugin::RequireSSL.3pm.html">CGI::Application::Plugin::RequireSSL.3pm: Force ssl in specified pages or modules <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
