<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Test::POE::Server::TCP: A poe component providing tcp server services for test cases</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="A poe component providing tcp server services for test cases">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="Test::POE::Server::TCP (3pm) manual">
  <meta name="twitter:description" content="A poe component providing tcp server services for test cases">
  <meta name="twitter:image" content="https://www.carta.tech/images/libtest-poe-server-tcp-perl-Test::POE::Server::TCP-3pm.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3pm/Test::POE::Server::TCP.3pm.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Test::POE::Server::TCP (3pm) manual" />
  <meta property="og:description" content="A poe component providing tcp server services for test cases" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libtest-poe-server-tcp-perl-Test::POE::Server::TCP-3pm.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">Test::POE::Server::TCP<small> (3pm)</small></h1>
        <p class="lead">A poe component providing tcp server services for test cases</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/">
      <span itemprop="name">MISSING SECTION</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/Test::POE::Server::TCP.3pm.html">
      <span itemprop="name">Test::POE::Server::TCP: A poe component providing tcp server services for test cases</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libtest-poe-server-tcp-perl/">
      <span itemprop="name">libtest-poe-server-tcp-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/Test::POE::Server::TCP.3pm.html">
      <span itemprop="name">Test::POE::Server::TCP: A poe component providing tcp server services for test cases</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">VERSION</h2>
        <div class="sectioncontent">
<p>version 1.14</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p>A very simple echo server with logging of requests by each client:</p>
<pre>
   use strict;
   use POE;
   use Test::POE::Server::TCP;

   POE::Session-&gt;create(
     package_states =&gt; [
        &apos;main&apos; =&gt; [qw(
                        _start
                        testd_connected
                        testd_disconnected
                        testd_client_input
        )],
     ],
   );

   $poe_kernel-&gt;run();
   exit 0;

   sub _start {
     # Spawn the Test::POE::Server::TCP server.
     $_[HEAP]-&gt;{testd} = Test::POE::Server::TCP-&gt;spawn(
        address =&gt; &apos;127.0.0.1&apos;,
        port =&gt; 0,
     );
     return;
   }

   sub testd_connected {
     my ($heap,$id) = @_[HEAP,ARG0];

     # A client connected the unique ID is in ARG0
     # Create a blank arrayref for this client on *our* heap

     $heap-&gt;{clients}-&gt;{ $id } = [ ];

     return;
   }

   sub testd_client_input {
     my ($kernel,$heap,$sender,$id,$input) = @_[KERNEL,HEAP,SENDER,ARG0,ARG1];

     # The client sent us a line of input
     # lets store it

     push @{ $heap-&gt;{clients}-&gt;{ $id }, $input;

     # Okay, we are an echo server so lets send it back to the client
     # We know the SENDER so can always obtain the server object.

     my $testd = $sender-&gt;get_heap();
     $testd-&gt;send_to_client( $id, $input );

     # Or even

     # $sender-&gt;get_heap()-&gt;send_to_client( $id, $input );

     # Alternatively we could just post back to the SENDER

     # $kernel-&gt;post( $sender, &apos;send_to_client&apos;, $id, $input );

     return;
   }

   sub testd_disconnected {
     my ($heap,$id) = @_[HEAP,ARG0];

     # Client disconnected for whatever reason
     # We need to free up our storage

     delete $heap-&gt;{clients}-&gt;{ $id };

     return;
   }
</pre>
<p>Using the module in a testcase:</p><p>   use strict;    use Test::More;    use POE qw(Wheel::SocketFactory Wheel::ReadWrite Filter::Line);    use Test::POE::Server::TCP;</p><p>   plan tests =&gt; 5;</p><p>   my @data = (      &apos;This is a test&apos;,      &apos;This is another test&apos;,      &apos;This is the last test&apos;,    );</p><p>   POE::Session-&gt;create(      package_states =&gt; [         &apos;main&apos; =&gt; [qw(                         _start                         _sock_up                         _sock_fail                         _sock_in                         _sock_err                         testd_connected                         testd_disconnected                         testd_client_input         )],      ],      heap =&gt; { data =&gt; &#92;@data, },    );</p><p>   $poe_kernel-&gt;run();    exit 0;</p><p>   sub _start {      $_[HEAP]-&gt;{testd} = Test::POE::Server::TCP-&gt;spawn(         address =&gt; &apos;127.0.0.1&apos;,         port =&gt; 0,      );      return;    }</p><p>   sub testd_registered {      my ($heap,$object) = @_[HEAP,ARG0];      $heap-&gt;{port} = $object-&gt;port();      $heap-&gt;{factory} = POE::Wheel::SocketFactory-&gt;new(         RemoteAddress  =&gt; &apos;127.0.0.1&apos;,         RemotePort     =&gt; $heap-&gt;{port},         SuccessEvent   =&gt; &apos;_sock_up&apos;,         FailureEvent   =&gt; &apos;_sock_fail&apos;,      );      return;    }</p><p>   sub _sock_up {      my ($heap,$socket) = @_[HEAP,ARG0];      delete $heap-&gt;{factory};      $heap-&gt;{socket} = POE::Wheel::ReadWrite-&gt;new(         Handle =&gt; $socket,         InputEvent =&gt; &apos;_sock_in&apos;,         ErrorEvent =&gt; &apos;_sock_err&apos;,      );      $heap-&gt;{socket}-&gt;put( $heap-&gt;{data}-&gt;[0] );      return;    }</p><p>   sub _sock_fail {      my $heap = $_[HEAP];      delete $heap-&gt;{factory};      $heap-&gt;{testd}-&gt;shutdown();      return;    }</p><p>   sub _sock_in {      my ($heap,$input) = @_[HEAP,ARG0];      my $data = shift @{ $heap-&gt;{data} };      ok( $input eq $data, &apos;Data matched&apos; );      unless ( scalar @{ $heap-&gt;{data} } ) {        delete $heap-&gt;{socket};        return;      }      $heap-&gt;{socket}-&gt;put( $heap-&gt;{data}-&gt;[0] );      return;    }</p><p>   sub _sock_err {      delete $_[HEAP]-&gt;{socket};      return;    }</p><p>   sub testd_connected {      my ($heap,$state,$id) = @_[HEAP,STATE,ARG0];      pass($state);      return;    }</p><p>   sub testd_disconnected {      pass($_[STATE]);      $poe_kernel-&gt;post( $_[SENDER], &apos;shutdown&apos; );      return;    }</p><p>   sub testd_client_input {      my ($sender,$id,$input) = @_[SENDER,ARG0,ARG1];      my $testd = $_[SENDER]-&gt;get_heap();      $testd-&gt;send_to_client( $id, $input );      return;    }</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>Test::POE::Server::TCP is a \s-1POE\s0 component that provides a \s-1TCP\s0 server framework for inclusion in client component test cases, instead of having to roll your own.</p><p>Once registered with the component, a session will receive events related to client connects, disconnects, input and flushed output. Each of these events will refer to a unique client \s-1ID\s0 which may be used in communication with the component when sending data to the client or disconnecting a client connection.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CONSTRUCTOR</h2>
        <div class="sectioncontent">
<p>Takes a number of optional arguments:   &apos;alias&apos;, set an alias on the component;   &apos;address&apos;, bind the listening socket to a particular address;   &apos;port&apos;, listen on a particular port, default is 0, assign a random port;   &apos;options&apos;, a hashref of POE::Session options;   &apos;filter&apos;, specify a POE::Filter to use for client connections, default is POE::Filter::Line;   &apos;inputfilter&apos;, specify a POE::Filter for client input;   &apos;outputfilter&apos;, specify a POE::Filter for output to clients;   &apos;prefix&apos;, specify a different prefix than &apos;testd&apos; for events; The semantics for \*(C`filter\*(C', \*(C`inputfilter\*(C' and \*(C`outputfilter\*(C' are the same as for POE::Component::Server::TCP in that one may provide either a \*(C`SCALAR\*(C', \*(C`ARRAYREF\*(C' or an \*(C`OBJECT\*(C'. If the component is \*(C`spawn\*(C'ed within another session it will automatically \*(C`register\*(C' the parent session to receive \*(C`all\*(C' events.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">METHODS</h2>
        <div class="sectioncontent">
<p>Returns the POE::Session \s-1ID\s0 of the component. Terminates the component. Shuts down the listener and disconnects connected clients. Send some output to a connected client. First parameter must be a valid client id. Second parameter is a string of text to send. The second parameter may also be an arrayref of items to send to the client. If the filter you have used requires an arrayref as input, nest that arrayref within another arrayref. Send some output to all connected clients. The parameter is a string of text to send. The parameter may also be an arrayref of items to send to the clients. If the filter you have used requires an arrayref as input, nest that arrayref within another arrayref. Retrieve socket information of a given client. Requires a valid client \s-1ID\s0 as a parameter. If called in a list context it returns a list consisting of, in order, the client address, the client \s-1TCP\s0 port, our address and our \s-1TCP\s0 port. In a scalar context it returns a \s-1HASHREF\s0 with the following keys:   &apos;peeraddr&apos;, the client address;   &apos;peerport&apos;, the client TCP port;   &apos;sockaddr&apos;, our address;   &apos;sockport&apos;, our TCP port; Retrieve the POE::Wheel::ReadWrite object of a given client. Requires a valid client \s-1ID\s0 as a parameter. This enables one to manipulate the given POE::Wheel::ReadWrite object, say to switch POE::Filter. Places a client connection in pending disconnect state. Requires a valid client \s-1ID\s0 as a parameter. Set this, then send an applicable message to the client using <em>send_to_client()</em> and the client connection will be terminated. Immediately disconnects a client conenction. Requires a valid client \s-1ID\s0 as a parameter. Stops the underlying listening socket from accepting new connections. This lets you test whether you handle the connection timing out gracefully. The companion of \*(C`pause_listening\*(C' Access to the POE::Wheel::SocketFactory method of the underlying listening socket. Returns the port that the component is listening on. If the listener fails on \*(C`listen\*(C' you can attempt to restart it with this.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">INPUT EVENTS</h2>
        <div class="sectioncontent">
<p>These are events that the component will accept: Takes N arguments: a list of event names that your session wants to listen for, minus the 'testd_' prefix. Registering for 'all' will cause it to send all TESTD-related events to you; this is the easiest way to handle it. Takes N arguments: a list of event names which you don't want to receive. If you've previously done a 'register' for a particular event which you no longer care about, this event will tell the \s-1POP3D\s0 to stop sending them to you. (If you haven't, it just ignores you. No big deal). Terminates the component. Shuts down the listener and disconnects connected clients. Send some output to a connected client. First parameter must be a valid client id. Second parameter is a string of text to send. The second parameter may also be an arrayref of items to send to the client. If the filter you have used requires an arrayref as input, nest that arrayref within another arrayref. Send some output to all connected clients. The parameter is a string of text to send. The parameter may also be an arrayref of items to send to the clients. If the filter you have used requires an arrayref as input, nest that arrayref within another arrayref. Places a client connection in pending disconnect state. Requires a valid client \s-1ID\s0 as a parameter. Set this, then send an applicable message to the client using <em>send_to_client()</em> and the client connection will be terminated. Immediately disconnects a client conenction. Requires a valid client \s-1ID\s0 as a parameter. If the listener fails on \*(C`listen\*(C' you can attempt to restart it with this.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OUTPUT EVENTS</h2>
        <div class="sectioncontent">
<p>The component sends the following events to registered sessions. If you have changed the \*(C`prefix\*(C' option in \*(C`spawn\*(C' then substitute \*(C`testd\*(C' with the event prefix that you specified. This event is sent to a registering session. \s-1ARG0\s0 is the Test::POE::Server::TCP object. Generated if the component cannot either start a listener or there is a problem accepting client connections. \s-1ARG0\s0 contains the name of the operation that failed. \s-1ARG1\s0 and \s-1ARG2\s0 hold numeric and string values for $!, respectively. If the operation was \*(C`listen\*(C', the component will remove the listener. You may attempt to start it again using \*(C`start_listener\*(C'. Generated whenever a client connects to the component. \s-1ARG0\s0 is the client \s-1ID\s0, \s-1ARG1\s0 is the client's \s-1IP\s0 address, \s-1ARG2\s0 is the client's \s-1TCP\s0 port. \s-1ARG3\s0 is our \s-1IP\s0 address and \s-1ARG4\s0 is our socket port. Generated whenever a client disconnects. \s-1ARG0\s0 was the client \s-1ID\s0, \s-1ARG1\s0 was the client's \s-1IP\s0 address, \s-1ARG2\s0 was the client's \s-1TCP\s0 port. \s-1ARG3\s0 was our \s-1IP\s0 address and \s-1ARG4\s0 was our socket port. Generated whenever a client sends us some traffic. \s-1ARG0\s0 is the client \s-1ID\s0, \s-1ARG1\s0 is the data sent ( tokenised by whatever POE::Filter you specified ). Generated whenever anything we send to the client is actually flushed down the 'line'. \s-1ARG0\s0 is the client \s-1ID\s0.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CREDITS</h2>
        <div class="sectioncontent">
<p>This module uses code borrowed from POE::Component::Server::TCP by Rocco Caputo, Ann Barcomb and Jos Boumans.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO Test::POE::Server::TCP&hellip;</h2>
        <div class="sectioncontent">
<p>\s-1POE\s0</p><p>POE::Component::Server::TCP</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Chris Williams &lt;chris@bingosnet.co.uk&gt;</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COPYRIGHT AND LICENSE</h2>
        <div class="sectioncontent">
<p>This software is copyright (c) 2010 by Chris Williams, Rocco Caputo, Ann Barcomb and Jos Boumans.</p><p>This is free software; you can redistribute it and/or modify it under the same terms as the Perl 5 programming language system itself.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="Test::POE::Client::TCP.3pm.html"><span aria-hidden="true">&larr;</span> Test::POE::Client::TCP.3pm: A poe component providing tcp client services for test cases</a></li>
   <li class="next"><a href="Test::POP3.3pm.html">Test::POP3.3pm: Automate email delivery tests <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
