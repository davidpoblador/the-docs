<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PAR::Tutorial: Cross-platform packaging and deployment with par</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Cross-platform packaging and deployment with par">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="PAR::Tutorial (3pm) manual">
  <meta name="twitter:description" content="Cross-platform packaging and deployment with par">
  <meta name="twitter:image" content="https://www.carta.tech/images/libpar-perl-PAR::Tutorial-3pm.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3pm/PAR::Tutorial.3pm.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="PAR::Tutorial (3pm) manual" />
  <meta property="og:description" content="Cross-platform packaging and deployment with par" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libpar-perl-PAR::Tutorial-3pm.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">PAR::Tutorial<small> (3pm)</small></h1>
        <p class="lead">Cross-platform packaging and deployment with par</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/">
      <span itemprop="name">MISSING SECTION</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/PAR::Tutorial.3pm.html">
      <span itemprop="name">PAR::Tutorial: Cross-platform packaging and deployment with par</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libpar-perl/">
      <span itemprop="name">libpar-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/PAR::Tutorial.3pm.html">
      <span itemprop="name">PAR::Tutorial: Cross-platform packaging and deployment with par</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p>This is a tutorial on \s-1PAR\s0, first appeared at the 7th Perl Conference. The \s-1HTML\s0 version of this tutorial is available online as &lt;http://search.cpan.org/perldoc?PAR::Tutorial&gt;</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<h3>On Deploying Perl Applications</h3>

<pre>
 % sshnuke.pl 10.2.2.2 -rootpw="Z1ON0101"
 Perl v5.6.1 required--this is only v5.6.0, stopped at sshnuke.pl line 1.
 BEGIN failed--compilation aborted at sshnuke.pl line 1.
</pre>
<ul>
<li><p>Q: \*(L"Help! I can't run your program!\*(R"</p></li><li><p>A1: Install Perl & \*(C`perl -MCPAN -e&apos;install(...)&apos;\*(C'</p><ul>
<li><p>How do we know which modules are needed?</p></li><li><p>New versions of \s-1CPAN\s0 modules may break \*(C`sshnuke.pl\*(C'</p></li>
</ul></li><li><p>A2: Install Perl & \*(C`tar zxf my_perllib.tgz\*(C'</p><ul>
<li><p>Possibly overwriting existing modules; not cross-platform at all</p></li>
</ul></li><li><p>A3: Use the executable generated by \*(C`perlcc sshnuke.pl\*(C'</p><ul>
<li><p>Impossible to debug; \*(C`perlcc\*(C' usually does not work anyway</p></li>
</ul></li>
</ul>
<h3>\s-1PAR\s0, the Perl Archive Toolkit</h3>
<ul>
<li><p>Do what \s-1JAR\s0 (Java Archive) does for Perl</p><ul>
<li><p>Aggregates modules, scripts and other files into a Zip file</p></li><li><p>Easy to generate, update and extract</p></li><li><p>Version consistency: solves forward-compatibility problems</p></li><li><p>Developed by community: \*(C`par@perl.org\*(C'</p></li>
</ul></li><li><p>\s-1PAR\s0 files can be packed into self-contained scripts</p><ul>
<li><p>Automatically scans perl script for dependencies</p></li><li><p>Bundles all necessary 3rd-party modules with it</p></li><li><p>Requires only core Perl to run on the target machine</p></li><li><p>\s-1PAR\s0 also comes with \*(C`pp\*(C', the Perl Packager:  % pp -o sshnuke.exe sshnuke.pl # stand-alone executable!</p></li>
</ul></li>
</ul>
<h3>Simple Packaging</h3>
<ul>
<li><p>\s-1PAR\s0 files are just Zip files with modules in it</p></li><li><p>Any Zip tools can generate them:  % zip foo.par Hello.pm World.pm        # pack two modules  % zip -r bar.par lib/          # grab all modules in lib/</p></li><li><p>To load modules from \s-1PAR\s0 files:  use PAR;  use lib "foo.par";             # the .par part is optional  use Hello;</p></li><li><p>This also works:  use PAR "/home/mylibs/*.par";  # put all of them into @INC  use Hello;</p></li>
</ul>
<h3>\s-1PAR\s0 Loaders</h3>
<ul>
<li><p>Use \*(C`par.pl\*(C' to run files inside a \s-1PAR\s0 archive:  % par.pl foo.par               # looks for &apos;main.pl&apos; by default  % par.pl foo.par test.pl       # runs script/test.pl in foo.par</p></li><li><p>Same thing, with the stand-alone \*(C`parl\*(C' or \*(C`parl.exe\*(C':  % parl foo.par                 # no perl or PAR.pm needed!  % parl foo.par test.pl         # ditto</p></li><li><p>The \s-1PAR\s0 loader can prepend itself to a \s-1PAR\s0 file:</p><ul>
<li><p>\*(C`-b\*(C' bundles non-core modules needed by \*(C`PAR.pm\*(C':  % par.pl -b -O./foo.pl foo.par # self-contained script</p></li><li><p>\*(C`-B\*(C' bundles core modules in addition to \*(C`-b\*(C':  % parl -B -O./foo.exe foo.par  # self-contained binary</p></li>
</ul></li>
</ul>
<h3>Dependency Scanning</h3>
<ul>
<li><p>Recursively scan dependencies with \*(C`scandeps.pl\*(C':  % scandeps.pl sshnuke.pl  # Legend: [C]ore [X]ternal [S]ubmodule [?]NotOnCPAN  &apos;Crypt::SSLeay&apos;       =&gt; &apos;0&apos;, #  X   #  &apos;Net::HTTP&apos;           =&gt; &apos;0&apos;, #      #  &apos;Crypt::SSLeay::X509&apos; =&gt; &apos;0&apos;, # S    # Crypt::SSLeay  &apos;Net::HTTP::Methods&apos;  =&gt; &apos;0&apos;, # S    # Net::HTTP  &apos;Compress::Zlib&apos;      =&gt; &apos;0&apos;, #  X   # Net::HTTP::Methods</p></li><li><p>Scan an one-liner, list all involved files:  % scandeps.pl -V -e "use Dynaloader;"  ...  # auto/DynaLoader/dl_findfile.al [autoload]  # auto/DynaLoader/extralibs.ld [autoload]  # auto/File/Glob/Glob.bs [data]  # auto/File/Glob/Glob.so [shared]  ...</p></li><li><p>Combines scanning, zipping and loader-embedding:  % pp -o out.exe src.pl         # self-contained .exe  % out.exe                      # runs anywhere on the same OS</p></li><li><p>Bundle additional modules:  % pp -o out.exe -M CGI src.pl  # pack CGI + its dependencies, too</p></li><li><p>Pack one-liners:  % pp -o out.exe -e &apos;print "Hi!"&apos;   # turns one-liner into executable</p></li><li><p>Generate \s-1PAR\s0 files instead of executables:  % pp -p src.pl                 # makes &apos;source.par&apos;  % pp -B -p src.pl              # include core modules</p></li>
</ul>
<h3>How it works</h3>
<ul>
<li><p>Command-line options are almost identical to \*(C`perlcc\*(C''s</p><ul>
<li><p>Also supports \*(C`gcc\*(C'-style long options:  % pp --gui --verbose --output=out.exe src.pl</p></li>
</ul></li><li><p>Small initial overhead; no runtime overhead</p></li><li><p>Dependencies are POD-stripped before packing</p></li><li><p>Loads modules directly into memory on demand</p></li><li><p>Shared libraries (DLLs) are extracted with File::Temp</p></li><li><p>Works on Perl 5.6.0 or above</p></li><li><p>Tested on Win32 (\s-1VC++\s0 and MinGW), FreeBSD, NetBSD, Linux, MacOSX, Cygwin, \s-1AIX\s0, Solaris, HP-UX, Tru64...</p></li>
</ul>
<h3>Aggregating multiple programs</h3>
<ul>
<li><p>A common question:  &gt; I have used pp to make several standalone applications which work  &gt; great, the only problem is that for each executable that I make, I am  &gt; assuming the parl.exe is somehow bundled into the resulting exe.</p></li><li><p>The obvious workaround:  You can ship parl.exe by itself, along with .par files built  by "pp -p", and run those PAR files by associating them to parl.exe.</p></li><li><p>On platforms that have \*(C`ln\*(C', there is a better solution:  % pp --output=a.out a.pl b.pl  # two scripts in one!  % ln a.out b.out               # symlink also works  % ./a.out                      # runs a.pl  % ./b.out                      # runs b.pl</p></li>
</ul>
<h3>Cross-platform Packages</h3>
<ul>
<li><p>Of course, there is no cross-platform binary format</p></li><li><p>Pure-perl \s-1PAR\s0 packages are cross-platform by default</p><ul>
<li><p>However, \s-1XS\s0 modules are specific to Perl version and platform</p></li><li><p>Multiple versions of a \s-1XS\s0 module can co-exist in a \s-1PAR\s0 file</p></li>
</ul></li><li><p>Suppose we need \*(C`out.par\*(C' on both Win32 and Finix:  C:&#92;&gt; pp --multiarch --output=out.par src.pl  ...copy src.pl and out.par to a Finix machine...  % pp --multiarch --output=out.par src.pl</p></li><li><p>Now it works on both platforms:  % parl out.par                 # runs src.pl  % perl -MPAR=out.par -e &apos;...&apos;  # uses modules inside out.par</p></li>
</ul>
<h3>The Anatomy of a \s-1PAR\s0 file</h3>
<ul>
<li><p>Modules can reside in several directories:  /                      # casual packaging only  /lib/                  # standard location  /arch/                 # for creating from blib/  /i386-freebsd/         # i.e. $Config{archname}  /5.8.0/                # i.e. Perl version number  /5.8.0/i386-freebsd/   # combination of the two above</p></li><li><p>Scripts are stored in one of the two locations:  /                      # casual packaging only  /script/               # standard location</p></li><li><p>Shared libraries may be architecture- or perl-version-specific:  /shlib/(5.8.0/)?(i386-freebsd/)?</p></li><li><p>\s-1PAR\s0 files may recursively contain other \s-1PAR\s0 files:  /par/(5.8.0/)?(i386-freebsd/)?</p></li>
</ul>
<h3>Special files</h3>
<ul>
<li><p>\s-1MANIFEST\s0</p><ul>
<li><p>Index of all files inside \s-1PAR\s0</p></li><li><p>Can be parsed with \*(C`ExtUtils::Manifest\*(C'</p></li>
</ul></li><li><p>\s-1META\s0.yml</p><ul>
<li><p>Dependency, license, runtime options</p></li><li><p>Can be parsed with \*(C`YAML\*(C'</p></li>
</ul></li><li><p>\s-1SIGNATURE\s0</p><ul>
<li><p>OpenPGP-signed digital signature</p></li><li><p>Can be parsed and verified with \*(C`Module::Signature\*(C'</p></li>
</ul></li>
</ul>
<h3>Advantages over perlcc, PerlApp and Perl2exe</h3>
<ul>
<li><p>This is not meant to be a flame</p><ul>
<li><p>All three maintainers have contributed to \s-1PAR\s0 directly; I'm grateful</p></li>
</ul></li><li><p>perlcc</p><ul>
<li><p>\*(L"The code generated in this way is not guaranteed to work... Use for production purposes is strongly discouraged.\*(R" (from perldoc perlcc)</p></li><li><p><em>Guaranteed to not work</em> is more like it</p></li>
</ul></li><li><p>PerlApp / Perl2exe</p><ul>
<li><p>Expensive: Need to pay for each upgrade</p></li><li><p>Non-portable: Only available for limited platforms</p></li><li><p>Proprietary: Cannot extend its features or fix bugs</p></li><li><p>Obfuscated: Vendor and black-hats can see your code, but you can't</p></li><li><p>Inflexible: Does not work with existing Perl installations</p></li>
</ul></li>
</ul>
<h3>\s-1MANIFEST:\s0 Best viewed with Mozilla</h3>
<ul>
<li><p>The \s-1URL\s0 of \*(C`MANIFEST\*(C' inside \*(C`/home/autrijus/foo.par\*(C':  jar:file:///home/autrijus/foo.par!/MANIFEST</p></li><li><p>Open it in a Gecko browser (e.g. Netscape 6+) with Javascript enabled:</p></li><li><p>No needed to unzip anything; just click on files to view them</p></li>
</ul>
<h3>\s-1META\s0.yml: Metadata galore</h3>
<ul>
<li><p>Static, machine-readable distribution metadata</p><ul>
<li><p>Supported by \*(C`Module::Build\*(C', \*(C`ExtUtils::MakeMaker\*(C', \*(C`Module::Install\*(C'</p></li>
</ul></li><li><p>A typical \*(C`pp\*(C'-generated \*(C`META.yml\*(C' looks like this:  build_requires: {}  conflicts: {}  dist_name: out.par  distribution_type: par  dynamic_config: 0  generated_by: &apos;Perl Packager version 0.03&apos;  license: unknown  par:    clean: 0    signature: &apos;&apos;    verbatim: 0    version: 0.68</p></li><li><p>The \*(C`par:\*(C' settings controls its runtime behavior</p></li>
</ul>
<h3>\s-1SIGNATURE:\s0 Signing and verifying packages</h3>
<ul>
<li><p>OpenPGP clear-signed manifest with \s-1SHA1\s0 digests</p><ul>
<li><p>Supported by \*(C`Module::Signature\*(C', \*(C`CPANPLUS\*(C' and \*(C`Module::Build\*(C'</p></li>
</ul></li><li><p>A typical \*(C`SIGNATURE\*(C' looks like this:  -----BEGIN PGP SIGNED MESSAGE-----  Hash: SHA1</p><p> SHA1 8a014cd6d0f6775552a01d1e6354a69eb6826046 AUTHORS  ...  -----BEGIN PGP SIGNATURE-----  ...  -----END PGP SIGNATURE-----</p></li><li><p>Use \*(C`pp\*(C' and \*(C`cpansign\*(C' to work with signatures:  % pp -s -o foo.par bar.pl      # make and sign foo.par from bar.pl  % cpansign -s foo.par  # sign this PAR file  % cpansign -v foo.par  # verify this PAR file</p></li>
</ul>
<h3>Perl Servlets with Apache::PAR</h3>
<ul>
<li><p>Framework for self-contained Web applications</p><ul>
<li><p>Similar to Java's \*(L"Web Application Archive\*(R" (\s-1WAR\s0) files</p></li><li><p>Works with mod_perl 1.x or 2.x</p></li>
</ul></li><li><p>A complete web application inside a \*(C`.par\*(C' file</p><ul>
<li><p>Apache configuration, static files, Perl modules...</p></li><li><p>Supports Static, Registry and PerlRun handlers</p></li><li><p>Can also load all PARs under a directory</p></li>
</ul></li><li><p>One additional special file: \*(C`web.conf\*(C'  Alias /myapp/cgi-perl/ ##PARFILE##/  &lt;Location /myapp/cgi-perl&gt;      Options +ExecCGI      SetHandler perl-script      PerlHandler Apache::PAR::Registry  &lt;/Location&gt;</p></li>
</ul>
<h3>Hon Dah, A-par-che!</h3>
<ul>
<li><p>First, make a \*(C`hondah.par\*(C' from an one-liner:  # use the "web.conf" from the previous slide  % pp -p -o hondah.par -e &apos;print "Hon Dah!&#92;n"&apos; &#92;       --add web.conf  % chmod a+x hondah.par</p></li><li><p>Add this to \*(C`httpd.conf\*(C', then restart apache:  &lt;IfDefine MODPERL2&gt;  PerlModule Apache2  &lt;/IfDefine&gt;  PerlAddVar PARInclude /home/autrijus/hondah.par  PerlModule Apache::PAR</p></li><li><p>Test it out:  % GET http://localhost/myapp/cgi-perl/main.pl  Hon Dah!</p></li><li><p>Instant one-liner web application that works!</p></li>
</ul>
<h3>On-demand library fetching</h3>
<ul>
<li><p>With \s-1LWP\s0 installed, your can use remote \s-1PAR\s0 files:  use PAR;  use lib &apos;http://aut.dyndns.org/par/DBI-latest.par&apos;;  use DBI;    # always up to date!</p></li><li><p>Modules are now cached under $ENV{PAR_GLOBAL_TEMP}</p></li><li><p>Auto-updates with \*(C`LWP::Simple::mirror\*(C'</p><ul>
<li><p>Download only if modified</p></li><li><p>Safe for offline use after the first time</p></li><li><p>May use \*(C`SIGNATURE\*(C' to prevent DNS-spoofing</p></li>
</ul></li><li><p>Makes large-scale deployment a breeze</p><ul>
<li><p>Upgrades from a central location</p></li><li><p>No installers needed</p></li>
</ul></li>
</ul>
<h3>Code Obfuscation</h3>
<ul>
<li><p>Also known as <em>source-hiding</em> techniques</p><ul>
<li><p>It is <em>not</em> encryption</p></li><li><p>Offered by PerlApp, Perl2Exe, Stunnix...</p></li>
</ul></li><li><p>Usually easy to defeat</p><ul>
<li><p>Take optree dump from memory, feed to \*(C`B::Deparse\*(C'</p></li><li><p>If you just want to stop a casual \*(C`grep\*(C', \*(L"deflate\*(R" already works</p></li>
</ul></li><li><p>\s-1PAR\s0 now supports pluggable <em>input filters</em> with \*(C`pp -f\*(C'</p><ul>
<li><p>Bundled examples: Bleach, PodStrip and PatchContent</p></li><li><p>True encryption using \*(C`Crypt::*\*(C'</p></li><li><p>Or even _product activation_ over the internet</p></li>
</ul></li><li><p>Alternatively, just keep core logic in your server and use \s-1RPC\s0</p></li>
</ul>
<h3>Accessing packed files</h3>
<ul>
<li><p>To get the host archive from a packed program:  my $zip = PAR::par_handle($0); # an Archive::Zip object  my $content = $zip-&gt;contents(&apos;MANIFEST&apos;);</p></li><li><p>Same thing, but with \*(C`read_file()\*(C':  my $content = PAR::read_file(&apos;MANIFEST&apos;);</p></li><li><p>Loaded \s-1PAR\s0 files are stored in %PAR::LibCache:  use PAR &apos;/home/mylibs/*.par&apos;;  while (my ($filename, $zip) = each %PAR::LibCache) {      print "[$filename - MANIFEST]&#92;n";      print $zip-&gt;contents(&apos;MANIFEST&apos;);  }</p></li>
</ul>
<h3>Packing \s-1GUI\s0 applications</h3>
<ul>
<li><p>\s-1GUI\s0 toolkits often need to link with shared libraries:  # search for libncurses under library paths and pack it  % pp -l ncurses curses_app.pl  # same for Tk, Wx, Gtk, Qt...</p></li><li><p>Use \*(C`pp --gui\*(C' on Win32 to eliminate the console window:  # pack &apos;src.pl&apos; into a console-less &apos;out.exe&apos; (Win32 only)  % pp --gui -o out.exe src.pl</p></li><li><p>\*(L"Can't locate Foo/Widget/Bar.pm in @INC\*(R"?</p><ul>
<li><p>Some toolkits (notably Tk) autoloads modules without \*(C`use\*(C' or \*(C`require\*(C'</p></li><li><p>Hence \*(C`pp\*(C' and \*(C`Module::ScanDeps\*(C' may fail to detect them</p></li><li><p>Tk problems mostly fixed by now, but other toolkits may still break</p></li><li><p>You can work around it with \*(C`pp -M\*(C' or an explicit \*(C`require\*(C'</p></li><li><p>Or better, send a short test-case to \*(C`par@perl.org\*(C' so we can fix it</p></li>
</ul></li>
</ul>
<h3>Precompiled \s-1CPAN\s0 distributions</h3>
<ul>
<li><p>Installing \s-1XS\s0 extensions from \s-1CPAN\s0 was difficult</p><ul>
<li><p>Some platforms do not come with a compiler (Win32, MacOSX...)</p></li><li><p>Some headers or libraries may be missing</p></li><li><p>\s-1PAR\s0.pm itself used to suffer from both problems</p></li>
</ul></li><li><p>...but not anymore \*(-- \*(C`Module::Install\*(C' to the rescue!  # same old Makefile.PL, with a few changes  use inc::Module::Install;      # was "use ExtUtils::MakeMaker;"  WriteMakefile( ... );          # same as the original  check_nmake();                 # make sure the user have nmake  par_base(&apos;AUTRIJUS&apos;);          # your CPAN ID or a URL  fetch_par() unless can_cc();   # use precompiled PAR only if necessary</p></li><li><p>Users will not notice anything, except now it works</p><ul>
<li><p>Of course, you still need to type \*(C`make par\*(C' and upload the precompiled package</p></li><li><p>\s-1PAR\s0 users can also install it directly with \*(C`parl -i\*(C'</p></li>
</ul></li>
</ul>
<h3>Platform-specific Tips</h3>
<ul>
<li><p>Win32 and other icon-savvy platforms</p><ul>
<li><p>Needs 3rd-party tools to add icons to \*(C`pp\*(C'-generated executables</p></li><li><p>\s-1PE\s0 Header manipulation in Perl \*(-- volunteers wanted!</p></li>
</ul></li><li><p>Linux and other libc-based platforms</p><ul>
<li><p>Try to avoid running \*(C`pp\*(C' on a bleeding-edge version of the \s-1OS\s0</p></li><li><p>Older versions with an earlier libc won't work with new ones</p></li>
</ul></li><li><p>Solaris and other zlib-lacking platforms (but not Win32)</p><ul>
<li><p>You need a static-linked \*(C`Compress::Zlib\*(C' before installing \s-1PAR\s0</p></li><li><p>In the future, \s-1PAR\s0 may depend on \*(C`Compress::Zlib::Static\*(C' instead</p></li>
</ul></li><li><p>Any platform with limited bandwidth or disk space</p><ul>
<li><p>Use \s-1UPX\s0 to minimize the executable size</p></li>
</ul></li>
</ul>
<h3>Thank you!</h3>
<ul>
<li><p>Additional resources</p><ul>
<li><p>Mailing list: \*(C`par@perl.org\*(C'</p></li><li><p>Subscribe: Send a blank email to \*(C`par-subscribe@perl.org\*(C'</p></li><li><p>List archive: &lt;http://nntp.x.perl.org/group/perl.par&gt;</p></li><li><p>PAR::Intro: &lt;http://search.cpan.org/dist/PAR/lib/PAR/Intro.pod&gt;</p></li><li><p>Apache::PAR: http://search.cpan.org/dist/Apache-PAR/ &lt;http://search.cpan.org/dist/Apache-PAR/&gt;</p></li><li><p>Module::Install: http://search.cpan.org/dist/Module-Install/ &lt;http://search.cpan.org/dist/Module-Install/&gt;</p></li>
</ul></li><li><p>Any questions?</p></li>
</ul>
<h3>Bonus Slides: \s-1PAR\s0 Internals</h3>

<h3>Overview of \s-1PAR\s0.pm's Implementation</h3>
<ul>
<li><p>Here begins the scary part</p><ul>
<li><p>Grues, Dragons and Jabberwocks abound...</p></li><li><p>You are going to learn weird things about Perl internals</p></li>
</ul></li><li><p>\s-1PAR\s0 invokes four areas of Perl arcana:</p><ul>
<li><p>@INC code references</p></li><li><p>On-the-fly source filtering</p></li><li><p>Overriding \*(C`DynaLoader::bootstrap()\*(C' to handle \s-1XS\s0 modules</p></li><li><p>Making self-bootstrapping binary executables</p></li>
</ul></li><li><p>The first two only works on 5.6 or later</p><ul>
<li><p>DynaLoader and %INC are there since Perl 5 was born</p></li><li><p>\s-1PAR\s0 currently needs 5.6, but a 5.005 port is possible</p></li>
</ul></li><li><p>On 1999-07-19, Ken Fox submitted a patch to P5P</p><ul>
<li><p>To _enable using remote modules_ by putting hooks in @INC</p></li><li><p>It's accepted to come in Perl 5.6, but undocumented until 5.8</p></li><li><p>Type \*(C`perldoc -f require\*(C' to read the nitty-gritty details</p></li>
</ul></li><li><p>Coderefs in @INC may return a fh, or undef to 'pass':  push @INC, sub {      my ($coderef, $filename) = @_;  # $coderef is &#92;&my_sub      open my $fh, "wget ftp://example.com/$filename |";      return $fh;        # using remote modules, indeed!  };</p></li><li><p>Perl 5.8 let you open a file handle to a string, so we just use that:         open my $fh, &apos;&lt;&apos;, &#92;($zip-&gt;memberNamed($filename)-&gt;contents);         return $fh;</p></li><li><p>But Perl 5.6 does not have that, and I don't want to use temp files...</p></li>
</ul>
<h3>Source Filtering without Filter::* Modules</h3>
<ul>
<li><p>... Undocumented features to the rescue!</p><ul>
<li><p>It turns out that @INC hooks can return <strong>two</strong> values</p></li><li><p>The first is still the file handle</p></li><li><p>The second is a code reference for line-by-line source filtering!</p></li>
</ul></li><li><p>This is how \*(C`Acme::use::strict::with::pride\*(C' works:  # Force all modules used to use strict and warnings  open my $fh, "&lt;", $filename or return;  my @lines = ("use strict; use warnings;&#92;n", "#line 1 &#92;"$full&#92;"&#92;n");  return ($fh, sub {      return 0 unless @lines;      push @lines, $_; $_ = shift @lines; return length $_;  });</p></li>
</ul>
<h3>Source Filtering without Filter::* Modules (cont.)</h3>
<ul>
<li><p>But we don't really have a filehandle for anything</p></li><li><p>Another undocumented feature saves the day!</p></li><li><p>We can actually omit the first return value altogether:  # Return all contents line-by-line from the file inside PAR  my @lines = split(      /(?&lt;=&#92;n)/,      $zip-&gt;memberNamed($filename)-&gt;contents  );  return (sub {      $_ = shift(@lines);      return length $_;  });</p></li>
</ul>
<h3>Overriding DynaLoader::bootstrap</h3>
<ul>
<li><p>\s-1XS\s0 modules have dynamically loaded libraries</p><ul>
<li><p>They cannot be loaded as part of a zip file, so we extract them out</p></li><li><p>Must intercept DynaLoader's library-finding process</p></li>
</ul></li><li><p>Module names are passed to \*(C`bootstrap\*(C' for \s-1XS\s0 loading</p><ul>
<li><p>During the process, it calls \*(C`dl_findfile\*(C' to locate the file</p></li><li><p>So we install pre-hooks around both functions</p></li>
</ul></li><li><p>Our \*(C`_bootstrap\*(C' just checks if the library is in PARs</p><ul>
<li><p>If yes, extract it to a \*(C`File::Temp\*(C' temp file</p><ul>
<li><p>The file will be automatically cleaned up when the program ends</p></li>
</ul></li><li><p>It then pass the arguments to the original \*(C`bootstrap\*(C'</p></li><li><p>Finally, our \*(C`dl_findfile\*(C' intercepts known filenames and return it</p></li>
</ul></li>
</ul>
<h3>Anatomy of a Self-Contained \s-1PAR\s0 executable</h3>
<ul>
<li><p>The par script ($0) itself</p><ul>
<li><p>May be in plain-text or native executable format</p></li>
</ul></li><li><p>Any number of embedded files</p><ul>
<li><p>Typically used to bootstrap \s-1PAR\s0's various dependencies</p></li><li><p>Each section begins with the magic string \*(L"\s-1FILE\s0\*(R"</p></li><li><p>Length of filename in pack('N') format and the filename (auto/.../)</p></li><li><p>File length in pack('N') and the file's content (not compressed)</p></li>
</ul></li><li><p>One \s-1PAR\s0 file</p><ul>
<li><p>Just a regular zip file with the magic string "PK&#92;003&#92;004"</p></li>
</ul></li><li><p>Ending section</p><ul>
<li><p>A pack('N') number of the total length of \s-1FILE\s0 and \s-1PAR\s0 sections</p></li><li><p>Finally, there must be a 8-bytes magic string: "&#92;012PAR.pm&#92;012"</p></li>
</ul></li>
</ul>
<h3>Self-Bootstrapping Tricks</h3>
<ul>
<li><p>All we can expect is a working perl interpreter</p><ul>
<li><p>The self-contained script *must not* use any modules at all</p></li><li><p>But to process \s-1PAR\s0 files, we need \s-1XS\s0 modules like Compress::Zlib</p></li>
</ul></li><li><p>Answer: bundle all modules + libraries used by \s-1PAR\s0.pm</p><ul>
<li><p>That's what the \*(C`FILE\*(C' section in the previous slide is for</p></li><li><p>Load modules to memory, and write object files to disk</p></li><li><p>Then use a local @INC hook to load them on demand</p></li>
</ul></li><li><p>Minimizing the amount of temporary files</p><ul>
<li><p>First, try to load PerlIO::scalar and File::Temp</p></li><li><p>Set up an \s-1END\s0 hook to unlink all temp files up to this point</p></li><li><p>Load other bundled files, and look in the compressed \s-1PAR\s0 section</p></li><li><p>This can be much easier with a pure-perl \*(C`inflate()\*(C'; patches welcome!</p></li>
</ul></li>
</ul>
<h3>Thank you (again)!</h3>
<ul>
<li><p>Any questions, <em>please</em>?</p></li>
</ul>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO PAR::Tutorial&hellip;</h2>
        <div class="sectioncontent">
<p>\s-1PAR\s0, pp, par.pl, parl</p><p>ex::lib::zip, Acme::use::strict::with::pride</p><p>App::Packer, Apache::PAR, \s-1CPANPLUS\s0, Module::Install</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHORS</h2>
        <div class="sectioncontent">
<p>Audrey Tang &lt;cpan@audreyt.org&gt;</p><p>&lt;http://par.perl.org/&gt; is the official \s-1PAR\s0 website.  You can write to the mailing list at &lt;par@perl.org&gt;, or send an empty mail to &lt;par-subscribe@perl.org&gt; to participate in the discussion.</p><p>Please submit bug reports to &lt;bug-par@rt.cpan.org&gt;.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COPYRIGHT</h2>
        <div class="sectioncontent">
<p>Copyright 2003, 2004, 2005, 2006 by Audrey Tang &lt;cpan@audreyt.org&gt;.</p><p>This document is free documentation; you can redistribute it and/or modify it under the same terms as Perl itself.</p><p>See &lt;http://www.perl.com/perl/misc/Artistic.html&gt;</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="PAR::SetupTemp.3pm.html"><span aria-hidden="true">&larr;</span> PAR::SetupTemp.3pm: Setup $env{par_temp}</a></li>
   <li class="next"><a href="PDF::API2::Simple.3pm.html">PDF::API2::Simple.3pm: Simplistic wrapper for the excellent pdf::api2 modules <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
