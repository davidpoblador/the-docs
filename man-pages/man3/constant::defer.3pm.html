<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>constant::defer: Constant subs with deferred value calculation</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Constant subs with deferred value calculation">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="constant::defer (3pm) manual">
  <meta name="twitter:description" content="Constant subs with deferred value calculation">
  <meta name="twitter:image" content="https://www.carta.tech/images/libconstant-defer-perl-constant::defer-3pm.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3pm/constant::defer.3pm.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="constant::defer (3pm) manual" />
  <meta property="og:description" content="Constant subs with deferred value calculation" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libconstant-defer-perl-constant::defer-3pm.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">constant::defer<small> (3pm)</small></h1>
        <p class="lead">Constant subs with deferred value calculation</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/">
      <span itemprop="name">MISSING SECTION</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/constant::defer.3pm.html">
      <span itemprop="name">constant::defer: Constant subs with deferred value calculation</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libconstant-defer-perl/">
      <span itemprop="name">libconstant-defer-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/constant::defer.3pm.html">
      <span itemprop="name">constant::defer: Constant subs with deferred value calculation</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
 use constant::defer FOO =&gt; sub { return $some + $thing; },
                     BAR =&gt; sub { return $an * $other; };

 use constant::defer MYOBJ =&gt; sub { require My::Class;
                                    return My::Class-&gt;new_thing; }
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>\*(C`constant::defer\*(C' creates a subroutine which on the first call runs given code to calculate its value, and on the second and subsequent calls just returns that value, like a constant.  The value code is discarded once run, allowing it to be garbage collected.</p><p>Deferring a calculation is good if it might take a lot of work or produce a big result, but is only needed sometimes or only well into a program run. If it's never needed then the value code never runs.</p><p>A deferred constant is generally not inlined or folded (see \*(L"Constant Folding\*(R" in perlop) like a plain \*(C`constant\*(C' since it's not a single scalar value.  In the current implementation a deferred constant becomes a plain one after the first use, so may inline etc in code compiled after that (see \*(L"\s-1IMPLEMENTATION\s0\*(R" below).</p><h3>Uses</h3>
<p>Here are some typical uses.</p><ul>
<li><p>A big value or slow calculation only sometimes needed,     use constant::defer SLOWVALUE =&gt; sub {                           long calculation ...;                           return $result;                         };</p><p>    if ($option) {       print "s=", SLOWVALUE, "&#92;n";     }</p></li><li><p>A shared object instance created when needed then re-used,     use constant::defer FORMATTER =&gt;           sub { return My::Formatter-&gt;new };</p><p>    if ($something) {       FORMATTER()-&gt;format ...     }</p></li><li><p>The value code might load requisite modules too, again deferring that until actually needed,     use constant::defer big =&gt; sub {       require Some::Big::Module;       return Some::Big::Module-&gt;create_something(...);     };</p></li><li><p>Once-only setup code can be created with no return value.  The code is garbage collected after the first run and becomes a do-nothing.  Remember to have an empty return statement so as not to keep the last expression's value alive forever.     use constant::defer MY_INIT =&gt; sub {       many lines of setup code ...;       return;     };</p><p>    sub new {       MY_INIT();       ...     }</p></li>
</ul>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">IMPORTS</h2>
        <div class="sectioncontent">
<p>There are no functions as such, everything works through the \*(C`use\*(C' import. The parameters are name/subroutine pairs.  For each one a sub called \*(C`NAME\*(C' is created, running the given \*(C`SUB\*(C' the first time its value is needed. \*(C`NAME\*(C' defaults to the caller's package, or a fully qualified name can be given.  Remember that the bareword stringizing of \*(C`=&gt;\*(C' doesn't act on a qualified name, so add quotes in that case.     use constant::defer &apos;Other::Package::BAR&apos; =&gt; sub { ... }; For compatibility with the \*(C`constant\*(C' module a hash of name/sub arguments is accepted too.  But \*(C`constant::defer\*(C' doesn't need that since there's only ever one thing (a sub) following each name.     use constant::defer { FOO =&gt; sub { ... },                           BAR =&gt; sub { ... } };</p><p>    # works without the hashref too     use constant::defer FOO =&gt; sub { ... },                         BAR =&gt; sub { ... };</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">MULTIPLE VALUES</h2>
        <div class="sectioncontent">
<p>The value sub can return multiple values to make an array style constant sub.</p><p>    use constant::defer NUMS =&gt; sub { return (&apos;one&apos;, &apos;two&apos;) };</p><p>    foreach (NUMS) {        print $_,"&#92;n";     }</p><p>The value sub is always run in array context, for consistency, irrespective how the constant is used.  The return from the new constant sub is an array style</p><p>    sub () { return @result }</p><p>If the value sub was a list-style return like \*(C`NUMS\*(C' shown above, then this array-style return is slightly different.  In scalar context a list return means the last value (like a comma operator), but an array return in scalar context means the number of elements.  A multi-value constant won't normally be used in scalar context, so the difference shouldn't arise.  The array style is easier for \*(C`constant::defer\*(C' to implement and is the same as the plain \*(C`constant\*(C' module does.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">ARGUMENTS</h2>
        <div class="sectioncontent">
<p>If the constant is called with arguments then they're passed on to the value sub.  This can be good for constants used as object or class methods. Passing anything to plain constants would be unusual.</p><p>One cute use for a class method style is to make a \*(L"singleton\*(R" instance of the class.  See <em>examples/instance.pl</em> in the sources for a complete program.</p><p>    package My::Class;     use constant::defer INSTANCE =&gt; sub { my ($class) = @_;                                           return $class-&gt;new };     package main;     $obj = My::Class-&gt;INSTANCE;</p><p>A subclass might want to be careful about letting a subclass object get into the parent \*(C`INSTANCE\*(C', though if a program only ever used the subclass then that might in fact be desirable.</p><p>Subs created by \*(C`constant::defer\*(C' always have prototype \*(C`()\*(C', ensuring they always parse the same way.  The prototype has no effect when called as a method like above, but if you want a plain call with arguments then use \*(C`&\*(C' to bypass the prototype (see perlsub).</p><p>    &MYCONST (&apos;Some value&apos;);</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">IMPLEMENTATION</h2>
        <div class="sectioncontent">
<p>Currently \*(C`constant::defer\*(C' creates a sub under the requested name and when called it replaces that with a new constant sub the same as \*(C`use constant\*(C' would make.  This is compact and means that later loaded code might be able to inline it.</p><p>It's fine to keep a reference to the initial sub and in fact that happens quite normally if importing into another module (with the usual \*(C`Exporter\*(C'), or an explicit \*(C`&#92;&foo\*(C', or a \*(C`$package-&gt;can(&apos;foo&apos;)\*(C'. The initial sub changes itself to jump to the new constant, it doesn't re-run the value code.</p><p>The jump is currently done by a \*(C`goto\*(C' to the new coderef, so it's a touch slower than the new constant sub directly.  A spot of \s-1XS\s0 would no doubt make the difference negligible, in fact perhaps to the point where there'd be no need for a new sub, just have the initial transform itself.  If the new form looked enough like a plain constant it might inline in later loaded code.</p><p>For reference, \*(C`Package::Constants\*(C' (as of version 0.02) considers \*(C`constant::defer\*(C' subrs as constants, both before and after the first call that runs the value code.  \*(C`Package::Constants\*(C' just looks for prototyped \*(C`sub&nbsp;foo&nbsp;()&nbsp;{&nbsp;}\*(C' functions, so any such subr rates as a constant.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">OTHER WAYS TO DO IT</h2>
        <div class="sectioncontent">
<p>There's many ways to do \*(L"deferred\*(R" or \*(L"lazy\*(R" calculations.</p><ul>
<li><p>\*(C`Memoize\*(C' makes a function repeat its return.  Results are cached against the arguments, so it keeps the original code whereas \*(C`constant::defer\*(C' discards after the first run.</p></li><li><p>\*(C`Class::Singleton\*(C' and friends make a create-once \*(C`My::Class-&gt;instance\*(C' method.  \*(C`constant::defer\*(C' can get close with the fakery shown under \*(L"\s-1ARGUMENTS\s0\*(R" above, though without a \*(C`has_instance\*(C' to query.</p></li><li><p>\*(C`Sub::Become\*(C' offers some syntactic sugar for redefining the running subroutine, including to a constant.</p></li><li><p>\*(C`Sub::SingletonBuilder\*(C' can create an instance function for a class.  It's geared towards objects and so won't allow 0 or \*(C`undef\*(C' as the return value.</p></li><li><p>A scalar can be rigged up to run code on its first access.  \*(C`Data::Lazy\*(C' uses a \*(C`tie\*(C'.  \*(C`Scalar::Defer\*(C' and \*(C`Scalar::Lazy\*(C' use \*(C`overload\*(C' on an object.  \*(C`Data::Thunk\*(C' optimizes out the object from \*(C`Scalar::Defer\*(C' after the first run.  \*(C`Variable::Lazy\*(C' uses \s-1XS\s0 magic removed after the first fetch and some parsing for syntactic sugar. The advantage of a variable is that it interpolates in strings, but it won't inline in later loaded code; sloppy \s-1XS\s0 code might bypass the magic; and package variables aren't very friendly when subclassing.</p></li><li><p>\*(C`Object::Lazy\*(C' and \*(C`Object::Trampoline\*(C' rig up an object wrapper to load and create an actual object only when a method is called, dispatching to it and replacing the callers $_[0].  The advantage is you can pass the wrapper object around, etc, deferring creation to an even later point than a sub or scalar can.</p></li><li><p>\*(C`Object::Realize::Later\*(C', \*(C`Class::LazyObject\*(C' and \*(C`Class::LazyFactory\*(C' help make a defer class which transforms lazy stub objects to real ones when a method call is made.  A separate defer class is required for each real class.</p></li><li><p>\*(C`once.pm\*(C' sets up a run-once code block, but with no particular return value and not discarding the code after run.</p></li><li><p>\*(C`Class::LazyLoad\*(C' and \*(C`deferred\*(C' load code on a class method call such as object creation.  They're more about module loading than a defer of a particular value.</p></li><li><p>\*(C`Tie::LazyList\*(C' and \*(C`Tie::Array::Lazy\*(C' makes an array calculate values on-demand from a generator function.  \*(C`Hash::Lazy\*(C' does a similar thing for hashes.  \*(C`Tie::LazyFunction\*(C' hides a function behind a scalar; its laziness is in the argument evaluation, the function is called every time.</p></li>
</ul>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO constant::defer&hellip;</h2>
        <div class="sectioncontent">
<p>constant, perlsub, constant::lexical</p><p>Memoize, Attribute::Memoize, Memoize::Attrs, Class::Singleton, Data::Lazy, Scalar::Defer, Scalar::Lazy, Data::Thunk, Variable::Lazy, Sub::Become, Sub::SingletonBuilder, Object::Lazy, Object::Trampoline, Object::Realize::Later, once, Class::LazyLoad, deferred</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">HOME PAGE</h2>
        <div class="sectioncontent">
<p>http://user42.tuxfamily.org/constant-defer/index.html</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COPYRIGHT</h2>
        <div class="sectioncontent">
<p>Copyright 2009, 2010, 2011 Kevin Ryde</p><p>constant-defer is free software; you can redistribute it and/or modify it under the terms of the \s-1GNU\s0 General Public License as published by the Free Software Foundation; either version 3, or (at your option) any later version.</p><p>constant-defer is distributed in the hope that it will be useful, but \s-1WITHOUT\s0 \s-1ANY\s0 \s-1WARRANTY\s0; without even the implied warranty of \s-1MERCHANTABILITY\s0 or \s-1FITNESS\s0 \s-1FOR\s0 A \s-1PARTICULAR\s0 \s-1PURPOSE\s0.  See the \s-1GNU\s0 General Public License for more details.</p><p>You should have received a copy of the \s-1GNU\s0 General Public License along with constant-defer.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="cipux-storage.perl.3pm.html"><span aria-hidden="true">&larr;</span> cipux-storage.perl.3pm: None</a></li>
   <li class="next"><a href="criticism.3pm.html">criticism.3pm: Perl pragma to enforce coding standards and best-practices <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
