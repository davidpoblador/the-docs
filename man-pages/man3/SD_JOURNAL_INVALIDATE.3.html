<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SD_JOURNAL_INVALIDATE: Journal change notification interface</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Journal change notification interface">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="SD_JOURNAL_INVALIDATE (3) manual">
  <meta name="twitter:description" content="Journal change notification interface">
  <meta name="twitter:image" content="https://www.carta.tech/images/libsystemd-dev-SD_JOURNAL_INVALIDATE-3.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3/SD_JOURNAL_INVALIDATE.3.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="SD_JOURNAL_INVALIDATE (3) manual" />
  <meta property="og:description" content="Journal change notification interface" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libsystemd-dev-SD_JOURNAL_INVALIDATE-3.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">SD_JOURNAL_INVALIDATE<small> (3)</small></h1>
        <p class="lead">Journal change notification interface</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/">
      <span itemprop="name">Library calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/SD_JOURNAL_INVALIDATE.3.html">
      <span itemprop="name">SD_JOURNAL_INVALIDATE: Journal change notification interface</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libsystemd-dev/">
      <span itemprop="name">libsystemd-dev</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/SD_JOURNAL_INVALIDATE.3.html">
      <span itemprop="name">SD_JOURNAL_INVALIDATE: Journal change notification interface</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
#include &lt;systemd/sd-journal.h&gt;
</pre>
<p><strong>int sd_journal_get_fd(sd_journal&nbsp;*</strong><em>j</em><strong>);</strong> <strong>int sd_journal_get_events(sd_journal&nbsp;*</strong><em>j</em><strong>);</strong> <strong>int sd_journal_get_timeout(sd_journal&nbsp;*</strong><em>j</em><strong>, uint64_t&nbsp;*</strong><em>timeout_usec</em><strong>);</strong> <strong>int sd_journal_process(sd_journal&nbsp;*</strong><em>j</em><strong>);</strong> <strong>int sd_journal_wait(sd_journal&nbsp;*</strong><em>j</em><strong>, uint64_t&nbsp;</strong><em>timeout_usec</em><strong>);</strong> <strong>int sd_journal_reliable_fd(sd_journal&nbsp;*</strong><em>j</em><strong>);</strong></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p><strong>sd_journal_get_fd()</strong> returns a file descriptor that may be asynchronously polled in an external event loop and is signaled as soon as the journal changes, because new entries or files were added, rotation took place, or files have been deleted, and similar. The file descriptor is suitable for usage in <a href="../man2/poll.2.html"><strong>poll</strong>(2)</a>. Use <strong>sd_journal_get_events()</strong> for an events mask to watch for. The call takes one argument: the journal context object. Note that not all file systems are capable of generating the necessary events for wakeups from this file descriptor for changes to be noticed immediately. In particular network files systems do not generate suitable file change events in all cases. Cases like this can be detected with <strong>sd_journal_reliable_fd()</strong>, below. <strong>sd_journal_get_timeout()</strong> will ensure in these cases that wake-ups happen frequently enough for changes to be noticed, although with a certain latency.</p><p><strong>sd_journal_get_events()</strong> will return the <strong>poll()</strong> mask to wait for. This function will return a combination of <strong>POLLIN</strong> and <strong>POLLOUT</strong> and similar to fill into the ".events" field of <em>struct pollfd</em>.</p><p><strong>sd_journal_get_timeout()</strong> will return a timeout value for usage in <strong>poll()</strong>. This returns a value in microseconds since the epoch of <strong>CLOCK_MONOTONIC</strong> for timing out <strong>poll()</strong> in <em>timeout_usec</em>. See <a href="../man2/clock_gettime.2.html"><strong>clock_gettime</strong>(2)</a> for details about <strong>CLOCK_MONOTONIC</strong>. If there is no timeout to wait for, this will fill in <strong>(uint64_t) -1</strong> instead. Note that <strong>poll()</strong> takes a relative timeout in milliseconds rather than an absolute timeout in microseconds. To convert the absolute &apos;us&apos; timeout into relative &apos;ms&apos;, use code like the following:</p>
<pre>
uint64_t t;
int msec;
sd_journal_get_timeout(m, &t);
if (t == (uint64_t) -1)
        msec = -1;
else {
        struct timespec ts;
        uint64_t n;
        clock_getttime(CLOCK_MONOTONIC, &ts);
        n = (uint64_t) ts.tv_sec * 1000000 + ts.tv_nsec / 1000;
        msec = t &gt; n ? (int) ((t - n + 999) / 1000) : 0;
}
</pre>
<p>The code above does not do any error checking for brevity&apos;s sake. The calculated <em>msec</em> integer can be passed directly as <strong>poll()</strong>&apos;s timeout parameter.</p><p>After each <strong>poll()</strong> wake-up <strong>sd_journal_process()</strong> needs to be called to process events. This call will also indicate what kind of change has been detected (see below; note that spurious wake-ups are possible).</p><p>A synchronous alternative for using <strong>sd_journal_get_fd()</strong>, <strong>sd_journal_get_events()</strong>, <strong>sd_journal_get_timeout()</strong> and <strong>sd_journal_process()</strong> is <strong>sd_journal_wait()</strong>. It will synchronously wait until the journal gets changed. The maximum time this call sleeps may be controlled with the <em>timeout_usec</em> parameter. Pass <strong>(uint64_t) -1</strong> to wait indefinitely. Internally this call simply combines <strong>sd_journal_get_fd()</strong>, <strong>sd_journal_get_events()</strong>, <strong>sd_journal_get_timeout()</strong>, <strong>poll()</strong> and <strong>sd_journal_process()</strong> into one.</p><p><strong>sd_journal_reliable_fd()</strong> may be used to check whether the wakeup events from the file descriptor returned by <strong>sd_journal_get_fd()</strong> are known to be immediately triggered. On certain file systems where file change events from the OS are not available (such as NFS) changes need to be polled for repeatedly, and hence are detected only with a certain latency. This call will return a positive value if the journal changes are detected immediately and zero when they need to be polled for and hence might be noticed only with a certain latency. Note that there&apos;s usually no need to invoke this function directly as <strong>sd_journal_get_timeout()</strong> on these file systems will ask for timeouts explicitly anyway.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RETURN VALUE</h2>
        <div class="sectioncontent">
<p><strong>sd_journal_get_fd()</strong> returns a valid file descriptor on success or a negative errno-style error code.</p><p><strong>sd_journal_get_events()</strong> returns a combination of <strong>POLLIN</strong>, <strong>POLLOUT</strong> and suchlike on success or a negative errno-style error code.</p><p><strong>sd_journal_reliable_fd()</strong> returns a positive integer if the file descriptor returned by <strong>sd_journal_get_fd()</strong> will generate wake-ups immediately for all journal changes. Returns 0 if there might be a latency involved.</p><p><strong>sd_journal_process()</strong> and <strong>sd_journal_wait()</strong> return one of <strong>SD_JOURNAL_NOP</strong>, <strong>SD_JOURNAL_APPEND</strong> or <strong>SD_JOURNAL_INVALIDATE</strong> on success or a negative errno-style error code. If <strong>SD_JOURNAL_NOP</strong> is returned, the journal did not change since the last invocation. If <strong>SD_JOURNAL_APPEND</strong> is returned, new entries have been appended to the end of the journal. If <strong>SD_JOURNAL_INVALIDATE</strong>, journal files were added or removed (possibly due to rotation). In the latter event, live-view UIs should probably refresh their entire display, while in the case of <strong>SD_JOURNAL_APPEND</strong>, it is sufficient to simply continue reading at the previous end of the journal.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">NOTES</h2>
        <div class="sectioncontent">
<p>The <strong>sd_journal_get_fd()</strong>, <strong>sd_journal_get_events()</strong>, <strong>sd_journal_reliable_fd()</strong>, <strong>sd_journal_process()</strong> and <strong>sd_journal_wait()</strong> interfaces are available as a shared library, which can be compiled and linked to with the <strong>libsystemd</strong>&nbsp;<a href="../man1/pkg-config.1.html"><strong>pkg-config</strong>(1)</a> file.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLES</h2>
        <div class="sectioncontent">
<p>Iterating through the journal, in a live view tracking all changes:</p>
<pre>
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;systemd/sd-journal.h&gt;

int main(int argc, char *argv[]) {
        int r;
        sd_journal *j;
        r = sd_journal_open(&j, SD_JOURNAL_LOCAL_ONLY);
        if (r &lt; 0) {
                fprintf(stderr, "Failed to open journal: %s&#92;n", strerror(-r));
                return 1;
        }
        for (;;)  {
                const void *d;
                size_t l;
                r = sd_journal_next(j);
                if (r &lt; 0) {
                        fprintf(stderr, "Failed to iterate to next entry: %s&#92;n", strerror(-r));
                        break;
                }
                if (r == 0) {
                        /* Reached the end, let&apos;s wait for changes, and try again */
                        r = sd_journal_wait(j, (uint64_t) -1);
                        if (r &lt; 0) {
                                fprintf(stderr, "Failed to wait for changes: %s&#92;n", strerror(-r));
                                break;
                        }
                        continue;
                }
                r = sd_journal_get_data(j, "MESSAGE", &d, &l);
                if (r &lt; 0) {
                        fprintf(stderr, "Failed to read message field: %s&#92;n", strerror(-r));
                        continue;
                }
                printf("%.*s&#92;n", (int) l, (const char*) d);
        }
        sd_journal_close(j);
        return 0;
}
</pre>
<p>Waiting with <strong>poll()</strong> (this example lacks all error checking for the sake of simplicity):</p>
<pre>
#include &lt;sys/poll.h&gt;
#include &lt;systemd/sd-journal.h&gt;

int wait_for_changes(sd_journal *j) {
        struct pollfd pollfd;
        int msec;

        sd_journal_get_timeout(m, &t);
        if (t == (uint64_t) -1)
                msec = -1;
        else {
                struct timespec ts;
                uint64_t n;
                clock_getttime(CLOCK_MONOTONIC, &ts);
                n = (uint64_t) ts.tv_sec * 1000000 + ts.tv_nsec / 1000;
                msec = t &gt; n ? (int) ((t - n + 999) / 1000) : 0;
        }

        pollfd.fd = sd_journal_get_fd(j);
        pollfd.events = sd_journal_get_events(j);
        poll(&pollfd, 1, msec);
        return sd_journal_process(j);
}
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO SD_JOURNAL_INVALIDATE&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man1/systemd.1.html"><strong>systemd</strong>(1)</a>, <a href="../man3/sd-journal.3.html"><strong>sd-journal</strong>(3)</a>, <a href="../man3/sd_journal_open.3.html"><strong>sd_journal_open</strong>(3)</a>, <a href="../man3/sd_journal_next.3.html"><strong>sd_journal_next</strong>(3)</a>, <a href="../man2/poll.2.html"><strong>poll</strong>(2)</a>, <a href="../man2/clock_gettime.2.html"><strong>clock_gettime</strong>(2)</a></p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="SD_JOURNAL_FOREACH_UNIQUE.3.html"><span aria-hidden="true">&larr;</span> SD_JOURNAL_FOREACH_UNIQUE.3: Read unique data fields from the journal</a></li>
   <li class="next"><a href="SD_JOURNAL_LOCAL_ONLY.3.html">SD_JOURNAL_LOCAL_ONLY.3: Open the system journal for reading <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
