<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>libefence: Electric fence malloc debugger</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Electric fence malloc debugger">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="libefence (3) manual">
  <meta name="twitter:description" content="Electric fence malloc debugger">
  <meta name="twitter:image" content="https://www.carta.tech/images/electric-fence-libefence-3.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3/libefence.3.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="libefence (3) manual" />
  <meta property="og:description" content="Electric fence malloc debugger" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/electric-fence-libefence-3.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">libefence<small> (3)</small></h1>
        <p class="lead">Electric fence malloc debugger</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/">
      <span itemprop="name">Library calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/libefence.3.html">
      <span itemprop="name">libefence: Electric fence malloc debugger</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/electric-fence/">
      <span itemprop="name">electric-fence</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/libefence.3.html">
      <span itemprop="name">libefence: Electric fence malloc debugger</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
#include &lt;stdlib.h&gt;
</pre>

<pre>
void * malloc (size_t size);
</pre>

<pre>
void free (void *ptr);
</pre>

<pre>
void * realloc (void *ptr, size_t size);
</pre>

<pre>
void * calloc (size_t nelem, size_t elsize);
</pre>

<pre>
void * memalign (size_t alignment, size_t size);
</pre>

<pre>
int posix_memalign (void ** memptr, size_t alignment, size_t size);
</pre>

<pre>
void * valloc (size_t size);
</pre>

<pre>
extern int EF_DISABLE_BANNER;
</pre>

<pre>
extern int EF_ALIGNMENT;
</pre>

<pre>
extern int EF_PROTECT_BELOW;
</pre>

<pre>
extern int EF_PROTECT_FREE;
</pre>

<pre>
extern int EF_ALLOW_MALLOC_0;
</pre>

<pre>
extern int EF_FILL;
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p><em>Electric Fence</em> helps you detect two common programming bugs: software that overruns the boundaries of a malloc() memory allocation, and software that touches a memory allocation that has been released by free(). Unlike other malloc() debuggers, Electric Fence will detect <em>read</em> accesses as well as writes, and it will pinpoint the exact instruction that causes an error. It has been in use at Pixar since 1987, and at many other sites for years.</p><p>Electric Fence uses the virtual memory hardware of your computer to place an inaccessible memory page immediately after (or before, at the user's option) each memory allocation. When software reads or writes this inaccessible page, the hardware issues a segmentation fault, stopping the program at the offending instruction. It is then trivial to find the erroneous statement using your favorite debugger. In a similar manner, memory that has been released by free() is made inaccessible, and any code that touches it will get a segmentation fault.</p><p>Simply linking your application with libefence.a will allow you to detect most, but not all, malloc buffer overruns and accesses of free memory. If you want to be reasonably sure that you've found <em>all</em> bugs of this type, you'll have to read and understand the rest of this man page.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">USAGE</h2>
        <div class="sectioncontent">
<p>Link your program with the library <strong>libefence.a .</strong> Make sure you are <em>not</em> linking with <strong>-lmalloc,</strong> <strong>-lmallocdebug,</strong> or with other malloc-debugger or malloc-enhancer libraries. You can only use one at a time. If your system administrator has installed Electric Fence for public use, you'll be able to use the <strong>-lefence</strong> argument to the linker, otherwise you'll have to put the path-name for <strong>libefence.a</strong> in the linker's command line. You can also use dynamic linking. If you're using a Bourne shell, the statement <strong>export LD_PRELOAD=libefence.so.0.0</strong> will cause Electric Fence to be loaded to run all dynamic executables. The command <strong>ef</strong> <em>command</em> runs a single command under Electric Fence.</p><p>Some systems will require special arguments to the linker to assure that you are using the Electric Fence malloc() and not the one from your C library.</p><p>Run your program <em>using a debugger.</em> It's easier to work this way than to create a <strong>core</strong> file and post-mortem debug it. Electric Fence can create <em>huge</em> core files, and some operating systems will thus take minutes simply to dump core! Some operating systems will not create usable core files from programs that are linked with Electric Fence. If your program has one of the errors detected by Electric Fence, it will get a segmentation fault (SIGSEGV) at the offending instruction. Use the debugger to locate the erroneous statement, and repair it.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">GLOBAL AND ENVIRONMENT VARIABLES</h2>
        <div class="sectioncontent">
<p>Electric Fence has six configuration switches that can be enabled via the shell environment, or by setting the value of global integer variables using a debugger. These switches change what bugs Electric Fence will detect, so it's important that you know how to use them.</p>
<dl class='dl-vertical'>
  <dt>
    <p>EF_DISABLE_BANNER</p>
  </dt>
  <dd>
    <p>This is an integer which if nonzero specifies that the usual Electric Fence banner and copyright notice should not be printed.  This is provided for certain circumstances where the banner can be annoying (eg, running a regression test suite that also monitors stderr).  Note that you should almost certainly not set this in your program, because then you might leave Electric Fence linked into the production version, which would be very bad.</p>
  </dd>
  <dt>
    <p>EF_ALIGNMENT</p>
  </dt>
  <dd>
    <p>This is an integer that specifies the alignment for any memory allocations that will be returned by malloc(), calloc(), and realloc(). The value is specified in bytes, thus a value of 4 will cause memory to be aligned to 32-bit boundaries unless your system doesn't have a 8-bit characters. EF_ALIGNMENT is set to sizeof(int) by default, since that is generally the word-size of your CPU. If your program requires that allocations be aligned to 64-bit boundaries and you have a 32-bit <strong>int</strong> you'll have to set this value to 8. This is the case when compiling with the <strong>-mips2</strong> flag on MIPS-based systems such as those from SGI. The memory allocation that is returned by Electric Fence malloc() is aligned using the value in EF_ALIGNMENT, and <em>its size the multiple of</em> <em>that value</em> that is greater than or equal to the requested size. For this reason, you will sometimes want to set EF_ALIGNMENT to 0 (no alignment), so that you can detect overruns of less than your CPU's word size. Be sure to read the section <em>WORD-ALIGNMENT AND OVERRUN DETECTION</em> in this manual page before you try this. To change this value, set EF_ALIGNMENT in the shell environment to an integer value, or assign to the global integer variable EF_ALIGNMENT using a debugger.</p>
  </dd>
  <dt>
    <p>EF_PROTECT_BELOW</p>
  </dt>
  <dd>
    <p>Electric Fence usually places an inaccessible page immediately after each memory allocation, so that software that runs past the end of the allocation will be detected. Setting EF_PROTECT_BELOW to 1 causes Electric Fence to place the inaccessible page <em>before</em> the allocation in the address space, so that under-runs will be detected instead of over-runs. When EF_PROTECT_BELOW is set, the EF_ALIGNMENT parameter is ignored. All allocations will be aligned to virtual-memory-page boundaries, and their size will be the exact size that was requested. To change this value, set EF_PROTECT_BELOW in the shell environment to an integer value, or assign to the global integer variable EF_PROTECT_BELOW using a debugger.</p>
  </dd>
  <dt>
    <p>EF_PROTECT_FREE</p>
  </dt>
  <dd>
    <p>When EF_PROTECT_FREE is not set (i. e. set to 0), Electric Fence returns free memory to a pool and only checks accesses to it until it is reallocated. If you suspect that a program may be touching free memory, set EF_PROTECT_FREE to 1. This will cause Electric Fence to never re-allocate memory once it has been freed, so that any access to free memory will be detected. Some programs will use tremendous amounts of memory when this parameter is set. To change this value, set EF_PROTECT_FREE in the shell environment to an integer value, or assign to the global integer variable EF_PROTECT_FREE using a debugger.</p>
  </dd>
  <dt>
    <p>EF_ALLOW_MALLOC_0</p>
  </dt>
  <dd>
    <p>By default, Electric Fence traps calls to malloc() with a size of zero, because they are often the result of a software bug. If EF_ALLOW_MALLOC_0 is non-zero, the software will not trap calls to malloc() with a size of zero. To change this value, set EF_ALLOW_MALLOC_0 in the shell environment to an integer value, or assign to the global integer variable EF_ALLOW_MALLOC_0 using a debugger.</p>
  </dd>
  <dt>
    <p>EF_FILL</p>
  </dt>
  <dd>
    <p>When set to a value between 0 and 255, every byte of allocated memory is initialized to that value. This can help detect reads of uninitialized memory. When set to -1, some memory is filled with zeroes (the operating system default on most systems) and some memory will retain the values written to it during its last use.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">WORD-ALIGNMENT AND OVERRUN DETECTION</h2>
        <div class="sectioncontent">
<p>There is a conflict between the alignment restrictions that malloc() operates under and the debugging strategy used by Electric Fence. When detecting overruns, Electric Fence malloc() allocates two or more virtual memory pages for each allocation. The last page is made inaccessible in such a way that any read, write, or execute access will cause a segmentation fault. Then, Electric Fence malloc() will return an address such that the first byte after the end of the allocation is on the inaccessible page. Thus, any overrun of the allocation will cause a segmentation fault.</p><p>It follows that the address returned by malloc() is the address of the inaccessible page minus the size of the memory allocation. Unfortunately, malloc() is required to return <em>word-aligned</em> allocations, since many CPUs can only access a word when its address is aligned. The conflict happens when software makes a memory allocation using a size that is not a multiple of the word size, and expects to do word accesses to that allocation. The location of the inaccessible page is fixed by hardware at a word-aligned address. If Electric Fence malloc() is to return an aligned address, it must increase the size of the allocation to a multiple of the word size. In addition, the functions memalign() and valloc() must honor explicit specifications on the alignment of the memory allocation, and this, as well can only be implemented by increasing the size of the allocation. Thus, there will be situations in which the end of a memory allocation contains some padding space, and accesses of that padding space will not be detected, even if they are overruns.</p><p>Electric Fence provides the variable EF_ALIGNMENT so that the user can control the default alignment used by malloc(), calloc(), and realloc(). To debug overruns as small as a single byte, you can set EF_ALIGNMENT to zero. This will result in Electric Fence malloc() returning unaligned addresses for allocations with sizes that are not a multiple of the word size. This is not a problem in most cases, because compilers must pad the size of objects so that alignment restrictions are honored when storing those objects in arrays. The problem surfaces when software allocates odd-sized buffers for objects that must be word-aligned. One case of this is software that allocates a buffer to contain a structure and a string, and the string has an odd size (this example was in a popular TIFF library). If word references are made to un-aligned buffers, you will see a bus error (SIGBUS) instead of a segmentation fault. The only way to fix this is to re-write the offending code to make byte references or not make odd-sized allocations, or to set EF_ALIGNMENT to the word size.</p><p>Another example of software incompatible with EF_ALIGNMENT &lt; word-size is the strcmp() function and other string functions on SunOS (and probably Solaris), which make word-sized accesses to character strings, and may attempt to access up to three bytes beyond the end of a string. These result in a segmentation fault (SIGSEGV). The only way around this is to use versions of the string functions that perform byte references instead of word references.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">INSTRUCTIONS FOR DEBUGGING YOUR PROGRAM</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    <p>1.</p>
  </dt>
  <dd>
    <p>Link with libefence.a as explained above.</p>
  </dd>
  <dt>
    <p>2.</p>
  </dt>
  <dd>
    <p>Run your program in a debugger and fix any overruns or accesses to free memory.</p>
  </dd>
  <dt>
    <p>3.</p>
  </dt>
  <dd>
    <p>Quit the debugger.</p>
  </dd>
  <dt>
    <p>4.</p>
  </dt>
  <dd>
    <p>Set EF_PROTECT_BELOW = 1 in the shell environment.</p>
  </dd>
  <dt>
    <p>5.</p>
  </dt>
  <dd>
    <p>Repeat step 2, this time repairing underruns if they occur.</p>
  </dd>
  <dt>
    <p>6.</p>
  </dt>
  <dd>
    <p>Quit the debugger.</p>
  </dd>
  <dt>
    <p>7.</p>
  </dt>
  <dd>
    <p>Read the restrictions in the section on <em>WORD-ALIGNMENT AND OVERRUN DETECTION.</em> See if you can set EF_ALIGNMENT to 0 and repeat step 2. Sometimes this will be too much work, or there will be problems with library routines for which you don't have the source, that will prevent you from doing this.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">MEMORY USAGE AND EXECUTION SPEED</h2>
        <div class="sectioncontent">
<p>Since Electric Fence uses at least two virtual memory pages for each of its allocations, it's a terrible memory hog. I've sometimes found it necessary to add a swap file using <a href="../man8/swapon.8.html"><strong>swapon</strong>(8)</a> so that the system would have enough virtual memory to debug my program. Also, the way we manipulate memory results in various cache and translation buffer entries being flushed with each call to malloc or free. The end result is that your program will be much slower and use more resources while you are debugging it with Electric Fence.</p><p>Don't leave libefence.a linked into production software! Use it only for debugging.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Bruce Perens</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">WARNINGS</h2>
        <div class="sectioncontent">
<p>I have tried to do as good a job as I can on this software, but I doubt that it is even theoretically possible to make it bug-free. This software has no warranty. It will not detect some bugs that you might expect it to detect, and will indicate that some non-bugs are bugs.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">LICENSE</h2>
        <div class="sectioncontent">
<p>Copyright 1987-1999 Bruce Perens. All rights reserved.</p><p>This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License, Version 2, as published by the Free Software Foundation. A copy of this license is distributed with this software in the file "COPYING".</p><p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. Read the file "COPYING" for more details.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CONTACTING THE AUTHOR</h2>
        <div class="sectioncontent">

<pre>
Bruce Perens
1563 Solano Ave. #349
Berkeley, CA 94707
Telephone: 510-526-1165
Internet: bruce@perens.com
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">FILES</h2>
        <div class="sectioncontent">
<p>/dev/zero: Source of memory pages (via <a href="../man2/mmap.2.html"><strong>mmap</strong>(2)</a>).</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO libefence&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man3/malloc.3.html"><strong>malloc</strong>(3)</a>, <a href="../man2/mmap.2.html"><strong>mmap</strong>(2)</a>, <a href="../man2/mprotect.2.html"><strong>mprotect</strong>(2)</a>, <a href="../man8/swapon.8.html"><strong>swapon</strong>(8)</a></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DIAGNOSTICS</h2>
        <div class="sectioncontent">
<p>Segmentation Fault: Examine the offending statement for violation of the boundaries of a memory allocation.</p><p>Bus Error: See the section on <em>WORD-ALIGNMENT AND OVERRUN DETECTION.</em> in this manual page.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BUGS</h2>
        <div class="sectioncontent">
<p>My explanation of the alignment issue could be improved.</p><p>Some Sun systems running SunOS 4.1 were reported to signal an access to a protected page with <strong>SIGBUS</strong> rather than <strong>SIGSEGV,</strong> I suspect this is an undocumented feature of a particular Sun hardware version, not just the operating system. On these systems, eftest will fail with a bus error until you modify the Makefile to define <strong>PAGE_PROTECTION_VIOLATED_SIGNAL</strong> as <strong>SIGBUS.</strong></p><p>There are, without doubt, other bugs and porting issues. Please contact me via e-mail if you have any bug reports, ideas, etc.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">WHAT'S BETTER</h2>
        <div class="sectioncontent">
<p><em>Purify</em> does a much more thorough job than Electric Fence, and does not have the huge memory overhead. <em>Checkergcc,</em> a modified version of the GNU C Compiler that instruments all memory references, is available on Linux systems and where GCC is used. It performs some of the same tasks as Purify, but only on code that it has compiled.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="libeXosip2.3.html"><span aria-hidden="true">&larr;</span> libeXosip2.3: Libexosip2 version 4.1.0</a></li>
   <li class="next"><a href="libemu.3.html">libemu.3: Emulate x86 shellcodes <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
