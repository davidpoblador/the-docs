<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cglobals: Lcg thread-specific global variables interface</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Lcg thread-specific global variables interface">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="Cglobals (3) manual">
  <meta name="twitter:description" content="Lcg thread-specific global variables interface">
  <meta name="twitter:image" content="https://www.carta.tech/images/liblcgdm-dev-Cglobals-3.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3/Cglobals.3.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Cglobals (3) manual" />
  <meta property="og:description" content="Lcg thread-specific global variables interface" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/liblcgdm-dev-Cglobals-3.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">Cglobals<small> (3)</small></h1>
        <p class="lead">Lcg thread-specific global variables interface</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/">
      <span itemprop="name">Library calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/Cglobals.3.html">
      <span itemprop="name">Cglobals: Lcg thread-specific global variables interface</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/liblcgdm-dev/">
      <span itemprop="name">liblcgdm-dev</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/Cglobals.3.html">
      <span itemprop="name">Cglobals: Lcg thread-specific global variables interface</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>#include &lt;Cglobals.h&gt;</strong></p><p><strong>void Cglobals_init(</strong></p><p><strong>int (*</strong><em>getspec</em><strong>) (int *</strong><em>key</em><strong>, void **</strong><em>addr</em><strong>),</strong></p><p><strong>int (*</strong><em>setspec</em><strong>) (int *</strong><em>key</em><strong>, void *</strong><em>addr</em><strong>),</strong></p><p><strong>int (*</strong><em>getTid</em><strong>) (void)</strong></p><p><strong>);</strong></p><p><strong>int Cglobals_get(int *</strong><em>key</em><strong>, void **</strong><em>addr</em><strong>, size_t </strong><em>size</em><strong>);</strong></p><p><strong>void Cglobals_getTid(int *</strong><em>Tid</em><strong>);</strong></p><p><strong>int C__serrno();</strong></p><p><strong>int C__rfio_errno();</strong></p><p><strong>int C__Copterr();</strong></p><p><strong>int C__Coptind();</strong></p><p><strong>int C__Coptopt();</strong></p><p><strong>int C__Coptreset();</strong></p><p><strong>char *C__Coptarg();</strong></p><p><strong>int C__h_errno();</strong></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p><strong>Cglobals</strong> is the interface where are defined all necessary functions that always return a thread-specific value of global variables. Each package of <strong>LCG</strong> that needs to externalize thread-specific global variables contains in its header, if compiled with threads turned on (e.g. the default), a set of:</p><p>an <strong>extern</strong> definition to a function contained in Cglobals</p><p>a <strong>#define</strong> macro that replaces all occurences of any global variable that needs to be thread-specific to this Cglobal's function.</p><p>In order to satisfy packages not compiled with threads turned on, or that do not initialize <strong>LCG</strong> Thread Interface's <strong>Cthread</strong>, any such global variable is also explicitly defined in <strong>Cglobals</strong>.</p><p>For example, taking the global error variable <strong>serrno</strong>, <strong>Cglobals</strong> source code contains:</p><p>an explicit definition of this variable <strong>serrno</strong></p><p>an explicit definition, with source code, of a function <strong>C_serrno()</strong> that does only the following:</p><p>if <strong>Cglobals_init</strong> was not (successfully) called, return the address of the global variable <strong>serrno</strong></p><p>else return the address of a thread-safe specific memory, instanciated at the first call to this function, that holds the content of the current instance of the thread-specific value of <strong>serrno</strong></p><p>The following description of <strong>Cglobals_init</strong> function is explaining internals of <strong>Cglobals</strong> and <strong>Cthread</strong>. In theory no LCG application need to call <strong>Cglobals_init</strong>, you can skip if you want the following paragraphs, and concentrate only on the other functions descriptions.</p><p><strong>Cglobals_init</strong> is bundled to work with the <strong>LCG</strong> Thread Interface's <strong>Cthread</strong>. That is, any implicit or explicit call to <strong>Cthread</strong> always makes sure that <strong>Cglobals_init</strong> is called, with three arguments that are:</p><p>a <em>getspec</em> function address that, given a static <em>key</em> address, returns the address of a Thread-Specific memory into <em>addr</em> content. This uses an internal structure inside <strong>Cthread</strong>, allocated on the heap, that is associated bijectively to <em>key</em> address. <strong>Cthread</strong> always explicitly allocates such internal structure to any <em>key</em> address if it is unknown at the moment of the call to <em>getspec.</em></p><p>In such a case it will return a NULL value into <em>addr</em> , and it will be the responsability of <strong>Cglobals</strong> to allocate memory on the heap and to say to <strong>Cthread</strong> that this newly allocated memory is the one to associate with <em>key</em> address, using <em>setspec.</em></p><p>If the internal structure in <strong>Cthread</strong> associated bijectively to <em>key</em> yet exists, <em>getspec</em> only returns what it knows about the thread-specific memory associated with it, which is a <strong>void *</strong> member inside the same internal structure mentionned above.</p><p>a <em>setspec</em> function address that, given the <em>key</em> address and the <em>addr</em> value, previously instanciated with a <em>getspec</em> call, and possibly allocated on the heap by <strong>Cglobals</strong> if necessary, will internally explicitly call the Operating System Thread-Specific functions that will put the value of <em>address</em> as something thread-specific, bijectively associated to another member of the internal structure of <strong>Cthread</strong>, itself bijective to <em>key.</em></p><p>a <em>getTid</em> function address that returns an unique integer identifier associated with any thread.</p><p><strong>Cglobals_get</strong> returns in <em>addr</em> content the address of a thread-specific memory, e.g. thread-safe, that is bijectively associated with the address of a *static*, e.g. constant, address <em>key</em> , that is automatically created and filled with zeros if necessary, up to <em>size</em> bytes.</p><p>If the <em>addr</em> content, at return of <strong>Cglobals_get</strong>, is not NULL, you can safely fill this memory with any value, provided you does not exceed the <em>size</em> bytes length specified in your previous call to <strong>Cglobals_get</strong>. Because of applications that are <strong>not</strong> multi-threaded, the initial value of <em>key</em> has then an importance, that's why it is necessary to always declare it with an initial value of -1.</p><p>Return code is -1 on error, 0 on success and <strong>not</strong> the first call for this <em></em> key , 1 on success and <strong>it is</strong> the first call for this <em>key.</em> This allows to distinguish when Cglobals_get() initialize the memory with zeros (return code 1) and not (return code 0).</p><p><strong>Cglobals_getTid</strong> uses the third function address, <em>getTid</em> , given as an argument to <strong>Cglobals_init</strong>, and will return in <em>Tid</em> content the value returned by <em>getTid.</em></p><p><strong>C__serrno</strong>, <strong>C__rfio_errno</strong>, <strong>C__Copterr</strong>, <strong>C__Coptind</strong>, <strong>C__Coptopt</strong>, <strong>C__Coptreset</strong>, <strong>C__Coptarg</strong> and <strong>C__h_errno</strong> are all the internal functions that return the address of the thread-specific memory hosting the value of the 'global' variables serrno, rfio_errno, Copterr, Coptind, Coptopt, Coptreset, Coptarg and h_errno, respectively.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLE</h2>
        <div class="sectioncontent">
<p>Any application can create its own instance of thread-specific global variable using <strong>Cglobals</strong>. You need only to use <strong>Cglobals_get</strong>. Here is how to proceed.</p>
<pre>
/*
 * The following shows how to define and use a thread-specific
 * integer, my_var, inside your package
 */

#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;Cglobals.h&gt;   /* Get <strong>Cglobals_get</strong> prototype */
static int my_key = -1; /* Our static key, integer, init value -1 */
#define my_var (*C__my_var())

static int my_var_static; /* If Cglobals_get error in order not to crash */


int *C__my_var()
{
        int *var;
        /* Call Cglobals_get */
        Cglobals_get(&my_key,
                     (void **) &var,
                     sizeof(int)
                    );
        /* If error, var will be NULL */
        if (var == NULL)
        {
                fprintf(stderr,"Cglobals_get error\n");
                return(&my_var_static);
        }
        return(var);
}

int main()
{
        fprintf(stdout, "Current my_var value is: %d\n", my_var);
        fprintf(stdout, "Set my_var value to: %d\n", 12);
        my_var = 12;
        fprintf(stdout, "Current my_var value is: %d\n", my_var);
        <strong>return</strong>(0);
}

The following example is the source of the test suite for Cglobals_get():

#include &lt;Cthread_api.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;Cglobals.h&gt;   /* Get Cglobals_get prototype */
#include &lt;serrno.h&gt;

static int my_key = -1; /* Our static key, integer, init value -1 */
#define my_var (*C__my_var())

static int my_var_static; /* If Cglobals_get error in order not to crash */
void *doit _PROTO((void *));

int doit_v = 0;
#define NTHREAD 100

int *C__my_var()
{
  int *var;
  /* Call Cglobals_get */
  switch (Cglobals_get(&my_key,
                       (void **) &var,
                       sizeof(int)
                       )) {
  case -1:
    fprintf(stderr,"[%d] Cglobals_get error\n", Cthread_self());
    break;
  case 0:
    fprintf(stderr,"[%d] Cglobals_get OK\n", Cthread_self());
    break;
  case 1:
    fprintf(stderr,"[%d] Cglobals_get OK and first call\n", Cthread_self());
    break;
  default:
    fprintf(stderr,"[%d] Cglobals_get unknown return code\n", Cthread_self());
    break;
  }
  /* If error, var will be NULL */
  if (var == NULL) {
    fprintf(stderr,"[%d] Cglobals_get error : RETURN static ADDRESS!!!!!!!!!!!!\n", Cthread_self());
    return(&my_var_static);
  }
  return(var);
}

int main()
{
  int i;

  fprintf(stdout, "[%d] ---&gt; Before any Cthread call\n", -1);
  fprintf(stdout, "[%d] Current my_var value is: %d\n", -1, my_var);
  fprintf(stdout, "[%d] Set my_var value to: %d\n", -1, 12);
  my_var = 12;
  fprintf(stdout, "[%d] Current my_var value is: %d\n", -1, my_var);
  fprintf(stdout, "[%d] Testing consistency\n", -1);
  if (my_var != 12) {
    fprintf(stdout, "[%d] Cglobals_get worked ok\n", -1);
    <strong>exit</strong>(1);
  }
  <a href="../man1/sleep.1.html"><strong>sleep</strong>(1)</a>;
  for (i = 0; i &lt; NTHREAD; i++) {
    Cthread_create(&doit, &doit_v);
    doit_v++;
  }
  fprintf(stdout, "[%d] ---&gt; After all Cthread_create calls\n", -1);
  fprintf(stdout, "[%d] Current my_var value is: %d\n", -1, my_var);
  fprintf(stdout, "[%d] Set my_var value to: %d\n", -1, NTHREAD * 10000 + 12);
  my_var = NTHREAD * 10000 + 12;
  fprintf(stdout, "[%d] Current my_var value is: %d\n", -1, my_var);
  fprintf(stdout, "[%d] Testing consistency\n", -1);
  if (my_var != (NTHREAD * 10000 + 12)) {
    fprintf(stdout, "[%d] Cglobals_get worked ok\n", -1);
    <strong>exit</strong>(1);
  }
  <a href="../man1/sleep.1.html"><strong>sleep</strong>(1)</a>;
  <strong>exit</strong>(0);
}

void *doit(arg)
     void *arg;
{
  int Tid;
  int doit = * (int *) arg;
  Cglobals_getTid(&Tid);
  my_var = (Tid + 1) * 100 + 12;
  fprintf(stdout, "[%d] my_var value is: %d (should be %d)\n", Cthread_self(), my_var, (Tid + 1) * 100 + 12);
  fprintf(stdout, "[%d] second call -- my_var value is: %d (should be %d)\n", Cthread_self(), my_var, (Tid + 1) * 100 + 12);
  fprintf(stdout, "[%d] Testing consistency\n", Cthread_self());
  if (my_var != ((Tid + 1) * 100 + 12)) {
    fprintf(stdout, "[%d] !!!!!!!!! ERROR !!!!!!!!!\n", Cthread_self());
    <strong>exit</strong>(1);
  } else {
    fprintf(stdout, "[%d] Cglobals_get worked ok\n", Cthread_self());
  }
  <strong>return</strong>(0);
}




</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO Cglobals&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man3/Cthread.3.html"><strong>Cthread</strong>(3)</a>, <a href="../man3/serrno.3.html"><strong>serrno</strong>(3)</a>, <strong>Cgetopt</strong>(3)</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p><strong>LCG Grid Deployment</strong> Team</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="Callback.3.html"><span aria-hidden="true">&larr;</span> Callback.3: Define a callback function</a></li>
   <li class="next"><a href="Cgrp.3.html">Cgrp.3: Lcg group file thread-safe inferface <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
