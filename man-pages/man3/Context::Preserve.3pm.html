<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Context::Preserve: Run code after a subroutine call, preserving the context the subroutine would have seen if it were the last statement in the caller</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Run code after a subroutine call, preserving the context the subroutine would have seen if it were the last statement in the caller">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="Context::Preserve (3pm) manual">
  <meta name="twitter:description" content="Run code after a subroutine call, preserving the context the subroutine would have seen if it were the last statement in the caller">
  <meta name="twitter:image" content="https://www.carta.tech/images/libcontext-preserve-perl-Context::Preserve-3pm.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3pm/Context::Preserve.3pm.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Context::Preserve (3pm) manual" />
  <meta property="og:description" content="Run code after a subroutine call, preserving the context the subroutine would have seen if it were the last statement in the caller" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libcontext-preserve-perl-Context::Preserve-3pm.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">Context::Preserve<small> (3pm)</small></h1>
        <p class="lead">Run code after a subroutine call, preserving the context the subroutine would have seen if it were the last statement in the caller</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/">
      <span itemprop="name">MISSING SECTION</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/Context::Preserve.3pm.html">
      <span itemprop="name">Context::Preserve: Run code after a subroutine call, preserving the context the subroutine would have seen if it were the last statement in the caller</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libcontext-preserve-perl/">
      <span itemprop="name">libcontext-preserve-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/Context::Preserve.3pm.html">
      <span itemprop="name">Context::Preserve: Run code after a subroutine call, preserving the context the subroutine would have seen if it were the last statement in the caller</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p>Have you ever written this?</p>
<pre>
    my ($result, @result);

    # run a sub in the correct context
    if(!defined wantarray){
        some::code();
    }
    elsif(wantarray){
        @result = some::code();
    }
    else {
        $result = some::code();
    }

    # do something after some::code
    $_ += 42 for (@result, $result);

    # finally return the correct value
    if(!defined wantarray){
        return;
    }
    elsif(wantarray){
        return @result;
    }
    else {
        return $result;
    }
</pre>
<p>Now you can just write this instead:</p><p>  use Context::Preserve;</p><p>  return preserve_context { some::code() }              after =&gt; sub { $_ += 42 for @_ };</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>Sometimes you need to call a function, get the results, act on the results, then return the result of the function.  This is painful because of contexts; the original function can behave different if it's called in void, scalar, or list context.  You can ignore the various cases and just pick one, but that's fragile.  To do things right, you need to see which case you're being called in, and then call the function in that context.  This results in 3 code paths, which is a pain to type in (and maintain).</p><p>This module automates the process.  You provide a coderef that is the \*(L"original function\*(R", and another coderef to run after the original runs.  You can modify the return value (aliased to @_) here, and do whatever else you need to do.  \*(C`wantarray\*(C' is correct inside both coderefs; in \*(L"after\*(R", though, the return value is ignored and the value \*(C`wantarray\*(C' returns is related to the context that the original function was called in.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXPORT</h2>
        <div class="sectioncontent">
<p>\*(C`preserve_context\*(C'</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">FUNCTIONS</h2>
        <div class="sectioncontent">
<h3>preserve_context { original } [after|replace] =&gt; sub { after }</h3>
<p>Invokes \*(C`original\*(C' in the same context as \*(C`preserve_context\*(C' was called in, save the results, runs \*(C`after\*(C' in the same context, then returns the result of \*(C`original\*(C' (or \*(C`after\*(C' if \*(C`replace\*(C' is used).</p><p>If the second argument is \*(C`after\*(C', then you can modify @_ to affect the return value.  \*(C`after\*(C''s return value is ignored.</p><p>If the second argument is \*(C`replace\*(C', then modifying @_ doesn't do anything.  The return value of \*(C`after\*(C' is returned from \*(C`preserve_context\*(C' instead.</p><p>Run \*(C`preserve_context\*(C' like this:</p><p>  sub whatever {       ...       return preserve_context { orginal_function() }                  after =&gt; sub { modify @_          };   }</p><p>  or</p><p>  sub whatever {       ...       return preserve_context   { orginal_function() }                  replace =&gt; sub { return @new_return };   }</p><p>Note that there's no comma between the first block and the \*(C`after =&gt;\*(C' part.  This is how perl parses functions with the \*(C`(&@)\*(C' prototype.  The alternative is to say:</p><p>      preserve_context(sub { original }, after =&gt; sub { after });</p><p>You can pick the one you like, but I think the first version is much prettier.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR AND COPYRIGHT</h2>
        <div class="sectioncontent">
<p>Jonathan Rockway \*(C`&lt;jrockway@cpan.org&gt;\*(C'</p><p>Copyright (c) 2008 Infinity Interactive.  You may redistribute this module under the same terms as Perl itself.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="Const::Fast.3pm.html"><span aria-hidden="true">&larr;</span> Const::Fast.3pm: Facility for creating read-only scalars, arrays, and hashes</a></li>
   <li class="next"><a href="Contextual::Return.3pm.html">Contextual::Return.3pm: Create context-sensitive return values <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
