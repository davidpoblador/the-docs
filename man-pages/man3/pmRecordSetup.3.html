<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>pmRecordSetup: Record mode support for pmapi clients</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Record mode support for pmapi clients">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="pmRecordSetup (3) manual">
  <meta name="twitter:description" content="Record mode support for pmapi clients">
  <meta name="twitter:image" content="https://www.carta.tech/images/libpcp3-dev-pmRecordSetup-3.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3/pmRecordSetup.3.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="pmRecordSetup (3) manual" />
  <meta property="og:description" content="Record mode support for pmapi clients" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libpcp3-dev-pmRecordSetup-3.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">pmRecordSetup<small> (3)</small></h1>
        <p class="lead">Record mode support for pmapi clients</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/">
      <span itemprop="name">Library calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/pmRecordSetup.3.html">
      <span itemprop="name">pmRecordSetup: Record mode support for pmapi clients</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libpcp3-dev/">
      <span itemprop="name">libpcp3-dev</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/pmRecordSetup.3.html">
      <span itemprop="name">pmRecordSetup: Record mode support for pmapi clients</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">C SYNOPSIS</h2>
        <div class="sectioncontent">
<p>#include &lt;pcp/pmafm.h&gt;</p><p>FILE *pmRecordSetup(const char *<em>folio</em>, const char *<em>creator</em>, int&nbsp;<em>replay</em>);</p><p>int pmRecordAddHost(const char *<em>host</em>, int <em>isdefault</em>, pmRecordHost&nbsp;**<em>rhp</em>);</p><p>int pmRecordControl(pmRecordHost *<em>rhp</em>, int <em>request</em>, const&nbsp;char&nbsp;*<em>options</em>);</p><p>cc ... -lpcp_gui</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>These routines may be used to create a Performance Co-Pilot (PCP) archive ``on the fly'' to support ``record mode'' services for PMAPI client applications.</p><p>Each record mode ``session'' involves one or more PCP archive logs each created using a dedicated <a href="../man1/pmlogger.1.html"><strong>pmlogger</strong>(1)</a> process, with an overall Archive Folio format as understood by <a href="../man1/pmafm.1.html"><strong>pmafm</strong>(1)</a>, to name and collect all of the archive logs associated with a single recording session.</p><p>The <em>pmRecordHost</em> structure is used to maintain state information between the creator of the recording session and the associated <strong>pmlogger</strong> process(es).  The structure is defined as:</p>
<pre>
typedef struct {
    FILE   *f_config;    /* caller writes pmlogger configuration here */
    int    fd_ipc;       /* IPC channel to pmlogger */
    char   *logfile;     /* full pathname for pmlogger error logfile */
    pid_t  pid;          /* process id for pmlogger */
    int    status;       /* exit status, -1 if unknown */
} pmRecordHost;
</pre>
<p>The routines are used in combination to create a recording session as follows.</p>
<dl class='dl-vertical'>
  <dt>
    1.
  </dt>
  <dd>
    <p>Call <strong>pmRecordSetup</strong> to establish a new recording session.  A new Archive Folio will be created using the name <em>folio</em>; if the file or directory <em>folio</em> already exists, or the file <em>folio</em> cannot be created, this is an error. The application that is creating the session is identified by <em>creator</em> (most often this would be the same as the global PMAPI application name, <em>pmProgname</em>). If the application knows how to create its own configuration file to replay the recorded session, then <em>replay</em> should be non-zero.</p><p><strong>pmRecordSetup</strong> returns a <em>stdio</em> stream onto which the application should write the text of the required replay configuration file, if any.</p>
  </dd>
  <dt>
    2.
  </dt>
  <dd>
    <p>For each <em>host</em> that is to be included in the recording session, call <strong>pmRecordAddHost</strong>. A new <em>pmRecordHost</em> structure is returned via <em>rhp</em>. It is assumed that <a href="../man1/pmcd.1.html"><strong>pmcd</strong>(1)</a> is running on <em>host</em> as this is how <a href="../man1/pmlogger.1.html"><strong>pmlogger</strong>(1)</a> will retrieve the required performance metrics.</p><p>If this <em>host</em> is the default host for this recording session, then <em>isdefault</em> should be non-zero.  This will ensure that the corresponding archive appears first in the PCP archive folio, and hence the tools used to replay the archive folio will make the correct determination of the archive associated with the default host. At most one <em>host</em> per recording session may be nominated as the default host.</p><p>The calling application should write the desired <strong>pmlogger</strong> configuration onto the <em>stdio</em> stream returned via the <em>f_config</em> field in the <em>pmRecordHost</em> structure.</p>
  </dd>
  <dt>
    3.
  </dt>
  <dd>
    <p>Optionally add arguments to the command line that will be used to launch <a href="../man1/pmlogger.1.html"><strong>pmlogger</strong>(1)</a> by calling <strong>pmRecordControl</strong> with a <em>request</em> of <strong>PM_REC_SETARG</strong>. The argument is passed via <em>options</em> and one call to <strong>pmRecordControl</strong> is required for each distinct argument.</p><p>An argument may be added for a particular <strong>pmlogger</strong> instance identified by <em>rhp</em>, or if the <em>rhp</em> argument is NULL the argument is added for all <strong>pmlogger</strong> instances that will be launched in the current recording session.</p><p>Independent of any calls to <strong>pmRecordControl</strong> with a <em>request</em> of <strong>PM_REC_SETARG</strong>, each <strong>pmlogger</strong> instance will automatically be launched with the following arguments: <strong>-c</strong>, <strong>-h</strong>, <strong>-l</strong>, <strong>-x</strong> and the basename for the PCP archive log.</p>
  </dd>
  <dt>
    4.
  </dt>
  <dd>
    <p>To commence the recording session, call <strong>pmRecordControl</strong> with a <em>request</em> of <strong>PM_REC_ON</strong>, and <em>rhp</em> must be NULL. This will launch one <a href="../man1/pmlogger.1.html"><strong>pmlogger</strong>(1)</a> process for each host in the recording session, and initialize the <em>fd_ipc</em>, <em>logfile</em>, <em>pid</em> and <em>status</em> fields in the associated <em>pmRecordHost</em> structure(s).</p>
  </dd>
  <dt>
    5.
  </dt>
  <dd>
    <p>To terminate a <strong>pmlogger</strong> instance identified by <em>rhp</em>, call <strong>pmRecordControl</strong> with a <em>request</em> of <strong>PM_REC_OFF</strong>. If the <em>rhp</em> argument to <strong>pmRecordControl</strong> is NULL, the termination request is broadcast to all <strong>pmlogger</strong> processes in the current recording session.</p><p>An informative dialog is generated directly by each <strong>pmlogger</strong> process and hence note the comments on the disposition of output from <strong>pmlogger</strong> below.</p><p>Alternatively, <strong>pmlogger</strong> can be started with options to limit the duration of logging, e.g. the <strong>-T</strong> or <strong>-s</strong> arguments, in which case there is no need to call <strong>pmRecordControl</strong> with a <em>request</em> of <strong>PM_REC_OFF</strong> and no dialog is generated.</p>
  </dd>
  <dt>
    6.
  </dt>
  <dd>
    <p>To display the current status of the <strong>pmlogger</strong> instance identified by <em>rhp</em>, call <strong>pmRecordControl</strong> with a <em>request</em> of <strong>PM_REC_STATUS</strong>. If the <em>rhp</em> argument to <strong>pmRecordControl</strong> is NULL, the status request is broadcast to all <strong>pmlogger</strong> processes in the current recording session.</p><p>The display is generated directly by each <strong>pmlogger</strong> process and hence note the comments on the disposition of output from <strong>pmlogger</strong> below.</p>
  </dd>
  <dt>
    7.
  </dt>
  <dd>
    <p>To detach a <strong>pmlogger</strong> instance identified by <em>rhp</em> and allow it to continue independent of the application that launched the recording session, call <strong>pmRecordControl</strong> with a <em>request</em> of <strong>PM_REC_DETACH</strong>. If the <em>rhp</em> argument to <strong>pmRecordControl</strong> is NULL, the detach request is broadcast to all <strong>pmlogger</strong> processes in the current recording session.</p><p>An informative dialog is generated directly by each <strong>pmlogger</strong> process and hence note the comments on the disposition of output from <strong>pmlogger</strong> below.</p>
  </dd>

</dl>
<p>The calling application should not close any of the returned <em>stdio</em> streams; this will be done by <strong>pmRecordControl</strong> when recording is commenced.</p><p>Once <strong>pmlogger</strong> has been started for a recording session, then <strong>pmlogger</strong> will assume responsibility for any dialog with the user in the event that the application that launched the recording session should exit, particularly without terminating the recording session.</p><p>By default, information and dialogs from <strong>pmlogger</strong> will be displayed using <a href="../man1/pmquery.1.html"><strong>pmquery</strong>(1)</a> on the assumption that most applications wishing to launch a recording session are GUI-based.  In the event that <strong>pmquery</strong> fails to display the information (for example, because the <strong>DISPLAY</strong> environment variable is not set), <strong>pmlogger</strong> will write on its own <em>stderr</em> stream ( .B not the <em>stderr</em> stream of the launching process); the output will be assigned to the <em>XXXXXX.host.</em><strong>log</strong><em></em> file described in the FILES section below. For convenience, the full pathname to this file is provided via the <em>logfile</em> field in the <em>pmRecordHost</em> structure.</p><p>If the <em>options</em> argument to <strong>pmRecordControl</strong> is not NULL, this string may be used to pass additional arguments to <a href="../man1/pmquery.1.html"><strong>pmquery</strong>(1)</a> in those cases where a dialog is to be displayed.  One use of this capability would be to provide a <strong>-geometry</strong> string to control the placement of the dialog.</p><p>Premature termination of a launched <strong>pmlogger</strong> process may be determined using the <em>pmRecordHost</em> structure, by calling <a href="../man2/select.2.html"><strong>select</strong>(2)</a> on the <em>fd_ipc</em> field or polling the <em>status</em> field that will contain the termination status from <a href="../man2/waitpid.2.html"><strong>waitpid</strong>(2)</a> if known, else -1.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO pmRecordSetup&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man1/pmafm.1.html"><strong>pmafm</strong>(1)</a>, <a href="../man1/pmlogger.1.html"><strong>pmlogger</strong>(1)</a>, <a href="../man1/pmquery.1.html"><strong>pmquery</strong>(1)</a> and <a href="../man3/PMAPI.3.html"><strong>PMAPI</strong>(3)</a>.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">FILES</h2>
        <div class="sectioncontent">
<p>These routines create a number of files in the <strong>same directory</strong> as the <em>folio</em> file named in the call to <strong>pmRecordSetup</strong>. In all cases, the ``XXXXXX'' component is the result of calling <a href="../man3/mktemp.3.html"><strong>mktemp</strong>(3)</a>.</p>
<dl class='dl-vertical'>
  <dt>
    <p><em>XXXXXX</em></p>
  </dt>
  <dd>
    <p>If <em>replay</em> is non-zero, this is the creator's replay configuration file, else an empty control file, used to guarantee uniqueness.</p>
  </dd>
  <dt>
    <p><em>folio</em></p>
  </dt>
  <dd>
    <p>The PCP Archive Folio, suitable for use with <a href="../man1/pmafm.1.html"><strong>pmafm</strong>(1)</a>.</p>
  </dd>
  <dt>
    <p><em>XXXXXX.host.</em><strong>config</strong><em></em></p>
  </dt>
  <dd>
    <p>The <a href="../man1/pmlogger.1.html"><strong>pmlogger</strong>(1)</a> configuration for each <em>host</em> - if the same <em>host</em> is used in different calls to <strong>pmRecordAddHost</strong> within the same recording session then one of the letters ``a'' through ``z'' will be appended to the ``XXXXXX'' part of all associated file names to ensure uniqueness.</p>
  </dd>
  <dt>
    <p><em>XXXXXX.host.</em><strong>log</strong><em></em></p>
  </dt>
  <dd>
    <p><em>stdout</em> and <em>stderr</em> for the <a href="../man1/pmlogger.1.html"><strong>pmlogger</strong>(1)</a> instance for each <em>host</em>.</p>
  </dd>
  <dt>
    <p><em>XXXXXX.host.</em>{<strong>0</strong>,<strong>meta</strong>,<strong>index</strong>}</p>
  </dt>
  <dd>
    <p>The files comprising a single PCP archive for each <em>host</em>.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DIAGNOSTICS</h2>
        <div class="sectioncontent">
<p><strong>pmRecordSetup</strong> may return <strong>NULL</strong> in the event of an error. Check <em>errno</em> for the real cause, but the value <strong>EINVAL</strong> typically means that the order of calls to these routines is not correct (there is obvious state associated with the current recording session that is maintained across calls to these routines). For example the following calls would produce this <strong>EINVAL</strong> error; calling <strong>pmRecordControl</strong> before calling <strong>pmRecordAddHost</strong> at least once, or calling <strong>pmRecordAddHost</strong> before calling <strong>pmRecordSetup</strong>.</p><p><strong>pmRecordControl</strong> and <strong>pmRecordAddHost</strong> both return 0 on success, else a value less than 0 suitable for decoding with <a href="../man3/pmErrStr.3.html"><strong>pmErrStr</strong>(3)</a> on failure. The value <strong>-EINVAL</strong> has the same interpretation as <em>errno</em> being set to <strong>EINVAL</strong> as described above.</p><p><strong>pmRecordControl</strong> will return <strong>PM_ERR_IPC</strong> if the associated <strong>pmlogger</strong> process has already exited.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="pmRecordControl.3.html"><span aria-hidden="true">&larr;</span> pmRecordControl.3: Record mode support for pmapi clients</a></li>
   <li class="next"><a href="pmRegisterDerived.3.html">pmRegisterDerived.3: Register a derived metric name and definition <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
