<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>pthread_cleanup_push - push and pop thread cancellation clean-up handlers</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="${metadescription}">
  
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">pthread_cleanup_push<small> (3)</small></h1>
        <p class="lead">push and pop thread cancellation clean-up handlers</p>
      </div>

    <ol class="breadcrumb">
	<li itemscope itemtype="http://data-vocabulary.org/Breadcrumb" itemref="breadcrumb_section">
		<a itemprop="url" href="https://www.carta.tech/man-pages/"><span itemprop="title">Linux Man Pages</span></a>
	</li>
	<li id="breadcrumb_section" itemscope itemtype="http://data-vocabulary.org/Breadcrumb" itemref="breadcrumb_page" itemprop="child">
		<a itemprop="url" href="https://www.carta.tech/man-pages/man3/"><span itemprop="title">Library calls</span></a>
	</li>
	<li id="breadcrumb_page" itemscope itemtype="http://data-vocabulary.org/Breadcrumb" itemprop="child" class="active">
		<a itemprop="url" href="https://www.carta.tech/man-pages/man3/pthread_cleanup_push.3.html"><span itemprop="title">pthread_cleanup_push</span></a>
	</li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre><strong>#include &lt;pthread.h&gt;</strong>

<strong>void pthread_cleanup_push(void (*</strong><em>routine</em><strong>)(void *),</strong>
<strong>                          void *</strong><em>arg</em><strong>);</strong>
<strong>void pthread_cleanup_pop(int </strong><em>execute</em><strong>);</strong>

Compile and link with <em>-pthread</em>.</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">

<p>These functions manipulate the calling thread's stack of thread-cancellation clean-up handlers. A clean-up handler is a function that is automatically executed when a thread is canceled (or in various other circumstances described below); it might, for example, unlock a mutex so that it becomes available to other threads in the process.</p>
<p class='spacer'>

<p>The <strong>pthread_cleanup_push</strong>() function pushes <em>routine</em> onto the top of the stack of clean-up handlers. When <em>routine</em> is later invoked, it will be given <em>arg</em> as its argument.</p>
<p class='spacer'>

<p>The <strong>pthread_cleanup_pop</strong>() function removes the routine at the top of the stack of clean-up handlers, and optionally executes it if <em>execute</em> is nonzero.</p>
<p class='spacer'>

  <p>A cancellation clean-up handler is popped from the stack and executed in the following circumstances:</p>
  <dl class='dl-horizontal'>
    <dt>1.</dt>
    <dd>
  <p>When a thread is canceled, all of the stacked clean-up handlers are popped and executed in the reverse of the order in which they were pushed onto the stack.</p>
    </dd>
    <dt>2.</dt>
    <dd>
  <p>When a thread terminates by calling <a href="../man3/pthread_exit.3.html"><strong>pthread_exit</strong>(3)</a>, all clean-up handlers are executed as described in the preceding point. (Clean-up handlers are <em>not</em> called if the thread terminates by performing a <em>return</em> from the thread start function.)</p>
    </dd>
    <dt>3.</dt>
    <dd>
  <p>When a thread calls <strong>pthread_cleanup_pop</strong>() with a nonzero <em>execute</em> argument, the top-most clean-up handler is popped and executed.</p>
    </dd>
  </dl>
<p class='spacer'>

<p>POSIX.1 permits <strong>pthread_cleanup_push</strong>() and <strong>pthread_cleanup_pop</strong>() to be implemented as macros that expand to text containing &apos;<strong>{</strong>&apos; and &apos;<strong>}</strong>&apos;, respectively. For this reason, the caller must ensure that calls to these functions are paired within the same function, and at the same lexical nesting level. (In other words, a clean-up handler is established only during the execution of a specified section of code.)</p>
<p class='spacer'>

<p>Calling <a href="../man3/longjmp.3.html"><strong>longjmp</strong>(3)</a> (<a href="../man3/siglongjmp.3.html"><strong>siglongjmp</strong>(3)</a>) produces undefined results if any call has been made to <strong>pthread_cleanup_push</strong>() or <strong>pthread_cleanup_pop</strong>() without the matching call of the pair since the jump buffer was filled by <a href="../man3/setjmp.3.html"><strong>setjmp</strong>(3)</a> (<a href="../man3/sigsetjmp.3.html"><strong>sigsetjmp</strong>(3)</a>). Likewise, calling <a href="../man3/longjmp.3.html"><strong>longjmp</strong>(3)</a> (<a href="../man3/siglongjmp.3.html"><strong>siglongjmp</strong>(3)</a>) from inside a clean-up handler produces undefined results unless the jump buffer was also filled by <a href="../man3/setjmp.3.html"><strong>setjmp</strong>(3)</a> (<a href="../man3/sigsetjmp.3.html"><strong>sigsetjmp</strong>(3)</a>) inside the handler.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RETURN VALUE</h2>
        <div class="sectioncontent">

<p>These functions do not return a value.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">ERRORS</h2>
        <div class="sectioncontent">

<p>There are no errors.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">ATTRIBUTES</h2>
        <div class="sectioncontent">

<p>For an explanation of the terms used in this section, see <a href="../man7/attributes.7.html"><strong>attributes</strong>(7)</a>.</p>
<table class="table table-striped">
<tr>
<th>Interface</th>
<th>Attribute</th>
<th>Value</th></tr>

<tr>
<td><strong>pthread_cleanup_push</strong>(),   <strong>pthread_cleanup_pop</strong>()  </td>
<td>Thread safety</td>
<td>MT-Safe</td></tr>
</table>

<p class='spacer'>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CONFORMING TO</h2>
        <div class="sectioncontent">

<p>POSIX.1-2001, POSIX.1-2008.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">NOTES</h2>
        <div class="sectioncontent">

<p>On Linux, the <strong>pthread_cleanup_push</strong>() and <strong>pthread_cleanup_pop</strong>() functions <em>are</em> implemented as macros that expand to text containing &apos;<strong>{</strong>&apos; and &apos;<strong>}</strong>&apos;, respectively. This means that variables declared within the scope of paired calls to these functions will be visible within only that scope.</p>
<p class='spacer'>

<p>POSIX.1 says that the effect of using <em>return</em>, <em>break</em>, <em>continue</em>, or <em>goto</em> to prematurely leave a block bracketed <strong>pthread_cleanup_push</strong>() and <strong>pthread_cleanup_pop</strong>() is undefined. Portable applications should avoid doing this.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLE</h2>
        <div class="sectioncontent">

<p>The program below provides a simple example of the use of the functions described in this page. The program creates a thread that executes a loop bracketed by <strong>pthread_cleanup_push</strong>() and <strong>pthread_cleanup_pop</strong>(). This loop increments a global variable, <em>cnt</em>, once each second. Depending on what command-line arguments are supplied, the main thread sends the other thread a cancellation request, or sets a global variable that causes the other thread to exit its loop and terminate normally (by doing a <em>return</em>).</p>
<p class='spacer'>

<p>In the following shell session, the main thread sends a cancellation request to the other thread:</p>
<p class='spacer'>

<pre>$ <strong>./a.out</strong>
New thread started
cnt = 0
cnt = 1
Canceling thread
Called clean-up handler
Thread was canceled; cnt = 0</pre>

<p class='spacer'>

<p>From the above, we see that the thread was canceled, and that the cancellation clean-up handler was called and it reset the value of the global variable <em>cnt</em> to 0.</p>
<p class='spacer'>

<p>In the next run, the main program sets a global variable that causes other thread to terminate normally:</p>
<p class='spacer'>

<pre>$ <strong>./a.out x</strong>
New thread started
cnt = 0
cnt = 1
Thread terminated normally; cnt = 2</pre>

<p class='spacer'>

<p>From the above, we see that the clean-up handler was not executed (because <em>cleanup_pop_arg</em> was 0), and therefore the value of <em>cnt</em> was not reset.</p>
<p class='spacer'>

<p>In the next run, the main program sets a global variable that causes the other thread to terminate normally, and supplies a nonzero value for <em>cleanup_pop_arg</em>:</p>
<p class='spacer'>

<pre>$ <strong>./a.out x 1</strong>
New thread started
cnt = 0
cnt = 1
Called clean-up handler
Thread terminated normally; cnt = 0</pre>

<p class='spacer'>

<p>In the above, we see that although the thread was not canceled, the clean-up handler was executed, because the argument given to <strong>pthread_cleanup_pop</strong>() was nonzero.</p>
  <h3>Program source</h3>
  <p></p>
<pre>#include &lt;pthread.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;errno.h&gt;

#define handle_error_en(en, msg) &#92;
        do { errno = en; perror(msg); exit(EXIT_FAILURE); } while (0)

static int done = 0;
static int cleanup_pop_arg = 0;
static int cnt = 0;

static void
cleanup_handler(void *arg)
{
    printf("Called clean-up handler&#92;n");
    cnt = 0;
}

static void *
thread_start(void *arg)
{
    time_t start, curr;

    printf("New thread started&#92;n");

    pthread_cleanup_push(cleanup_handler, NULL);

    curr = start = time(NULL);

    while (!done) {
        pthread_testcancel();           /* A cancellation point */
        if (curr &lt; time(NULL)) {
            curr = time(NULL);
            printf("cnt = %d&#92;n", cnt);  /* A cancellation point */
            cnt++;
        }
    }

    pthread_cleanup_pop(cleanup_pop_arg);
    return NULL;
}

int
main(int argc, char *argv[])
{
    pthread_t thr;
    int s;
    void *res;

    s = pthread_create(&thr, NULL, thread_start, NULL);
    if (s != 0)
        handle_error_en(s, "pthread_create");

    <strong>sleep</strong>(2);           /* Allow new thread to run a while */

    if (argc &gt; 1) {
        if (argc &gt; 2)
            cleanup_pop_arg = atoi(argv[2]);
        done = 1;

    } else {
        printf("Canceling thread&#92;n");
        s = pthread_cancel(thr);
        if (s != 0)
            handle_error_en(s, "pthread_cancel");
    }

    s = pthread_join(thr, &res);
    if (s != 0)
        handle_error_en(s, "pthread_join");

    if (res == PTHREAD_CANCELED)
        printf("Thread was canceled; cnt = %d&#92;n", cnt);
    else
        printf("Thread terminated normally; cnt = %d&#92;n", cnt);
    exit(EXIT_SUCCESS);
}</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SEE ALSO</h2>
        <div class="sectioncontent">

<p><a href="../man3/pthread_cancel.3.html"><strong>pthread_cancel</strong>(3)</a>, <a href="../man3/pthread_cleanup_push_defer_np.3.html"><strong>pthread_cleanup_push_defer_np</strong>(3)</a>, <a href="../man3/pthread_setcancelstate.3.html"><strong>pthread_setcancelstate</strong>(3)</a>, <a href="../man3/pthread_testcancel.3.html"><strong>pthread_testcancel</strong>(3)</a>, <a href="../man7/pthreads.7.html"><strong>pthreads</strong>(7)</a></p>
        </div>
      </section>
<nav>
  <ul class="pager">
  <li class="previous"><a href="pthread_cleanup_pop_restore_np.3.html"><span aria-hidden="true">&larr;</span> pthread_cleanup_pop_restore_np.3: push and pop thread cancellation clean-up handlers while saving cancelability type</a></li><li class="next"><a href="pthread_cleanup_push_defer_np.3.html">pthread_cleanup_push_defer_np.3: push and pop thread cancellation clean-up handlers while saving cancelability type <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>
  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
