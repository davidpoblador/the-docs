<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LockFile::Simple: Simple file locking scheme</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Simple file locking scheme">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="LockFile::Simple (3pm) manual">
  <meta name="twitter:description" content="Simple file locking scheme">
  <meta name="twitter:image" content="https://www.carta.tech/images/liblockfile-simple-perl-LockFile::Simple-3pm.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3pm/LockFile::Simple.3pm.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="LockFile::Simple (3pm) manual" />
  <meta property="og:description" content="Simple file locking scheme" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/liblockfile-simple-perl-LockFile::Simple-3pm.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">LockFile::Simple<small> (3pm)</small></h1>
        <p class="lead">Simple file locking scheme</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/">
      <span itemprop="name">MISSING SECTION</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/LockFile::Simple.3pm.html">
      <span itemprop="name">LockFile::Simple: Simple file locking scheme</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/liblockfile-simple-perl/">
      <span itemprop="name">liblockfile-simple-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/LockFile::Simple.3pm.html">
      <span itemprop="name">LockFile::Simple: Simple file locking scheme</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
 use LockFile::Simple qw(lock trylock unlock);

 # Simple locking using default settings
 lock("/some/file") || die "can&apos;t lock /some/file&#92;n";
 warn "already locked&#92;n" unless trylock("/some/file");
 unlock("/some/file");

 # Build customized locking manager object
 $lockmgr = LockFile::Simple-&gt;make(-format =&gt; &apos;%f.lck&apos;,
        -max =&gt; 20, -delay =&gt; 1, -nfs =&gt; 1);

 $lockmgr-&gt;lock("/some/file") || die "can&apos;t lock /some/file&#92;n";
 $lockmgr-&gt;trylock("/some/file");
 $lockmgr-&gt;unlock("/some/file");

 $lockmgr-&gt;configure(-nfs =&gt; 0);

 # Using lock handles
 my $lock = $lockmgr-&gt;lock("/some/file");
 $lock-&gt;release;
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>This simple locking scheme is not based on any file locking system calls such as \*(C`flock()\*(C' or \*(C`lockf()\*(C' but rather relies on basic file system primitives and properties, such as the atomicity of the \*(C`write()\*(C' system call. It is not meant to be exempt from all race conditions, especially over \s-1NFS\s0. The algorithm used is described below in the <strong>\s-1ALGORITHM\s0</strong> section.</p><p>It is possible to customize the locking operations to attempt locking once every 5 seconds for 30 times, or delete stale locks (files that are deemed too ancient) before attempting the locking.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">ALGORITHM</h2>
        <div class="sectioncontent">
<p>The locking alogrithm attempts to create a <em>lockfile</em> using a temporarily redefined <em>umask</em> (leaving only read rights to prevent further create operations). It then writes the process \s-1ID\s0 (\s-1PID\s0) of the process and closes the file. That file is then re-opened and read. If we are able to read the same \s-1PID\s0 we wrote, and only that, we assume the locking is successful.</p><p>When locking over \s-1NFS\s0, i.e. when the one of the potentially locking processes could access the <em>lockfile</em> via \s-1NFS\s0, then writing the \s-1PID\s0 is not enough. We also write the hostname where locking is attempted to ensure the data are unique.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CUSTOMIZING</h2>
        <div class="sectioncontent">
<p>Customization is only possible by using the object-oriented interface, since the configuration parameters are stored within the object. The object creation routine \*(C`make\*(C' can be given configuration parmeters in the form a \*(L"hash table list\*(R", i.e. a list of key/value pairs. Those parameters can later be changed via \*(C`configure\*(C' by specifying a similar list of key/value pairs.</p><p>To benefit from the bareword quoting Perl offers, all the parameters must be prefixed with the \*(C`-\*(C' (minus) sign, as in \*(C`-format\*(C' for the <em>format</em> parameter..  However, when querying the object, the minus must be omitted, as in \*(C`$obj-&gt;format\*(C'.</p><p>Here are the available configuration parmeters along with their meaning, listed in alphabetical order:</p>
<dl class='dl-vertical'>
  <dt>
    <em>autoclean</em>
  </dt>
  <dd>
    <p>When true, all locks are remembered and pending ones are automatically released when the process exits normally (i.e. whenever Perl calls the \s-1END\s0 routines).</p>
  </dd>
  <dt>
    <em>delay</em>
  </dt>
  <dd>
    <p>The amount of seconds to wait between locking attempts when the file appears to be already locked. Default is 2 seconds.</p>
  </dd>
  <dt>
    <em>efunc</em>
  </dt>
  <dd>
    <p>A function pointer to dereference when an error is to be reported. By default, it redirects to the <em>logerr()</em> routine if you have Log::Agent installed, to Perl's <em>warn()</em> function otherwise. You may set it explicitly to \*(C`&#92;&LockFile::Simple::core_warn\*(C' to force the use of Perl's <em>warn()</em> function, or to \*(C`undef\*(C' to suppress logging.</p>
  </dd>
  <dt>
    <em>ext</em>
  </dt>
  <dd>
    <p>The locking extension that must be added to the file path to be locked to compute the <em>lockfile</em> path. Default is \*(C`.lock\*(C' (note that \*(C`.\*(C' is part of the extension and can therefore be changed). Ignored when <em>format</em> is also used.</p>
  </dd>
  <dt>
    <em>format</em>
  </dt>
  <dd>
    <p>Using this parmeter supersedes the <em>ext</em> parmeter. The formatting string specified is run through a rudimentary macro expansion to derive the <em>lockfile</em> path from the file to be locked. The following macros are available:     %%  A real % sign     %f  The full file path name     %D  The directory where the file resides     %F  The base name of the file     %p  The process ID (PID) The default is to use the locking extension, which itself is \*(C`.lock\*(C', so it is as if the format used was \*(C`%f.lock\*(C', but one could imagine things like \*(C`/var/run/%F.%p\*(C', i.e. the <em>lockfile</em> does not necessarily lie besides the locked file (which could even be missing). When locking, the locking format can be specified to supersede the object configuration itself.</p>
  </dd>
  <dt>
    <em>hold</em>
  </dt>
  <dd>
    <p>Maximum amount of seconds we may hold a lock. Past that amount of time, an existing <em>lockfile</em> is removed, being taken for a stale lock. Default is 3600 seconds. Specifying 0 prevents any forced unlocking.</p>
  </dd>
  <dt>
    <em>max</em>
  </dt>
  <dd>
    <p>Amount of times we retry locking when the file is busy, sleeping <em>delay</em> seconds between attempts. Defaults to 30.</p>
  </dd>
  <dt>
    <em>nfs</em>
  </dt>
  <dd>
    <p>A boolean flag, false by default. Setting it to true means we could lock over \s-1NFS\s0 and therefore the hostname must be included along with the process \s-1ID\s0 in the stamp written to the lockfile.</p>
  </dd>
  <dt>
    <em>stale</em>
  </dt>
  <dd>
    <p>A boolean flag, false by default. When set to true, we attempt to detect stale locks and break them if necessary.</p>
  </dd>
  <dt>
    <em>wafter</em>
  </dt>
  <dd>
    <p>Stands for <em>warn after</em>. It is the number of seconds past the first warning during locking time after which a new warning should be emitted. See <em>warn</em> and <em>wmin</em> below. Default is 20.</p>
  </dd>
  <dt>
    <em>warn</em>
  </dt>
  <dd>
    <p>A boolean flag, true by default. To suppress any warning, set it to false.</p>
  </dd>
  <dt>
    <em>wfunc</em>
  </dt>
  <dd>
    <p>A function pointer to dereference when a warning is to be issued. By default, it redirects to the <em>logwarn()</em> routine if you have Log::Agent installed, to Perl's <em>warn()</em> function otherwise. You may set it explicitly to \*(C`&#92;&LockFile::Simple::core_warn\*(C' to force the use of Perl's <em>warn()</em> function, or to \*(C`undef\*(C' to suppress logging.</p>
  </dd>
  <dt>
    <em>wmin</em>
  </dt>
  <dd>
    <p>The minimal amount of time when waiting for a lock after which a first warning must be emitted, if <em>warn</em> is true. After that, a warning will be emitted every <em>wafter</em> seconds. Defaults to 15.</p>
  </dd>

</dl>
<p>Each of those configuration attributes can be queried on the object directly:</p><p>    $obj = LockFile::Simple-&gt;make(-nfs =&gt; 1);     $on_nfs = $obj-&gt;nfs;</p><p>Those are pure query routines, i.e. you cannot say:</p><p>    $obj-&gt;<strong>nfs</strong>(0);                  # WRONG     $obj-&gt;configure(-nfs =&gt; 0);    # Right</p><p>to turn of the \s-1NFS\s0 attribute. That is because my \s-1OO\s0 background chokes at having querying functions with side effects.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">INTERFACE</h2>
        <div class="sectioncontent">
<p>The \s-1OO\s0 interface documented below specifies the signature and the semantics of the operations. Only the \*(C`lock\*(C', \*(C`trylock\*(C' and \*(C`unlock\*(C' operation can be imported and used via a non-OO interface, with the exact same signature nonetheless.</p><p>The interface contains all the attribute querying routines, one for each configuration parmeter documented in the <strong>\s-1CUSTOMIZING\s0</strong> section above, plus, in alphabetical order:</p>
<dl class='dl-vertical'>
  <dt>
    configure(<em>-key =&gt; value, -key2 =&gt; value2, ...</em>)
  </dt>
  <dd>
    <p>Change the specified configuration parameters and silently ignore the invalid ones.</p>
  </dd>
  <dt>
    lock(<em>file</em>, <em>format</em>)
  </dt>
  <dd>
    <p>Attempt to lock the file, using the optional locking <em>format</em> if specified, otherwise using the default <em>format</em> scheme configured in the object, or by simply appending the <em>ext</em> extension to the file. If the file is already locked, sleep <em>delay</em> seconds before retrying, repeating try/sleep at most <em>max</em> times. If warning is configured, a first warning is emitted after waiting for <em>wmin</em> seconds, and then once every <em>wafter</em> seconds, via  the <em>wfunc</em> routine. Before the first attempt, and if <em>hold</em> is non-zero, any existing <em>lockfile</em> is checked for being too old, and it is removed if found to be stale. A warning is emitted via the <em>wfunc</em> routine in that case, if allowed. Likewise, if <em>stale</em> is non-zero, a check is made to see whether any locking process is still around (only if the lock holder is on the same machine when \s-1NFS\s0 locking is configured). Should the locking process be dead, the <em>lockfile</em> is declared stale and removed. Returns a lock handle if the file has been successfully locked, which does not necessarily needs to be kept around. For instance:     $obj-&gt;lock(&apos;ppp&apos;, &apos;/var/run/ppp.%p&apos;);     &lt;do some work&gt;     $obj-&gt;unlock(&apos;ppp&apos;); or, using \s-1OO\s0 programming:     my $lock = $obj-&gt;lock(&apos;ppp&apos;, &apos;/var/run/ppp.%p&apos;) ||;         die "Can&apos;t lock for ppp&#92;n";     &lt;do some work&gt;     $lock-&gt;relase;   # The only method defined for a lock handle i.e. you don't even have to know which file was locked to release it, since there is a lock handle right there that knows enough about the lock parameters.</p>
  </dd>
  <dt>
    lockfile(<em>file</em>, <em>format</em>)
  </dt>
  <dd>
    <p>Simply compute the path of the <em>lockfile</em> that would be used by the <em>lock</em> procedure if it were passed the same parameters.</p>
  </dd>
  <dt>
    make(<em>-key =&gt; value, -key2 =&gt; value2, ...</em>)
  </dt>
  <dd>
    <p>The creation routine for the simple lock object. Returns a blessed hash reference.</p>
  </dd>
  <dt>
    trylock(<em>file</em>, <em>format</em>)
  </dt>
  <dd>
    <p>Same as <em>lock</em> except that it immediately returns false and does not sleep if the to-be-locked file is busy, i.e. already locked. Any stale locking file is removed, as <em>lock</em> would do anyway. Returns a lock hande if the file has been successfully locked.</p>
  </dd>
  <dt>
    unlock(<em>file</em>)
  </dt>
  <dd>
    <p>Unlock the <em>file</em>.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BUGS</h2>
        <div class="sectioncontent">
<p>The algorithm is not bullet proof.  It's only reasonably safe.  Don't bet the integrity of a mission-critical database on it though.</p><p>The <em>sysopen()</em> call should probably be used with the \*(C`O_EXCL|O_CREAT\*(C' flags to be on the safer side. Still, over \s-1NFS\s0, this is not an atomic operation anyway.</p><p><strong>\s-1BEWARE\s0</strong>: there is a race condition between the time we decide a lock is stale or too old and the time we unlink it. Don't use \*(C`-stale\*(C' and set \*(C`-hold\*(C' to 0 if you can't bear with that idea, but recall that this race only happens when something is already wrong. That does not make it right, nonetheless. ;-)</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Raphael Manfredi <em>&lt;Raphael_Manfredi@pobox.com&gt;</em></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO LockFile::Simple&hellip;</h2>
        <div class="sectioncontent">
<p><em>File::Flock</em>\|(3).</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="Locale::libintlFAQ.3pm.html"><span aria-hidden="true">&larr;</span> Locale::libintlFAQ.3pm: Frequently asked questions for libintl-perl</a></li>
   <li class="next"><a href="Log::Agent.3pm.html">Log::Agent.3pm: Logging agent <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
