<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CPS::Future: Represent an operation awaiting completion</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Represent an operation awaiting completion">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="CPS::Future (3pm) manual">
  <meta name="twitter:description" content="Represent an operation awaiting completion">
  <meta name="twitter:image" content="https://www.carta.tech/images/libcps-perl-CPS::Future-3pm.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3pm/CPS::Future.3pm.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="CPS::Future (3pm) manual" />
  <meta property="og:description" content="Represent an operation awaiting completion" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libcps-perl-CPS::Future-3pm.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">CPS::Future<small> (3pm)</small></h1>
        <p class="lead">Represent an operation awaiting completion</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/">
      <span itemprop="name">MISSING SECTION</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/CPS::Future.3pm.html">
      <span itemprop="name">CPS::Future: Represent an operation awaiting completion</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libcps-perl/">
      <span itemprop="name">libcps-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/CPS::Future.3pm.html">
      <span itemprop="name">CPS::Future: Represent an operation awaiting completion</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
 my $future = CPS::Future-&gt;new;
 $future-&gt;on_ready( sub {
    say "The operation is complete";
 } );

 kperform_some_operation( sub {
    $future-&gt;done( @_ );
 } );
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>An \*(C`CPS::Future\*(C' object represents an operation that is currently in progress, or has recently completed. It can be used in a variety of ways to manage the flow of control, and data, through an asynchronous program.</p><p>Some futures represent a single operation (returned by the \*(C`new\*(C' constructor), and are explicitly marked as ready by calling the \*(C`done\*(C' method. Others represent a tree of sub-tasks (returned by the \*(C`wait_all\*(C' or \*(C`needs_all\*(C' constructors), and are implicitly marked as ready when all of their component futures are ready.</p><p>It is intended that library functions that perform asynchonous operations would use \*(C`CPS::Future\*(C' objects to represent outstanding operations, and allow their calling programs to control or wait for these operations to complete. The implementation and the user of such an interface would typically make use of different methods on the class. The methods below are documented in two sections; those of interest to each side of the interface.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CONSTRUCTORS</h2>
        <div class="sectioncontent">
<p>Returns a new \*(C`CPS::Future\*(C' instance to represent a leaf future. It will be marked as ready by any of the \*(C`done\*(C', \*(C`fail\*(C', or \*(C`cancel\*(C' methods.</p><p>This constructor would primarily be used by implementations of asynchronous interfaces. Returns a new \*(C`CPS::Future\*(C' instance that will indicate it is ready once all of the sub future objects given to it indicate that they are ready.</p><p>This constructor would primarily be used by users of asynchronous interfaces. Returns a new \*(C`CPS::Future\*(C' instance that will indicate it is ready once all of the sub future objects given to it indicate that they have completed successfully, or when any of them indicates that they have failed. If any sub future fails, then this will fail immediately, and the remaining subs not yet ready will be cancelled.</p><p>This constructor would primarily be used by users of asynchronous interfaces. Returns a new \*(C`CPS::Future\*(C' instance that allows a sequence of dependent operations to be performed. Once $f1 indicates a successful completion, the code reference will be invoked and is passed one argument, being $f1. It should return a new future, $f2. Once $f2 indicates completion the combined future $future will then be marked as complete. The result of calling \*(C`get\*(C' on the combined future will return whatever was passed to the \*(C`done\*(C' method of $f2.</p><p> $f2 = $code-&gt;( $f1 )</p><p>If $f1 fails then $future will indicate this failure immediately and the block of code will not be invoked.</p><p>If $future is cancelled before $f1 completes, then $f1 will be cancelled. If it is cancelled after completion then $f2 is cancelled instead. Returns a new \*(C`CPS::Future\*(C' instance that wraps the one given as $f1. With no arguments this will be a trivial wrapper; $future will complete or fail when $f1 does, and $f1 will be cancelled when $future is.</p><p>By passing the following named argmuents, the returned $future can be made to behave differently to $f1:</p>
<dl class='dl-vertical'>
  <dt>
    done =&gt; \s-1CODE\s0
  </dt>
  <dd>
    <p>Provides a function to use to modify the result of a successful completion. When $f1 completes successfully, the result of its \*(C`get\*(C' method is passed into this function, and whatever it returns is passed to the \*(C`done\*(C' method of $future</p>
  </dd>
  <dt>
    fail =&gt; \s-1CODE\s0
  </dt>
  <dd>
    <p>Provides a function to use to modify the result of a failure. When $f1 fails, the result of its \*(C`failure\*(C' method is passed into this function, and whatever it returns is passed to the \*(C`fail\*(C' method of $future.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">IMPLEMENTATION METHODS</h2>
        <div class="sectioncontent">
<p>These methods would primarily be used by implementations of asynchronous interfaces. Marks that the leaf future is now ready, and provides a list of values as a result. (The empty list is allowed, and still indicates the future as ready). Cannot be called on a non-leaf future.</p><p>Returns the $future. This method is used to overload the calling operator, so simply invoking the future object itself as if it were a \*(C`CODE\*(C' reference is equivalent to calling the \*(C`done\*(C' method. This makes it simple to pass as a callback function to other code.</p><p>It turns out however, that this behaviour is too subtle and can lead to bugs when futures are accidentally used as plain \*(C`CODE\*(C' references. See the \*(C`done_cb\*(C' method instead. This overload behaviour will be removed in a later version. Returns a \*(C`CODE\*(C' reference that, when invoked, calls the \*(C`done\*(C' method. This makes it simple to pass as a callback function to other code. Marks that the leaf future has failed, and provides an exception value. This exception will be thrown by the \*(C`get\*(C' method if called. If the exception is a non-reference that does not end in a linefeed, its value will be extended by the file and line number of the caller, similar to the logic that \*(C`die\*(C' uses.</p><p>The exception must evaluate as a true value; false exceptions are not allowed. Further details may be provided that will be returned by the \*(C`failure\*(C' method in list context. These details will not be part of the exception string raised by \*(C`get\*(C'.</p><p>Returns the $future. Returns a \*(C`CODE\*(C' reference that, when invoked, calls the \*(C`fail\*(C' method. This makes it simple to pass as a callback function to other code. If the future is not yet ready, adds a callback to be invoked if the future is cancelled by the \*(C`cancel\*(C' method. If the future is already ready, throws an exception.</p><p>If the future is cancelled, the callbacks will be invoked in the reverse order to that in which they were registered.</p><p> $on_cancel-&gt;( $future ) If passed another \*(C`CPS::Future\*(C' instance, the passed instance will be cancelled when the original future is cancelled. Returns true if the future has been cancelled by \*(C`cancel\*(C'.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">USER METHODS</h2>
        <div class="sectioncontent">
<p>These methods would primarily be used by users of asynchronous interfaces, on objects returned by such an interface. Returns true on a leaf future if a result has been provided to the \*(C`done\*(C' method, failed using the \*(C`fail\*(C' method, or cancelled using the \*(C`cancel\*(C' method.</p><p>Returns true on a \*(C`wait_all\*(C' future if all the sub-tasks are ready.</p><p>Returns true on a \*(C`needs_all\*(C' future if all the sub-tasks have completed successfully or if any of them have failed. If the future is not yet ready, adds a callback to be invoked when the future is ready. If the future is already ready, invokes it immediately.</p><p>In either case, the callback will be passed the future object itself. The invoked code can then obtain the list of results by calling the \*(C`get\*(C' method.</p><p> $on_ready-&gt;( $future )</p><p>Returns the $future. If passed another \*(C`CPS::Future\*(C' instance, the passed instance will have its \*(C`done\*(C' or \*(C`fail\*(C' methods invoked when the original future completes successfully or fails respectively. If the future is ready, returns the list of results that had earlier been given to the \*(C`done\*(C' method. If not, will raise an exception.</p><p>If called on a \*(C`wait_all\*(C' or \*(C`needs_all\*(C' future, it will return a list of the futures it was waiting on, in the order they were passed to the constructor. If the future is not yet ready, adds a callback to be invoked when the future is ready, if it completes successfully. If the future completed successfully, invokes it immediately. If it failed or was cancelled, it is not invoked at all.</p><p>The callback will be passed the result passed to the \*(C`done\*(C' method.</p><p> $on_done-&gt;( @result )</p><p>Returns the $future. If passed another \*(C`CPS::Future\*(C' instance, the passed instance will have its \*(C`done\*(C' method invoked when the original future completes successfully. Returns the exception passed to the \*(C`fail\*(C' method, \*(C`undef\*(C' if the future completed successfully via the \*(C`done\*(C' method, or raises an exception if called on a future that is not yet ready.</p><p>If called in list context, will additionally yield a list of the details provided to the \*(C`fail\*(C' method.</p><p>Because the exception value must be true, this can be used in a simple \*(C`if\*(C' statement:</p><p> if( my $exception = $future-&gt;failure ) {     ...  }  else {     my @result = $future-&gt;get;     ...  } If the future is not yet ready, adds a callback to be invoked when the future is ready, if it fails. If the future has already failed, invokes it immediately. If it completed successfully or was cancelled, it is not invoked at all.</p><p>The callback will be passed the exception and details passed to the \*(C`fail\*(C' method.</p><p> $on_fail-&gt;( $exception, @details )</p><p>Returns the $future. If passed another \*(C`CPS::Future\*(C' instance, the passed instance will have its \*(C`fail\*(C' method invoked when the original future fails.</p><p>To invoke a \*(C`done\*(C' method on a future when another one fails, use a \s-1CODE\s0 reference:</p><p> $future-&gt;on_fail( sub { $f-&gt;done( @_ ) } ); Requests that the future be cancelled, immediately marking it as ready. This will invoke all of the code blocks registered by \*(C`on_cancel\*(C', in the reverse order. When called on a non-leaf future, all its sub-tasks are also cancelled. Returns a \*(C`CODE\*(C' reference that, when invoked, calls the \*(C`cancel\*(C' method. This makes it simple to pass as a callback function to other code.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLES</h2>
        <div class="sectioncontent">
<p>The following examples all demonstrate possible uses of a \*(C`CPS::Future\*(C' object to provide a fictional asynchronous \s-1API\s0 function called simply \*(C`koperation\*(C'.</p><h3>Providing Results</h3>
<p>By returning a new \*(C`CPS::Future\*(C' object each time the asynchronous function is called, it provides a placeholder for its eventual result, and a way to indicate when it is complete.</p><p> sub foperation  {     my %args = @_;</p><p>    my $future = CPS::Future-&gt;new;</p><p>    kdo_something(        foo =&gt; $args{foo},        on_done =&gt; sub { $future-&gt;done( @_ ); },     );</p><p>    return $future;  }</p><p>In most cases, the \*(C`done\*(C' method will simply be invoked with the entire result list as its arguments. In that case, it is simpler to pass the $future object itself as if it was a \*(C`CODE\*(C' reference; this will invoke the \*(C`done\*(C' method.</p><p>    my $future = CPS::Future-&gt;new;</p><p>    kdo_something(        foo =&gt; $args{foo},        on_done =&gt; $future,     );</p><p>The caller may then use this future to wait for a result using the \*(C`on_ready\*(C' method, and obtain the result using \*(C`get\*(C'.</p><p> my $f = foperation( foo =&gt; "something" );</p><p> $f-&gt;on_ready( sub {     my $f = shift;     say "The operation returned: ", $f-&gt;get;  } );</p>
<h3>Indicating Success or Failure</h3>
<p>Because the stored exception value of a failued \*(C`CPS::Future\*(C' may not be false, the \*(C`failure\*(C' method can be used in a conditional statement to detect success or failure.</p><p> my $f = koperation( foo =&gt; "something" );</p><p> $f-&gt;on_ready( sub {     my $f = shift;     if( not my $e = $f-&gt;failure ) {        say "The operation succeeded with: ", $f-&gt;get;     }     else {        say "The operation failed with: ", $e;     }  } );</p><p>By using \*(C`not\*(C' in the condition, the order of the \*(C`if\*(C' blocks can be arranged to put the successful case first, similar to a \*(C`try\*(C'/\*(C`catch\*(C' block.</p><p>Because the \*(C`get\*(C' method re-raises the passed exception if the future failed, it can be used to control a \*(C`try\*(C'/\*(C`catch\*(C' block directly. (This is sometimes called <em>Exception Hoisting</em>).</p><p> use Try::Tiny;</p><p> $f-&gt;on_ready( sub {     my $f = shift;     try {        say "The operation succeeded with: ", $f-&gt;get;     }     catch {        say "The operation failed with: ", $_;     };  } );</p>
<h3>Merging Control Flow</h3>
<p>A \*(C`wait_all\*(C' future may be used to resynchronise control flow, while waiting for multiple concurrent operations to finish.</p><p> my $f1 = koperation( foo =&gt; "something" );  my $f2 = koperation( bar =&gt; "something else" );</p><p> my $f = CPS::Future-&gt;wait_all( $f1, $f2 );</p><p> $f-&gt;on_ready( sub {     say "Operations are ready:";     say "  foo: ", $f1-&gt;get;     say "  bar: ", $f2-&gt;get;  } );</p><p>This provides an ability somewhat similar to \*(C`CPS::kpar()\*(C' or Async::MergePoint.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">TODO</h2>
        <div class="sectioncontent">
<p>Lots of things still need adding. \s-1API\s0 or semantics is somewhat unclear in places.</p><ul>
<li><p>\*(C`CPS::Future-&gt;needs_first\*(C', which succeeds on the first success of dependent futures and cancels the outstanding ones, only fails if all the dependents do.</p></li><li><p>Some way to do deferred futures that don't even start their operation until invoked somehow. Ability to chain these together in a sequence, like \*(C`CPS::kseq()\*(C'.</p></li>
</ul>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Paul Evans &lt;leonerd@leonerd.org.uk&gt;</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="CPS::Functional.3pm.html"><span aria-hidden="true">&larr;</span> CPS::Functional.3pm: Functional utilities in continuation-passing style</a></li>
   <li class="next"><a href="CPS::Governor.3pm.html">CPS::Governor.3pm: Control the iteration of the "cps" functions <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
