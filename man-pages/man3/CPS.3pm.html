<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CPS: Manage flow of control in continuation-passing style</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Manage flow of control in continuation-passing style">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="CPS (3pm) manual">
  <meta name="twitter:description" content="Manage flow of control in continuation-passing style">
  <meta name="twitter:image" content="https://www.carta.tech/images/libcps-perl-CPS-3pm.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3pm/CPS.3pm.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="CPS (3pm) manual" />
  <meta property="og:description" content="Manage flow of control in continuation-passing style" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libcps-perl-CPS-3pm.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">CPS<small> (3pm)</small></h1>
        <p class="lead">Manage flow of control in continuation-passing style</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/">
      <span itemprop="name">MISSING SECTION</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/CPS.3pm.html">
      <span itemprop="name">CPS: Manage flow of control in continuation-passing style</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libcps-perl/">
      <span itemprop="name">libcps-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/CPS.3pm.html">
      <span itemprop="name">CPS: Manage flow of control in continuation-passing style</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">OVERVIEW</h2>
        <div class="sectioncontent">
<p>The functions in this module implement or assist the writing of programs, or parts of them, in Continuation Passing Style (\s-1CPS\s0). Briefly, \s-1CPS\s0 is a style of writing code where the normal call/return mechanism is replaced by explicit \*(L"continuations\*(R", values passed in to functions which they should invoke, to implement return behaviour. For more detail on \s-1CPS\s0, see the \s-1SEE\s0 \s-1ALSO\s0 section.</p><p>What this module implements is not in fact true \s-1CPS\s0, as Perl does not natively support the idea of a real continuation (such as is created by a co-routine). Furthermore, for \s-1CPS\s0 to be efficient in languages that natively support it, their runtimes typically implement a lot of optimisation of \s-1CPS\s0 code, which the Perl interpreter would be unable to perform. Instead, \s-1CODE\s0 references are passed around to stand in their place. While not particularly useful for most regular cases, this becomes very useful whenever some form of asynchronous or event-based programming is being used. Continuations passed in to the body function of a control structure can be stored in the event handlers of the asynchronous or event-driven framework, so that when they are invoked later, the code continues, eventually arriving at its final answer at some point in the future.</p><p>In order for these examples to make sense, a fictional and simple asynchronisation framework has been invented. The exact details of operation should not be important, as it simply stands to illustrate the point. I hope its general intention should be obvious. :)</p>
<pre>
 read_stdin_line( &#92;&on_line ); # wait on a line from STDIN, then pass it
                               # to the handler function
</pre>
<p>This module itself provides functions that manage the flow of control through a continuation passing program. They do not directly facilitate the flow of data through a program. That can be managed by lexical variables captured by the closures passed around. See the \s-1EXAMPLES\s0 section.</p><p>For \s-1CPS\s0 versions of data-flow functionals, such as \*(C`map\*(C' and \*(C`grep\*(C', see also CPS::Functional. For backward compatibility with previous versions, the functions in \*(C`CPS::Functional\*(C' are also exported here; and \*(C`kunfold\*(C' is renamed to \*(C`kgenerate\*(C'. This may be removed in a later version.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p> use CPS qw( kloop );</p><p> kloop( sub {     my ( $knext, $klast ) = @_;</p><p>    print "Enter a number, or q to quit: ";</p><p>    read_stdin_line( sub {        my ( $first ) = @_;        chomp $first;</p><p>       return $klast-&gt;() if $first eq "q";</p><p>       print "Enter a second number: ";</p><p>       read_stdin_line( sub {           my ( $second ) = @_;</p><p>          print "The sum is " . ( $first + $second ) . "&#92;n";</p><p>          $knext-&gt;();        } );     } );  },  sub { exit }  );</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">FUNCTIONS</h2>
        <div class="sectioncontent">
<p>In all of the following functions, the \*(C`&#92;&body\*(C' function can provide results by invoking its continuation / one of its continuations, either synchronously or asynchronously at some point later (via some event handling or other mechanism); the next invocation of \*(C`&#92;&body\*(C' will not take place until the previous one exits if it is done synchronously.</p><p>They all take the prefix \*(C`k\*(C' before the name of the regular perl keyword or function they aim to replace. It is common in \s-1CPS\s0 code in other languages, such as Scheme or Haskell, to store a continuation in a variable called \*(C`k\*(C'. This convention is followed here. \s-1CPS\s0 version of perl's \*(C`while(true)\*(C' loop. Repeatedly calls the \*(C`body\*(C' code until it indicates the end of the loop, then invoke $k.</p><p> $body-&gt;( $knext, $klast )     $knext-&gt;()     $klast-&gt;()</p><p> $k-&gt;()</p><p>If $knext is invoked, the body will be called again. If $klast is invoked, the continuation $k is invoked. Compatibility synonym for \*(C`kloop\*(C'; it was renamed after version 0.10. New code should use \*(C`kloop\*(C' instead. \s-1CPS\s0 version of perl's \*(C`foreach\*(C' loop. Calls the \*(C`body\*(C' code once for each element in @items, until either the items are exhausted or the \*(C`body\*(C' invokes its $klast continuation, then invoke $k.</p><p> $body-&gt;( $item, $knext, $klast )     $knext-&gt;()     $klast-&gt;()</p><p> $k-&gt;() \s-1CPS\s0 version of recursive descent on a tree-like structure, defined by a function, \*(C`body\*(C', which when given a node in the tree, yields a list of child nodes.</p><p> $body-&gt;( $node, $kmore )     $kmore-&gt;( @child_nodes )</p><p> $k-&gt;()</p><p>The first value to be passed into \*(C`body\*(C' is $root.</p><p>At each iteration, a node is given to the \*(C`body\*(C' function, and it is expected to pass a list of child nodes into its $kmore continuation. These will then be iterated over, in the order given. The tree-like structure is visited depth-first, descending fully into one subtree of a node before moving on to the next.</p><p>This function does not provide a way for the body to accumulate a resultant data structure to pass into its own continuation. The body is executed simply for its side-effects and its continuation is invoked with no arguments. A variable of some sort should be shared between the body and the continuation if this is required. A breadth-first variation of \*(C`kdescendd\*(C'. This function visits each child node of the parent, before iterating over all of these nodes's children, recursively until the bottom of the tree. This \s-1CPS\s0 function takes a list of function bodies and calls them all immediately. Each is given its own continuation. Once every body has invoked its continuation, the main continuation $k is invoked.</p><p> $body-&gt;( $kdone )    $kdone-&gt;()</p><p> $k-&gt;()</p><p>This allows running multiple operations in parallel, and waiting for them all to complete before continuing. It provides in a \s-1CPS\s0 form functionality similar to that provided in a more object-oriented fashion by modules such as Async::MergePoint or Event::Join. This \s-1CPS\s0 function takes a list of items and a function body, and calls the body immediately once for each item in the list. Each invocation is given its own continuation. Once every body has invoked its continuation, the main continuation $k is invoked.</p><p> $body-&gt;( $item, $kdone )    $kdone-&gt;()</p><p> $k-&gt;()</p><p>This is similar to \*(C`kforeach\*(C', except that the body is started concurrently for all items in the list list, rather than each item waiting for the previous to finish. This \s-1CPS\s0 function takes a list of function bodies and calls them each, one at a time in sequence. Each is given a continuation to invoke, which will cause the next body to be invoked. When the last body has invoked its continuation, the main continuation $k is invoked.</p><p> $body-&gt;( $kdone )    $kdone-&gt;()</p><p> $k-&gt;()</p><p>A benefit of this is that it allows a long operation that uses many continuation \*(L"pauses\*(R", to be written without code indenting further and further to the right. Another is that it allows easy skipping of conditional parts of a computation, which would otherwise be tricky to write in a \s-1CPS\s0 form. See the \s-1EXAMPLES\s0 section.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">GOVERNORS</h2>
        <div class="sectioncontent">
<p>All of the above functions are implemented using a loop which repeatedly calls the body function until some terminating condition. By controlling the way this loop re-invokes itself, a program can control the behaviour of the functions.</p><p>For every one of the above functions, there also exists a variant which takes a CPS::Governor object as its first argument. These functions use the governor object to control their iteration.</p><p> kloop( &#92;&body, $k )  gkloop( $gov, &#92;&body, $k )</p><p> kforeach( &#92;@items, &#92;&body, $k )  gkforeach( $gov, &#92;@items, &#92;&body, $k )</p><p> etc...</p><p>In this way, other governor objects can be constructed which have different running properties; such as interleaving iterations of their loop with other \s-1IO\s0 activity in an event-driven framework, or giving rate-limitation control on the speed of iteration of the loop.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CPS UTILITIES</h2>
        <div class="sectioncontent">
<p>These function names do not begin with \*(C`k\*(C' because they are not themselves \s-1CPS\s0 primatives, but may be useful in CPS-oriented code. Returns a new \s-1CODE\s0 reference to a CPS-wrapped version of the code block or passed \s-1CODE\s0 reference. When $kfunc is invoked, the function &func is called in list context, being passed all the arguments given to $kfunc apart from the last, expected to be its continuation. When &func returns, the result is passed into the continuation.</p><p> $kfunc-&gt;( @func_args, $k )     $k-&gt;( @func_ret )</p><p>The following are equivalent</p><p> print func( 1, 2, 3 );</p><p> my $kfunc = liftk( &#92;&func );  $kfunc-&gt;( 1, 2, 3, sub { print @_ } );</p><p>Note that the returned wrapper function only has one continuation slot in its arguments. It therefore cannot be used as the body for \*(C`kloop()\*(C', \*(C`kforeach()\*(C' or \*(C`kgenerate()\*(C', because these pass two continuations. There does not exist a \*(L"natural\*(R" way to lift a normal call/return function into a \s-1CPS\s0 function which requires more than one continuation, because there is no way to distinguish the different named returns. Returns a new \s-1CODE\s0 reference to a plain call/return version of the passed CPS-style \s-1CODE\s0 reference. When the returned (\*(L"dropped\*(R") function is called, it invokes the passed \s-1CPS\s0 function, then waits for it to invoke its continuation. When it does, the list that was passed to the continuation is returned by the dropped function. If called in scalar context, only the first value in the list is returned.</p><p> $kfunc-&gt;( @func_args, $k )     $k-&gt;( @func_ret )</p><p> $waitfunc-&gt;()</p><p> @func_ret = $func-&gt;( @func_args )</p><p>Given the following trivial \s-1CPS\s0 function:</p><p> $kadd = sub { $_[2]-&gt;( $_[0] + $_[1] ) };</p><p>The following are equivalent</p><p> $kadd-&gt;( 10, 20, sub { print "The total is $_[0]&#92;n" } );</p><p> $add = dropk { } $kadd;  print "The total is ".$add-&gt;( 10, 20 )."&#92;n";</p><p>In the general case the \s-1CPS\s0 function hasn't yet invoked its continuation by the time it returns (such as would be the case when using any sort of asynchronisation or event-driven framework). For \*(C`dropk\*(C' to actually work in this situation, it requires a way to run the event framework, to cause it to process events until the continuation has been invoked.</p><p>This is provided by the block, or the first passed \s-1CODE\s0 reference. When the returned function is invoked, it repeatedly calls the block or wait function, until the \s-1CPS\s0 function has invoked its continuation.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXAMPLES</h2>
        <div class="sectioncontent">
<h3>Returning Data From Functions</h3>
<p>No facilities are provided directly to return data from \s-1CPS\s0 body functions in \*(C`kloop\*(C', \*(C`kpar\*(C' and \*(C`kseq\*(C'. Instead, normal lexical variable capture may be used here.</p><p> my $bat;  my $ball;</p><p> kpar(     sub {        my ( $k ) = @_;        get_bat( on_bat =&gt; sub { $bat = shift; goto &$k } );     },     sub {        my ( $k ) = @_;        serve_ball( on_ball =&gt; sub { $ball = shift; goto &$k } );     },</p><p>    sub {        $bat-&gt;hit( $ball );     },  );</p><p>The body function can set the value of a variable that it and its final continuation both capture. Consider the call/return style of code</p><p> A();  if( $maybe ) {     B();  }  C();</p><p>We cannot easily write this in \s-1CPS\s0 form without naming C twice</p><p> kA( sub {     $maybe ?        kB( sub { kC() } ) :        kC();  } );</p><p>While not so problematic here, it could get awkward if C were in fact a large code block, or if more than a single conditional were employed in the logic; a likely scenario. A further issue is that the logical structure becomes much harder to read.</p><p>Using \*(C`kseq\*(C' allows us to name the continuation so each arm of \*(C`kmaybe\*(C' can invoke it indirectly.</p><p> kseq(     &#92;&kA,     sub { my $k = shift; $maybe ? kB( $k ) : goto &$k; },     &#92;&kC  );</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO CPS&hellip;</h2>
        <div class="sectioncontent">
<ul>
<li><p>CPS::Functional - functional utilities in Continuation-Passing Style</p></li><li><p>http://en.wikipedia.org/wiki/Continuation-passing_style &lt;http://en.wikipedia.org/wiki/Continuation-passing_style&gt; on wikipedia</p></li><li><p>Coro - co-routines in Perl</p></li>
</ul>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">ACKNOWLEDGEMENTS</h2>
        <div class="sectioncontent">
<p>Matt S. Trout (mst) &lt;mst@shadowcat.co.uk&gt; - for the inspiration of \*(C`kpareach\*(C' and with apologies to for naming of the said. ;)</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Paul Evans &lt;leonerd@leonerd.org.uk&gt;</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="CPANDB::Ticket.3pm.html"><span aria-hidden="true">&larr;</span> CPANDB::Ticket.3pm: Cpandb class for the ticket table</a></li>
   <li class="next"><a href="CPS::Functional.3pm.html">CPS::Functional.3pm: Functional utilities in continuation-passing style <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
