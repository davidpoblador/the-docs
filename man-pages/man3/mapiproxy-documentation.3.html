<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>mapiproxy-documentation: </title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="mapiproxy-documentation (3) manual">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="https://www.carta.tech/images/libmapi-dev-mapiproxy-documentation-3.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3/mapiproxy-documentation.3.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="mapiproxy-documentation (3) manual" />
  <meta property="og:description" content="" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libmapi-dev-mapiproxy-documentation-3.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">mapiproxy-documentation<small> (3)</small></h1>
        <p class="lead"></p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/">
      <span itemprop="name">Library calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/mapiproxy-documentation.3.html">
      <span itemprop="name">mapiproxy-documentation: </span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libmapi-dev/">
      <span itemprop="name">libmapi-dev</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/mapiproxy-documentation.3.html">
      <span itemprop="name">mapiproxy-documentation: </span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">Contents</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    *
  </dt>
  <dd>
    <p>Revision History </p>
  </dd>
  <dt>
    *
  </dt>
  <dd>
    <p>1. Introduction </p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>1.1. Purpose and Scope</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>1.2. General Overview</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>1.3. Bugs and Limitations </p>
  </dd>

</dl>

<dl class='dl-vertical'>
  <dt>
    *
  </dt>
  <dd>
    <p>2. Installation</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>2.1. Download MAPIProxy</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>2.2. Samba4 installation</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>2.3. MAPIProxy installation</p>
  </dd>

</dl>

<dl class='dl-vertical'>
  <dt>
    *
  </dt>
  <dd>
    <p>3. Configuration</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>3.1. 5-Minute Configuration</p>
  </dd>

</dl>

<dl class='dl-vertical'>
  <dt>
    *
  </dt>
  <dd>
    <p>4. Technical Concepts</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>4.1. NSPI Bindings Replacement</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>4.2. NSPI Referral FQDN Replacement</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>4.3. Force EMSMDB Protocol Version</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>4.4. OpenChange IDL file</p>
  </dd>

</dl>

<dl class='dl-vertical'>
  <dt>
    *
  </dt>
  <dd>
    <p>5. Stackable Modules </p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>5.1. General Overview</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>5.2. Module entry point</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>5.3. Module Hooks</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>5.4. mapiproxy structure</p>
  </dd>

</dl>

<dl class='dl-vertical'>
  <dt>
    *
  </dt>
  <dd>
    <p>6. Available Modules </p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>6.1. Downgrade Module</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>6.2. Pack Module</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>6.3. Cache Module</p>
  </dd>

</dl>

<dl class='dl-vertical'>
  <dt>
    *
  </dt>
  <dd>
    <p>7. Server Mode </p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>7.1. 5-Minute Configuration</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>7.2. General Overview </p>
  </dd>

</dl>

<dl class='dl-vertical'>
  <dt>
    *
  </dt>
  <dd>
    <p>8. Frequently Asked Questions</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>8.1. The action could not be completed</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>8.2. Profile creation goes fine, but Outlook can't open your default e-mail folders</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>8.3. Does MAPIProxy need to be domain controller?</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>8.4. Generating Samba's private keys takes infinite time</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>8.5. On Ubuntu <em>make samba-git</em> exits with <em>gmake: not found</em><em></em></p>
  </dd>

</dl>
<h3>Revision History</h3>
<p><strong>Date</strong> <strong>Revision Number</strong> <strong>Author</strong> <strong>Revision Content</strong>  27/11/2010 <strong>0.6.3</strong> Brad Hards Fix tracker link and a couple of typos.  03/03/09 <strong>0.6.2</strong> Julien Kerihuel Add configuration info for server mode.  01/02/09 <strong>0.6.1</strong> Julien Kerihuel Add configuration info for server mode.  04/01/09 <strong>0.6</strong> Julien Kerihuel server mode documented, update mapiproxy naming to MAPIProxy.  29/12/08 <strong>0.5.5</strong> Julien Kerihuel Add 3 new questions to FAQ section  09/12/08 <strong>0.5.4</strong> Julien Kerihuel Add dcesrv:assoc group checking to smb.conf configuration requirements  10/07/08 <strong>0.5.3</strong> Julien Kerihuel Rename smbd process to samba session API and update documentation  08/26/08 <strong>0.5.2</strong> Julien Kerihuel documentation update on NSPI replacement and new FAQ question added  08/26/08 <strong>0.5.1</strong> Julien Kerihuel documentation on NSPI referral added  08/11/08 <strong>0.5</strong> Julien Kerihuel unbind hook added, cache module documentation and scenario added   07/23/08 <strong>0.4</strong> Julien Kerihuel MAPIProxy API hooks, IDL update, mapiproxy structure description and documentation added for the cache module  06/25/08 <strong>0.3.2</strong> Julien Kerihuel Minor installation update  06/04/08 <strong>0.3.1</strong> Brad Hards Minor edits  05/27/08 <strong>0.3</strong> Julien Kerihuel Available modules section added  05/24/08 <strong>0.2</strong> Julien Kerihuel EMSMDB protocol version subsection updated, modules system section added, 5-minute configuration updated  05/15/08 <strong>0.1</strong> Julien Kerihuel Initial Revision</p>
<h3>1. Introduction</h3>

<h3>1.1. Purpose and Scope</h3>
<p>MAPIProxy is an endpoint server for Samba4 which proxies ExchangeRPC traffic from MAPI clients (Outlook, openchangeclient, etc.) to Microsoft Exchange Server (and back). It can either act as a transparent proxy, for hacking, monitoring or debugging purposes or modify traffic on the fly and so provide new features. It is primarily developed for - but not limited to - third-party implementors looking for a development framework they can use for MAPI acceleration purposes.</p><p>This project is originally based on dcerpc_remote.c code from Stefan Metzemacher (Samba4 trunk) and is released under GPLv3 or later. It creates a dynamic shared object file which is loaded into samba and uses the Samba configuration file (smb.conf) to set common options.</p>
<h3>1.2. General overview</h3>

<pre>
   Figure 1. General MAPIProxy network overview
</pre>
<p>The MAPIProxy traffic can be divided into 3 different parts as described in the figure above:</p><ul>
<li><p><strong>[1] clients to MAPIProxy:</strong></p><p>The origin of a client connect does not have much importance: it can either be an incoming connection from a real MAPI client, a connection relayed from another third-party proxy or another MAPIProxy instance. MAPIProxy runs as an endpoint server registered when samba starts. When the Samba4 endpoint mapper receives an incoming connection asking for one of the ExchangeRPC endpoints: NSPI (Name Service Provider Interface - Address Book) or EMSMDB (Exchange Message Store), the endpoint mapper redirects ExchangeRPC traffic to MAPIProxy which will pull, push and dispatch MAPI operations.</p></li>
</ul><ul>
<li><p><strong>[2] MAPIProxy to MAPIProxy:</strong></p><p>The main objective of MAPIProxy is not to directly connect to the remote message server, but rather to relay some kind of modified MAPI traffic to the next MAPIProxy hop. This configuration can be used to add a compression layer between MAPIProxy instances, or to send specific third-party vendor information. However, a proxied connection directly from a MAPI client to an Exchange server (i.e. <em>client-MAPIProxy-server</em> is possible and such a configuration could be used for many other purposes.</p></li>
</ul><ul>
<li><p><strong>[3] MAPIProxy to server:</strong></p><p>This last node is responsible for restoring MAPI contents and pushing it to the real Exchange server.</p></li>
</ul>
<h3>1.3. Bugs and Limitations</h3>
<p>If you find bugs, limitations or have features you would like to see included in MAPIProxy, please register on the OpenChange Tracker System and create new tickets.</p>
<h3>2. Installation</h3>

<h3>2.1. Download MAPIProxy</h3>
<p>MAPIProxy is only available through SVN at the moment. A tarball release will only be made when we have a stabilized API with a preliminary set of useful features. You will need a SVN client to download openchange (including MAPIProxy).</p>
<pre>
$ svn co https://svn.openchange.org/openchange/trunk openchange
</pre>

<h3>2.2. Samba4 installation</h3>
<p>The MAPIProxy implementation requires a very recent Samba4 version in order to run properly. If Samba4 is planned to be installed from scratch for MAPIProxy only, please use the <em>make samba-git</em> compilation rule provided in the build system. This command will automate most part of the samba4 installation process. The only requirement for this step is to have an up to date GIT version<em> installed on the system.</em></p>
<pre>
# make samba-git
</pre>
<p>When the installation process is finished, a running samba4 installation will be located in <em>/usr/local/samba/</em>. You will possibly be required to run <em>ldconfig</em> before you move to next steps. Please refer to <em>doc/howto.txt</em> for further information on openchange compilation.</p>
<h3>2.3. MAPIProxy installation</h3>
<p>If you have existing OpenChange DSO in the <em>/usr/local/samba/modules/dcerpc_server/</em> folder, such as <em>dcesrv_exchange.so</em>, <strong>please remove them prior loading samba with MAPIProxy.</strong></p>
<pre>
$ ./autogen.sh
$ ./configure --prefix=/usr/local/samba
$ make
# make install
# rm -rf /usr/local/samba/modules/dcerpc_server/dcesrv_exchange.so
</pre>

<h3>3. Configuration</h3>

<h3>3.1. 5-Minute Configuration</h3>
<p>This 5-Minute configuration will help you set up a minimal MAPIProxy using specified credentials and relaying traffic from Outlook clients to a remote Exchange server. This configuration will be performed in three steps:</p><ul>
<li><p><strong>[1] Provision Samba</strong>:</p><p>From samba4/source4 directory, run under the root account:</p></li>
</ul>
<pre>
# ./setup/provision --realm=OPENCHANGE.LOCAL --domain=OPENCHANGE                      --adminpass=openchange --server-role='domain controller'

</pre>
<p>If you don't have DNS resolution and your realm can't be resolved, samba will be unable to authenticate the user in its user database. You must specify a realm which MAPI clients and MAPIProxy can resolve.</p><p>If everything works fine, the provisioning script will have created all the databases, populated the AD (Active Directory) and generated a valid smb.conf file.</p><ul>
<li><p><strong>[2] Add a user account</strong>:</p></li>
</ul><p>In this configuration, we'll set the same credentials both for the user in the windows domain and on the Samba4 server. Let say there is already a user named <em>testuser</em> with its password set to <em>openchange</em> on the Exchange server:</p>
<pre>
# ./setup/newuser testuser
New Password: openchange

</pre>
<ul>
<li><p><strong>[3] Configure MAPIProxy options</strong>:</p></li>
</ul><p>In this final step, we only need to customize a small set of parameters:</p>
<dl class='dl-vertical'>
  <dt>
      &bull;
  </dt>
  <dd>
    <p><strong>dcerpc endpoint servers</strong>:</p><p> MUST include epmapper and mapiproxy separated with comma.</p>
  </dd>

</dl>

<dl class='dl-vertical'>
  <dt>
      &bull;
  </dt>
  <dd>
    <p><strong>dcerpc_mapiproxy:binding</strong>:</p><p> This is the binding string used to connect to the remote Exchange server. The format of this string is: transport:address[flags]. In the example below, we'll be using the TCP over IP transport, connect on 192.168.1.1 and add the print flag so MAPI packets get dissected on samba stdout (or logfile).</p>
  </dd>

</dl>

<dl class='dl-vertical'>
  <dt>
      &bull;
  </dt>
  <dd>
    <p><strong>dcerpc_mapiproxy:username</strong> and <strong>dcerpc_mapiproxy:password</strong>:</p><p>The specified credentials we will be using to connect to the remote Exchange server.</p>
  </dd>

</dl>

<dl class='dl-vertical'>
  <dt>
      &bull;
  </dt>
  <dd>
    <p><strong>dcerpc_mapiproxy:domain</strong>:</p><p> The Windows domain the remote Exchange server belongs to.</p>
  </dd>

</dl>

<dl class='dl-vertical'>
  <dt>
      &bull;
  </dt>
  <dd>
    <p><strong>dcerpc_mapiproxy:interfaces</strong>:</p><p> In our case, we want to relay the whole ExchangeRPC traffic, so we need to load both the EMSMDB and NSP interface. In the meantime, people interested in NSPI proxy only would only have to load the exchange_nsp interface.</p>
  </dd>

</dl>

<dl class='dl-vertical'>
  <dt>
      &bull;
  </dt>
  <dd>
    <p><strong>dcerpc_mapiproxy:modules</strong>:</p><p> MAPIProxy provides a stackable modular system which primary objective is to provide developers an API for modules development. In our case we want to activate the <em>downgrade</em> module responsible for the EcDoConnect/EcDoRpc EMSMDB RPC functions negotiation.</p>
  </dd>

</dl>

<pre>
[globals]
        netbios name    = MAPIPROXY
        workgroup       = OPENCHANGE
        realm           = OPENCHANGE.LOCAL
        server role     = domain controller

        ### Configuration required by mapiproxy ###
        dcesrv:assoc group checking = false
        dcerpc endpoint servers = epmapper, mapiproxy

        dcerpc_mapiproxy:binding = ncacn_ip_tcp:192.168.1.1[print]
        dcerpc_mapiproxy:username = testuser
        dcerpc_mapiproxy:password = openchange
        dcerpc_mapiproxy:domain = EXCHANGE
        dcerpc_mapiproxy:interfaces = exchange_emsmdb, exchange_nsp, exchange_ds_rfr
        dcerpc_mapiproxy:modules = downgrade
        ### Configuration required by mapiproxy ###


[netlogon]
        path = /usr/local/samba/var/locks/sysvol/openchange.local/scripts
        read only = no

[sysvol]
        path = /usr/local/samba/var/locks/sysvol
        read only = no
</pre>
<p>We are now ready to run samba:</p>
<pre>
# samba -d5 -i -M single

</pre>
<p>If everything works properly, the following lines should be displayed in samba output:</p>
<pre>
DCERPC endpoint server 'exchange_emsmdb' registered
DCERPC endpoint server 'exchange_nsp' registered
DCERPC endpoint server 'exchange_ds_rfr' registered
DCERPC endpoint server 'mapiproxy' registered
dcesrv_interface_register: interface 'epmapper' registered on endpoint 'ncacn_np:[\pipe&#92;pmapper]'
dcesrv_interface_register: interface 'epmapper' registered on endpoint 'ncacn_ip_tcp:[135]'
dcesrv_interface_register: interface 'epmapper' registered on endpoint 'ncalrpc:[EPMAPPER]'
MAPIPROXY module 'downgrade' registered
MAPIPROXY module 'downgrade' loaded
mapiproxy_module_load 'downgrade' (Downgrade EMSMDB protocol version EcDoConnect/EcDoRpc)
dcesrv_interface_register: interface 'exchange_emsmdb' registered on endpoint 'ncacn_np:[\pipe\lsass]'
dcesrv_interface_register: interface 'exchange_emsmdb' registered on endpoint 'ncacn_np:[\pipe\protected_storage]'
dcesrv_interface_register: interface 'exchange_emsmdb' registered on endpoint 'ncacn_ip_tcp:'
dcesrv_interface_register: interface 'exchange_nsp' registered on endpoint 'ncacn_np:[\pipe\lsass]'
dcesrv_interface_register: interface 'exchange_nsp' registered on endpoint 'ncacn_np:[\pipe\protected_storage]'
dcesrv_interface_register: interface 'exchange_nsp' registered on endpoint 'ncacn_ip_tcp:[]'
dcesrv_interface_register: interface 'exchange_ds_rfr' registered on endpoint 'ncacn_np:[\pipe\lsass]'
dcesrv_interface_register: interface 'exchange_ds_rfr' registered on endpoint 'ncacn_np:[\pipe\protected_storage]'
dcesrv_interface_register: interface 'exchange_ds_rfr' registered on endpoint 'ncacn_ip_tcp:[]'

</pre>
<p><strong>You should now be able to configure Outlook to use an Exchange account with the proxy IP address and run Outlook seamlessly (both online or cached exchange mode).</strong></p>
<h3>4. Technical Concepts</h3>

<h3>4.1. NSPI Bindings Replacement</h3>
<p>When Outlook sets up an Exchange account using either the mail applet from the configuration panel or the account editor within Outlook, it uses the NSPI protocol (Name Service Provider Interface, effectively the address book provider). In this case, NSPI is used to resolve the Exchange username and fetch from Exchange server all information needed by Outlook to initiate direct connection to the EMSMDB pipe (effectively the message store) the next time it connects to the server.</p><p>At some point of the profile's creation process, Outlook queries Exchange for some specific connection information using the <strong>NspiGetProps (0x9) RPC operation </strong>. More specifically, when Outlook requests for the <strong>PR_EMS_AB_NETWORK_ADDRESS</strong> MAPI property, Exchange returns a list <strong>binding strings</strong>. Outlook next stores these binding strings at some location - associated to the Outlook profile - in the windows registry and uses them for future connections.</p><p>Outlook can also rely on other information returned by NSPI functions and connect to the real Exchange server rather than MAPIProxy. Such case occurs when Outlook is able to resolve the exchange server using its hostname. This reference to the original Exchange server can be found when Outlook requests for the <strong>PR_EMS_AB_HOME_MDB</strong> MAPI property during the <strong>NspiQueryRows (0x3) RPC operation</strong>. MAPIProxy replaces the Exchange server name with its own netbios name and forward the reply to the client.</p><p>In the meantime, this information is next used by Outlook to query a minimal entry ID for a distinguished name using this server name. MAPIProxy needs to substitute the server name in the inbound request string with the original exchange one.</p><p>MAPIProxy needs to avoid Outlook clients being aware of this remote server address and trying to communicate directly with the remote server instead of using the proxy. In order to do this, MAPIProxy alters the Outlook-Exchange MAPI traffic and replaces these binding strings with the MAPIProxy FQDN and netbios name.</p>
<h3>4.2. NSPI Referral Replacement</h3>
<p>The Address Book Name Service Provider Interface (NSPI) Referral Service is a service used by Outlook to retrieve the name of an NSPI server. No NSPI connection should be initiated without first querying for the correct NSPI server. In this case, RFR returns the fully qualified domain name of the real Exchange server and starts using it if available.</p><p>MAPIProxy needs to avoid Outlook clients being aware of this server address and trying to communicate directly with the remote server instead of using the proxy. In order to do this, MAPIProxy alters the Outlook-Exchange MAPI traffic and replaces the server DN returned by <strong>RfrGetNewDSA (0x0) RPC operation</strong> with the MAPIProxy realm as specified in smb.conf.</p>
<h3>4.3. Force EMSMDB Protocol Version</h3>
<p>When Outlook starts and presumably calls MapiLogonEx, it first opens a connection to the Exchange server on the NSPI pipe, then on the EMSMDB pipe. Under Outlook 2003, the very first EMSMDB RPC call Outlook makes can be considered as a kind of <em>protocol version negotiation</em>. Depending on which version of Outlook is used, and how the Exchange server replies to the EMSMDB connect request, Outlook will either keep using the same pool of RPC calls or downgrade.</p><p>For example Outlook 2003 (default behavior) tests if the remote server supports the 2 new EMSMDB calls (EcDoConnectEx/EcDoRpcExt2) introduced in Exchange 2003. If Exchange replies to the EcDoConnectEx request with a dcerpc_fault, it means the server does not support the RPC operation, presumably has a version before 2003, and Outlook needs to downgrade its version in order to communicate with the server:</p>
<dl class='dl-vertical'>
  <dt>
    *
  </dt>
  <dd>
    <p>EcDoConnectEx (0xa) call</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>On success, Outlook will use EcDoRpcExt2 (0xb) to handle MAPI traffic</p>
  </dd>
  <dt>
      &bull;
  </dt>
  <dd>
    <p>On failure (dcerpc_fault: nca_op_rng_error), Outlook calls EcDoConnect (0x0) and use EcDoRpc (0x2) to handle MAPI traffic</p>
  </dd>

</dl>
<p>If MAPIProxy runs in an environment with Outlook clients and Exchange servers using a version above 2003, a last step is required to successfully use Outlook. The EcDoConnect RPC reply returns the Exchange server version (as an array of 3 short integers). When Outlook detects this particular server version, it automatically closes the connection and keep requesting indefinitely for EcDoConnectEx. To deal with this, MAPIProxy modifies the EcDoConnect reply sent by Exchange and replaces the server version with a one equal to that sent by Exchange 2000.</p><p>In the meantime, if we reproduce this test with Outlook 2000 which doesn't support these 2 new RPC calls, Outlook will directly call EcDoConnect.</p><p>The main difference between the EcDoConnectEx/EcDoRpcExt2 operations and the EcDoConnect/EcDoRpc operations is that the former use both XOR 0xA5 obfuscation and LZ77 compression/Direct2 encoding; while the latter only use the XOR obfuscation to handle MAPI content. If MAPIProxy wants to act as an intelligent proxy (for example, to be able to analyze MAPI content on the fly, compress MAPI data etc), receiving non compressed MAPI traffic would probably improve the overall process.</p><p>Below is a list of Exchange/Outlook pairs and the EMSMDB connect function they will use by default: <strong>Exchange version</strong> <strong>Outlook version</strong> <strong>EMSMDB connect function</strong>  5.5/2000 any EcDoConnect (0x0)  2003 2000 EcDoConnect (0x0)  2007 2000 EcDoConnect (0x0)</p><p>Microsoft officially says it is unsupported  2003 2003-2007 EcDoConnectEx (0xa)  2007 2003 EcDoConnectEx (0xa)  2007 2007 EcDoConnectEx (0xa)</p><p>MAPIProxy reproduces the Exchange 2000 behavior and prevents Outlook from communicating with the Exchange server using the EcDoConnectEx/EcDoRpcExt2 as described in Figure 2 below. When Outlook sends an EcDoConnectEx request, MAPIProxy does not relay the request to the remote Exchange server and immediately returns a dcerpc_fault to Outlook. Outlook, assuming the server doesn't support this call uses EcDoConnect instead. From this call, MAPIProxy relay the information to Exchange.</p>
<pre>
   Figure 2. MAPIProxy behavior on Outlook EMSMDB connection
</pre>
<p>From the Exchange side, the server will analyze this EcDoConnect request as a call sent by Outlook 2000 or below version. Exchange works fine using this protocol version unless Exchange 2007 SP1 which appears to introduce client version restrictions <em>by default</em>. In the meantime, existing tests demonstrate similar restrictions would apply to Outlook 2003 connection (without MAPIProxy) and prevent Outlook version before 2007 connecting to Exchange 2007. Further information and solution is available at the following addresses:</p><ul>
<li><p>Earlier Outlook clients cant connect to Exchange 2007 Server</p></li><li><p>Exchange 12 and Public Folders</p></li>
</ul>
<h3>4.4. OpenChange IDL File </h3>
<p>IDL stands for Interface Definition Language and OpenChange uses this format to describe ExchangeRPC communications. This file is processed by pidl (Perl IDL compiler provided by Samba4) which turns this protocol description into C-code dealing with the push, pull and print operations.</p><p>OpenChange development policy in trunk used to push a new MAPI call in the IDL only when the associated libmapi implementation and mapitest unit is developed, but this was preventing from distributing MAPIProxy with further openchange releases. Furthermore, the OpenChange IDL is now almost complete and merging back to the trunk helps improving libmapi reliability.</p>
<h3>5. Stackable Modules</h3>

<h3>5.1. General Overview</h3>
<p>The MAPIProxy stackable modules system provides implementers a development framework to add new features. This stackable mechanism allows developers to write modules with a very specific scope of which modifications will transparently be relayed to the next module until it is finally pushed by MAPIProxy to the next hop (Figure 3.).</p>
<pre>
   Figure 3. MAPIProxy module stack and EcDoRpc interaction
</pre>
<p>With this system, developers can focus their effort on ExchangeRPC traffic - or any other protocol samba supports - interception, modification, analysis and avoid spending time on implementing a new endpoint server. Furthermore it provides an easier way for implementers to divide the work in smaller units and develop each of them in a separated module.</p><p>MAPIProxy modules are dynamic shared objects with an entry point and a limited set of hooks. These modules have to be installed in the <em>dcerpc_mapiproxy</em> folder within the samba4 modules directory (e.g. <em>/usr/local/samba/modules</em>). MAPIProxy modules specified in the Samba configuration file (smb.conf) will be loaded into MAPIProxy at runtime and interact with each other in the same order they were defined:</p>
<pre>
dcerpc_mapiproxy:modules = downgrade,dummy
</pre>
<p>All MAPIProxy modules will be registered but only those specified on the <strong>dcerpc_mapiproxy:modules</strong> parametric option line will be added to the chained list of effective modules.</p>
<h3>5.2. Module entry point</h3>
<p>MAPIProxy modules must have an entry point function named <strong>samba_init_module</strong>. This function needs to set general information about the module, specify the module's hooks and finally call the <strong>mapiproxy_module_register</strong> function to register itself in the MAPIProxy module subsystem.</p>
<pre>
NTSTATUS samba_init_module(void)
{
        struct mapiproxy_module module;
        NTSTATUS                ret;

        /* Fill in our name */
        module.name        = "sample";
        module.description = "A sample module";
        module.endpoint    = "any";

        /* Fill in all the operations */
        module.init     = sample_init;
        module.push     = sample_push;
        module.ndr_pull = sample_ndr_pull;
        module.pull     = sample_pull;
        module.dispatch = NULL;
        module.unbind   = NULL;

        /* Register ourselves with the MAPIPROXY subsytem */
        ret = mapiproxy_module_register(&module);
        if (!NT_STATUS_IS_OK(ret)) {
                DEBUG(0, ("Failed to register 'sample' mapiproxy module!\n"));
                return ret;
        }

        return ret;
}
</pre>
<ul>
<li><p><strong>module.name</strong>:</p><p> This is the module name. This name will be used by dcerpc_mapiproxy:modules in smb.conf to load the module</p></li>
</ul><ul>
<li><p><strong>module.description</strong>:</p><p> This field lets developers specify a brief module description for information purpose only.</p></li>
</ul><ul>
<li><p><strong>module.endpoint</strong>:</p><p> This field defines the interface which this module is designed to work with. The primary objective is to avoid calling the module hooks if the module doesn't have any impact on the requests or replies. For example, a module only interacting with the EcDoRpc function should define <em>exchange_emsmdb</em>.</p></li>
</ul><p>In the meantime, it can happen that a module requires to interact with more than a single interface. In such case, use the '<strong>any</strong>' keyword which will call the modules functions with any endpoints proxied by MAPIProxy.</p>
<h3>5.3. Module Hooks</h3>
<p>MAPIProxy offers a set of hooks which modules can implement to modify/change/alter client to server MAPI traffic. The figure below shows how and when hooks are called during a request/response lifetime.</p>
<pre>
    Figure 4. Usage of MAPIProxy Hooks during a request/response life time
</pre>
<ul>
<li><p><strong>init</strong>: This is the initialization function for the module which is only called once - when the module is loaded. It is generally used to retrieve smb.conf parametric options for the module and initialize some global structures</p></li>
</ul><ul>
<li><p><strong>pull</strong>: This is the function called when MAPIProxy receives a MAPI request. The request has already been extracted and its information filled into MAPI structures</p></li>
</ul><ul>
<li><p><strong>push</strong>: This is the function called when MAPIProxy receive a MAPI response. The response has already been extracted and its information filled into MAPI structures</p></li>
</ul><ul>
<li><p><strong>dispatch</strong>: Similarly to the MAPIProxy top-level dispatch function, it is used to dispatch the information. This function is called after the pull but before the push. Moreover it is called before the request is forward to the remote endpoint.</p></li>
</ul><ul>
<li><p><strong>ndr_pull</strong>: This is the function called before data from a request is extracted from the NDR blob.</p></li>
</ul><ul>
<li><p><strong>ndr_push</strong>: This is the function called before data from a response is extracted from the NDR blob.</p></li>
</ul><ul>
<li><p><strong>unbind</strong>: This is the function called when the connection closes. It can be used to free data associated to a given session and stored within a module global list.</p></li>
</ul><p><strong>Please note that the module API is still under development and is likely to change in further revisions.</strong></p>
<h3>5.4. mapiproxy structure </h3>
<p>MAPIProxy uses a structure modules can modify in their dispatch routine and which impact on the general MAPIProxy behavior.</p>
<pre>
    Figure 5. overview of mapiproxy structure variables scope
</pre>
<ul>
<li><p><strong>norelay</strong>: This boolean variable can be used by modules to tell MAPIProxy not to relay the incoming <strong>request</strong> to the remote server through <em>dcerpc_ndr_request()</em> but directly jump to the push (response) MAPIProxy code. This variable is for example in use within the cache module when we read stream from the local filesystem and play it back to MAPI clients.</p></li>
</ul><ul>
<li><p><strong>ahead</strong>: This boolean variable can be used by modules to tell MAPIProxy not to relay the incoming <strong>response</strong> to the client through the <em>push</em> and <em>dcerpc_ndr_request</em> routine but loop over the dispatch routine. This variable is for example in use within the cache module when we want to read a stream ahead from Exchange server to the remote MAPIProxy instance.</p></li>
</ul>
<h3>6. Available Modules </h3>

<h3>6.1. Downgrade Module</h3>
<p>The <strong>downgrade</strong> module implements the EcDoConnect/EcDoRpc negotiation as described in section 4.2<strong>. It ensures Outlook will not send compressed information or use functions other than EcDoRpc for EMSMDB transport. In order to use the downgrade module, edit smb.conf and add </strong><em>downgrade</em><strong> to </strong><em>dcerpc_mapiproxy:modules</em><strong>.</strong></p>
<pre>
dcerpc_mapiproxy:modules = downgrade
</pre>

<h3>6.2. Pack Module </h3>
<p><strong>Note that this module only works with an infrastructure using two or more instances of MAPIProxy as described in Figure 1</strong><strong></strong></p><p>The <strong>pack</strong> module implements routines designed to manipulate and factorize MAPI content between different MAPIProxy instances. It also offers a developer overview on how to manipulate mapi requests. Last but not least, it provides data which can next be used by subsequent MAPIProxy modules for example to compress or encrypt this proxypack blob.</p><ul>
<li><p>First, MAPIProxy extracts and removes specific MAPI calls from the request, pack them within the proxypack MAPI call data blob, prefix them with their real offset in the array of mapi requests and finally append this custom call at the end of the mapi requests array (Figure 4).</p></li>
</ul>
<pre>
    Figure 6. Pack process
</pre>
<ul>
<li><p>Final MAPIProxy hop will seek the mapi requests array looking for the proxypack call. If found, it unpacks MAPI data and restore these calls at their initial location within the mapi requests array (Figure 6).</p></li>
</ul>
<pre>
    Figure 7. Unpack process
</pre>
<p>This module has two configuration options:</p><ul>
<li><p><strong>mpm_pack:opnums</strong></p><p> This option takes a list of MAPI calls to pack into the proxypack data blob. It can take one or more MAPI opnums, each of them separated with a comma.</p></li>
</ul><ul>
<li><p><strong>mpm_pack:lasthop</strong></p><p> This options takes either <em>true</em> or <em>false</em>.the lasthop option defines whether this is a MAPIProxy directly connected to Outlook/Exchange or yet another proxy inserted within the MAPIProxy chain of hops. If this MAPIProxy instance is not a last hop, then it will skip the pack/unpack operations and forward the request to the next one.</p></li>
</ul>
<pre>
mpm_pack:opnums = 0x70,0x75,0x76,0x77,0xa
mpm_pack:lasthop = true
</pre>
<p>In order to use the pack module, edit smb.conf and add <em>pack</em> to <em>dcerpc_mapiproxy:modules</em>.</p>
<pre>
dcerpc_mapiproxy:modules = downgrade,pack
</pre>

<h3>6.3. Cache Module </h3>
<p>The <strong>cache</strong> module implements a cache mechanism for streams related to messages or attachments. This module reduces communication latency between MAPI clients (using <em>online</em> mode) and Exchange. When configured with online mode, MAPI clients retrieve data from Exchange each time they access a message and don't have any offline storage mechanisms enabled - data are downloaded and stored within a <em>temporary files</em> folder. This module also offers a preliminary synchronization mechanism which can be used to transfer files between different MAPIProxy instances and use different protocols than MAPI for data transfer (such as rsync or wget).</p><p>The cache module is designed to cover different cases:</p>
<h3>Scenario 1: Replay attachments</h3>
<p>This scenario only requires a single MAPIProxy instance and requires a single configuration option:</p>
<pre>
mpm_cache:path = /tmp/cache

</pre>

<pre>
    Figure 8. Replay stream scenario
</pre>
<ul>
<li><p><strong>1. Outlook reads a stream for the first time</strong>:</p><p> MAPIProxy monitors the Outlook-Exchange traffic and store the attachment on the local filesystem.</p></li>
</ul><ul>
<li><p><strong>2. Outlook requests this stream again</strong>:</p><p> MAPIProxy looks over its cache, find the requested stream and directly communicate with Outlook without forwarding requests to the remote server.</p></li>
</ul>
<h3>Scenario 2: Read stream ahead</h3>
<p>This scenario requires two MAPIProxy instances and requires different configuration options for local and remote MAPIProxy:</p><ul>
<li><p><strong>local MAPIProxy smb.conf sample</strong>:</p></li>
</ul>
<pre>
mpm_cache:path = /tmp/cache
mpm_cache:ahead = false
mpm_cache:sync = true
mpm_cache:sync_cmd = /usr/bin/rsync -z mapiproxy@192.168.102.2:__FILE__  __FILE__

</pre>
<ul>
<li><p><strong>remote MAPIProxy smb.conf sample</strong>:</p></li>
</ul>
<pre>
mpm_cache:path = /tmp/cache
mpm_cache:ahead = true
mpm_cache:sync = false

</pre>

<pre>
    Figure 9. Read ahead scenario with synchronization mechanism
</pre>
<ul>
<li><p><strong>This scenario uses 2 MAPIProxy instances</strong>. We call <em>remote MAPIProxy</em>, the MAPIProxy instance connected to the Exchange server network and <em>local MAPIProxy</em> the instance connected to the MAPI clients network.</p></li>
</ul><ul>
<li><p><strong>1. Outlook wants to read an attachment for the first time</strong>:</p><p> The remote MAPIProxy monitors the first ReadStream request and read the full stream ahead on its own and stores it on its local filesystem.</p></li>
</ul><ul>
<li><p><strong>2. remote MAPIProxy replies to local MAPIProxy and local MAPIProxy runs the synchronization mechanism.</strong> The current implementation provides a fork/execve/waitpid process which allows to run any command with parameters. When local MAPIProxy finishes to store the file locally through the synchronization mechanism, it marks the stream as being cached.</p></li>
</ul><ul>
<li><p><strong>3. local MAPIProxy plays the attachment back to the client from cache</strong>.</p></li>
</ul><p>The module monitors OpenMessage, OpenAttach, OpenStream, ReadStream and Release MAPI calls and stores streams on the local filesystem with indexation in a TDB database. Note that the module doesn't yet provide semantics needed to remove entries from the TDB database.</p><p>This module has different configuration options and modes:</p><ul>
<li><p><strong>mpm_cache:path</strong></p><p> This option takes the full path to an existing folder on the filesystem. This folder will be the storage root path for the cache module and will hold the TDB store, a folder hierarchy and stream files.</p></li>
</ul>
<pre>
mpm_cache:path = /tmp/cache
</pre>
<ul>
<li><p><strong>mpm_cache:ahead</strong></p><p> This option takes a boolean value (true or false) and defines whether the ahead mechanism should be enabled or not. This mode should only be enabled on the remote MAPIProxy instance. It can be enabled on local MAPIProxy instance, however there won't be any benefit but Outlook unexpectedly falling in some time out mode and close the connection.</p></li>
</ul>
<pre>
mpm_cache:ahead = true
</pre>
<ul>
<li><p><strong>mpm_cache:sync</strong></p><p> This option takes a boolean value (true or false) and defines whether the synchronization mechanism should be enabled or not. This mode only makes sense on the local MAPIProxy instance and <strong>mpm_cache:sync_cmd</strong> must also be configured.</p></li>
</ul>
<pre>
mpm_cache:sync = true
</pre>
<ul>
<li><p><strong>mpm_cache:sync_cmd</strong></p><p> This option takes the command line to execute for the synchronization process. A preliminary substitution variable mechanism is available but should be improved over time. For the moment, the cache module only provides <strong>__FILE__</strong> which will be substituted by the full path to the cached file. The synchronization process currently assumes local and remote MAPIProxy instances have the same storage path (<em>mpm_cache:path</em>).</p></li>
</ul>
<pre>
mpm_cache:sync_cmd = /usr/bin/rsync -z mapiproxy@192.168.102.2:__FILE__  __FILE__
</pre>
<p>In order to use the cache module, edit smb.conf and add <em>cache</em> to <em>dcerpc_mapiproxy:modules</em>.</p>
<pre>
dcerpc_mapiproxy:modules = downgrade,cache
</pre>

<h3>Notes</h3>
<ul>
<li><p>While the cache module implements a preliminary <em>session</em> mechanism (multiple clients support), this mode is currently only implemented up to 50%. Multiple clients will work for files already cached, but will cause unexpected behaviors while synchronizing a remote file at the same moment from different session. This bug should be fixed when the streaming and lock mechanism will be implemented.</p></li>
</ul><ul>
<li><p>The synchronization mechanism is yet experimental and we have deliberately changed the storage path permissions from 0700 to 0777 for trivial setup. File permissions will become parametric smb.conf options in the future.</p></li>
</ul>
<h3>7. Server Mode</h3>

<h3>7.1. 5-Minute Configuration</h3>
<p>This 5-Minute configuration will help you set up a preliminary OpenChange server. This configuration will be performed in three steps. Before running these commands, make sure you have followed <strong>step 1 (Provision Samba)</strong> and <strong>step 2 (Add a user account)</strong> in MAPIProxy 5-Minute configuration section<strong>.</strong></p><ul>
<li><p><strong>[1] Provision OpenChange</strong>:</p><p>From openchange root directory, run under the root account:</p></li>
</ul>
<pre>
# ./setup/openchange_provision

</pre>
<p>This script will extends Samba4 Active Directory with Exchange classes and attributes needed to run OpenChange server. Note that this operation may require several minutes to complete.</p><ul>
<li><p><strong>[2] Create the Exchange user account</strong>:</p><p> OpenChange <strong>does not create</strong> the user account the way Samba does. It only extends existing users from the SAM database and add attributes required to access OpenChange server. The underlying concept is that system administrators may want to give access to Samba shares to a specific user but do not want him to access OpenChange server.<strong>The user must have been created using the Samba4 </strong><em>samba-tool newuser</em><strong> script</strong><em> before you run this command. Run under the root account:</em></p></li>
</ul>
<pre>
# ./setup/openchange_newuser --create &lt;username&gt;

</pre>
<p> where username is the user account you want to give access to OpenChange server</p><ul>
<li><p><strong>[3] Create the OpenChange Dispatcher database</strong>:</p><p> OpenChange uses a dispatcher database designed to store generic and top-level information about user mailbox. The following command will create a blank openchangedb ldb database:</p></li>
</ul>
<pre>
# ./setup/openchange_provision --openchangedb

</pre>
<ul>
<li><p><strong>[4] Create a mailbox for the user in the OpenChange Dispatcher database</strong>:</p><p> Run under the root account:</p></li>
</ul>
<pre>
# ./setup/openchange_newuser --mailbox &lt;username&gt;

</pre>
<ul>
<li><p><strong>[5] Configure OpenChange server options</strong>:</p><p> OpenChange server only requires a very limited set of options to be added to <em>smb.conf</em> in order to run. Note that the following configuration also works with existing MAPIProxy configuration. This configuration will turn MAPIProxy into OpenChange server only and no remote connection to Exchange server will be made:</p></li>
</ul>
<pre>
[globals]
        netbios name    = MAPIPROXY
        workgroup       = OPENCHANGE
        realm           = OPENCHANGE.LOCAL
        server role     = domain controller

        ### Configuration required by OpenChange server ###
        dcerpc endpoint servers = epmapper, mapiproxy
        dcerpc_mapiproxy:server = true
        dcerpc_mapiproxy:interfaces = exchange_emsmdb, exchange_nsp, exchange_ds_rfr
        ### Configuration required by OpenChange server ###

[netlogon]
        path = /usr/local/samba/var/locks/sysvol/openchange.local/scripts
        read only = no

[sysvol]
        path = /usr/local/samba/var/locks/sysvol
        read only = no
</pre>

<h3>7.2. General Overview</h3>
<p>Although section 1.1 only describes MAPIProxy as a proxy, recent work makes it possible to turn MAPIProxy either into a <strong>complete and real stand-alone server</strong> or server/proxy hybrid.</p><p>MAPIProxy behaviour is controlled through the <em>dcerpc_mapiproxy:server</em> parametric option. To use MAPIProxy as an independent server, set</p>
<pre>
dcerpc_mapiproxy:server = true
</pre>
<ul>
<li><p><strong>dcerpc_mapiproxy:server = true</strong></p><p> When this parametric option is set to true, MAPIProxy will not initiate connections to a remote server, but instead will direct client connections to its own default NSPI, RFR and EMSMDB servers and work as a stand-alone server.</p></li>
</ul><ul>
<li><p><strong>dcerpc_mapiproxy:server = false</strong></p><p> If this option is unset or set to false (default behavior), MAPIProxy will work in proxy mode only and initiates a connection to a remote server using the binding/credentials configuration as specified in section 3.1 (5-Minute Configuration).</p></li>
</ul><p>In addition to the server mode described above, MAPIProxy provides an additional set of configuration options which makes possible to override and customize MAPIProxy behavior. The server mode has been designed to supply a modular mechanism somewhat similar to the modules one described in section 5. While MAPIProxy modules are stackable and can be chained, server modules only support a single module for a given endpoint:</p><ul>
<li><p>When dcerpc_mapiproxy:server is set to true, MAPIProxy registers dynamic shared object stored at a specific location (modules/dcerpc_mapiproxy_servers) and load server modules tagged with the <strong>MAPIPROXY_DEFAULT</strong> status. For each of the endpoints MAPIProxy can handle (exchange_nsp, exchange_emsmdb, exchange_ds_rfr), the associated default server will be loaded. These default servers are located within mapiproxy/servers/modules. (Figure 10.)</p></li>
</ul>
<pre>
   Figure 10. Server mode enabled
</pre>
<ul>
<li><p>When dcerpc_mapiproxy:server is set to false, MAPIProxy still registers server dynamic shared objects but does not load any of them, which means that ExchangeRPC traffic will be relayed to remote server.</p></li>
</ul><p>However there may be some cases where developers would like to run a custom server they have developed, or handle a limited set of ExchangeRPC traffic on their own for a given endpoint. This configuration is made possible through 3 parametric options:</p>
<pre>
dcerpc_mapiproxy:nspi_server   = nspi_server
dcerpc_mapiproxy:emsmdb_server = emsmdb_server
dcerpc_mapiproxy:rfr_server    = exchange_ds_rfr
</pre>
<p>Each of these options specifies the server module name to be loaded for a given endpoint. Note that these options override the dcerpc_mapiproxy:server state:</p><ul>
<li><p>If dcerpc_mapiproxy:server is set to true, specifying one or all of these options will override default servers with your own custom servers. For example Figure 11 shows a mapiproxy configuration where server mode is enabled but where the NSPI server has been replaced with a custom one.</p></li>
</ul>
<pre>
   Figure 11. Server mode enabled but custom NSPI server loaded
</pre>
<ul>
<li><p>If dcerpc_mapiproxy:server is set to false, specifying one or all of these options will force MAPIProxy to relay the associated traffic to default or custom server. For example, Figure 12 shows a mapiproxy configuration where NSPI traffic is handled by OpenChange NSPI server while EMSMDB and RFR traffic is relayed to the remote server.</p></li>
</ul>
<pre>
   Figure 12. Server mode disabled but NSPI server loaded
</pre>

<h3>8. Frequently Asked Questions</h3>

<h3>8.1. The action could not be completed</h3>

<pre>
   Figure 13. Outlook error: The action could not be completed
</pre>
<p>If you have followed the 5-Minute Configuration instructions and the above error message box (Figure 13) is displayed each time you click the <em>Check Name</em> button, then you need to:</p><ul>
<li><p>Click on <strong>More Settings</strong></p></li><li><p>Open the security Tab</p></li><li><p>Tick the <strong>Always prompt for username and password</strong> checkbox in the User Configuration section (Figure 14)</p></li>
</ul>
<pre>
   Figure 14. Resolution: Always prompt for username and password
</pre>
<p>Next time you click on <em>Check Name</em>, Outlook will prompt for username and password. A similar credentials dialog will be displayed each time Outlook is launched.</p>
<h3>8.2. Profile creation goes fine, but Outlook can't open your default e-mail folders</h3>
<p>The profile was properly created using the mail applet from the configuration panel (or using Outlook wizard). However when I launch Outlook, I keep having the following error message:</p>
<pre>
   Figure 15. Outlook error: Unable to Open your default e-mail folders
</pre>
<p>This probably means Outlook is unable to lookup the resolved name of your MAPIProxy/samba4 server. You can either:</p><ul>
<li><p>1. Make your Windows workstation points to a domain name server able to resolve MAPIProxy fully qualified name.</p></li>
</ul><ul>
<li><p>2. Open</p></li>
</ul>
<pre>
C:\WINDOWS\system32&#92;tc\drivers\hosts

</pre>
<p> file and add an entry for mapiproxy. For example if I have mapiproxy.openchange.local pointing at 192.168.102.2, then hosts file should hold the following line:</p>
<pre>
192.168.102.2 mapiproxy.openchange.local mapiproxy

</pre>

<h3>8.3. Does MAPIProxy need to be domain controller?</h3>
<p>No it doesn't. MAPIProxy works fine as a member server of a Windows domain. However, since delegated credentials and forwarded kerberos credentials don't yet work, you'll need to force samba to rely on the local SAM database. To force this behavior, add to smb.conf within the global section:</p>
<pre>
server role               = member server
aux_methods:member server = sam
</pre>

<h3>8.4. Generating Samba's private keys takes infinite time</h3>
<p>For some configuration, the private keys generation process at Samba startup can be very long. In case private keys are not generated within a couple of minutes, it is suggested to recompile Samba with gnutls disabled as in the example below:</p>
<pre>
$ ./configure.developer --enable-debug --disable-gnutls
$ gmake idl_full
$ gmake
$ sudo gmake install
</pre>

<h3>8.5. On Ubuntu \fImake samba-git\fP exits with \fIgmake: not found\fP</h3>
<p>On Ubuntu, I have the following output while trying to install samba4 from OpenChange sources:</p>
<pre>
To build Samba, run /usr/bin/make
Step2: Compile Samba4 (IDL)
./script/installsamba4.sh: 332: gmake: not found
Step3: Compile Samba4 (Source)
./script/installsamba4.sh: 332: gmake: not found
Error in Step3 (error code 127)
</pre>
<p>gmake is make on Ubuntu. Creating the following symbolic link will fix the issue:</p>
<pre>
$ sudo ln -s /usr/bin/make /usr/bin/gmake
</pre>


        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="mapiconcepts.3.html"><span aria-hidden="true">&larr;</span> mapiconcepts.3: Mapi concepts</a></li>
   <li class="next"><a href="mapistore-documentation.3.html">mapistore-documentation.3:  <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
