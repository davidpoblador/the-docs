<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AnyEvent::Tools: Instrument collection for anyevent.</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Instrument collection for anyevent.">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="AnyEvent::Tools (3pm) manual">
  <meta name="twitter:description" content="Instrument collection for anyevent.">
  <meta name="twitter:image" content="https://www.carta.tech/images/libanyevent-tools-perl-AnyEvent::Tools-3pm.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3pm/AnyEvent::Tools.3pm.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="AnyEvent::Tools (3pm) manual" />
  <meta property="og:description" content="Instrument collection for anyevent." />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libanyevent-tools-perl-AnyEvent::Tools-3pm.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">AnyEvent::Tools<small> (3pm)</small></h1>
        <p class="lead">Instrument collection for anyevent.</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/">
      <span itemprop="name">MISSING SECTION</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/AnyEvent::Tools.3pm.html">
      <span itemprop="name">AnyEvent::Tools: Instrument collection for anyevent.</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libanyevent-tools-perl/">
      <span itemprop="name">libanyevent-tools-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/AnyEvent::Tools.3pm.html">
      <span itemprop="name">AnyEvent::Tools: Instrument collection for anyevent.</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<h3>Objects pool</h3>

<pre>
    use AnyEvent::Tools qw(pool);
    my $dbh1 = ...
    my $dbh2 = ...

    ...
    my $dbhN = ...


    my $pool = pool($dbh1, $dbh2, $dbh3, ..., $dbhN);

    # later
    ...
    $pool-&gt;get(sub {
        my ($guard, $dbh) = @_;
        ... # Enjoy $dbh here

        undef $guard;           # the other process can use the $dbh
    });
</pre>

<h3>Mutexes</h3>
<p>    use AnyEvent::Tools qw(mutex);</p><p>    my $dbh = new AnyEvent::DBI(bla);     my $mutex_dbh = mutex;</p><p>    sub some_callback() {         ...         $mutex_dbh-&gt;lock(sub {             my ($mutex_guard) = @_;</p><p>            $dbh-&gt;exec("SELECT * FROM table", sub {                 my ($dbh, $rows, $rv) = @_;                 ...</p><p>                undef $mutex_guard; # unlock mutex             });</p><p>        });     }</p>
<h3>Read/Write mutexes</h3>
<p>    # Your data     my @shared_data;</p><p>    use AnyEvent::Tools qw(rw_mutex);     use AnyEvent::Tools qw(:mutex);     # mutex and rw_mutex     my $rw_mutex = rw_mutex;</p><p>    sub some_callback() {         ...         $rw_mutex-&gt;rlock(sub {             my ($mutex_guard) = @_;</p><p>            ...</p><p>            # You can read Your data here             ...             # later             ... = sub {                 # done</p><p>                undef $mutex_guard;     # unlock mutex             }</p><p>        });     }</p><p>    sub other_callback() {         ...         $rw_mutex-&gt;wlock(sub {             my ($mutex_guard) = @_;             ...</p><p>            # You can write Your data here             ...             # later             ... = sub {                 # done</p><p>                undef $mutex_guard;     # unlock mutex             }</p><p>        });     }</p>
<h3>Foreaches</h3>
<p>    use AnyEvent::Tools qw(:foreach);</p><p>    async_repeat $count,         sub {             my ($guard, $iteration, $first_flag, $last_flag) = @_;</p><p>            ... do something $count times         },         sub {             ... # do something after all cycles         };</p><p>    async_foreach             &#92;@array,             sub {                 my ($guard, $element, $index, $first_flag, $last_flag) = @_;</p><p>                ... # do something with $array[$index];             },             sub {                 ... # do something after all cycles</p><p>            };</p><p>    async_foreach             &#92;%hash,             sub {                 my ($guard, $key, $value, $first_flag, $last_flag) = @_;</p><p>                ... # do something with $hash{$key};             },             sub {                 my ($guard) = @_;</p><p>                ... # do something after all cycles</p><p>            };</p>
<h3>Buffers</h3>
<p>    use AnyEvent::Tools &apos;:pool&apos;;    # pool and buffer     use AnyEvent::Tools qw(buffer); # buffer only     my $buffer = buffer;     $buffer-&gt;on_flush( sub { ($guard, $objects_aref) = @_; .... });</p><p>    ...</p><p>    $buffer-&gt;push($obj1);     $buffer-&gt;push($obj2);     $buffer-&gt;push($obj3);     $buffer-&gt;push($obj4);</p><p>    $buffer-&gt;flush;</p><p>    # autoflush after 30 second     $buffer-&gt;interval(30);</p><p>    # autoflush if it contains more than 50 elements     $buffer-&gt;size(50);</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>In spite of event machine is started as one process, You may want to share one resource between a lot of subprocesses. Sometimes You also want to do  something with a  lot of data placed in hashes/arrays.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">FUNCTIONS</h2>
        <div class="sectioncontent">
<h3>mutex</h3>
<p>returns unlocked mutex.</p><p>This object provides the following methods:</p><p><em>lock(\s-1CODEREF\s0)</em></p><p>You declare that You want to lock mutex. When it is possible the mutex will be locked and Your callback will be called.</p><p>If the method is called in non-void context it returns guard object which can be destroyed. So if You want You can cancel Your lockrequest.</p><p>Example:</p><p>    $mutex-&gt;lock(sub {         my $guard = shift;         ... # do something</p><p>        undef $guard;       # unlock mutex     });</p><p>The callback receives a guard (see AnyEvent::Util#guard) which unlocks the mutex. Hold the guard while You need locked resourse.</p><p><em>is_locked</em></p><p>Returns <strong>\s-1TRUE\s0</strong> if mutex is locked now. Usually You shoudn't use the function.</p>
<h3>rw_mutex</h3>
<p>returns unlocked read-write mutex.</p><p>This object provides the following methods:</p><p><em>rlock(\s-1CODEREF\s0)</em></p><p>You declare that You want to lock mutex for reading. When it is possible the mutex will be locked and Your callback will be called.</p><p>There may be a lot of read processes running simultaneously that catch the lock.</p><p><em>wlock(\s-1CODEREF\s0).</em></p><p>You declare that You want to lock mutex for writing. When it is possible the mutex will be locked and Your callback will be called.</p><p>There may be only one write process that catches the lock.</p><p>Both callbacks receive a guard to hold the mutex locked.</p><p><em>rlock_limit(\s-1NUMBER\s0)</em></p><p>Get/Set count limit for rlock. If an rlock request is come and this limit is reached the request will be queued.</p><p><em>is_locked</em></p><p>Returns <strong>\s-1TRUE\s0</strong> if the mutex has 'read' or 'write' lock status.</p><p><em>is_rlocked</em></p><p>Returns <strong>\s-1TRUE\s0</strong> if the mutex has 'read' lock status.</p><p><strong>Important</strong>: this method returns <strong>\s-1FALSE\s0</strong> if the mutex is wlocked (is_wlocked), so if You want to know if any lock is set, use the function is_locked.</p><p><em>is_wlocked</em></p><p>Returns <strong>\s-1TRUE\s0</strong> if the mutex has 'write' lock status.</p><p>Usually You shoudn't use is_[rw]?locked functions.</p>
<h3>async_repeat(\s-1COUNT\s0, \s-1CALLBACK\s0 [, \s-1DONE_CALLBACK\s0 ])</h3>
<p>Repeats calling Your callback(s).</p><p>    async_repeat 10, sub { $count++ };     async_repeat 20, sub { $count++ }, sub { $done = 1 };</p><p>The function async_repeat returns the guard if it is called in non-void context. Destroy the guard if You want to cancel iterations.</p><p>Iteration callback receives the following arguments:</p>
<dl class='dl-vertical'>
  <dt>
    1. guard
  </dt>
  <dd>
    <p>The next iteration will not start until the guard is destroyed.</p>
  </dd>
  <dt>
    2. iteration number
  </dt>
  <dd>
    <p>The number of current iteration.</p>
  </dd>
  <dt>
    3. first_flag
  </dt>
  <dd>
    <p>\s-1TRUE\s0 on the first iteration.</p>
  </dd>
  <dt>
    4. last_flag
  </dt>
  <dd>
    <p>\s-1TRUE\s0 on the last iteration.</p>
  </dd>

</dl>

<h3>async_for(HASREF|ARRAYREF, \s-1CALLBACK\s0 [, \s-1DONE_CALLBACK\s0 ]);</h3>
<p>Calls Your callbacks for each array or hash element.</p><p>The function returns the guard if it is called in non-void context. Destroy the guard if You want to cancel iterations.</p><p>If You process an array using the function, iteration callback will receive the following arguments:</p>
<dl class='dl-vertical'>
  <dt>
    1. guard
  </dt>
  <dd>
    <p>The next iteration will not start until the guard is destroyed.</p>
  </dd>
  <dt>
    2. element
  </dt>
  <dd>
    <p>Next array element.</p>
  </dd>
  <dt>
    3. index
  </dt>
  <dd>
    <p>Index of array element.</p>
  </dd>
  <dt>
    4. first_flag
  </dt>
  <dd>
    <p>The iteration is the first.</p>
  </dd>
  <dt>
    5. last_flag
  </dt>
  <dd>
    <p>The iteration is the last.</p>
  </dd>

</dl>
<p>If You process a hash using the function, iteration callback will receive the following arguments:</p>
<dl class='dl-vertical'>
  <dt>
    1. guard
  </dt>
  <dd>
    <p>The next iteration will not start until the guard is destroyed.</p>
  </dd>
  <dt>
    2. key
  </dt>
  <dd>
    
  </dd>
  <dt>
    3. value
  </dt>
  <dd>
    
  </dd>
  <dt>
    4. first_flag
  </dt>
  <dd>
    <p>The iteration is the first.</p>
  </dd>
  <dt>
    5. last_flag
  </dt>
  <dd>
    <p>The iteration is the last.</p>
  </dd>

</dl>

<h3>async_rfor(HASREF|ARRAYREF, \s-1CALLBACK\s0 [, \s-1DONE_CALLBACK\s0 ]);</h3>
<p>The same as async_for but has reverse sequence.</p>
<h3>pool</h3>
<p>Returns the object that incapsulates object collection. You can cacth one object of the collection using the method:</p><p><em>get($callback)</em></p><p>    $pool-&gt;get(sub { my ($guard, $object) = @_; ... });</p><p>If there is a free object in the pool, Your callback will be called. The callback receives also a guard. Hold the guard while You use the object.</p><p>There are also a few methods:</p><p><em>push($object);</em></p><p>    my $id = $pool-&gt;push($dbh);</p><p>Add an object in pool. Returns the object's identifier. You can use that to delete the object from pool:</p><p><em>delete($id)</em></p><p>    $pool-&gt;delete($id);     $pool-&gt;delete($id, sub { # on_delete });</p><p>Deletes object from pool.</p><p><strong>Note</strong>: The function will croak if it receives an ivalid object id.</p>
<h3>buffer</h3>
<p>Returns the buffer object. Can receive a few named arguments: interval, size, on_flush. They are the same that the following functions.</p><p>It provides the following methods:</p><p><em>push</em></p><p>Push the object into buffer.</p><p>    $buffer-&gt;push(123);     $buffer-&gt;push($obj);     $buffer-&gt;push(1,2,3);</p><p><em>unshift</em></p><p>Unshift the object into buffer</p><p>    $buffer-&gt;unshift(123);     $buffer-&gt;unshift(1,2,3);</p><p><em>unshift_back</em></p><p>The function can be called only inside on_flush handler (until its guard destroyed). It can be used to unshift non-flushed data (for example: if an error was occured) back to buffer. Receives <strong>\s-1ARRAYREF\s0</strong> (like on_flush's callback).</p><p><em>flush</em></p><p>Flush buffer (calls on_flush function)</p><p><em>interval</em></p><p>Get/Set autoflush interval (zero == periodical autoflush is disabled)</p><p><em>size</em></p><p>Get/Set buffer size (zero == buffer overflow autoflush is disabled)</p><p><em>unique_cb</em></p><p>If the callback is defined it will be called for each pushing element to determine its key value. If the key has already appeared since last flush the element will be ignored. So buffer will contain only unique objects.</p><p><em>on_flush</em></p><p>Set flush callback. It will be called if flush function is called or buffer overflow is detected or timeout is exceeded.</p><p>The callback receives two arguments:</p>
<dl class='dl-vertical'>
  <dt>
    guard
  </dt>
  <dd>
    <p>If You hold the guard, and user calls flush, flushing will be delayed.</p>
  </dd>
  <dt>
    arrayref
  </dt>
  <dd>
    <p>Reference to object list that were accumulated.</p>
  </dd>

</dl>


        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO AnyEvent::Tools&hellip;</h2>
        <div class="sectioncontent">
<p>AnyEvent</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>Dmitry E. Oboukhov, &lt;unera@debian.org&gt;</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COPYRIGHT AND LICENSE</h2>
        <div class="sectioncontent">
<p>Copyright (C) 2011 by Dmitry E. Oboukhov</p><p>This library is free software; you can redistribute it and/or modify it under the same terms as Perl itself, either Perl version 5.10.1 or, at your option, any later version of Perl 5 you may have available.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">VCS</h2>
        <div class="sectioncontent">
<p>The project is placed in my git repo. See here: &lt;http://git.uvw.ru/?p=anyevent-tools;a=summary&gt;</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="AnyEvent::Serialize.3pm.html"><span aria-hidden="true">&larr;</span> AnyEvent::Serialize.3pm: Async serialize/deserialize function</a></li>
   <li class="next"><a href="Apache2::AuthCASSimple.3pm.html">Apache2::AuthCASSimple.3pm: Apache2 module to authentificate through a cas server <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
