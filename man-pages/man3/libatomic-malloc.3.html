<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>libatomic-malloc: Library providing simple almost-lock-free malloc implementation</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Library providing simple almost-lock-free malloc implementation">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="libatomic-malloc (3) manual">
  <meta name="twitter:description" content="Library providing simple almost-lock-free malloc implementation">
  <meta name="twitter:image" content="https://www.carta.tech/images/libatomic-ops-dev-libatomic-malloc-3.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3/libatomic-malloc.3.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="libatomic-malloc (3) manual" />
  <meta property="og:description" content="Library providing simple almost-lock-free malloc implementation" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libatomic-ops-dev-libatomic-malloc-3.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">libatomic-malloc<small> (3)</small></h1>
        <p class="lead">Library providing simple almost-lock-free malloc implementation</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/">
      <span itemprop="name">Library calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/libatomic-malloc.3.html">
      <span itemprop="name">libatomic-malloc: Library providing simple almost-lock-free malloc implementation</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libatomic-ops-dev/">
      <span itemprop="name">libatomic-ops-dev</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/libatomic-malloc.3.html">
      <span itemprop="name">libatomic-malloc: Library providing simple almost-lock-free malloc implementation</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">
<p><strong>#include &lt;atomic_ops_malloc.h&gt;</strong></p><p><strong>cc ... -latomic_ops_gpl</strong></p><p>Note that the AO_malloc implementation is licensed under the GPL, unlike the lower level routines.</p><p><strong>void *AO_malloc(size_t sz);</strong></p><p><strong>void AO_free(void *p);</strong></p><p><strong>void AO_malloc_enable_mmap(void);</strong></p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>A simple almost-lock-free malloc implementation.</p><p>This is intended as a safe way to allocate memory from a signal handler, or to allocate memory in the context of a library that does not know what thread library it will be used with.  In either case locking is impossible.</p><p>Note that the operations are only guaranteed to be 1-lock-free, i.e. a single blocked thread will not prevent progress, but multiple blocked threads may.  To safely use these operations in a signal handler, the handler should be non-reentrant, i.e. it should not be interruptable by another handler using these operations.  Furthermore use outside of signal handlers in a multithreaded application should be protected by a lock, so that at most one invocation may be interrupted by a signal. The header will define the macro <em>AO_MALLOC_IS_LOCK_FREE</em> on platforms on which malloc is completely lock-free, and hence these restrictions do not apply.</p><p>In the presence of threads, but absence of contention, the time performance of this package should be as good, or slightly better than, most system malloc implementations.  Its space performance is theoretically optimal (to within a constant factor), but probably quite poor in practice.  In particular, no attempt is made to coalesce free small memory blocks.  Something like Doug Lea's malloc is likely to use significantly less memory for complex applications.</p><p>Perfomance on platforms without an efficient compare-and-swap implementation will be poor.</p><p>This package was not designed for processor-scalability in the face of high allocation rates.  If all threads happen to allocate different-sized objects, you might get lucky.  Otherwise expect contention and false-sharing problems.  If this is an issue, something like Maged Michael's algorithm (PLDI 2004) would be technically a far better choice.  If you are concerned only with scalablity, and not signal-safety, you might also consider using Hoard instead.  We have seen a factor of 3 to 4 slowdown from the standard glibc malloc implementation with contention, even when the performance without contention was faster.  (To make the implementation more scalable, one would need to replicate at least the free list headers, so that concurrent access is possible without cache conflicts.)</p><p>Unfortunately there is no portable async-signal-safe way to obtain large chunks of memory from the OS.  Based on reading of the source code, mmap-based allocation appears safe under Linux, and probably BSD variants. It is probably unsafe for operating systems built on Mach, such as Apple's Darwin.  Without use of mmap, the allocator is limited to a fixed size, statically preallocated heap (2MB by default), and will fail to allocate objects above a certain size (just under 64K by default).  Use of mmap to circumvent these limitations requires an explicit call.</p><p>The entire interface to the AO_malloc package currently consists of:</p>
<dl class='dl-vertical'>
  <dt>
    <p><strong>AO_malloc</strong></p>
  </dt>
  <dd>
    <p>Allocate an area of memory</p>
  </dd>
  <dt>
    <p><strong>AO_free</strong></p>
  </dt>
  <dd>
    <p>Free a previously malloced memory area</p>
  </dd>
  <dt>
    <p>AO_malloc_enable_mmap</p>
  </dt>
  <dd>
    <p>Enable mmap for large malloc chunks</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO libatomic-malloc&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man3/libatomic-ops.3.html"><strong>libatomic-ops</strong>(3)</a>, <strong>libatomic-stack</strong>(3)</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHOR</h2>
        <div class="sectioncontent">
<p>This manual page was written by Ian Wienand &lt;ianw@gelato.unsw.edu.au&gt;, based on comments in the source code.  It was written for the Debian project (but may be used by others).</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="libast-config.3.html"><span aria-hidden="true">&larr;</span> libast-config.3: Libast build information script</a></li>
   <li class="next"><a href="libatomic-ops.3.html">libatomic-ops.3: Library providing user level atomic operations <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
