<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Object::Destroyer: Make objects with circular references destroy normally</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Make objects with circular references destroy normally">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="Object::Destroyer (3pm) manual">
  <meta name="twitter:description" content="Make objects with circular references destroy normally">
  <meta name="twitter:image" content="https://www.carta.tech/images/libobject-destroyer-perl-Object::Destroyer-3pm.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3pm/Object::Destroyer.3pm.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Object::Destroyer (3pm) manual" />
  <meta property="og:description" content="Make objects with circular references destroy normally" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libobject-destroyer-perl-Object::Destroyer-3pm.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">Object::Destroyer<small> (3pm)</small></h1>
        <p class="lead">Make objects with circular references destroy normally</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/">
      <span itemprop="name">MISSING SECTION</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/Object::Destroyer.3pm.html">
      <span itemprop="name">Object::Destroyer: Make objects with circular references destroy normally</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libobject-destroyer-perl/">
      <span itemprop="name">libobject-destroyer-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/Object::Destroyer.3pm.html">
      <span itemprop="name">Object::Destroyer: Make objects with circular references destroy normally</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
  use Object::Destroyer;

  ## Use a standalone destroyer to release something
  ## when it falls out of scope
  BLOCK:
  {
      my $tree = HTML::TreeBuilder-&gt;new_from_file(&apos;somefile.html&apos;);
      my $sentry = Object::Destroyer-&gt;new( $tree, &apos;delete&apos; );
      ## Here you can safely die, return, call last BLOCK or next BLOCK.
      ## The tree will be deleted automatically
  }

  ## Use it to break circular references
  {
      my $var;
      $var = &#92;$var;
      my $sentry =  Object::Destroyer-&gt;new( sub {undef $var} );
      ## No more memory leaks!
      ## $var will be released when $sentry leaves the block
  }

  ## Destroyer can be used as a nearly transparent wrapper
  ## that will pass on method calls normally.
  {
      my $Mess = Big::Custy::Mess-&gt;new;
      print $Mess-&gt;hello;
  }

  package Big::Crusty::Mess;
  sub new {
      my $self = bless {}, shift;
      $self-&gt;populate;
      return Object::Destroyer-&gt;new( $self, &apos;release&apos; );
  }
  sub hello { "Hello World!" }
  sub release { ...actual code to clean-up the memory... }
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>One of the biggest problem with working with large, nested object trees is implementing a way for a child node to see its parent. The easiest way to do this is to add a reference to the child back to its parent.</p><p>This results in a \*(L"circular\*(R" reference, where A refers to B refers to A. Unfortunately, the garbage collector perl uses during runtime is not capable of knowing whether or not something \s-1ELSE\s0 is referring to these circular references.</p><p>In practical terms, this means that object trees in lexically scoped variable ( e.g. \*(C`my $Object = Tree-&gt;new\*(C' ) will not be cleaned up when they fall out of scope, like normal variables. This results in a memory leak for the life of the process, which is a bad thing when using mod_perl or other processes that live for a long time.</p><p>Object::Destroyer allows for the creation of \*(L"Destroy\*(R" handles. The handle is \*(L"attached\*(R" to the circular relationship, but is not a part of it. When the destroy handle falls out of scope, it will be cleaned up correctly, and while being cleaned up, it will also force the data structure it is attached to to be destroyed as well. Object::Destroyer can call a specified release method on an object (or method \s-1DESTROY\s0 by default). Alternatively, it can execute an arbitrary user code passed to constructor as a code reference.</p><h3>Use as a Standalone Handle</h3>
<p>The simplest way to use the class is to create a standalone destroyer, preferably in the same lexical content. ( i.e. immediately after creating the object to be destroyed)</p><p>  sub plagiarise {     # Parse in a large nested document     my $filename = shift;     my $document = My::XML::Tree-&gt;open($filename);</p><p>    # Create the Object::Destroyer to clean it up as needed     my $sentry = Object::Destroyer-&gt;new( $document, &apos;release&apos; );</p><p>    # Continue with the Document as normal     if ($document-&gt;author == $me) {         # Normally this would have leaked the document         return new Error("You already own the Document");     }</p><p>    $document-&gt;change_author($me);     $document-&gt;save;</p><p>    # We don&apos;t have to $Document-&gt;DESTROY here     return 1;   }</p><p>When the $sentry falls out of scope at the end of the sub, it will force the cirularly linked $Document to be cleaned up at the same time, rather than being forced to manually call \*(C`$Document-&lt;gt\*(C'release&gt; at each and every location that the sub could possible return.</p><p>Using the Object::Destroy object to force garbage collection to work properly allows you to neatly sidestep the inadequecies of the perl garbage collector and work the way you normally would, even with big objects.</p>
<h3>Use to clean-up data structures</h3>
<p>If a data structure with circular refereces has no method to release memory, you can create an \*(C`Object::Destroyer\*(C' object that will do the job. Pass a code reference (most probably created by an anonymous subrotine block) to the constructor of the sentry object, and this code will be called upon leaving the scope.</p><p>  {      $params{other}        = &#92;%other_params;      $other_params{params} = &#92;%params;</p><p>     my $sentry = Object::Destroyer-&gt;new( sub {undef $params{other}} );      ##      ## From now on, memory of %params will be      ## safely released when block is exited.      ##</p><p>     ... code with return, next or last ...</p><p>  }</p>
<h3>Use as a Transparent Wrapper</h3>
<p>For situations where a class is always going to produce circular references, you may wish to build this improved clean up directly into the class itself, and with a few exceptions everything will just work the same.</p><p>Take the following example class</p><p>  package My::Tree;</p><p>  use strict;   use Object::Destroyer;</p><p>  sub new {       my $self = bless {}, shift;       $self-&gt;init; ## assume that circular references are made</p><p>      ## Return the Object::Destroyer, with ourself inside it       my $wrapper = Object::Destroyer-&gt;new( $self, &apos;release&apos; );       return $wrapper;   }</p><p>  sub release {     my $self = shift;     foreach (values %$self) {         $_-&gt;DESTROY if ref $_ eq &apos;My::Tree::Node&apos;;     }     %$self = ();   }</p><p>We might use the class in something like this</p><p>  sub process_file {       # Create a new tree       my $tree = My::Tree-&gt;new( source =&gt; shift );</p><p>      # Process the Tree       if ($tree-&gt;comments) {           $tree-&gt;remove_comments or return;       }       else {           return 1; # Nothing to do       }</p><p>      my $filename = $tree-&gt;param(&apos;target&apos;) or return;       $tree-&gt;write($filename) or return;</p><p>      return 1;   }</p><p>We were able to work with the data, and at no point did we know that we were working with a Object::Destroyer object, rather than the My::Tree object itself.</p>
<h3>Resource Usage</h3>
<p>To implement the transparency, there is a slight \s-1CPU\s0 penalty when a method is called on the wrapper to allow it to pass the method through to the encased object correctly, and without appearing in the <em>caller()</em> information. Once the method is called on the underlying object, you can make further method calls with no penalty and access the internals of the object normally.</p>
<h3>Problems with Wrappers and ref or UNIVERSAL::isa</h3>
<p>Although it may \s-1ACT\s0 exactly like what's inside it, is isn't really it. Calling \*(C`ref $wrapper\*(C' or \*(C`blessed $wrapper\*(C' will return &apos;Object::Destroyer&apos;, and not the class of the object inside it.</p><p>Likewise, calling \*(C`UNIVERSAL::isa( $wrapper, &apos;My::Tree&apos; )\*(C' or \*(C`UNIVERSAL::can( $wrapper, &apos;param&apos; )\*(C' directly as functions will also not work. The two alternatives to this are to either use \*(C`$Wrapper-&gt;isa\*(C' or \*(C`$wrapper-&gt;can\*(C', which will be caught and treated normally, or simple don't use a wrapper and just use the standalone cleaners.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">METHODS</h2>
        <div class="sectioncontent">

<dl class='dl-vertical'>
  <dt>
    new
  </dt>
  <dd>
    <p>  my $sentry = Object::Destroyer-&gt;new( $object );   my $sentry = Object::Destroyer-&gt;new( $object, &apos;method_name&apos; );   my $sentry = Object::Destroyer-&gt;new( $code_reference ); The \*(C`new\*(C' constructor takes as arguments either a single blessed object with an optional name of the method to be called, or a refernce to code to be executed. If the method name is not specified, the \*(C`DESTROY\*(C' method is assumed. The constructor will die if the object passed to it does not have the specified method.</p>
  </dd>
  <dt>
    \s-1DESTROY\s0
  </dt>
  <dd>
    <p>  $sentry-&gt;DESTROY;   undef $sentry; If you wish, you may explicitly \s-1DESTROY\s0 the Destroyer at any time you wish. This will also \s-1DESTROY\s0 the encased object at the same. This can allow for legacy cases relating to Wrappers, where a user expects to have to manually \s-1DESTROY\s0 an object even though it is not needed. The \s-1DESTROY\s0 call will be accepted and dealt with as it is called on the encased object.</p>
  </dd>
  <dt>
    dismiss
  </dt>
  <dd>
    <p>  $sentry-&gt;dismiss; If you have changed your mind and you don't want Destroyer object to do its job, dismiss it. You may continue to use it as a wrapper, though.</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO Object::Destroyer&hellip;</h2>
        <div class="sectioncontent">
<p>Another option for dealing with circular references are \*(C`weak references\*(C' (stable since Perl 5.8.0, see Scalar::Util). See also GTop::Mem and Devel::Monitor for monitoring memory leaks. The latter module contains a discussion on object desing with weak references.</p><p>For lexically scoped resource management, see also Scope::Guard, Sub::ScopeFinalizer and Hook::Scope.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SUPPORT</h2>
        <div class="sectioncontent">
<p>Bugs should be reported via the \s-1CPAN\s0 bug tracker at</p><p>&lt;http://rt.cpan.org/NoAuth/ReportBug.html?Queue=Object-Destroyer&gt;</p><p>For other issues, or commercial enhancement or support, contact the Adam Kennedy.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHORS</h2>
        <div class="sectioncontent">
<p>Adam Kennedy &lt;adamk@cpan.org&gt; and Igor Gariev &lt;gariev@hotmail.com&gt;</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">COPYRIGHT</h2>
        <div class="sectioncontent">
<p>Copyright 2004 - 2006 Adam Kennedy.</p><p>This program is free software; you can redistribute it and/or modify it under the same terms as Perl itself.</p><p>The full text of the license can be found in the \s-1LICENSE\s0 file included with this module.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="Object::Declare.3pm.html"><span aria-hidden="true">&larr;</span> Object::Declare.3pm: Declarative object constructor</a></li>
   <li class="next"><a href="Object::Event.3pm.html">Object::Event.3pm: A class that provides an event callback interface <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
