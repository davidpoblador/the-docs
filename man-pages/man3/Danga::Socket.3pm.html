<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Danga::Socket: Event loop and event-driven async socket base class</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Event loop and event-driven async socket base class">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="Danga::Socket (3pm) manual">
  <meta name="twitter:description" content="Event loop and event-driven async socket base class">
  <meta name="twitter:image" content="https://www.carta.tech/images/libdanga-socket-perl-Danga::Socket-3pm.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3pm/Danga::Socket.3pm.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Danga::Socket (3pm) manual" />
  <meta property="og:description" content="Event loop and event-driven async socket base class" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libdanga-socket-perl-Danga::Socket-3pm.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">Danga::Socket<small> (3pm)</small></h1>
        <p class="lead">Event loop and event-driven async socket base class</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/">
      <span itemprop="name">MISSING SECTION</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/Danga::Socket.3pm.html">
      <span itemprop="name">Danga::Socket: Event loop and event-driven async socket base class</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libdanga-socket-perl/">
      <span itemprop="name">libdanga-socket-perl</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3pm/Danga::Socket.3pm.html">
      <span itemprop="name">Danga::Socket: Event loop and event-driven async socket base class</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">SYNOPSIS</h2>
        <div class="sectioncontent">

<pre>
  package My::Socket
  use Danga::Socket;
  use base (&apos;Danga::Socket&apos;);
  use fields (&apos;my_attribute&apos;);

  sub new {
     my My::Socket $self = shift;
     $self = fields::new($self) unless ref $self;
     $self-&gt;SUPER::new( @_ );

     $self-&gt;{my_attribute} = 1234;
     return $self;
  }

  sub event_err { ... }
  sub event_hup { ... }
  sub event_write { ... }
  sub event_read { ... }
  sub close { ... }

  $my_sock-&gt;tcp_cork($bool);

  # write returns 1 if all writes have gone through, or 0 if there
  # are writes in queue
  $my_sock-&gt;write($scalar);
  $my_sock-&gt;write($scalarref);
  $my_sock-&gt;write(sub { ... });  # run when previous data written
  $my_sock-&gt;write(undef);        # kick-starts

  # read max $bytecount bytes, or undef on connection closed
  $scalar_ref = $my_sock-&gt;read($bytecount);

  # watch for writability.  not needed with -&gt;write().  write()
  # will automatically turn on watch_write when you wrote too much
  # and turn it off when done
  $my_sock-&gt;watch_write($bool);

  # watch for readability
  $my_sock-&gt;watch_read($bool);

  # if you read too much and want to push some back on
  # readable queue.  (not incredibly well-tested)
  $my_sock-&gt;push_back_read($buf); # scalar or scalar ref

  Danga::Socket-&gt;AddOtherFds(..);
  Danga::Socket-&gt;SetLoopTimeout($millisecs);
  Danga::Socket-&gt;DescriptorMap();
  Danga::Socket-&gt;WatchedSockets();  # count of DescriptorMap keys
  Danga::Socket-&gt;SetPostLoopCallback($code);
  Danga::Socket-&gt;EventLoop();
</pre>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>This is an abstract base class for objects backed by a socket which provides the basic framework for event-driven asynchronous \s-1IO\s0, designed to be fast.  Danga::Socket is both a base class for objects, and an event loop.</p><p>Callers subclass Danga::Socket.  Danga::Socket's constructor registers itself with the Danga::Socket event loop, and invokes callbacks on the object for readability, writability, errors, and other conditions.</p><p>Because Danga::Socket uses the \*(L"fields\*(R" module, your subclasses must too.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">MORE INFO</h2>
        <div class="sectioncontent">
<p>For now, see servers using Danga::Socket for guidance.  For example: perlbal, mogilefsd, or ddlockd.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">API</h2>
        <div class="sectioncontent">
<p>Note where "\*(C`CLASS\*(C'" is used below, normally you would call these methods as:</p><p>  Danga::Socket-&gt;method(...);</p><p>However using a subclass works too.</p><p>The \s-1CLASS\s0 methods are all methods for the event loop part of Danga::Socket, whereas the object methods are all used on your subclasses. Reset all state Returns a true value if this class will use IO::Epoll for async \s-1IO\s0. Returns the number of file descriptors which are registered with the global poll object. Turns profiling on, clearing current profiling data. Turns off profiling, but retains data up to this point Returns reference to a hash of data in format:</p><p>  ITEM =&gt; [ utime, stime, #calls ] Return the list of sockets that are awaiting <em>close()</em> at the end of the current event loop. Get/set the hash of file descriptors that need processing in parallel with the registered Danga::Socket objects. Add fds to the OtherFds hash for processing. Set the loop timeout for the event loop to some value in milliseconds.</p><p>A timeout of 0 (zero) means poll forever. A timeout of -1 means poll and return immediately. Print the debugging message specified by the \*(C`sprintf\*(C'-style <em>format</em> and <em>args</em> Add a timer to occur $seconds from now. $seconds may be fractional, but timers are not guaranteed to fire at the exact time you ask for.</p><p>Returns a timer object which you can call \*(C`$timer-&gt;cancel\*(C' on if you need to. Get the hash of Danga::Socket objects keyed by the file descriptor (fileno) they are wrapping.</p><p>Returns a hash in list context or a hashref in scalar context. Start processing \s-1IO\s0 events. In most daemon programs this never exits. See \*(C`PostLoopCallback\*(C' below for how to exit the loop. Sets post loop callback function.  Pass a subref and it will be called every time the event loop finishes.</p><p>Return 1 (or any true value) from the sub to make the loop continue, 0 or false and it will exit.</p><p>The callback function will be passed two parameters: &#92;%DescriptorMap, &#92;%OtherFds.</p><h3>\s-1OBJECT\s0 \s-1METHODS\s0</h3>
<p>Create a new Danga::Socket subclass object for the given <em>socket</em> which will react to events on it during the \*(C`EventLoop\*(C'.</p><p>This is normally (always?) called from your subclass via:</p><p>  $class-&gt;SUPER::new($socket); Turn \s-1TCP_CORK\s0 on or off depending on the value of <em>boolean</em>. Basically returns our socket and makes it so that we don't try to close it, but we do remove it from epoll handlers.  \s-1THIS\s0 \s-1CLOSES\s0 $self.  It is the same thing as calling close, except it gives you the socket to use. Close the socket. The <em>reason</em> argument will be used in debugging messages. Returns the underlying IO::Handle for the object. Sets a function to use instead of \*(C`syswrite()\*(C' when writing data to the socket. Write the specified data to the underlying handle.  <em>data</em> may be scalar, scalar ref, code ref (to run when there), or undef just to kick-start. Returns 1 if writes all went through, or 0 if there are writes in queue. If it returns 1, caller should stop waiting for 'writable' events) Push back <em>buf</em> (a scalar or scalarref) into the read stream. Useful if you read more than you need to and want to return this data on the next \*(L"read\*(R". Read at most <em>bytecount</em> bytes from the underlying handle; returns scalar ref on read, or undef on connection closed. Readable event handler. Concrete deriviatives of Danga::Socket should provide an implementation of this. The default implementation will die if called. Error event handler. Concrete deriviatives of Danga::Socket should provide an implementation of this. The default implementation will die if called. 'Hangup' event handler. Concrete deriviatives of Danga::Socket should provide an implementation of this. The default implementation will die if called. Writable event handler. Concrete deriviatives of Danga::Socket may wish to provide an implementation of this. The default implementation calls \*(C`write()\*(C' with an \*(C`undef\*(C'. Turn 'readable' event notification on or off. Turn 'writable' event notification on or off. Prints to \s-1STDERR\s0 a backtrace with information about this socket and what lead up to the dump_error call. Print the debugging message specified by the \*(C`sprintf\*(C'-style <em>format</em> and <em>args</em>. Returns the string describing the peer's \s-1IP\s0 Returns the string describing the peer for the socket which underlies this object in form \*(L"ip:port\*(R" Returns the string describing the local \s-1IP\s0 Returns the string describing the local end of the socket which underlies this object in form \*(L"ip:port\*(R" Returns a string describing this socket.</p>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">AUTHORS</h2>
        <div class="sectioncontent">
<p>Brad Fitzpatrick &lt;brad@danga.com&gt; - author</p><p>Michael Granger &lt;ged@danga.com&gt; - docs, testing</p><p>Mark Smith &lt;junior@danga.com&gt; - contributor, heavy user, testing</p><p>Matt Sergeant &lt;matt@sergeant.org&gt; - kqueue support, docs, timers, other bits</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">BUGS</h2>
        <div class="sectioncontent">
<p>Not documented enough (but isn't that true of every project?).</p><p>tcp_cork only works on Linux for now.  No \s-1BSD\s0 push/nopush support.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">LICENSE</h2>
        <div class="sectioncontent">
<p>License is granted to use and distribute this module under the same terms as Perl itself.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="Dancer::Session::Memcached.3pm.html"><span aria-hidden="true">&larr;</span> Dancer::Session::Memcached.3pm: Memcached-based session backend for dancer</a></li>
   <li class="next"><a href="Data::BitMask.3pm.html">Data::BitMask.3pm: Bitmask manipulation <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
