<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700&effect=destruction%7Cshadow-multiple" rel="stylesheet" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>pmRegisterDerived: Register a derived metric name and definition</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/manpage.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="manifest" href="/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Register a derived metric name and definition">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@CartaTech">
  <meta name="twitter:creator" content="@CartaTech">
  <meta name="twitter:title" content="pmRegisterDerived (3) manual">
  <meta name="twitter:description" content="Register a derived metric name and definition">
  <meta name="twitter:image" content="https://www.carta.tech/images/libpcp3-dev-pmRegisterDerived-3.png">
  <meta property="og:url" content="https://www.carta.tech/man-pages/man3/pmRegisterDerived.3.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="pmRegisterDerived (3) manual" />
  <meta property="og:description" content="Register a derived metric name and definition" />
  <meta property="fb:app_id" content="1241677679199500" />
  <meta property="og:image" content="https://www.carta.tech/images/libpcp3-dev-pmRegisterDerived-3.png" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="315" />
</head>
<body>
  <div class="container final">
          <div class="page-header">
        <h1 class="font-effect-destruction">pmRegisterDerived<small> (3)</small></h1>
        <p class="lead">Register a derived metric name and definition</p>
      </div>

    <ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/">
      <span itemprop="name">Man Pages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/">
      <span itemprop="name">Library calls</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/pmRegisterDerived.3.html">
      <span itemprop="name">pmRegisterDerived: Register a derived metric name and definition</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
<ol class="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/">
      <span itemprop="name">Carta.tech</span>
    </a>
    <meta itemprop="position" content="1" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/">
      <span itemprop="name">Packages</span>
    </a>
    <meta itemprop="position" content="2" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/packages/libpcp3-dev/">
      <span itemprop="name">libpcp3-dev</span>
    </a>
    <meta itemprop="position" content="3" />
  </li>
  <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
    <a itemscope itemtype="http://schema.org/Thing" itemprop="item" href="/man-pages/man3/pmRegisterDerived.3.html">
      <span itemprop="name">pmRegisterDerived: Register a derived metric name and definition</span>
    </a>
    <meta itemprop="position" content="4" />
  </li>
</ol>
    
      <section>
        <h2 class="font-effect-shadow-multiple">C SYNOPSIS</h2>
        <div class="sectioncontent">
<p>#include &lt;pcp/pmapi.h&gt;</p><p>char *pmRegisterDerived(char *<em>name</em>, char *<em>expr</em>);</p><p>cc ... -lpcp</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DESCRIPTION</h2>
        <div class="sectioncontent">
<p>Derived metrics provide a way of extending the Performance Metrics Name Space (PMNS) with new metrics defined at the PCP client-side using arithmetic expressions over the existing performance metrics.</p><p>Typical uses would be to aggregate a number of similar metrics to provide a higher-level summary metric or to support the ``delta V over delta V'' class of metrics that are not possible in the base data semantics of PCP. An example of the latter class would be the average I/O size, defined as</p><p>delta(disk.dev.total_bytes) / delta(disk.dev.total) where both of the disk.dev metrics are counters, and what is required is to to sample both metrics, compute the difference between the current and previous values and then calculate the ratio of these differences.</p><p>The arguments to <strong>pmRegisterDerived</strong> are the <em>name</em> of the new derived metric and <em>expr</em> is an arithmetic expression defining how the values of <em>name</em> should be computed.</p><p><em>name</em> should follow the syntactic rules for the names of performance metrics, namely one or more components separated with a dot (``.''), and each component must begin with an alphabetic followed by zero or more characters drawn from the alphabetics, numerics and underscore (``_''). For more details, refer to <a href="../man1/PCPIntro.1.html"><strong>PCPIntro</strong>(1)</a> and <a href="../man5/pmns.5.html"><strong>pmns</strong>(5)</a>.</p><p><em>name</em> must be unique across all derived metrics and should <strong>not</strong> match the name of any regular metric in the PMNS.  It is acceptable for <em>name</em> to share some part of its prefix with an existing subtree of the PMNS, e.g. the average I/O size metric above could be named disk.dev.avgsz which would place it amongst the other disk.dev metrics in the PMNS. Alternatively, derived metrics could populate their own subtree of the PMNS, e.g. the average I/O size metric above could be named my.summary.disk.avgsz .ft R .</p><p>The expression <em>expr</em> follows these syntactic rules:</p><ul>
<li><p>Terminal elements are either names of existing metrics or integer constants. Recursive definitions are not allowed, so only the names of regular metrics (not other derived metrics) may be used. Integer constants are constrained to the precision of 32-bit unsigned integers.</p></li><li><p>The usual binary arithmetic operators are supported, namely - addition (``+''), subtraction (``-''), multiplication (``*'') and division (``/'') with the normal precedence rules where multiplication and division have higher precedence than addition and subtraction, so a+b*c is evaluated as a+(b*c) .ft R</p></li><li><p>Parenthesis may be used for grouping.</p></li><li><p>The following unary functions operate on a single performance metric and return one or more values. For all functions (except count() .ft R ), the type of the operand metric must be arithmetic (integer of various sizes and signedness, float or double).</p><table class="table table-striped">
<tr>
<th>Function</th>
<th>Value</th>
<th></th></tr>

<tr>
<td>avg(x)</td>
<td>A singular instance being the average value across all instances for the metric x.  </td>
<td>count(x)</td></tr>

<tr>
<td>A singular instance being the count of the number of instances for the metric x.  </td>
<td>delta(x)</td>
<td>Returns the difference in values for the metric x between   one call to   <a href="../man3/pmFetch.3.html"><strong>pmFetch</strong>(3)</a>   and the next. There is one value in the result   for each instance that appears in both the current and the previous   sample.  </td></tr>

<tr>
<td>rate(x)</td>
<td>Returns the difference in values for the metric x between   one call to   <a href="../man3/pmFetch.3.html"><strong>pmFetch</strong>(3)</a>   and the next divided by the elapsed time between the calls to   <a href="../man3/pmFetch.3.html"><strong>pmFetch</strong>(3)</a>.   The semantics of the derived metric are based on the semantics of the   operand (x) with the dimension in the   <strong>time</strong>   domain decreased by one and scaling if required in the time utilization case   where the operand is in units of time, and the derived metric is unitless.   This mimics the rate conversion applied to counter metrics by tools   such as   <a href="../man1/pmval.1.html"><strong>pmval</strong>(1)</a>,   <a href="../man1/pmie.1.html"><strong>pmie</strong>(1)</a>   and   <a href="../man1/pmchart.1.html"><strong>pmchart</strong>(1)</a>.   There is one value in the result   for each instance that appears in both the current and the previous   sample.  </td>
<td>max(x)</td></tr>

<tr>
<td>A singular instance being the maximum value across all instances for the metric x.  </td>
<td>min(x)</td>
<td>A singular instance being the minimum value across all instances for the metric x.  </td></tr>

<tr>
<td>sum(x)</td>
<td>A singular instance being the sum of the values across all instances for the metric x.  </td></tr>
</table></li><li><p>White space is ignored.</p></li>
</ul><p>Syntactic checking is performed at the time <strong>pmRegisterDerived</strong> is called, but semantic checking is deferred until each new context is created with <a href="../man3/pmNewContext.3.html"><strong>pmNewContext</strong>(3)</a> or re-established with <a href="../man3/pmReconnectContext.3.html"><strong>pmReconnectContext</strong>(3)</a>, at which time the PMNS and metadata is available to allow semantic checking and the metadata of the derived metrics to be established.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">SEMANTIC CHECKS AND RULES</h2>
        <div class="sectioncontent">
<p>There are a number of conversions required to determine the metadata for a derived metric and to ensure the semantics of the expressions are sound.</p><p>In a binary expression, if the semantics of both operands is not a counter (i.e. PM_SEM_INSTANT or PM_SEM_DISCRETE) then the result will have semantics PM_SEM_INSTANT unless both operands are PM_SEM_DISCRETE in which case the result is also PM_SEM_DISCRETE.</p><p>The mapping of the pmUnits of the metadata uses the following rules:</p><ul>
<li><p>If both operands have a dimension of COUNT and the scales are not the same, use the larger scale and convert the values of the operand with the smaller scale.</p></li><li><p>If both operands have a dimension of TIME and the scales are not the same, use the larger scale and convert the values of the operand with the smaller scale.</p></li><li><p>If both operands have a dimension of SPACE and the scales are not the same, use the larger scale and convert the values of the operand with the smaller scale.</p></li><li><p>For addition and subtraction all dimensions for each of the operands and result are identical.</p></li><li><p>For multiplication, the dimensions of the result are the sum of the dimensions of the operands.</p></li><li><p>For division, the dimensions of the result are the difference of the dimensions of the operands.</p></li>
</ul><p>Scale conversion involves division if the dimension is positive else multiplication if the dimension is negative. If scale conversion is applied to either of the operands, the result is promoted to type PM_TYPE_DOUBLE.</p><p>Putting all of this together in an example, consider the derived metric defined as follows:</p><p>x = network.interface.speed - delta(network.interface.in.bytes) / delta(sample.milliseconds)</p><p>The type, dimension and scale settings would propagate up the expression tree as follows.</p><table class="table table-striped">
<tr>
<th>Expression</th>
<th>Type</th>
<th>Dimension & Scale      </th>
<th>Scale Factor(s)      </th>
<th>sample.milliseconds</th>
<th>DOUBLE</th>
<th>millisec</th></tr>

<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td>delta(...)</td>
<td>DOUBLE</td>
<td>millisec</td></tr>

<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td>network...bytes</td>
<td>U64</td>
<td>byte</td></tr>

<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td>delta(...)</td>
<td>U64</td>
<td>byte</td></tr>

<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td>delta(...) / delta(...)</td>
<td>DOUBLE</td>
<td>byte/millisec</td></tr>

<tr>
<td>/1048576 and *1000      </td>
<td>network...speed</td>
<td>FLOAT</td>
<td>Mbyte/sec</td>
<td></td>
<td></td>
<td></td></tr>

<tr>
<td></td>
<td>x</td>
<td>DOUBLE</td>
<td>Mbyte/sec</td>
<td></td>
<td></td>
<td></td></tr>

<tr>
<td></td></tr>
</table><p>Because semantic checking cannot be done at the time <strong>pmRegisterDerived</strong> is called, errors found during semantic checking are reported using <a href="../man3/pmprintf.3.html"><strong>pmprintf</strong>(3)</a>. These include:</p>
<dl class='dl-vertical'>
  <dt>
    <p>Error: derived metric &lt;name1&gt;: operand: &lt;name2&gt;: &lt;reason&gt;</p>
  </dt>
  <dd>
    <p>There was a problem calling <a href="../man3/pmLookupName.3.html"><strong>pmLookupName</strong>(3)</a> to identify the operand metric &lt;name2&gt; used in the definition of the derived metric &lt;name1&gt;.</p>
  </dd>
  <dt>
    <p>Error: derived metric &lt;name1&gt;: operand (&lt;name2&gt; [&lt;pmid2&gt;]): &lt;reason&gt;</p>
  </dt>
  <dd>
    <p>There was a problem calling <a href="../man3/pmLookupDesc.3.html"><strong>pmLookupDesc</strong>(3)</a> to identify the operand metric &lt;name2&gt; with PMID &lt;pmid2&gt; used in the definition of the derived metric &lt;name1&gt;.</p>
  </dd>
  <dt>
    <p>Semantic error: derived metric &lt;name&gt;: &lt;operand&gt; &lt;op&gt; &lt;operand&gt;: Illegal operator for counters</p>
  </dt>
  <dd>
    <p>If both operands have the semantics of counter, only addition or subtraction make sense, so multiplication and division are not allowed.</p>
  </dd>
  <dt>
    <p>Semantic error: derived metric &lt;name&gt;: &lt;operand&gt; &lt;op&gt; &lt;operand&gt;: Illegal operator for counter and non-counter</p>
  </dt>
  <dd>
    <p>Only multiplication or division are allowed if the left operand has the semantics of a counter and the right operand is <strong>not</strong> a counter.</p>
  </dd>
  <dt>
    <p>Semantic error: derived metric &lt;name&gt;: &lt;operand&gt; &lt;op&gt; &lt;operand&gt;: Illegal operator for non-counter and counter</p>
  </dt>
  <dd>
    <p>Only multiplication is allowed if the right operand has the semantics of a counter and the left operand is <strong>not</strong> a counter.</p>
  </dd>
  <dt>
    <p>Semantic error: derived metric &lt;name&gt;: &lt;operand&gt; &lt;op&gt; &lt;operand&gt;: Non-arithmetic type for &lt;left-or-right&gt; operand</p>
  </dt>
  <dd>
    <p>The binary arithmetic operators are only allowed with operands with an arithmetic type (integer of various sizes and signedness, float or double).</p>
  </dd>
  <dt>
    <p>Semantic error: derived metric &lt;name&gt;: &lt;function&gt;(&lt;operand&gt;): Non-arithmetic operand for function</p>
  </dt>
  <dd>
    <p>The unary functions are only defined if the operand has arithmetic type.</p>
  </dd>
  <dt>
    <p>Semantic error: derived metric &lt;name&gt;: Incorrect time dimension for operand</p>
  </dt>
  <dd>
    <p>Rate conversion using the <strong>rate</strong>() function is only possible for operand metrics with a Time dimension of 0 or 1 (see <a href="../man3/pmLookupDesc.3.html"><strong>pmLookupDesc</strong>(3)</a>). If the operand metric's Time dimension is 0, then the derived metrics has a value "per second" (Time dimension of -1). If the operand metric's Time dimension is 1, then the derived metrics has a value of time utilization (Time dimension of 0).</p>
  </dd>

</dl>

        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">EXPRESSION EVALUATION</h2>
        <div class="sectioncontent">
<p>For the binary arithmetic operators, if either operand must be scaled (e.g. convert bytes to Kbytes) then the result is promoted to PM_TYPE_DOUBLE. Otherwise the type of the result is determined by the types of the operands, as per the following table which is evaluated from top to bottom until a match is found.</p><table class="table table-striped">
<tr>
<th>Operand Types</th>
<th>Operator</th>
<th>Result Type</th>
<th></th>
<th></th></tr>

<tr>
<td>either is PM_TYPE_DOUBLE</td>
<td>any</td>
<td>PM_TYPE_DOUBLE</td>
<td></td>
<td></td></tr>

<tr>
<td>any</td>
<td>division</td>
<td>PM_TYPE_DOUBLE</td>
<td></td>
<td></td></tr>

<tr>
<td>either is PM_TYPE_FLOAT</td>
<td>any</td>
<td>PM_TYPE_FLOAT</td>
<td></td>
<td></td></tr>

<tr>
<td>either is PM_TYPE_U64</td>
<td>any</td>
<td>PM_TYPE_U64</td>
<td></td>
<td></td></tr>

<tr>
<td>either is PM_TYPE_64</td>
<td>any</td>
<td>PM_TYPE_64</td>
<td></td>
<td></td></tr>

<tr>
<td>either is PM_TYPE_U32</td>
<td>any</td>
<td>PM_TYPE_U32</td>
<td></td>
<td></td></tr>

<tr>
<td>otherwise (both are PM_TYPE_32)    </td>
<td>any</td>
<td>PM_TYPE_32</td></tr>
</table>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">CAVEATS</h2>
        <div class="sectioncontent">
<p>Unary negation is not supported, so the following expressions would be syntactically incorrect, -3*abc and -this.number .ft R</p><p>Derived metrics are not available when using <a href="../man3/pmFetchArchive.3.html"><strong>pmFetchArchive</strong>(3)</a> as this routine does not use a target list of PMIDs that could be remapped (as is done for <a href="../man3/pmFetch.3.html"><strong>pmFetch</strong>(3)</a>).</p><p><strong>pmRegisterDerived</strong> does not apply retrospectively to any open contexts, so the normal use would be to make all calls to <strong>pmRegisterDerived</strong> (possibly via <a href="../man3/pmLoadDerivedConfig.3.html"><strong>pmLoadDerivedConfig</strong>(3)</a>) and then call <a href="../man3/pmNewContext.3.html"><strong>pmNewContext</strong>(3)</a>.</p><p>There is no <strong>pmUnregisterDerived</strong> method, so once registered a derived metric persists for the life of the application.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">DIAGNOSTICS</h2>
        <div class="sectioncontent">
<p>On success, <strong>pmRegisterDerived</strong> returns NULL.</p><p>If a syntactic error is found at the time of registration, the value returned by <strong>pmRegisterDerived</strong> is a pointer into <em>expr</em> indicating <strong>where</strong> the error was found.  To identify <strong>what</strong> the error was, the application should call <a href="../man3/pmDerivedErrStr.3.html"><strong>pmDerivedErrStr</strong>(3)</a> to retrieve the corresponding parser error message.</p>
        </div>
      </section>

      <section>
        <h2 class="font-effect-shadow-multiple">RELATED TO pmRegisterDerived&hellip;</h2>
        <div class="sectioncontent">
<p><a href="../man1/PCPIntro.1.html"><strong>PCPIntro</strong>(1)</a>, <a href="../man3/PMAPI.3.html"><strong>PMAPI</strong>(3)</a>, <a href="../man3/pmDerivedErrStr.3.html"><strong>pmDerivedErrStr</strong>(3)</a>, <a href="../man3/pmFetch.3.html"><strong>pmFetch</strong>(3)</a>, <a href="../man3/pmLoadDerivedConfig.3.html"><strong>pmLoadDerivedConfig</strong>(3)</a>, <a href="../man3/pmNewContext.3.html"><strong>pmNewContext</strong>(3)</a> and <a href="../man3/pmReconnectContext.3.html"><strong>pmReconnectContext</strong>(3)</a>.</p>
        </div>
      </section>
<nav>
  <ul class="pager">
   <li class="previous"><a href="pmRecordSetup.3.html"><span aria-hidden="true">&larr;</span> pmRecordSetup.3: Record mode support for pmapi clients</a></li>
   <li class="next"><a href="pmSetMode.3.html">pmSetMode.3: Set collection time parameters for the current pmapi context <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>

  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60781387-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
